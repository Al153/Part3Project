\documentclass{Report}
\usepackage{framed}

\usepackage{listings}





\input{../proofs/header.tex}

%Theorems
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}

\usepackage{tikz}

\usetikzlibrary{shapes.geometric,fit}
\usetikzlibrary{arrows,automata,positioning}
\usetikzlibrary{decorations.pathreplacing,calc}


\begin{document}
\abstract


    
To date, there has been limited work on the semantics of languages with polymorphic effect systems. The application, by Moggi, of strong monads to modelling the semantics of effects has become a mainstream concept in functional programming languages. This was improved upon by Lucasson (?) using a graded monad to model languages with a range of independent and dependent effects at an operational level. A categorical semantics for parametric polymorphism in types was first published by Reynolds (?) allowing a denotational analysis of languages including type parameters. There has been some work on polymorphism over the exception effect (which paper). Despite these works, there has been no work to date on the denotational semantics of languages with general parametric polymorphism over effects.

In this dissertation, I present several pieces of work. Firstly, I introduce a modern definition of a lambda-calculus based language with an explicit graded monad to handle a variety of effects. This calculus is then extended using polymorphic terms to yield a more general polymorphic-effect-calculus. Next, I give an indexed-category-based denotational semantics for the language, along with an outline of a proof for the soundness of these semantics. Following this, I present a method of transforming a model of a non-polymorphic language into a model of the language with polymorphism over effects.

The full proofs can be found online on my github repository (link), since due to the number of theorems and cases, the total size is well over 100 pages of definitions, theorems, and proofs.

\chapter{Introduction}
\section{What is Effect Polymorphism?}
Effect polymorphism is when the same function in a language can operate on values of similar types but with different effects. It allows the same piece of code to be used in multiple contexts with different type signatures. This manifests in a similar manner to type parameter polymorphism in system-F based languages. Consider the following Scala-style pseudo-code:

\begin{framed}
    \begin{framed}
        \begin{verbatim}
def check[E: Effect](
    action: Unit => (Unit;e)
): Unit; (IO, e) {
    val ok: Boolean = promptBool(
        "Are you sure you want to do this?"
    )
    If (ok) {
        action()
    } else {
       abort()
    }
}  
            \end{verbatim}
    \end{framed}

    \begin{framed}
        \begin{verbatim}
check[RealWorld](() => check[RealWorld](FireMissiles))
check[Transaction](SendMoney(Bob, 100, USD))
check[Exception](ThrowException("Not Aborted"))
        \end{verbatim}
    \end{framed}
\end{framed}

In this example, we are reusing the same “check” function in three different cases with three different effects in a type safe manner. Hence, “check” is polymorphic in the effect parameter it receives. To analyse this language, it would be useful to have an analysis tool that can precisely model these separate, though potentially interdependent effects. A denotational semantics that can account for the parametric polymorphism over effects would be a step towards building such tools.

\section{An Introduction to Categorical Semantics}
In this dissertation, I describe a denotational semantics using category theory. A denotational semantics for a language is a mapping, known as a denotation, $\deno{-}$, of structures in the language, such as types and terms to mathematical objects in such a way that non-trivial properties of the terms in the language correspond to other properties of the denotations of the terms.

When we specify a denotational semantics of a language in category theory, we look to find a mapping of types and typing environments to objects in a given category.

\begin{align}
    A: \type & \mapsto \deno{A} \in \obj \C \\
    \G & \mapsto  \deno{\G} \in \obj \C
\end{align}



Further more, instances of the type relation should be mapped to morphisms between the relevant objects.

\begin{align}
    \gtyperelation{v}{A} & \mapsto \C(\deno{\G}, \deno{A}) 
\end{align}

This should occur in a sound manner. That is, for every instance of the $\beta\eta$-equivalence relation between two terms, the denotations of the terms should be equal in the category.

\begin{align}
    \gberelation{v_1}{v_2}{A} & \implies \deno{\gtyperelation{v_1}{A}} = \deno{\gtyperelation{v_2}{A}}
\end{align}

An example of $\beta\eta$-equivalence is that of the $\beta$-reduction of lambda terms. It should be the case that:

\begin{align}
    \treerule{Lambda-Beta}{\typerelation{\gax}{v_1}{B}\s\s\gtyperelation{v_2}{A}}{\gberelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{v_1\ssub{x}{v_2}}{B}}
\end{align}

Means that the denotations $\deno{\gtyperelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{B}}$ and $\deno{\gtyperelation{v_1\ssub{x}{v_2}}{B}}$ are equal.

To prove soundness, we perform rule induction over the derivation of the $\beta\eta$-equivalence relation, such as the lambda-beta-reduction rule above. 

Some of the inductive cases require us to quantify what the substitution of terms for variables, such as $\ssub{x}{v_1}$ does to the denotations of the parent term. Substitution theorems, allow us to quantify this action on denotations in a category theoretic way. 

If \begin{equation}
    \typerelation{\gax}{v_1}{B}
\end{equation}

And \begin{equation}
    \typerelation{\G}{v_2}{A}
\end{equation}

Then \begin{equation}
    \deno{\typerelation{\G}{v_1\ssub{x}{v_2}}{B}}
\end{equation}

Should be derivable from

\begin{equation}
    \deno{\typerelation{\gax}{v_1}{B}}
\end{equation}

And  \begin{equation}
    \deno{\gtyperelation{v_2}{A}}
\end{equation}

A similar concept is that of environment weakening. $\gax$ can derive every typing relation that $\G$ can, if $x$ is not already in the environment $\G$. Hence, $\gax$ is an example of a typing environment that is \textit{weaker} than $\G$. A weakening theorem proves that there is a systematic way to generate the denotation of a typing-relation on a term in a weaker environment from the denotation of the same term in a stronger environment.

If \begin{equation}
    \G' \leq_{\text{weaker}} \G
\end{equation}

Then

\begin{equation}
    \deno{\typerelation{\G'}{v}{A}}
\end{equation}

should be derivable from

\begin{equation}
    \deno{\typerelation{\G}{v}{A}}
\end{equation}

\subsection{Languages and Their Requirements}
Different languages require different structures to be present in a category for the category to be able to interpret terms in the language. Using the concepts defined in \ref{CategoryTheoryRequirements}, I shall now give an introduction to which category-theoretic structures are required to interpret different language features. 

One of the simplest, while still interesting, languages to derive a denotational semantics for is the simply typed lambda calculus (STLC). STLC's semantics require a cartesian closed category (CCC, see section \ref{CCC}).

Products in the CCC are used to denote the lists of variable types in the typing environment, exponential objects model functions, and the terminal object is used to derive representations of ground terms, such as the unit term, $()$, as well as the empty typing environment.


\begin{itemize}
    \item Products are used to construct type environments. $\deno{\G} = \deno{\nil, x: A, y:B, ... z:C} = \1 \times \deno{A} \times \deno{B} \times ... \times \deno{C}$
    \item Terminal objects are used in the denotation of constant terms $\deno{\gtyperelation{\const{A}}{A}} = \deno{\const{A}}\after\term{\deno{\G}}$
    \item Exponentials are used in the denotations of functions. $\deno{\typerelation{\G}{\lam{x}{A}{v}}{\ab}} = \cur{\deno{\typerelation{\gax}{v}{B}}}$
\end{itemize}

From this, we can specify what structures categories need to have in order to model more complex languages.
\begin{center}
    \begin{tabular}{|c|c|}
        \hline
        Language Feature & Structure Required \\
        \hline
        \hline
        STLC            & CCC \\
        \hline
        If expressions and booleans   & Co-product on the terminal object \\
        \hline
        Single Effect   & Strong Monad \\
        \hline
        Multiple Effects & Strong Graded Monad \\
        \hline
        Polymorphism & Indexed Category \\
        \hline
    \end{tabular}
\end{center}


A single effect can be modelled by adding a strong monad to the category, as shown by Moggi \todo{Reference}. The monad allows us to generate a unit effect and to compose multiple instances of the effect together in a way that intuitively matches the type system of a monadic language.

\begin{eqnarray}\label{MonadTypeRules}
    \treerule{Return}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\M{}{A}}} & \treerule{Bind}{\typerelation{\G}{v_1}{\M{}{A}} \s\s \typerelation{\gax}{v_2}{\M{}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{}{B}}}
\end{eqnarray}

These type rules can be modelled using the ``unit'' natural transformation and a combination of the ``join'' and tensor strength natural transformations respectively. 

For a more precise analysis of languages with multiple effects, we can look into the algebra on the effects. A simple example of such an algebra is a partially ordered monoid. The monoid operation defines how to compose effects, and the partial order gives a sub-typing relation to make programming more intuitive with respect to if statements. A category with a strong graded monad allows us to model this algebra in a category theoretic way. It also allows us to do some effect analysis in the type system, as seen in the type rules for return and bind in equation \ref{GradedMonadTypeRules}.

\begin{eqnarray}\label{GradedMonadTypeRules}
    \treerule{Return}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\moa}} & \treerule{Bind}{\typerelation{\G}{v_1}{\M{\e_1}{A}} \s\s \typerelation{\gax}{v_2}{\M{\e_2}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
\end{eqnarray}


To express polymorphism over a property $P$, the language's semantics are expanded to use a new environment specifying the variables ranging over $P$ that are allowed in a given context. This can be seen in the augmented type rules in \ref{PolymorphismTypeRules}.

\begin{eqnarray}\label{PolymorphismTypeRules}
    \treerule{Gen}{\etyperelation{\P, \a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}& \treerule{Spec}{\gpetyperelation{v}{\all{\a}{A}}\s\s\wellformed{\P}{\e}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\end{eqnarray}

To model these augmented type rules, we can create a category representing the semantics (a fibre) of the non-polymorphic language at each given context. This collection of non-polymorphic categories can be indexed by a base category which models the operations and relationships between the $P$-Environment. Morphisms in the base category between environments correspond to re-indexing functors between the fibres for the relevant environments. These functors, and a right adjoint for the re-indexing functor corresponding to $\p$ morphism can then be used to construct the semantics of polymorphic terms. Figure \ref{IndexDiagram} demonstrates this construction. How the fibres are derived from objects in the base category depends on the polymorphic properties of the language being modeled. For example, in the polymorphic lambda calculus (System-F) types are impredicative. That is, types can quantify over any other types, including themselves. This means that there has to be a strong coupling between the base category, which represents type-variable environments and transformations upon them and objects in the fibres, which represent types. This typically manifests in the set of objects  in each fibre being in bijection with the set of morphisms from the appropriate type-variable environment in the base category. Since, as we shall see, in effect-polymorphic languages, types quantify over effects, but effects do not quantify over themselves, we can conceptually decouple the objects in the fibres from the base category, meaning that effect-polymorphic models are simpler to define. 

In this dissertation, I show how these category theoretic building blocks can be put together to give the class of categories that can model polymorphic effect systems.

\begin{figure}[h!]\label{IndexDiagram}
    \begin{tikzpicture}[->,>=stealth']]
        % Draw the env objects
        \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {3, 4, 5, 6}{
            \node[fill,circle,inner sep=2pt,label=left:{\small $I_\yi$}] (d\yi) at (0,\y) {};
        }

        % draw the ... above the env objects
        \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {7, 7.5, 8}{
            \node[fill, circle, inner sep=1pt] (dd\yi) at (0,\y){};
        }
        % Draw the index category
        \node[fit=(d0) (d1) (d2) (d3) (dd0) (dd1) (dd2),ellipse,draw,minimum width=2cm] {};

        %draw the s-category stack
        \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {2, 4, 6, 8}{
            \node[circle, draw, inner sep=1pt, fill, label=above:{$\G$}] (g\yi) at (7,\y){};
            \node[circle, draw, inner sep=1pt, fill, label=above:{$A$}] (a\yi) at (9,\y){};
            \draw[->, dashed](g\yi) to[bend right=5] node[below]{\tiny $\deno{\etyperelation{\P_\yi}{\G}{v}{A}}$} (a\yi);
            \node[ellipse, draw, minimum width=5cm, minimum height=15mm,label=right:$S_\yi$] (s\yi) at (8,\y){};
        }

        % Hidden ellipse to draw functors to
        \node[ellipse, minimum width=5cm, minimum height=15mm] (s4) at (8,10){};

        %Draw the ... for the s-category stack
        \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {9.5, 10, 10.5}{
            \node[fill, circle, inner sep=1pt] (p\yi) at (8, \y){};
        }

        % Draw index arrows
        \foreach \i in {0, 1, 2, 3}{
            \draw[->] (d\i) to (s\i);
        }

        % draw the re-indexing functors

        \foreach \source[count=\dest] in {0, 1, 2, 3}{
            \draw[->](s\source.north west) to[bend left=10] node[left]{$\pstar$} (s\dest.south west);
        }

        % Draw the quantification functors
        \foreach \dest[count=\source] in {0, 1, 2, 3}{
            \draw[->] 
            (s\source.south east) to[bend left=10] node[right]{$\forall_{I_\dest}$} (s\dest.north east);
        }

        % Draw the internal morphisms in base category
        \foreach \dest[count=\source] in {0, 1, 2}{
            \draw[dashed,->]
            (d\source) to[bend right=10] node[right]{$\p$} (d\dest);
        }

        %Draw the bracket

        \draw [decoration={brace,amplitude=8pt},decorate] ($(s3)+(10em,1ex)$) -- ($(s0)+(10em,-1ex)$);
        \node[text width=20mm] (Label) at (14,5){Fibres for each effect environment};
    \end{tikzpicture}
    \caption{Diagram of the structure of an indexed category for modelling a polymorphic language. Solid arrows represent functors and dashed arrows represent internal morphisms. The left hand category is the base category.}
\end{figure}

\chapter{Required Category Theory}\label{CategoryTheoryRequirements}

Before going further, it is necessary to assert a common level of category theory knowledge. This section is not intended as a tutorial but to jog the memory of the reader, and briefly introduce some new concepts.

\section{Cartesian Closed Category}\label{CCC}

Recall that a category is cartesian closed if it has a terminal object, products for all pairs of objects, and exponentials.

\subsection{Terminal Object}
An object, $\1$, is terminal in a category, $\C$ if for all objects $X\in\obj\C$, there exists exactly one morphism $\term{X}: X \rightarrow \1$.

\subsection{Products}
There is a product for a pair of objects $X, Y\in\obj\C$ if there exists an object and morphisms in C:
\begin{tikzcd}
    X & \arrow{l}[swap]{\p} (X\times Y) \arrow [r, "\pp"] & Y
\end{tikzcd}

Such that for any other object and morphisms,

\begin{tikzcd}
    X & \arrow{l}[swap]{f} Z \arrow [r, "g"] & Y
\end{tikzcd}

There exists a unique morphism $\pr{f}{g}: Z \rightarrow (X\times Y)$ such that the following commutes:

\begin{tikzcd}
    & \arrow{dl}[swap]{f} Z  \arrow[d, "\pr{f}{g}"] \arrow [dr, "g"] & \\
    X & \arrow [l, "\p"] (X\times Y) \arrow{r}[swap]{\pp} & Y\\
\end{tikzcd}

\subsection{Exponentials}
A category has exponentials if for all objects $A, B$, it has an object $B^A$ and a morphism $\app: \B^A \times A \rightarrow B$ and for each $f: (A\times B)\rightarrow C$ in $\C$ there exists a unique morphism $\cur{f}: A \rightarrow C^B$ such that the following diagram commutes.

\begin{tikzcd}
    C^B \times B \arrow{r}{\app}& C\\
    A\times B\arrow{u}{\cur{f}\times \Id{B}} \arrow{ur}{f}    
\end{tikzcd}

\section{Initial Object}

An initial object, $I$ of $\C$ is one such that for every other object $X\in\obj\C$, there exists a unique morphism $\i_X: I\rightarrow X$. It is the conceptual dual of a terminal objects.

\section{Co-Product}
A co-product is the conceptual dual of a product.

There is a co-product for a pair of objects $X, Y\in\obj\C$ if there exists an object and morphisms in C:
\begin{tikzcd}
    X  \arrow{r}[swap]{\inl} & (X + Y) & \arrow [l, "inr"]  Y
\end{tikzcd}

Such that for any other object and morphisms,

\begin{tikzcd}
    X \arrow{r}[swap]{f} & Z & \arrow [l, "g"]  Y
\end{tikzcd}

There exists a unique morphism $[f, g]: X + Y \rightarrow Z $ such that the following commutes:


\begin{tikzcd}
    &  Z   & \\
    X \arrow{ur}{f} \arrow [r, "\inl"] &  \arrow{u}{[f, g]} (X + Y)  & \arrow{l}[swap]{\inr} \arrow{ul}[swap]{g} Y\\
\end{tikzcd}



\section{Functors}
A functor $F: \C \rightarrow \DC$ is a mapping of objects:
\begin{align}
    A\in\obj\C \mapsto FA \in \obj\DC
\end{align}

And morphisms:

\begin{align}
    f: \C(A, B) \mapsto F(f): \DC(FA, FB)
\end{align}

that preserves the category properties of composition and identity.

\begin{align}
    F(\Id{A}) & = \Id{FA} \\
    F(g\after f) & = F(g)\after F(f)
\end{align}

\section{Natural Transformations}

A natural transformation $\theta$ between to functors $F, G: \C \rightarrow \DC$ is a collection of morphisms, indexed by objects in $\C$ with  $\theta_A: F(A) \rightarrow G(A)$ such that diagram in figure \ref{Naturality} commutes for each $f: A \rightarrow B \in \C$.

\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{Naturality}
        \centering
        \begin{tikzcd}
            F(A) \arrow{r}{\theta_A} \arrow{d}{F(f)}  & G(A) \arrow{d}{G(f)}\\
            F(B) \arrow{r}{\theta_B}& G(B)\\ 
        \end{tikzcd}
        \caption{Naturality of a natural transformation}
    \end{minipage}\hfill
\end{figure}



\section{Monad}

A monad is famously ``a monoid on the category of endofunctors''. In less opaque terms, a monad is:

\begin{itemize}
    \item A functor from $\C$ onto itself. (An endofunctor) $T: \C \rightarrow C$
    \item A ``unit'' natural transformation $\point{A}: A\rightarrow T(A)$
    \item A ``join'' natural transformation $\mu_{A}: T(T(A)) \rightarrow T(A)$
\end{itemize}

Such that the diagrams in figures \ref{MonadAssociativity}, \ref{MonadUnits} commute.


\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{MonadAssociativity}
        \centering
        \begin{tikzcd}
            T(T(T(A)) \arrow{r}{\mu_{T(A)}} \arrow{d}{T(\mu_{A})} & T(T(A)) \arrow{d}{\mu_A} \\
            T(T(A)) \arrow{r}{\mu_A} & T(A)    
        \end{tikzcd}        \caption{Monad Associativity Laws}
    \end{minipage}\hfill
    \begin{minipage}{0.45\textwidth}
        \centering
        \label{MonadUnits}
        \begin{tikzcd}
            T(A) \arrow{r}{\point{T(A)}} \arrow{d}{T(\point{A})} \arrow[equal]{rd} & T(T(A)) \arrow{d}{\mu_A}\\
            T(T(A)) \arrow{r}{\mu_A} & T(A)
        \end{tikzcd}
        \caption{Monad Left- and Right-Unit laws}
    \end{minipage}
\end{figure}




\section{Graded Monad}
A graded monad is a generalisation of a monad to be indexed by a monoidal algebra $E$. It is made up of:

\begin{itemize}
    \item An endo-functor indexed by a monoid: $\T{}{}: (\E, \dot\, \1)  \rightarrow [\C, \C]$
    \item A unit natural transformation: $\point{}: \Id{} \rightarrow \T{\1}{}$
    \item A join natural transformation: $\bind{\e_1}{\e_2}{}: \T{\e_1}{\T{\e_2}{}} \rightarrow \T{\e_1 \dot \e_2}{}$
\end{itemize}

Such that the diagrams in figures \ref{GradedMonadAssociativity}, \ref{GradedMonadTypeRules} commute.


\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{GradedMonadAssociativity}
        \centering
        \begin{tikzcd}[ampersand replacement=\&]
            \T{\e_1}{\T{\e_2}{\T{\e_3}{A}}} 
            \arrow [r, "\bind{\e_1}{\e_2}{\T{\e_3}{A}}"]
            \arrow [d, "\T{\e_1}{\bind{\e_2}{\e_3}{A}}"] \& \T{\e_1 \dot \e_2}{\T{\e_3} A} \arrow [d, "\bind{\e_1 \dot \e_2}{\e_3}{A}"] \\
            \T{\e_1}{\T{\e_2 \dot \e_3}{A}} \arrow [r, "\bind{\e_1}{\e_2 \dot \e_3}{A}"] \& \T{\e_1 \dot \e_2 \dot \e_3}{A}    
        \end{tikzcd}
        \caption{Associativity of a graded monad}
    \end{minipage}\hfill
    \begin{minipage}{0.45\textwidth}
        \centering
        \begin{tikzcd}[ampersand replacement=\&]
            \tea
             \arrow[equal]{rd} 
             \arrow[r, "\T{\e}{\point{A}}"]
             \arrow{d}{\point{\tea}}
            \& 
            \T{\e}{\T{\1}{A}} 
                \arrow[d, "\bind{\e}{\1}{A}"] \\
                \T{\1}{\T{\e}{A}}
                     \arrow{r}{\bind{\1}{\e}{A}}
            \& 
            \tea
        \end{tikzcd}
        \caption{Left- and Right- Units of a graded monad}
    \end{minipage}
\end{figure}


\section{Tensor Strength}
Tensorial strength over a graded monad gives us the tools necessary to manipulate monadic operations in an intuitive way. A monad with tensor strength is referred to as ``strong''. Tensorial strength consists of a natural transformation:

\begin{align}
    \tstrength{\e}{A}{B}: A \times \teb \rightarrow \T{\e}{(A \times B)}
\end{align}

Which has well defined interactions with the graded monad morphisms and the product-reordering natural transformation $\alpha_{A, B, C} = \pr{\p\after\p}{\pr{\pp\after\p}{\pp}}: ((A \times B) \times C) \rightarrow (A \times (B \times C))$, as seen in figures \ref{TensorStrengthLeftNaturality}, \ref{TensorStrengthRightNaturality}, \ref{TensorStrengthUnitorLaw}, \ref{TensorStengthJoin}, \ref{TensorStrengthPoint}, \ref{TensorStrengthAlpha}.

\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{TensorStrengthLeftNaturality}
        \centering
        \begin{tikzcd}[ampersand replacement=\&]
            A \times \teb  \arrow [r, "f \times \Id{\teb}"] \arrow [d, "\tstrength{\e}{A}{B}"]  \&
            A' \times \teb \arrow [d, "\tstrength {\e} {A'}{B}"]\\
            \T{\e}{(A \times B)} \arrow [r, "\T{\e}{(f \times \Id{B})}"]\&
            \T{\e}{(A' \times B)}
            \end{tikzcd}
            \caption{Left Naturality of Graded Tensor Strength}
    \end{minipage}
    \hfill
    \begin{minipage}{0.45\textwidth}
        \label{TensorStrengthRightNaturality}
        \centering
        \begin{tikzcd}[ampersand replacement=\&]
            A \times \teb \arrow [r, "\Id{A} \times \T{\e}{f}"] \arrow [d, "\tstrength{\e}{A}{B}"]\&
            A \times \T{\e}{B'} \arrow [d, "\tstrength{\e}{A}{B'}"]\\
            \T{\e}{(A \times B)} \arrow [r, "\T{e}{(\Id{A} \times f)}"] \&
            \T{\e}{(A \times B')}
        \end{tikzcd}
        \caption{Right Naturality of Graded Tensor Strength}
    \end{minipage} 
\end{figure}


\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{TensorStrengthUnitorLaw}
    \begin{tikzcd}[ampersand replacement=\&]
        A \times \teb 
        \arrow [r, "\tstrength{\e}{A}{B}"]
        \arrow [rd, "\pp"]
        \& 
        \T{\e}{(A \times B)}
        \arrow [d, "\T{\e}{\pp}"]
        \\
        \&
        \teb
    \end{tikzcd}
    \caption{Tensor Strength Unitor Law}
    \end{minipage}
    \quad
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{TensorStengthJoin}
        \begin{tikzcd}[ampersand replacement=\&]
            A \times \T{\e_1}{\T{\e_2}{B}} 
            \arrow [r, "\tstrength{\e_1}{A}{\T{\e_2}{B}}"]
            \arrow [dr, "\Id{A} \times \bind{\e_1}{\e_2}{B}"]
            \& 
            \T{\e_1}{(A \times \T{\e_2}{B})} 
            \arrow [r, "\T{\e_1}{\tstrength{\e_2}{A}{B}}"]
            \& 
            \T{\e_1}{\T{\e_2}{(A \times B)}} 
            \arrow [d, "\bind{\e_1}{\e_2}{A \times B}"]
            \\
            \&
            A \times \T{\e_1 \dot \e_2}{B}  
            \arrow [r, "\tstrength{\e_1 \dot \e_2}{A}{B}"] 
            \&
            \T{\e_1 \dot \e_2}({A \times B)}
        \end{tikzcd}
        \caption{How the tensor strength natural transformation commutes with the join natural transformation }
    \end{minipage}

    \quad
    \begin{minipage}{0.45\textwidth}
        \label{TensorStrengthPoint}
        \begin{tikzcd}[ampersand replacement=\&]
            A \times B
            \arrow [r, "\Id{A} \times \point{B}"]
            \arrow [rd, "\point{A \times B}"]
            \&
            A \times \tob 
            \arrow [d, "\tstrength{\1}{A}{B}"]
            \\
            \&
            \T{\1}{(A \times B)}
        \end{tikzcd}
        \caption{How the tensor strength natural transformation commutes with the unit natural transformation}
    \end{minipage}
\end{figure}



\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \label{TensorStrengthAlpha}
        \begin{tikzcd}[ampersand replacement=\&]
            (A\times B)\times \T{\e}{C} 
            \arrow [rr, "\tstrength{\e}{(A\times B)}{C}"]
            \arrow [d, "\alpha_{A, B, \T{\e}{C}}"]
            \& \& \T{\e}{((A \times B)\times C)}
            \arrow [d, "\T{\e}{\alpha_{A, B, C}}"]
            \\
            A \times (B \times \T{\e}{C}) 
            \arrow [r, "\Id{A}\times\tstrength{\e}{B}{C}"]
            \&
            A\times\T{\e}{(B \times C)} 
            \arrow [r, "\tstrength{\e}{A}{(B \times C)}"]
            \& \T{\e}{(A \times (B \times C))}
            \\
        \end{tikzcd}
    \end{minipage}
    \caption{Tensorial strength commutes with the reordering natural transformation.}
\end{figure}






\section{Adjunction}
An important concept in category theory is that of an Adjunction.

Given functors F, G:

\begin{tikzcd}
    C \arrow[bend right=30]{rr}{F} & & D\arrow[bend right=30]{ll}{G}
\end{tikzcd}

And natural transformations:

\begin{itemize}
    \item Unit: $\eta_A: A \rightarrow G(F A)$ in $\C$
    \item Co-unit $\epsilon_B: F(G B) \rightarrow B$ in $\DC$
\end{itemize}

Such that 

\begin{align}
    \epsilon_{F A}\after F(\eta_A) & = \Id{F A} \\
    G(\epsilon_B)\after \eta_{F B} & = \Id{G B}
\end{align}

We can then use $\epsilon$ and $\eta$ to form a natural isomorphism between morphisms in the two categories.

\begin{align}
    \bar{(-)}: \quad\C(FA, B) &\leftrightarrow \DC(A, GB) \quad: \widehat{(-)}\\
     f & \mapsto G(f)\after\eta_A \\
     \epsilon\after F(g) & \mapsfrom g\\
\end{align}

\section{Strict-Indexed Category}

The final piece of category theory required to understand this dissertation is the concept of a strict-indexed Category. A strict-indexed category is a functor from a base category into a target category of categories, such as the category of cartesian closed categories. Objects, $A$, in the base category are mapped to categories $\C(A)$, known as fibres in the target category. Morphisms between objects in the base category, $f: B\rightarrow A$, are mapped to functors, $f\star: \C(A)\rightarrow \C(B)$, between categories in the target category. The strict- modifier indicates that the indexing in this construction is done by a functor as opposed to the weaker pseudofunctor (weak functor) structure. Since pseudofunctors are not needed to explain anything in this project, I shall leave out their definition, though an interested reader may wish to research them further. \footnote{https://ncatlab.org/nlab/show/pseudofunctor}


Due to the composition laws for functors, $\theta\star\after\phi\star = (\phi\after\theta)\star$ and $\Id{A}*(B) = B\in\obj \C(A)$. For example, we may use the the case of cartesian closed categories indexed by a pre-order, $\mathbb{P}$:

\begin{align}
    I: \mathbb{P} & \rightarrow \textit{CCCat}\qt{The indexing functor} \\
    A \in\obj\mathbb{P} & \mapsto \C \in\textit{CCCat}\qt{Objects are mapped to categories}\\
    A \leq B & \mapsto (A \leq B)\star: \C \rightarrow \DC\qt{Morphisms are mapped to functors preserving CCC properties.}
\end{align}




\chapter{The Polymorphic-Effect-Calculus}
In this chapter I introduce the monadic, effect-ful language used in the rest of the dissertation, known from now on as the Effect Calculus (EC). Following this, I then introduce polymorphic terms to the EC which yield the Polymorphic Effect Calculus (PEC).

\section{Effect Calculus}
The basic effect calculus is an extension of the simply typed lambda calculus to include constants, if-statements, effects, and sub-typing.

It has terms of the following form:

\begin{align}
    v ::= \const{A} \mid x\mid \t \mid\f \mid\u\mid\lam{x}{A}{v}\mid\apply{v_1}{v_2}\mid\return{v}\mid\doin{x}{v_1}{v_2}\mid\pifthenelse{A}{v}{v_1}{v_2} 
\end{align}

Where $\const{A}$ is one of collection of ground constants, and $A$ ranges over the types:

\begin{align}
    A, B, C ::= \g\mid \ab \mid\mea
\end{align}

Where $\g$ is from a collection of ground types, including $\U, \B$, and $\e$ ranges over pre-ordered monoid of effects: $(E, \dot, \subeffect, \1)$.

For example, by instantiating the language with the appropriate constants, ground effects, and ground types, we can write the following programs.

\begin{framed}
    \begin{lstlisting}[
        mathescape,
        columns=fullflexible,
        basicstyle=\fontfamily{lmvtt}\selectfont,
      ]
        do $b$ <$-$ PromptUser("Are You Sure?") in (
            if $b$ then
                FireMissiles
            else
                AbortMissiles
        )
    \end{lstlisting}        
\end{framed}

\begin{framed}
    \begin{lstlisting}[
        mathescape,
        columns=fullflexible,
        basicstyle=\fontfamily{lmvtt}\selectfont,
      ]
       $\lambda$ $alice$: Agent. (
           $\lambda$ $bob$: Agent. (
            do $amount$ <$-$ AwaitPayment($alice$)
            in SendPayment($bob$, $amount$)
           )
       )
      \end{lstlisting}
\end{framed}

Already, we can see where having effect polymorphism in the language would be useful. We could make the first example \todo{Add references} into a more general procedure that prompts a user to confirm any I-O action.

\section{Polymorphic Effect Calculus}
Next, we consider the Effect Calculus extended with terms to allow System-F style polymorphism over effects.

\begin{align}
    v::=\text{..}\mid\elam{\a}{v}\mid\eapp{v}{\e}
\end{align}

\begin{align}
    A, B, C::=\text{...}\mid \all{\a}{A}
\end{align}

Where effects $\e$ now range over the effect pre-ordered monoid augmented with effect variables from an environment $\P = \nil, \a, \b ...$, written as $(E_\P, \dotp, \subeffectp, \1)$.

\section{Type System}
\subsection{Environments}
As mentioned before, effects can now include effect variables. These are managed in the type system using a well-formed effect-variable-environment $\P$, which is a snoc-list.

\begin{align}
    \P ::= \nil \mid \P, \a
\end{align}



\subsection{Effects}
The ground effects form the same monotonous, pre-ordered monoid $(E, \dot, \1, \subeffect)$ over ground elements $e$. For each effect environment $\P$, we define a new, symbolic pre-ordered monoid:

\begin{equation}
    (E_\P, \dotp, \1, \subeffectp)
\end{equation}

Where $E_\P$ is the closure of $E\cup \left\{\a\mid\a\in\P\right\}$ under $\dotp$, which is defined as:

\begin{equation}
    \treerule{}{\e_3 = \e_1\dot\e_2}{\e_3 = \e_1\dotp\e_2}
\end{equation} 

For variable-free terms and is defined symbolically for variable-containing terms. Further more, we also define the sub-effecting relation in terms of its variables and the ground relation.

\begin{equation}
    \e_1 \subeffectp \e_2 \Leftrightarrow \forall \si\downarrow. \e_1\sub{\si\downarrow} \subeffect \e_2\sub{\si\downarrow}
\end{equation}

Where $\si\downarrow$ denotes any ground-effect-substitution of $\P$. That is any substitution of all effect-variables in $\P$ to ground effects. Where it is obvious from the context, I shall use $\subeffect$ instead of $\subeffectp$.


\subsection{Types}
As stated, types are now generated by the following grammar.

$$ A, B, C \gens \ground \mid \ab \mid \mea \mid \all{\a}{A}$$
  
\subsection{Type Environments}
As is often the case in similar type systems, a type environment is a snoc-list of term-variable, type pairs, $G \gens \nil \mid \gax$.

\paragraph{Domain Function on Type Environments}

\[
    \dom{\nil} = \emptyset
    \quad\quad\quad
    \dom{\gax} =  \dom{\G}  \cup \left\{x \right\}
\]

\subsection{Well-Formed-Ness Predicates}
To formalise properties of the type system, it will be useful to have a collection of predicates ensuring that structures in the language are well-behaved with respect to their use of effect variables.

Informally, $\a \in \P$ if $\a$ appears in the list represented by $\P$.

The $\ok{}$ predicate on effect environments asserts that the effect environment does not contain any duplicate effect-variables.

\[
    \treerule{Atom}{}{\ok{\nil}}
\quad
    \treerule{A}{\ok{\P} \s\s \a\notin \P}{\ok{\P, \a}}
\]

Using this, we can define the well-formed-ness relation on effects, $\wellformed{\P}{\e}$. In short, this relation ensures that effects do not reference variables that are not in the effect environment.

\[
    \treerule{Ground}{\ok{\P}}{\wellformed{\P}{e}}
    \quad
    \treerule{Var}{\ok{\P,\a}}{\wellformed{\P,\a}{\a}}
    \quad
    \condtreerule{Weaken}{\wellformed{\P}{\a}}{\wellformed{\P,\b}{\a}}{\a\neq\b}
    \quad
    \treerule{Monoid Op}{\wellformed{\P}{\e_1}\s\s\wellformed{\P}{\e_2}}{\wellformed{\P}{\e_1\dot\e_2}}
\]

The well-formed-ness of effects can be used to a similar well-typed-relation on types, $\wellformed{\P}{A}$, which asserts that all effects in the type are well-formed.

\[
    \treerule{Ground}{}{\wellformed{\P}{\g}}
    \quad
    \treerule{Lambda}{\wellformed{\P}{A}\s\s\wellformed{\P}{B}}{\wellformed{\P}{\ab}}
    \quad
    \treerule{Computation}{\wellformed{\P}{A}\s\s\wellformed{\P}{\e}}{\wellformed{\P}{\mea}}
    \quad
    \treerule{For-All}{\wellformed{\P,\a}{A}}{\wellformed{\P}{\all{\a}{A}}}
\]

Finally, we can derive the a well-formed-ness of type-environments,   $\oke{\P}{\G}$, which ensures that all types in the environment are well formed.

\[
    \treerule{Nil}{}{\oke{\P}{\nil}}
    \quad
    \treerule{Var}{\oke{\P}{\G}\s\s x\notin\dom{\G}\s\s \wellformed{\P}{A}}{\oke{\P}{\gax}}
\]

\subsection{Sub-typing}
    There exists a sub-typing pre-order relation $\subtype_{\ground}$ over ground types. That is:

    \[
        \treerule{Reflexive}{}{A \subtype_{\ground} A}
        \quad
        \treerule{Transitive}{A \subtype_{\ground} B \s \s B \subtype_{\ground} C}{A \subtype_{\ground} C}
    \]

    We extend this relation with the function, effect, and effect-lambda sub-typing rules to yield the full sub-typing relation under an effect environment, $\P$, $\subtypep$
\[
    \treerule{ground}{A \subtype_{\ground} B}{A \subtypep B}
    \quad
    \treerule{Fn}{A \subtypep A' \s\s B' \subtypep B }{\fntype{A'}{B'} \subtypep \ab}
    \quad
    \treerule{All}{A\subtypep A'}{\all{\a}{A}\subtypep\all{a}{A'}}
    \quad
    \treerule{Effect}{A\subtypep B\s\s \e_1\subeffectp\e_2}{\M{\e_1}{A}\subtypep\M{\e_2}{B}}
\]


\subsection{Type Rules}
We define a fairly standard set of type rules on the language.

\[
    \treerule{Const}{\oke{\P}{\G}\s\s\wellformed{\P}{A}}{\gpetyperelation{\const{A}}{A}} 
    \quad
    \treerule{Unit}{\oke{\P}{\G}}{\gpetyperelation{\u}{\U}} 
    \quad
    \treerule{True}{\oke{\P}{\G}}{\gpetyperelation{\t}{\B}}
    \quad
    \treerule{False}{\oke{\P}{\G}}{\gpetyperelation{\f}{\B}}
\]
\[
\treerule{Var}{\oke{\P}{\gax}}{\etyperelation{\P}{\gax}{x}{A}}
\quad
\condtreerule{Weaken}{\etyperelation{\P}{\G}{x}{A}\s\s\wellformed{\P}{B}}{\etyperelation{\P}{\gby}{x}{A}}{x \neq y}
\quad
\treerule{Fn}{\etyperelation{\P}{\gax}{v}{\b}}{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
\]
\[
    \treerule{Sub}{\etyperelation{\P}{\G}{v}{A}\s\s A \subtypep B}{\etyperelation{\P}{\G}{v}{B}}
    \quad
    \treerule{Effect-Abs}{\etyperelation{\P,\a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}
    \quad
    \treerule{Effect-apply}{\gpetyperelation{v}{\all{\a}A}\s\s\wellformed{\P}{\e}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\]
\[
    \treerule{Return}{\gpetyperelation{v}{A}}{\gpetyperelation{\return{v}}{\moa}}
    \quad
    \treerule{Apply}{\gpetyperelation{v_1}{\aeb}\s\s\gpetyperelation{v_2}{A}}{\gpetyperelation{\apply{v_1}{v_2}}{\meb}}
\]
\[
    \treerule{If}{\gpetyperelation{v}{\B} \s\s \gpetyperelation{v_1}{A}\s\s\gpetyperelation{v_2}{A}}{\gpetyperelation{\pifthenelse{A}{V}{v_1}{v_2}}{A}}
    \quad
    \treerule{Do}{\gpetyperelation{v_1}{\M{\e_1}{A}} \s\s \etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}{\gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
\]

\subsection{Ok Lemma} The first lemma used in this dissertation is that: If $\gpetyperelation{v}{A}$ then $\oke{\P}{\G}$.
\paragraph{Proof}
If $\ok{\gax}$ then by inversion $\ok{\G}$
Only the type rule \texttt{Weaken} adds terms to the environment from its preconditions to its post-condition and it does so in an $\ok{}$ preserving way. Any type derivation tree has at least one leaf. All leaves are axioms which require $\oke{\P}{\G}$. And all non-axiom derivations preserve the $\ok{}$ property.


\chapter{Semantics for EC in an S-Category}

As suggested in \todo{Reference to intro}, since EC contains multiple effects, STLC terms, and if-expressions, we should be able interpret its semantics in a cartesian closed category with an appropriate strong graded monad. With the addition of some extra category structure to handle sub-typing, which I shall explain shortly, it is indeed possible to interpret EC. This section contains a fairly high-level treatment of the semantics. This is because the concepts introduced are a sub-set of those required for the semantics of PEC, which I shall explain in more detail later.

\todo{
    Denotational semantics-es for similar languages have been presented before - references?
}

In order to correctly model a given instantiation of EC, that is an EC with a collection of effects, constants, and ground types, there should be a collection of objects in the category to represent the ground types. There should also be a point morphism (a morphism from the terminal object to the appropriate type) for each constant.

In addition to the previously stated requirements, we also require the category, $\C$, to be able to model sub-typing and sub-effecting. For each instance of the ground sub-typing relation, $A \subtypeg B$, there should exist a morphism between the objects representing the ground types $A$ and $B$. A further requirement is that $\C$ has a collection of sub-effecting natural transformations. For each instance of $\e_1 \subeffect \e_2$, there exists a natural transformation $\db{\e_1\subeffect\e2}: \T{\e_1}{}\rightarrow\T{\e_2}{}$ such that it has interactions with the graded monad as specified in figures \ref{SubeffectTensorStrength}, \ref{SubeffectBind}. We can now define morphisms for all forms of sub-typing by constructions following the derivation tree for sub-typing. For more detail, one can look at section \todo{Ref} in the semantics of PEC for the same construction on PEC. From this point onwards, we shall refer to a category that fulfills these properties of having a strong graded monad, CCC, ground objects and points, sub-effect natural transformations, and a co-product as an S-Category (Semantic Category).

\todo{S-Category is a novel term.}

\todo{This is very vague so far. I don't want to get too bogged down in the semantics of the Effect Calculus though}
A full derivation and proof of soundness of the semantics of the Effect Calculus can be found online \todo{Link} as it is too long to include here and many of the concepts are repeated later in the remainder of this dissertation anyway. The categorical semantics of the Effect Calculus requires an S-category not only to simply model all of the features of EC but also to use the various commutivity diagrams and rules to manipulate the expressions encountered when proving properties of the semantics.



\begin{figure}
\centering
\begin{minipage}{0.45\textwidth}\label{SubeffectTensorStrength}
    \begin{tikzcd}[ampersand replacement=\&]
        A \times \T{\e_1}{B} \arrow [r, "\Id{A} \times \dse{\e_1}{\e_2}_B"] \arrow [d, "\tstrength{\e_1}{A}{B}"] \&
        A \times \T{\e_2}{B} \arrow [d, "\tstrength{\e_2}{A}{B}"] \\
        \T{\e_1}{(A \times B)} \arrow [r, "\dse{\e_1}{\e_2}_{ A \times B}"] \&
        \T{\e_2}{(A \times B)} 
    \end{tikzcd}\qquad
    \caption{The interaction of the sub-effect natural transformation with the tensor strength natural transformation.}
\end{minipage}  
\quad
\begin{minipage}{0.45\textwidth}\label{SubeffectBind}
\begin{tikzcd}[ampersand replacement=\&]
    \T{\e_1}{\T{\e_2}{}} 
    \arrow [rr, "\T{\e_1}{\deno{\e_2\subeffect\e_2'}
    }"]
    \arrow [d, "\bind{\e_1}{\e_2}{}"]
    \&  \&
    \T{\e_1}{\T{\e_2'}{}}
    \arrow [rr, "\db{\e_1 \subeffect\e_1'}_{M, \T{\e_2'}{}}"]
    \& \&
     \T{\e_1'}{\T{\e_2'}{}} 
     \arrow [d, "\bind{\e_1'}{\e_2'}{}"]
     \\
    \T{\e_1\dot\e_2}{}
    \arrow [rrrr, "\deno{\e_1\dot\e_2\subeffect\e_1'\dot\e_2'}"]
    \& \&
     \& \&
    \T{\e_1'\dot\e_2'}{}
\end{tikzcd}
\caption{The interaction of the sub-effect natural transformation with the graded monad  bind natural transformation.}
\end{minipage}  
\end{figure}





\todo{This has been very vague as I want to save words on the non-polymorphic stuff.}

\chapter{Semantics For PEC in an Indexed Category}


In this chapter, I  describe the category structure required to interpret an instance of the PEC. I then present denotations of each type of structure in the language, such as types, effects, terms, substitutions, and environment weakenings. Finally, I provide outlines and interesting cases of the proofs of the lemmas leading up to and including soundness of $\beta\eta$-conversion.


\section{Required Category Structure}
In order to model the polymorphism of PEC, we need to now look at an indexed category. This consists of a base category, $\C$ in which we can interpret the possible effect-environments in, and a mapping from objects in the base category to S-Categories in the category of S-closed categories. This functor is denoted from this point onwards as $\C(-)$ and the induced categories $\C(\deno{\P})$ are called ``fibres''. A further notational short-hand I use, inheriting from R. L. Crole \todo{Reference}, is to write $I$ for the denotation of $\P$. The term ``S-closed'' indicates that all functors derived from $\C$ within this category preserve the properties of S-categories, which are explained in section \todo{Ref}. A functor $F$ preserves the properties of S-categories if it preserves each of the features within an S-category. For example $F(X\times Y) = (FX)\times (FY)$. For a full list of properties that an S-closed functor should preserve, please see appendix \todo{Link/reference}. Thus, each morphism $\theta: \deno{\P'}\rightarrow\deno{\P}$ in $\C$ should induce as S-closed, re-indexing functor $\theta\star: \C(I)\rightarrow\C(I')$ between the fibres.

The essential idea from this point on is that for each relation $\wellformed{\texttt{Env}}{\texttt{Conclusion}}$ should have a denotation that is an object or morphism in a category. For example, $\deno{\typerelation{\P}{\e}{\effect}}$ is a morphism in the base category, $\deno{\typerelation{\P}{A}{\type}}$ is an object in the fibre (S-category) induced by $\P$, and $\deno{\gpetyperelation{v}{A}}$ is morphism between the objects which denote $\G$ and $A$ in the fibre induced by $\P$.

In order to form denotations of well formed effects, $\e$, we need specific objects to exist in the base category $\C$. Firstly, there should exist an object, $U$, indicating the kind of effects. To denote effect-variable-environments, essentially a list of variables, we need finite products on $U$, that is $\C$ should have a terminal object, $\1$ and binary products. We can form finite products as so: $U^0 = \1$ and $U^{n+1} = U^n\times U$. From now on, I use $I$ to mean $U^n$ for some $n$.

There is also a requirement that the indexed category can model ground effects, types, and terms. In order to do this, it should have a base-category morphism $\deno{e}: \C(\1, U)$ for each ground effect $e$. Furthermore, each fibre should contain and object $\deno{\g}$ for each ground-type $\g$. Finally, for each constant, $\const{A}$, there should exist a morphism in each fibre: $\deno{\const{A}}: \1 \rightarrow A$. These last two requirements are satisfied by the fibres all being S-categories.

Next up, there needs to be a monoidal operator $\Mul: \ciu \times \ciu \rightarrow \ciu$. $\Mul$ should be natural, which means: $\Mul(f, g)\after\theta = \Mul(f\after\theta, g\after\theta)$. Secondly, $\Mul$ should preserve the operation of the multiplication of ground effects. That is, $\Mul(\deno{e_1},\deno{e_2}) = \deno{e_1\dot e_2}$ where $e_1, e_2$ are ground effects.

Our penultimate requirement is that the re-indexing functor  induced by $\p: I\times U\rightarrow U$ (that is $\pstar: \C(I) \rightarrow \C(I\times U)$) has a right adjoint, $\allI: \C(I\times U) \rightarrow \C(I)$. As the reader might be able to guess, this functor allows us to interpret quantification over effects.

Finally, $\allI$ should satisfy the Beck-Chevalley condition \todo{Reference}. That is $\theta\star\after\allI = \allII\after(\theta\times\Id{U})\star$, and the natural transformation $\bar{(\theta\times\Id{U})\star(\counit{})}$ between these functors is equal to the identity natural transformation. This allows us to commute the re-indexing functors with the quantification functor.

\begin{align}
    \bar{(\theta\times\Id{U})\star(\counit{})} = \Id{}: \theta\star\after\allI \rightarrow \allII\after(\theta\times\Id{U})\star\in \C(I')
\end{align}

From the beck-chevalley condition, we can derive some more naturality conditions that will become useful later.
Using the adjunction property, we have that: $\bar{f\after\pstar(n)} = \bar{f}\after n$. Secondly, using the Beck-Chevalley condition, we can derive some non-trivial interactions between re-indexing functors and the adjunction. \todo{Reference for this? It's from a math-overflow answer} 
    \begin{align}
        \theta\star\unit{A}:\quad&\theta\star A \rightarrow \theta\star\after\allI\after\pstar A\\
        \theta\star\unit{} =& \bar{(\theta\times\Id{U})\star(\counit{\pstar})}\after\theta\star\unit{}\\
        =& (\allII\after(\theta\times\Id{U})\star)(\counit{\pstar})\after\unit{(\allII\after(\theta\times\Id{U})\star)\after\pstar}\after\theta\star\unit{}\\
        = & (\allII\after(\theta\times\Id{U})\star)(\counit{\pstar})\after\unit{\theta\star\after\allI\after\pstar}\after\theta\star\unit{}\\
        = & (\allII\after(\theta\times\Id{U})\star)(\counit{\pstar}) \after(\theta\star\after\allI\after\pstar)\unit{} \after\unit{(\theta\times\Id{U})\star}\\
        = & (\theta\star\after\allI)(\counit{\pstar}
        \after\pstar\unit{})\after\unit{(\theta\times\Id{U})\star}\\
        = & (\theta\star\after\allI)(\Id{})\after\unit{(\theta\times\Id{U})\star}\\
        = & \unit{(\theta\times\Id{U})\star}
    \end{align}

    Importantly, this gives us the useful naturality condition that allows us to push re-indexing functors into the adjunction terms.
    
    \begin{align}\label{NaturalityCondition}
        \theta\star(\bar{f}) & = \theta\star(\allI(f)\after\eta_A)\\
        & = \theta\star(\allI(f))\after\theta\star(\eta_A)\\
        & =  (\allII\after(\theta\times\Id{U})\star)f \after\unit{(\theta\times\Id{U})\star A}\\
        & = \bar{(\theta\times\Id{U})\star f}\\
    \end{align}

\section{Road Map}
In figure \ref{RoadMap}, one can see a diagram of the collection of theorems that need to be proved to establish the $\beta\eta$-equivalence soundness of a semantics for PEC.


The first pair of theorems is made up of the effect-substitution and weakening theorem on effects. These theorems show that substitutions of effects have a well-behaved and easily defined action upon the denotations of effects. Using these theorems, we can then move on to characterize the action of effect-substitutions and effect-environment-weakening on the denotations of types and type-environments. From this, we can also look at the action of weakening and substituting effect environments on the sub-typing between types.

The next step is to use these substitution theorems to formalise the action of substitution and weakening of the effect environments on terms. This then allows us to find denotations for the weakening of term-substitutions and type environment weakening, which set us up to prove the typical weakening and substitution theorems upon term-variables and type environments. 

Separately, we prove that all derivable denotations for a typing relation instance, $\gpetyperelation{v}{A}$ have the same denotation. This is important, since sub-typing allows us to find multiple distinct typing derivations for terms, which initially look like they may have distinct denotations. Using a reduction function to transform typing derivations into a unique form, I prove that all typing derivations yield equal denotations.

This collection of theorems finally allows us to complete all cases of the $\beta\eta$-equivalence soundness theorem.

\begin{figure}[h!]\label{RoadMap}\begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=3cm,
    thick,main node/.style={rectangle,fill=blue!20,draw,
    font=\sffamily\small\bfseries,minimum size=15mm}]

    \node[main node,text width=20mm, fill=red] (IndexCategory) {Indexed Category and Adjunction};
    \node[main node,text width=20mm, fill=red] (MulNaturality) [below of=IndexCategory] {Naturality of Mul Operator};

    \node[main node,text width=20mm, fill=red] (BeckChevalley) [left of=MulNaturality]{Beck-Chevalley Condition};
    \node[main node,text width=20mm, fill=red](SClosure) [right of=MulNaturality]{S-Closure of Re-indexing};

    \node[main node, text width=20mm](EffectWeakeningEffects) [below left of=MulNaturality]{Effect Weakening on Effects};

    \node[main node, text width=20mm](EffectSubEffects) [below right of=MulNaturality]{Effect Substitution on Effects};

    \node[main node, text width=20mm](EffectWeakeningTypes)[below of=EffectWeakeningEffects]{Effect Weakening on Types};

    \node[main node, text width=20mm](EffectSubTypes)[below of=EffectSubEffects]{Effect Substitution on Types};

    \node[main node, text width=20mm](EffectWeakeningTerms)[below of=EffectWeakeningTypes]{Effect Weakening on Terms};

    \node[main node, text width=20mm](EffectSubTerms)[below of=EffectSubTypes]{Effect Substitution on Terms};

    \node[main node, text width=20mm](EffectWeakeningSubTyping)[left of=EffectWeakeningTerms]{Effect Weakening on Sub-typing};

    \node[main node, text width=20mm](EffectSubSubTyping)[right of=EffectSubTerms]{Effect Substitution on Sub-typing};

    \node[main node, text width=20mm](EffectWeakeningWeakening)[below of=EffectWeakeningTerms]{Effect Weakening on Term Weakening};

    \node[main node, text width=20mm](EffectWeakeningSubstitution)[below of=EffectSubTerms]{Effect Weakening on Term Substitution};

    \node[main node, text width=20mm](TermWeakening)[below of=EffectWeakeningWeakening]{Term Weakening Theorem};

    \node[main node, text width=20mm](TermSubstitution)[below of=EffectWeakeningSubstitution]{Term Substitution Theorem};

    \node[main node, text width=20mm](UniqueDenotations)[below left of=TermSubstitution]{Unique Denotations};

    \node[main node, text width=20mm](Soundness)[below of=UniqueDenotations]{Soundness};

    \draw [->] (IndexCategory) edge (BeckChevalley) (IndexCategory) edge (MulNaturality) (IndexCategory) edge (SClosure);
    \draw [->] (MulNaturality) edge (EffectWeakeningEffects) (MulNaturality) edge (EffectSubEffects);

    
    \draw [->] (EffectWeakeningEffects) edge (EffectWeakeningTypes) (EffectSubEffects) edge (EffectSubTypes);

    \draw [->] (EffectWeakeningTypes) edge (EffectWeakeningSubTyping) (EffectSubTypes) edge (EffectSubSubTyping);

    
    \draw [->] (EffectWeakeningSubTyping) edge (EffectWeakeningTerms) (EffectSubSubTyping) edge (EffectSubTerms);


    \draw [->] (EffectWeakeningTypes) edge (EffectWeakeningTerms) (EffectSubTypes) edge (EffectSubTerms);

    \draw [->] (EffectWeakeningTerms) edge (EffectWeakeningSubstitution) (EffectWeakeningSubTyping) edge (EffectWeakeningWeakening);

    \draw [->] (EffectWeakeningWeakening) edge (TermWeakening) (EffectWeakeningSubstitution) edge (TermSubstitution);

    \draw [->] (EffectSubTerms) edge [bend left=40] (TermSubstitution);
    \draw [->] 
        (BeckChevalley) edge [bend right=30] (EffectWeakeningTypes)
        (SClosure) edge [bend right=20] (EffectWeakeningTypes)
        (BeckChevalley) edge [bend left=20]  (EffectSubTypes)
        (SClosure) edge [bend left=30] (EffectSubTypes);
    

    \draw [->] (TermWeakening) edge (UniqueDenotations) (TermSubstitution) edge (UniqueDenotations) (TermWeakening) edge [bend right=20] (Soundness)
    (TermSubstitution) edge [bend left=20] (Soundness)
    (UniqueDenotations) edge (Soundness);
  \end{tikzpicture}
\caption{A road map of the proof dependencies. Assumptions in red, theorems in blue}
\end{figure}


\section{Denotations}
We are now equipped to define the denotations of structures in the language. Firstly, we shall define the denotation of the well-formed-ness relation on effects. As stated earlier, the denotation of an effect is a morphism $\deno{\typerelation{\P}{\e}{\effect}}$ in $\C$.

\[
    \deno{\typerelation{\P}{e}{\effect}} = \deno{\e} \after \term{I}: \rightarrow U
    \quad\quad
    \deno{\typerelation{\P,\a}{\a}{\effect}} = \pp: I\times U \rightarrow U
\]\[
    \deno{\typerelation{\P, \b}{\a}{\effect}} = \deno{\typerelation{\P}{\a}{\effect}}\after\p: I\times U\rightarrow U
\]\[
    \deno{\typerelation{\P}{\e_1\dot \e_2}{\effect}} = \Mul(\deno{\typerelation{\P}{\e_2}{\effect}},\deno{\typerelation{\P}{\e_1}{\effect}}): I \rightarrow U
\]

Using these denotations, we are now equipped to define the denotations of types. As stated above, types that are well formed in $\P$ are denoted by objects in the fibre category $\C(I)$ given by the denotation of $\P$.

Since the fibre category $\C(I)$ is S-Closed, it has objects for all ground types, a terminal object, graded monad $\T{}{}$, exponentials, products, and co-product over $\1+\1$.

\[
    \deno{\typerelation{\P}{\U}{\type}} = \1
    \quad\quad
    \deno{\typerelation{\P}{\B}{\type}} = \1+\1
    \quad\quad
    \deno{\typerelation{\P}{\g}{\type}} = \deno{\g}
\] 

\[
    \deno{\typerelation{\P}{\ab}{\type}} = (\deno{\typerelation{\P}{B}{\type}})^{(\deno{\typerelation{\P}{A}{\type}})}
\]

\[
    \deno{\typerelation{\P}{\mea}{\type}} =\T{\deno{\typerelation{\P}{\e}{\effect}}}{\deno{\typerelation{\P}{A}{\type}}}
    \quad\quad
    \deno{\typerelation{\P}{\all{\a}{A}}{\type}} =\allI(\deno{\typerelation{\P,\a}{A}{\type}})
\]


By using the terminal objects and products present in each fibre, we can now derive denotations of type-environments. $\deno{\oke{\P}{\G}}$ should be an object in the fibre induced by $\P$, $\C(I)$.

\[
    \deno{\wellformedok{\P}{\nil}} = \1
    \quad\quad
    \deno{\wellformedok{\P}{\gax}} = (\deno{\wellformedok{\P}{\G}} \times \deno{\typerelation{\P}{A}{\type}})
\]

Another construction that is important is the denotation of sub-typing. For each instance of the sub-typing relation in $\P$, $A\subtypep B$, there exists a denotation in the fibre induced by $\P$. $\deno{A\subtypep B} \in\C(I)(A, B)$. Since the fibres are S-closed, the ground-instances of the sub-typing relation exist in each fibre anyway.


\[
    \deno{\g_1\subtypep \g_2} = \deno{\g_1\subtypeg \g_2}
    \quad
    \deno{\ab \subtypep \fntype{A'}{B'}} = \deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}}
\]

\[
    \deno{\M{\e_1}{A}\subtypep\M{\e_2}{B}} = \deno{\e_1\subeffectp\e_2}\after\T{\e_1}{\deno{A\subtypep B}}
    \quad    
    \deno{\all{\a}{A}\subtypep\all{\a}{B}} = \allI{\deno{A\subtypepa B}}
\]

This finally gives us the ability to express the denotations of well-typed terms in an effect environment, $\P$ as morphisms in the fibre induced by $\P$, $\C(I)$.  Writing $\G_I$ and $A_I$ for $\deno{\wellformedok{\P}{\G}}$ and $\deno{\typerelation{\P}{A}{\type}}$, we can derive $\deno{\gpetyperelation{v}{A}}$ as a morphism in $\C(I)(\G_I, A_I)$.

Since each fibre is an S-category, for each ground constant, $\const{A}$, there exists $c: \1 \rightarrow A_I$ in $\C(I)$.

\todo{Make these more readable/fix spacing}
\[
    \treerule{Unit}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\u}{\U}} = \term{\G} : \G_I \rightarrow \1}
    \quad
    \treerule{Const}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\const{A}}{A}} = \deno{\const{A}} \after \term{\G} : \G \rightarrow \deno{A}}
\]

\[
    \treerule{True}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\t}{\B}} = \inl \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}
    \quad
    \treerule{False}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\f}{\B}} = \inr \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}
\]

\[
    \treerule{Var}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\gax}{x}{A}} = \pp: \G \times A \rightarrow A}
    \quad    
    \treerule{Weaken}{f = \deno{\gpetyperelation{x}{A}}: \G \rightarrow A}{\deno{\etyperelation{\P}{\gby}{x}{A}} = f \after \p: \G \times B \rightarrow A}
\]

\[
    \treerule{Lambda}{f = \deno{\etyperelation{\P}{\gax}{v}{B}} : \G \times A \rightarrow B}{\deno{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}} = \cur{f} : \G \rightarrow (B)^A}
\]

\[
    \treerule{Subtype}{f = \deno{\etyperelation{\P}{\G}{v}{A}} : \G \rightarrow A\s\s g = \deno{A \subtypep B}}{\deno{\etyperelation{\P}{\G}{v}{B}} = g \after f : \G \rightarrow B}
    \quad 
    \treerule{Return}{f = \deno{\etyperelation{\P}{\G}{v}{A}}}{\deno{\etyperelation{\P}{\G}{\return{v}}{\moa}} = \point{A} \after f}   
\]

\[
    \treerule{If}{f = \deno{\etyperelation{\P}{\G}{v}{\B}}: \G\rightarrow\1+\1 \s\s g = \deno{\etyperelation{\P}{\G}{v_1}{\mea}}\s\s h = \deno{\etyperelation{\P}{\G}{v_2}{\mea}}}{\deno{{\etyperelation{\P}{\G}{\ifthenelse{\e}{A}{v}{v_1}{v_2}}{\mea}}} = \app\after((\fld{\cur{g\after\pp}}{\cur{h\after\pp}}\after f)\times \idg)\after \diag{\G} : \G \rightarrow \tea}    
\]

\[
    \treerule{Bind}{f = \deno{\etyperelation{\P}{\G}{v_1}{\M{\e_1}{A}} : \G \rightarrow \T{\e_1}{A}\s\s g = \deno{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}}: \G \times A \rightarrow \T{\e_2}{B}}{\deno{\etyperelation{\P}{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}} = \bind{\e_1}{\e_2}{B} \after \T{\e_1}{g} \after \tstrength{\G}{A}{\e_1} \after \pr{\idg}{f}: \G \rightarrow \T{\e_1 \dot \e_2}{B}}  
\]

\[
    \treerule{Apply}{f = \deno{\gpetyperelation{v_1}{\ab}}: \G \rightarrow (B)^{A} \s\s g=\deno{\gpetyperelation{v_2}{A}}: \G \rightarrow A}{\deno{\gpetyperelation{\apply{v_1}{v_2}}{\b}}= \app\after\pr{f}{g}: \G \rightarrow B }
\]

\[
    \treerule{Effect-Lambda}{f = \deno{\etyperelation{\P,\a}{\G}{v}{A}}: \ciuw(\G, A)}{\deno{\gpetyperelation{\elam{\a}{A}}{\all{\e}{A}}} = \bar{f}: \C(I)(\G, \allI(A))}    
\] 

\[
    \treerule{Effect-App}{g=\deno{\gpetyperelation{v}{\all{\a}{A}}}: \C(I)(\G, \allI(A))\s\s h = \deno{\typerelation{\P}{\e}{\effect}}: \ciu}{\deno{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}} = \pr{\Id{I}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after g: \C(I)(\G, A\ssub{\a}{\e})}
\]


\section{Substitution and Weakening Theorems}

In this section, I introduce and prove a series of utility theorems, which will help us prove cases in future theorems. These weakening and substitution theorems are concerned with a change-in-environment of typing derivations and their associated denotations. If $\gpetyperelation{v}{A}$, then it should be the case that $\etyperelation{\P}{\gax}{v}{A}$. We also want to know what happens to the denotation when we change the type environment in this way. In this section, I introduce the tools for manipulating the type and effect environments in this way.

Substitutions and weakenings are two distinct ways of manipulating an effect or typing environment. Weakening acts as a kind of sub-typing of the environment. If we insert fresh variables into an environment, then any expression that was typeable under the previous environment should also be typeable under the the new environment. This change of environment should also have a predictable effect on the denotations of any expressions to which it is applied.

Substitution considers what happens when we simultaneously replace all variables in one expression, that is typeable under an environment, with expressions that are well formed under another environment. The resulting substituted expression should be typeable under the new environment, and the denotation of the new expression should be composed from the denotation of the old relation and the denotations of the expressions that replace the variables. 

As we go on, I shall define and state the denotations of specific substitutions and weakenings, upon both the effect environment and the typing environment.

In this dissertation, substitutions and weakenings come in two flavours: weakening and substitution of the effect-variable environment and weakening and substitution of the typing environment. For each of these there is a family of theorems defining the effects of the applying a substitution and weakening to the various language structures and their denotations, such as well-formed-ness and typing relations.


The first family of theorems is that of weakening and substitution of the effect environment. Weakenings are a relation between effect-environments $\wrel{\w}{\P'}{\P}$, that are defined as so:

\[
    \treerule{Id}{\ok{\P}}{\wrel{\i}{\P}{\P}}
    \quad
    \treerule{Project}{\wrel{\w}{\P'}{\P}}{\wrel{\w\pi}{(\P', \a)}{\P}}
    \quad
    \treerule{Extend}{\wrel{\w}{\P'}{\P}}{\wrel{\w\x}{(\P', \a)}{(\P, \a)}}
\]

With inductively defined denotations: 

\[
    \deno{\wrel{\i}{\P}{\P}} = \Id{I}: I \rightarrow I
    \quad
    \deno{\wrel{w\pi}{\P',\a}{\P}} = \deno{\wrelw{\P'}{\P}}\after \p: I'\times U\rightarrow I
\]

\[
    \deno{\wrel{w\x}{\P',\a}{\P,\a}} = (\deno{\wrelw{\P'}{\P}}\times \Id{U}): I'\times U\rightarrow I\times U    
\]

Substitutions are also an inductively defined relation between effect-environments, with inductively defined denotations. Substitutions may be represented as a snoc-list of variable-effect pairs.

\[
    \si \gens \nil \mid \si, \a \setto \e    
\]

The substitution relation between effect environments is defined as so:

\[
    \treerule{Nil}{\ok{\P'}}{\typerelation{\P'}{\nil}{\nil}}
    \quad\quad
    \treerule{Extend}{\typerelation{\P'}{\si}{\P}\s\s\wellformed{\P'}{\e}\s\s\a\notin\P}{\typerelation{\P'}{\si, \a \setto\e}{(\P, \a)}}
\]

The denotations of substitutions, $\deno{\typerelation{\P'}{\si}{\P}}: \cii$, are defined as so:

\[
    \deno{\typerelation{\P'}{\nil}{\nil}} = \term{I}: \C(I', \1)
    \quad\quad
    \deno{\typerelation{\P'}{(\si, \a\setto\e)}{\P,\a}} = \pr{\deno{\typerelation{\P'}{\si}{\P}}}{\deno{\typerelation{\P}{\e}{\effect}}}: \C(I', I\times U)
\]

We can also define the action of substitutions on effects.

\begin{align}
    \si(e) & = e \\
    \si(\e_1\dot\e_2) & = (\si(\e_1))\dot(\si(\e_2))\\
    \nil(\a) & = \a\\
    (\si, \b\setto \e)(\a) & = \si(\a) \\
    (\si, \a\setto \e)(\a) & =\e
\end{align}.
\begin{theorem}[Effect Substitution on Effects]
    The substitution theorem on effects is the proposition that if $\wellformed{\P}{\e}$ and $\typerelation{\P'}{\si}{\P}$ then $\wellformed{\P'}{\si(\e)}$ and, writing $\si$ for $\deno{\typerelation{\P'}{\si}{\P}}$,  $\deno{\wellformed{\P'}{\si(\e)}} = \deno{\wellformed{\P}{\si}}\after\si$. 
\end{theorem}


\begin{proof}
    The proof of this depends on the naturality of $\Mul$ and inversion to narrow down case splitting on the structure of the effect environments.

    \case{Ground}
    This case holds due to the terminal morphism being unique. Hence, pre-composing it with another morphism yields the terminal morphism.

    \begin{align}
        \deno{\typerelation{\P}{e}{\effect}}\after\si & = \deno{e}\after\term{I}\after\si \\
        & = \deno{e}\after\term{I'} \\
        & = \deno{\typerelation{\P'}{e}{\type}}\\
    \end{align}

\case{Var}

Since the structure of the substitution $\si$ depends on the structure of $\P$, we can perform inversion to infer the denotation of $\si$.

\begin{align}
    \deno{\typerelation{\P,\a}{\a}{\effect}}\after\si &= \pp\after\pr{\si'}{\deno{\typerelation{\P'}{\e}{\effect}}}\qt{By inversion $\si = (\si', \a\setto\e)$}\\
    & =\deno{\typerelation{\P'}{\e}{\effect}} \\
    &= \deno{\typerelation{\P'}{\si'(\a)}{\effect}}\\
\end{align}

\case{Multiply}

We make use of the naturality of $\Mul$ and induction upon the sub-terms.
\begin{align}
    \deno{\typerelation{\P}{\e_1\dot\e_2}{\type}} \after\si &=
    \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}})\after \si \\
    & = \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}\after \si, \deno{\typerelation{\P}{\e_2}{\effect}}\after \si)\qt{By Naturality}\\
    & = \Mul(\deno{\typerelation{\P'}{\si(\e_1)}{\effect}}, \deno{\typerelation{\P}{\si(\e_2)}{\effect}})\\
    & = \deno{\typerelation{\P'}{\si(\e_1)\dot\si(\e_2)}{\effect}}\\
    & = \deno{\typerelation{\P'}{\si(\e_1\dot\e_2)}{\effect}}\\
\end{align}

$$\square$$
\end{proof}


\begin{theorem}[Effect Weakening on Effects]
    The weakening theorem proceeds similarly. If $\wellformed{\P}{\e}$ and $\wrelw{\P'}{\P}$ then $\wellformed{\P'}{\w}$ and, writing $\w$ for $\deno{\wrelw{\P'}{\P}}$,  $\deno{\wellformed{\P'}{\e}} = \deno{\wellformed{\P}{\si}}\after\w$.

\end{theorem}

\begin{proof}
    This proof also depends on the naturality of $\Mul$ and case splitting on the structure of $\w$. It is harder to use inversion on the structure of $\w$, since the structure of $\w$ does not depend as strongly on the structure of $\P$. I present here the cases for variables.

    \case{Var}
    We do a case split on $\w$.
    \subcase{$\w = \i$}
    Then $\P' = \P$ and $\w = \Id{I}$. So the theorem holds trivially.
    \subcase{$\w = \w'\x$}
    Then by the definition of its denotation:    
    \begin{align}
        \deno{\typerelation{\P,\a}{\a}{\effect}}\after\w &= \pp\after(\w'\times \Id{U}) \\
        & = \pp\\
        & = \deno{\typerelation{\P',\a}{\a}{\effect}}
    \end{align}
    
    \subcase{$\w = \w'\pi$}
    Then \begin{equation}
        \deno{\typerelation{\P,\a}{\a}{\effect}} = \pp\after\w'\after\p
    \end{equation}
    
    Where $\P' = \P,\b$ and $\wrel{\w'}{\P''}{\P}$.
    
    So\begin{align}
        \pp\after\w' & = \deno{\typerelation{\P''}{\a}{\effect}}
        \\
        \pp\after\w'\after\p & =\deno{\typerelation{\P'',\b}{\a}{\effect}}\\
        &= \deno{\typerelation{\P'}{\a}{\effect}}
    \end{align}
    
    \case{Weaken}
    \begin{equation}
        \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w = \deno{\typerelation{\P}{\a}{\effect}}\after\p\after\w
    \end{equation}
    
    Similarly, we perform a case split on structure of $w$:
    
    \subcase{$\w=\i$}
    Then $\P' = \P,\b$ so $\w=\Id{I}$
    So $\deno{\typerelation{\P,\b}{\a}{\effect}}\after\w = \deno{\typerelation{\P'}{\a}{\effect}}$
    
    \subcase{$\w=\w'\p$}
    Then $\P' = (\P'',\g)$ and $\w=\w'\after\p$
    Where $\wrel{\w'}{\P''}{\P,\b}$.
    So
    \begin{align}
        \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w & = \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w'\after\p\\
        & = {\typerelation{\P''}{\a}{\effect}}\after\p\\
        & = {\typerelation{\P'',\g}{\a}{\effect}}\\
        & = {\typerelation{\P'}{\a}{\effect}}\\
    \end{align}
    
    \subcase{$\w=\w'\x$}
    Then $\P'=\P'',\b$ and $\wrel{\w'}{\P''}{\P}$
    
    So \begin{align}
        \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w &= \deno{\typerelation{\P}{\a}{\effect}}\after\p\after(\w'\times\Id{U})\\
        &=\deno{\typerelation{\P}{\a}{\effect}}\after\w'\after\p\\
        & = \deno{\typerelation{\P''}{\a}{\effect}}\after\p\\
        & = \deno{\typerelation{\P'}{\a}{\effect}}\\
    \end{align}

    $$\square$$
\end{proof}




We can then move on to state and prove the weakening and substitution theorems on types, sub-typing, and type environments. The general structure of these theorems, as well as the term-based theorems later, is that when we want to quantify the effect of a morphism $\theta: I' \rightarrow I$ between objects in the base category on structure in the fibres $\C(I)$, we should simply apply the associated re-indexing functor $\theta\star: \C(I) \rightarrow \C(I')$ to the structure. The proof of the soundness of this operation is driven by the S-closure of the re-indexing functor.

Specifically, effect substitutions have the following actions on types, and type-environments:

\begin{align*}
    \g\sub{\si} &= \g \\
    (\fntype{A}{B})\sub{\si} &= \fntype{(A\sub{\si})}{(B\sub{\si})} \\
    (\M{\e}{A})\ssi &= \M{\si(\e)}{(A\ssi)}\\
    (\all{\a}{A})\ssi &= \all{\a}{(A\ssi)}\qt{If $\a\#\si$}
\end{align*}

\begin{align*}
    \nil\ssi & = \nil \\
    (\gax)\ssi &= (\G\ssi, x:(A\ssi))\\
\end{align*}


\begin{theorem}[Effect Substitution on Types]
    The specific effect-substitution theorem on types is if $\wellformed{\P}{A}$ and $\typerelation{\P'}{\si}{\P}$, then $\wellformed{\P'}{A\ssi}$ and $\deno{\wellformed{\P'}{A\ssi}} = \si\star\deno{\wellformed{\P}{A}}$.
\end{theorem}

\begin{proof}
    By S-closure of $\si\star$ and the Beck-Chevalley Condition.

    \case{Monad}
    This case makes use of the S-closure of $\si\star$. Specifically the S-closure property upon the graded monad functor $\T{}{}$: $\si\star(\T{f}{A}) = \T{f\after\si}{(\si\star A)}$.


    \begin{align}
        \si\star\deno{\typerelation{\P}{\mea}{\type}} & =  \si\star(\T{\deno{\typerelation{\P}{\e}{\effect}}}{\deno{\typerelation{\P}{A}{\type}}})\\
        &= \T{\deno{\typerelation{\P}{\e}{\effect}}\after\si}{\si\star(\deno{\typerelation{\P}{A}{\type}})}\\
        & = \deno{\typerelation{\P'}{(\mea)\ssi}{\type}}
    \end{align}
    \case{Quantification}
    This case makes use of the Beck-Chevalley condition and the fact that $\deno{\typerelation{(\P', \a)}{(\si, \a\setto\a)}{(\P, \a)}} = \si\times\Id{U}$, which we can induct upon.
        \begin{align}
            \si\star\deno{\typerelation{\P}{\all{\a}A}{\type}} & = \si\star(\allI(\deno{\typerelation{\P,\a}{A}{\type}}))\\
            & = \allI((\si\times\Id{U})\star\deno{\typerelation{\P,\a}{A}{\type}})\qt{By Beck-Chevalley}\\
            & = \allI(\deno{\typerelation{\P',\a}{A\sub{\si, \a\setto\a}}{\type}})\qt{By induction}\\
            & = \allI(\deno{\typerelation{\P',\a}{A\ssi}{\type}})\\
            & = \deno{\typerelation{\P'}{\all{\a}{A\ssi}}{\type}}\\
            & = \deno{\typerelation{\P'}{(\all{\a}{A})\ssi}{\type}}\\
        \end{align}
        $$\square$$
\end{proof}

\begin{theorem}[Effect Substitution on Type Environments]
    Similarly, the effect-substitution theorem on type environments is that if $\wellformedok{\P}{\G}$, then $\wellformedok{\P'}{\G\ssi}$ and $\deno{\wellformedok{\P'}{\G\ssi}} = \si\star\deno{\wellformedok{\P}{\G}}$.
\end{theorem}

\begin{proof}
    By induction on the derivation on $\deno{\wellformedok{\P}{\G}}$ whilst making use of S-closure of the re-indexing functor.

    \case{Nil}
    We make use of the fact that S-closure means that the terminal object is preserved.
    \begin{align}
        \si\star\deno{\wellformedok{\P}{\nil}} &=\si\star\1\\
        & = \1\qt{By S-closure}\\
        &= \deno{\wellformedok{\P'}{\nil}}\\
        &= \deno{\wellformedok{\P'}{\nil\ssi}}\\
    \end{align}
    
    \case{Var}
    S-closure means that $\si\star(A \times B) = (\si\star A)\times (\si\star B)$.
    \begin{align}
       \si\star\deno{\wellformedok{\P}{\gax}} &= \si\star(\deno{\wellformedok{\P}{\G}} \times \deno{\typerelation{\P}{A}{\type}}) \\
       & = (\si\star\deno{\wellformedok{\P}{\G}} \times \si\star\deno{\typerelation{\P}{A}{\type}})\\
        & = (\deno{\wellformedok{\P'}{\G\ssi}} \times \deno{\typerelation{\P'}{A\ssi}{\type}})\\
        & = \deno{\wellformedok{\P'}{\G\ssi, x: A\ssi}}\\
        & = \deno{\wellformedok{\P'}{(\gax)\ssi}}\\
    \end{align}

    $$\square$$
\end{proof}


The effect-weakening theorem on types and type environments is also very similar.

\begin{theorem}[Effect Weakening on Types]
    If $\wrelw{\P'}{\P}$ then $\wellformed{\P}{A}$ implies $\wellformed{\P'}{A} \wedge \deno{\wellformed{\P'}{A}} = \w\star\deno{\wellformed{\P}{A}}$ and $\wellformedok{\P}{\G}$ then $\deno{\wellformedok{\P'}{\G}} = \w\star\deno{\wellformedok{\P}{\G}}$
\end{theorem}

\begin{proof}
   In a similar fashion, we make use of the Beck-Chevalley condition and the S-closure of $\si\star$.

    \case{Quantification}
        This case uses the Beck-Chevalley condition and the fact that $\deno{\wrel{\w\x}{(\P', \a)}{(\P,\a)}} = w\times \Id{U}$. This property is used in conjunction with induction to change the environment from $(\P, \a)$ to $(\P', \a)$.

        \begin{align}
            \w\star\deno{\typerelation{\P}{\all{\a}A}{\type}} & = \w\star(\allI(\deno{\typerelation{\P,\a}{A}{\type}}))\\
            & = \allI((\w\times\Id{U})\star\deno{\typerelation{\P,\a}{A}{\type}})\qt{By Beck-Chevalley}\\
            & = \allI(\deno{\typerelation{\P',\a}{A}{\type}})\qt{By induction}\\
            & = \allI(\deno{\typerelation{\P',\a}{A}{\type}})\\
            & = \deno{\typerelation{\P'}{\all{\a}{A}}{\type}}\\
        \end{align}
    
    \case{Function}
    This case makes use of the S-closure property that $\w\star$ preserves exponentials. Specifically $\w\star(B^A) = (\w\star B)^{(\w\star A)}$.
    \begin{align}
        \w\star\deno{\typerelation{\P}{\ab}{\type}} &= \w\star(\deno{\typerelation{\P}{B}{\type}}^{\deno{\typerelation{\P}{A}{\type}}})\\
        &=\w\star(\deno{\typerelation{\P}{B}{\type}})^{\w\star(\deno{\typerelation{\P}{A}{\type}})}\\
        & = \deno{\typerelation{\P'}{B}{\type}}^{\deno{\typerelation{\P'}{A}{\type}}}\\
        & = \deno{\typerelation{\P'}{\ab}{\type}}\\
    \end{align}

    
    The proof for type environments follows the same steps as effect-substitution proof.

    $$\square$$
\end{proof}


Next we consider the action of weakening and substitution on sub-typing relations. 

\begin{theorem}[Effect Substitution on Sub-typing]
    If $A \subtypep B$ and $\typerelation{\P'}{\si}{\P}$, then $A\ssi\subtypepp B\ssi$ and $\deno{A\ssi\subtypepp B\ssi} = \ssi\star\deno{A\subtypep B}$.
\end{theorem}

\begin{proof}
    By rule induction over the definition of the subtype relation, making use of S-closure and the effect-substitution theorem on types.


\case{Ground}
This case holds by the property of the S-closure of $\si\star$ that $\si\star$ preserves the ground-type sub-typing denotation.

\begin{align}
    \si\star(\g_1\subtypeg\g_2) &= (\g_1\subtypeg\g_2)
\end{align}



\case{Fn}

This case holds by several S-closure properties of $\si\star$. $\si\star$ preserves the exponential morphisms: $\si\star(\cur{f}) = \cur{\si\star(f)}$ and $\si\star(\app) = \app$. $\si\star$ should also preserve the product morphisms: $\si\star(\p) = \p$, $\si\star(\pp) = \pp$ and $\si\star\pr{f}{g} = \pr{\si\star f}{\si\star g}$. Hence $\si\star(f \times g) = (\si\star f \times \si\star g)$.

\begin{align}
    \si\star\deno{(\ab)\subtypep\fntype{A'}{B'}} &= \si\star(\deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}})\\
    &= \si\star(\cur{\deno{B\subtypep B'}\after\app})\after\si\star(\cur{\app\after(\Id{B}\times\deno{A'\subtypep A})})\\
    & = \cur{\si\star(\deno{B\subtypep B'})\after\app}\after\cur{\app\after(\Id{B}\times\si\star(\deno{A'\subtypep A}))}\\
    & = \cur{\deno{B\ssi\subtypepp B'\ssi}\after\app}\after\cur{\app\after(\Id{B\ssi}\times\deno{A'\ssi\subtypepp A\ssi})}\\
    &= \deno{\fntype{(A\ssi)}{(B\ssi)}\subtypepp\fntype{(A'\ssi)}{(B'\ssi)}}\\
    &= \deno{(\ab)\ssi\subtypepp(\fntype{A'}{B'})\ssi}
\end{align}


$$\square$$
\end{proof}


Similarly we can form the symmetrical weakening theorem.

\begin{theorem}[Effect Weakening on Subtyping]
    If $A \subtypep B$ and $\wrelw{\P'}{\P}$, then $A \subtypepp B$ and $\deno{A\subtypepp B} = \w\star\deno{A\subtypep B}$.
\end{theorem}



\begin{proof}
    The cases hold the same as in the corresponding substitution theorem.

    $$\square$$
\end{proof}



We are now a point to define and prove the effect weakening and substitution theorems on terms. Following the intuition above that changes of index object should be modelled by applying the re-indexing functor to the morphisms denoting the terms, we can construct the theorems. Firstly, we must define the operation of effect substitutions on terms.

\begin{align*}
    x\ssi & = x \\
    \const{A}\ssi & = \const{(A\ssi)} \\
    (\lam{x}{A}{v})\ssi &= \lam{x}{(A\ssi)}{(v\ssi)}\\
    (\pifthenelse{A}{v}{v_1}{v_2})\ssi &= \pifthenelse{(A\ssi)}{v\ssi}{v_1\ssi}{v_2\ssi}\\
    (\apply{v_1}{v_2})\ssi&= \apply{(v_1\ssi)}{v_2\ssi}\\
    (\doin{x}{v_1}{v_2})\ssi&= \doin{x}{(v_1\ssi)}{(v_2\ssi)}\\
    (\elam{\a}{v})\ssi & = \elam{\a}{(v\ssi)}\qt{If $\a\#\si$}\\
    (\eapp{v}{\e})\ssi & = \eapp{(v\ssi)}{\si(\e)}\\
\end{align*}

The substitution theorem is defined as so:

\begin{theorem}[Effect Substitution on Terms]
    If $\typerelation{\P'}{\si}{\P}$ and $\D$ derives $\gpetyperelation{v}{A}$ then there exists $\D'$ deriving $\etyperelation{\P'}{\G\ssi}{v\ssi}{A\ssi}$ and $\D' = \si\star(\D)$.
\end{theorem}


\begin{proof}
    This proof makes use of the previous effect-substitution theorems, and the adjunction of quantification and the re-indexing functor of projection.


\case{Effect-Lambda}

This case makes use of the naturality condition \todo{Needs to be introduced somewhere before + reference} and simple reductions.

If $\D$ derives $\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}$ then by inversion, there exists $\D_1$ deriving  $\etyperelation{\P,\a}{\G}{v}{A}$ such that:

\begin{equation}
    \D = \bar{\D_1}\\
\end{equation}

It is also the case that:

\begin{equation}
    \si\times\Id{} = \deno{\typerelation{(\P',\a)}{(\si, \a\setto\e)}{(\P,\a)}}
\end{equation}

So
\begin{align}
    \si\star\D &= \si\star(\bar{\D_1})\\
    & = \bar{(\si\times\Id{U})\star\D_1}\qt{By naturality}\\
    & = \bar{\D_1'}\qt{By induction}\\
    & = \D'
\end{align}

\case{Effect-Application}

This is a more complex case, as it makes use of several naturality properties and the adjunction $\pstar\dashv\allI$.

\todo{Missing the proof of existence of derivation}
\todo{Explain single substitutions}

By inversion, if $\D$ derives $\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}$ then there exists $\D_1$ deriving $\gpetyperelation{v}{\all{\a}{A}}$ and $h = \deno{\typerelation{\P}{\e}{\effect}}$ such that:

\begin{equation}
    \D = \pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1\\
\end{equation}

So, due to the substitution theorem on effects,
\begin{equation}
    h\after\si = \deno{\typerelation{\P}{\e}{\effect}}\after\si = \deno{\typerelation{\P'}{\si(\e)}{\effect}} = h'
\end{equation}

Hence, by applying the re-indexing functor to $\D$, we have:

\begin{align}
    \si\star{\D} & = \si\star(\pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)\\
    & = (\pr{\Id{\G}}{h}\after\si)\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\si\star(\D_1)\\
    & = ((\si\times\Id{U})\after\pr{\Id{\G}}{h\after\si})\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1')\\
    & = (\pr{\Id{\G}}{h'})\star((\si\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1')\\
\end{align}

Looking at the inner part of the functor application:
Let \begin{align}
    A & = \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}\\
\end{align}
\begin{align}
    (\si\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}} &= (\si\times\Id{U})\star\e_{A}\\
    & = (\si\times\Id{U})\star(\widehat{\Id{\allI(A)}})\\
    & = \widehat{\bar{(\si\times\Id{U})\star(\widehat{\Id{\allI(A)}})}}\qt{By bijection}\\
    & = \widehat{\si\star(\bar{\widehat{\Id{\allI(A)}}})}\qt{By naturality}\\
    & = \widehat{\si\star(\Id{\allI(A)})}\qt{By bijection}\\
    & = \widehat{\Id{\allII(A\after(\si\times\Id{U}))}}\qt{By S-Closure, naturality}\\
    & = \widehat{\Id{\allII(A\sub{\si,\a\setto\a})}}\qt{By Substitution theorem}\\
    & = \e_{A\ssi}
\end{align}

Going back to the original expression:

\begin{align}
    \si\star{\D} & = (\pr{\Id{\G}}{h'})\star(\e_{A\ssi})\after\D_1')\\
    & = \D'\\
\end{align}
$$\square$$
\end{proof}


Similarly, we can derive the weakening theorem on terms. 
\begin{theorem}[Effect Weakening on Terms]
    If $\wrelw{\P'}{\P}$ and $\D$ derives $\gpetyperelation{v}{A}$ then there exists $\D'$ deriving $\etyperelation{\P'}{\G}{v}{A}$ and $\D' = \w\star\D$.
\end{theorem}

\begin{proof}
    \todo{Prove typing}
    This theorem is proved in a similar fashion to the substitution theorem, and many of its cases are the same.


    \case{Subtype}
    If $\D$ derives $\gpetyperelation{v}{B}$ them by inversion, there exists $\D_1$ deriving $\gpetyperelation{v}{A}$, such that $ \D = \deno{A\subtypep B}\after \D_1$

    
    So, using the weakening of the sub-typing morphism, and induction, we can derive $\D'$.
    \begin{align}
        \w\star(\D) & = \w\star{\deno{A\subtypep B}}\after\w\star\D_1 \\
        & = \deno{A_{I'}\subtypepp B_{I'}}\after\D_1'\qt{By induction}\\
        & = D'
    \end{align}
    
    \case{Lambda}
    This case holds by induction and the S-closure of $\w\star$.

    If $\D$ derives $\gpetyperelation{\lam{x}{A}{v}}{\ab}$ then by inversion there exists $\D_1$ deriving $\etyperelation{\P}{\gax}{v}{B}$ such that:
    
    \begin{equation}
        \D = \cur{\D_1}\\
    \end{equation}
    
    Using induction and S-closure, we can derive $\D'$.
    \begin{align}
        \w\star(\D) & = \w\star(\cur{\D_1})\\
        & = \cur{\w\star(\D_1)}\qt{By S-closure}\\
        & = \cur{\D_1'}\qt{By induction}\\
        & = \D'
    \end{align}

    $$\square$$

\end{proof}




Now we are at a point to start considering weakenings and substitution of the typing environment. Type environment weakenings are inductively defined with respect to an effect environment.


\[
    \treerule{Id}{\wellformedok{\P}{\G}}{\pewrel{\i}{\G}{\G}}
    \quad  
    \treerule{Project}{\pewrel{\w}{\G'}{\G}\s\s x \notin \dom{\G'}}{\pewrel{\w \pi}{\G, x: A}{\G}}
    \quad
    \treerule{Extend}{\pewrel{\w}{\G'}{\G}\s\s x \notin \dom{\G'}\s\s A \subtype B}{\pewrel{w \x}{\G', x: A}{\G, x: B}}
\]

With denotations defined as morphisms in a fibre: $\deno{\pewrel{\w}{\G'}{\G}}: \G' \rightarrow \G \in \C(I)$.

\[
    \deno{\pewrel{\i}{\G}{\G}} = \idg: \G \rightarrow \G \in \C(I)
    \quad
    \deno{\pewrel{\w\pi}{\G', ax}{\G}} = \deno{\pewrel{\w}{\G'}{\G}}\after\p: \G'\times A \rightarrow \G
\]

\[
    \deno{\pewrel{\w\x}{\G', x: A}{\G, x: B}} = \deno{\pewrel{\w}{\G'}{\G}}\times \deno{A\subtypep B}: \G'\times A \rightarrow \G\times B
\]

Type-environment substitutions are also derived inductively with respect to a effect environment.


\[
    \treerule{Nil}{\wellformedok{\P}{\G'}}{\etyperelation{\P}{\G'}{\nil}{\nil}}
    \quad
    \treerule{Extend}{
        \etyperelation{\P}{\G'}{\si}{\G}
        \s\s
        x\notin\dom{\G}
        \s\s
        \etyperelation{\P}{\G'}{v}{A}
    }{
        \etyperelation{\P}{\G'}{(\si, x \setto v)}{(\gax)}
    }
\]

With denotations defined as morphisms in the appropriate fibre category: $\deno{\etyperelation{\P}{\G'}{\si}{\G}}: \G' \rightarrow \in \C(I)$

\[
    \deno{\etyperelation{\P}{\G'}{\nil}{\nil}} = \term{\G'}: \G' \rightarrow \1
    \quad
    \deno{\etyperelation{\P}{\G'}{(\si, x \setto v)}{\gax}} = \pr{\deno{\etyperelation{\P}{\G'}{\G}}}{\deno{\etyperelation{\P}{\G'}{v}{A}}}: \G' \rightarrow \G\times \1
\]

\todo{Explain weakening theorem on these}

In order to prove the quantification case of typing-environment weakening and substitution theorems on terms, as can be seen in section \todo{Reference}, it will be necessary to be able to weaken the effect environment on term-environment weakenings and substitutions

Let us first consider the action of effect weakenings on these morphisms. The weakening theorem on term-environment weakenings is as so:


\begin{theorem}[Effect Weakening on Term Weakening]
    If $\wrel{\w_1}{\P'}{\P}$ and $\pewrel{\w}{\G'}{\G}$ then $\ewrel{\P'}{\w}{\G'}{G}$ and $\deno{\ewrel{\P'}{\w}{\G'}{\G}} = \w_1\star\deno{\pewrel{\w}{\G'}{\G}}$.
\end{theorem}

\begin{proof}
    By induction on the derivation of $\w$. making use of weakening on types, type environments, and sub-typing.

    \case{Id}
    Then $\w = \i$, so its denotation is $\w = \Id{\G_I}$
    
    So
    \begin{equation}
      \w_1\star(\Id{\G_I}) = \Id{\G_{I'}} = \deno{\ewrel{\P'}{\i}{\G}{\G}}  
    \end{equation}
    
    \case{Project}
    Then $\w = \w'\pi$
    
    \begin{equation}
        \treerule{Project}{\ewrel{\P}{\w'}{\G'}{\G}}{\ewrel{\P}{\w\pi}{\G',x:A}{\G}}
    \end{equation}
    
    So $\w = \w'\after\p$
    
    Hence
    \begin{align}
        \w_1\star(\w) &= \w_1\star(\w')\after\w_1\star(\p)\\
        & = \deno{\ewrel{\P'}{\w'}{\G'}{\G}}\after\p\\
        & = \deno{\ewrel{\P'}{\w'\pi}{(\G',x:A)}{\G}}\\
        & = \deno{\ewrel{\P'}{\w}{(\G', x:A)}{\G}}
    \end{align}
    
    \case{Extend}
    Then $\w = \w'\x$
    
    \begin{equation}
        \treerule{Extend}{\ewrel{\P}{\w'}{\G'}{\G}\s\s A\subtypep B}{\ewrel{\P}{\w\x}{(\G',x:A)}{(\G, x:B)}}
    \end{equation}
    
    So $\w = \w'\times\deno{A\subtypep B}$
    
    Hence
    \begin{align}
        \w_1\star(\w) &=(\w_1\star(\w')\times\w_1\star(\deno{A\subtypep B})\\
        & = (\deno{\ewrel{\P'}{\w'}{\G'}{\G}}\times\deno{A\subtypepp B})\\
        & = \deno{\ewrel{\P'}{\w}{(\G',x:A)}{(\G,x:B)}}
    \end{align}

    $$\square$$
\end{proof}


Secondly, we can form the weakening theorem on term-environment substitutions.


\begin{theorem}[Effect Weakening on Term Substitution]
    If $\etyperelation{\P}{\G'}{\si}{\G}$ and $\wrelw{\P'}{\P}$ then $\etyperelation{\P'}{\G'}{\si}{\G}$ and $\deno{\etyperelation{\P'}{\G'}{\si}{\G}} = \w\star\deno{\etyperelation{\P}{\G'}{\si}{\G}}$
\end{theorem}

\begin{proof}
    By induction on the definition of $\si$, making use of the weakening on terms, types, and type environments.

    \case{Nil}
    Then $\si = \term{\G'_{I}}$, so $\w\star(\si) = \term{\G'_{I'}} = \deno{\etyperelation{\P'}{\G'}{\si}{\G}}$
    
    \case{Var}
    Then $\si = (\si',x\setto v)$
    
    \begin{align}
        \w\star\si & = \w*\pr{\si'}{\deno{\gpetyperelation{v}{A}}}\\
        & = \pr{\w\star\si'}{\w\star\deno{\gpetyperelation{v}{A}}}\\
        &=\pr{\deno{\etyperelation{\P'}{\G'}{\si'}{\G}}}{\deno{\etyperelation{\G'}{\P'}{v}{A}}}\\
        &=\deno{\etyperelation{\P'}{\G'}{\si}{\gax}}
    \end{align}

    $$\square$$

\end{proof}



Now we can move onto the term substitution and weakening theorems. These theorems are the final step before we prove that all denotations for a typing relation are equivalent and then move onto soundness. They demonstrate that the can model the action of applying well-formed type-environment changes by pre-composing the morphisms to be acted on () with a morphism modelling the change in environment.

The term-weakening theorem is as so: 

\begin{theorem}[Term Weakening]
    If $\pewrel{\w}{\G'}{\G}$ and $\D$ is a derivation of $\gpetyperelation{v}{A}$ then we can derive $\D'$, a derivation of $\etyperelation{\P}{\G'}{v}{A}$ with denotation $\D' = \D\after\w$.
\end{theorem}

\todo{Show cases that make use of the above therorems}

\begin{proof}
    By induction on the derivation of $\D$. Making use of the weakening of effect environments on term weakenings.

\case{Effect-Lambda}
This case makes use of the effect-weakening of term weakenings.

If $\D$ derives $\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}$, then by inversion, we have $\D_1$ such that

\begin{equation}
    \D = \treerule{Effect-Fn}{\treerule{}{\D_1}{\etyperelation{\P,\a}{\G}{v}{A}}}{\gpetyperelation{\elam{\a}{v}}{\all{\e}{A}}}
\end{equation}

By induction, we derive $\D_1'$ such that

\begin{equation}
    \D' = \treerule{Effect-Fn}{\treerule{}{\D_1'}{\etyperelation{\P,\a}{\G'}{v}{A}}}{\etyperelation{\P}{\G'}{(\elam{\a}{v})}{\all{\e}{A}}}
\end{equation}

Where 
\begin{align}
    \D_1' & = \D_1\after\deno{\ewrel{\P,\a}{\w}{\G'}{\G}}\\
    & = \D_1\after\deno{\wrel{\i\pi}{\P,a}{\P}}\star(\w)\\
    & = \D_1\after\pstar(\w)
\end{align}

Hence \begin{align}
    \D\after\w & = \bar{\D_1}\after\w\\
    & = \bar{\D_1\after\pstar(\w)}\\
    & = \bar{\D_1'}\\
    & = \D'
\end{align}


\case{Bind}
This case makes use of the properties of an S-category, specifically the tensor strength on the graded monad. By inversion, we have derivations $\D_1, \D_2$ such that:


\begin{equation}
    \D = \treerule{Bind}{
        \treerule{}{\D_1}{\etyperelation{\P}{\G}{v_1}{\M{\E_1}{A}}}
        \s\s
        \treerule{}{\D_2}{\etyperelation{\P}{\G,x: A}{v_2}{\M{\e_2}{B}}}
    }{
        \etyperelation{\P}{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
    }
\end{equation}

If $\ewrel{\P}{\w}{\G'}{\G}$ then $\ewrel{\P}{\w\x}{\G',x:A}{\gax}$, so by induction, we can derive $\D_1'$, $\D_2'$ such that:

\begin{equation}
    \D' = \treerule{Bind}{
        \treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v_1}{\M{\e_1}{A}}}
        \s\s
        \treerule{}{\D_2'}{\etyperelation{\P}{\G',x: A}{v_2}{\M{\e_2}{B}}}
    }{
        \etyperelation{\P}{\G'}{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
    }
\end{equation}

This preserves denotations:

\begin{align}
    \D' & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{\D_2'}\after\tstrength{\e_1}{\G'}{A}\after\pr{\Id{G'}}{\D_1'}\qt{By definition}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{(\D_2\after(\w\times\Id{A}))}\after\tstrength{\e_1}{\G'}{A}\after\pr{\Id{G'}}{\D_1\after\w}\qt{By induction on $\D_1', \D_2'$}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\w}{\D_1\after\w}\qt{By tensor strength}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{\D_1}\after\w\qt{By product property}\\
    & = \D \qt{By definition}
\end{align}

\case{Return}
    We have the sub-derivation $\D_1$ such that
    \begin{equation}
        \D = \treerule{Return}{\treerule{}{\D_1}{\gpetyperelation{v}{A}}}{\gpetyperelation{\return{v}}{\moa}}
    \end{equation}

    Hence, by induction, with $\ewrel{\P}{\w}{\G'}{\G}$, we find the derivation $\D_1'$ such that:
    \begin{equation}
        \D' = \treerule{Return}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v}{A}}}{\etyperelation{\P}{\G'}{\return{v}}{\moa}}
    \end{equation}

    This preserves denotations:

    \begin{align}
        \D' & = \point{A}\after\D_1' \qt{By definition}\\
            & = \point{A}\after\D_1\after\w\qt{By induction of $\D_1, \D_1'$}\\
            & = \D\after\w\qt{By Definition}
    \end{align}

    $$\square$$
\end{proof}



The term-substitution theorem is formed similarly: 

\begin{theorem}[Term Substitution]
    If $\etyperelation{\P}{\G'}{\si}{\G}$ and $\D$ is a derivation of $\gpetyperelation{v}{A}$, then we can construct $\D'$ deriving $\etyperelation{\P}{\G'}{v\ssi}{A}$ with denotation $\D' = \D \after \si$.
\end{theorem}


\begin{proof}
    \todo{More detail on these cases}
    This proof proceeds by induction on the derivation $\D$ similarly to the term weakening theorem and making use of weakening of term substitutions.



\case{Weaken}
By inversion, $\G = \G', y:B$ and $\si = \si', y\setto v$
and we have $\D_1$ deriving:

\begin{equation}
    \treerule{Weaken}{\treerule{}{\D_1}{\etyperelation{\P}{\G''}{x}{A}}}{\etyperelation{\P}{\G'',y: B}{x}{A}}
\end{equation}

Also by inversion of the well-formed-ness of $\etyperelation{\P}{\G'}{\si}{\G}$, we have $\etyperelation{\P}{\G'}{\si'}{\G''}$ and 

\begin{equation}
    \deno{\etyperelation{\P}{\G'}{\si}{\G}} = \pr{\deno{\etyperelation{\P}{\G'}{\si}{\G''}}}{\deno{\etyperelation{\P}{\G'}{v}{B}}}
\end{equation}

Hence by induction on $\D_1$ we have $\D_1'$ such that

\begin{equation}
    \treerule{}{\D_1'}{\etyperelation{\P}{\G'}{x\ssi}{A}}
\end{equation}



Hence
\begin{align}
    \D' & = \D_1' \qt{By definition}\\
        & = \D_1\after\si'\qt{By induction}\\
        & = \D_1\after\p\after\pr{\si'}{\deno{\etyperelation{\P}{\G'}{v}{B}}}\qt{By product property}\\
        & = \D_1\after\p\after\si\qt{By defintion of the denotation of $\si$}\\
        & = \D\after\si\qt{By defintion.}
\end{align}


\case{Lambda}

By inversion, we have $\D_1$ such that
\begin{equation}
    \D = \treerule{Fn}{
        \treerule{}{\D_1}{\etyperelation{\P}{\G, x:A}{v}{B}}
    }{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
\end{equation}

By induction of $\D_1$ we have $\D_1'$ such that
\begin{equation}
    \D' = \treerule{Fn}{
        \treerule{}{\D_1'}{\etyperelation{\P}{\G', x:A}{(v\ssi)}{B}}
    }{\etyperelation{\P}{\G}{(\lam{x}{A}{v})\ssi}{\ab}}
\end{equation}
By induction and the extension lemma, we have:
\begin{equation}
    \D_1' = \D_1\after(\si\times\Id{A})
\end{equation}

Hence:

\begin{align}
    \D' &= \cur{\D_1'}\qt{By definition}\\
        &= \cur{\D_1\after(\si\times\Id{A})}\qt{By induction and extension lemma.}\\
        & = \cur{\D_1}\after\si\qt{By the exponential property (Uniqueness)}\\
        &= \D\after\si\qt{By Definition}\\
\end{align}

\todo{Single subs + extension lemma}

$$\square$$
\end{proof}


\section{Uniqueness of Denotations}

Up until this point we have hat to be careful about the implicit typing derivation for every term denotation $\deno{\gpetyperelation{v}{A}}$. We are now equipped with the tools to prove that all derivations of the same typing relation instance $\gpetyperelation{v}{A}$ induce the same denotation. This allows us to no-longer worry about the equality of denotations, which will be helpful in the soundness proof.

To prove that all typing denotations have the same denotation, I first introduce the concept of a \textit{reduced} typing derivation that is unique to each term and type in each typing environment. Next, I present a function, $\reduce$, which recursively maps  typing derivations to their reduced equivalent. I also prove that this function preserves the denotation of the derivations. That is $\deno{\gpetyperelation{v}{A}} = \deno{\reduce(\gpetyperelation{v}{A})}$. Hence, we can conclude, since all derivations for a typing relation instance reduce to the same unique typing derivation, and that the reduction function preserves the denotations, that all derivations of a typing derivation have the same denotation.

The need for reduced typing derivations comes about because of sub-typing. The sub-typing rule can be inserted into different places in a derivation to derive the same typing relation. Hence, the reduction function focuses on only placing sub-typing rule instances in specific places. In particular, we only allow the sub-typing rule to occur at the root of the derivation or above instances of the if-rule and apply-rule in reduced derivations. This has the effect of only introducing sub-typing rule uses when it is necessary maintain syntactic-correctness of the derivation.

\begin{theorem}[Uniqueness of reduced Derivations]
    These reduced derivations are unique.    
\end{theorem}

\begin{proof}
    This proof proceeds by induction on the term structure, making use of the unique derivations of the sub-terms to show that a reduced derivation of the whole term must also be unique. There are no cases for sub-typing, as it is not a syntactic feature. As an aside, if sub-typing were a syntactic feature, such as explicit casts, then the rules for the typing relation would be entirely syntax directed, and hence we would not have the ambiguity that these theorems are required in order to solve.



    \case{Bind} This case makes use of the weakening theorem on typing-environments.

    Let 

    \begin{equation}
        \edeltacrule{\G}{v_1}{\e_1}{A}{\e_1'}{A'}
    \end{equation}

    \begin{equation}
        \edeltacruleprime{\G, x:A}{v_2}{\e_2}{B}{\e_2'}{B'}
    \end{equation}

    Be the respective unique reduced type derivations of the sub-terms. By weakening, $\ewrel{\P}{\i\x}{(\G, x:A)}{(\G, x: A')}$ so if there's a derivation of $\etyperelation{\P}{(\G, x:A')}{v_2}{B}$, there's also one of $\etyperelation{\P}{\gax}{v_2}{B}$.

    \begin{equation}
        \edeltacruleprimeprime{(\G, x:A')}{v_2}{\e_2}{B}{\e_2'}{B'}
    \end{equation}

    Since the effects monoid operation is monotone, if $\e_1\subeffectp\e_1'$ and $\e_2\subeffectp\e_2'$ then $\e_1\dot\e_2 \subeffectp \e_1'\dot\e_2'$

    Hence the reduced type derivation of $\gpetyperelation{\doin{x}{v_1}{v-2}}{\M{\e_1'\dot\e_2'}{B'}}$ is the following:

    \todo{Make this and the other smaller}
    \begin{equation}
        \treerule{Type} {
            \treerule{Bind}{
                \edeltacrule{\G}{v_1}{\e_1}{A}{\e_1'}{A'}
                \s\s
                \edeltacruleprimeprime{\G, x:A'}{v_2}{\e_2}{B}{\e_2'}{B'}
            } {
                \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
            }
            \s\s
            B\subtypep B'
            \s\s
            \e_1\dot\e_2\subeffectp\e_1'\dot\e_2'
        } {
            \gpetyperelation{\doin{x}{v_1}{v-2}}{\M{\e_1'\dot\e_2'}{B'}}
        }
    \end{equation}

    \case{Effect-Fn}

    The unique reduced derivation of $\gpetyperelation{\elam{\a}{A}}{\all{\a}{B}}$

    is 

    \begin{equation}
        \treerule{Sub-type}{
            \treerule{Effect-Fn}{
                \treerule{}{\D}{\etyperelation{\P,\a}{\G}{v}{A}}
            }{
                \gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}
            }
            \s\s
            \all{\a}{A}\subeffectp\all{\a}{B}
        }{
            \gpetyperelation{\elam{\a}{B}}{\all{\a}{B}}
        }
    \end{equation}

    Where
    \begin{eqnarray}
        \treerule{Sub-type}{
            \treerule{}{\D}{\etyperelation{\P,\a}{\G}{v}{A}}
            \s\s
            A\subtypepa B
        }{
            \etyperelation{\P,\a}{\G}{v}{B}
        }
    \end{eqnarray}

    Is the unique reduced derivation of $\etyperelation{\P,\a}{\G}{v}{B}$


    $$\square$$
\end{proof}


The $\reduce$ function maps each derivation to its reduced equivalent. It does this by pushing sub-typing rules from the leaves of the derivation tree down towards the root of the tree. The function case splits on the root of the tree and works up recursively. Some cases of the function are given in figure \ref{ReduceFunctionCases}. 

\todo{Diagram of a type-derivation tree being reduced}

\begin{figure}\label{ReduceFunctionCases}
    \begin{framed}
        \case{Apply}
    To find:
    \begin{equation}
        \reduce(\treerule{Apply}{
            \treerule{}{\D_1}{
                \gpetyperelation{v_1}{\ab}
            }
            \s\s
            \treerule{}{\D_2}{
                \gpetyperelation{v_2}{A}
            }
        }{
            \gpetyperelation{\apply{v_1}{v_2}}{B}
        })
    \end{equation}

    Let
    \begin{align}
        \treerule{Subtype}{
            \treerule{}{\D'_1}{\gpetyperelation{v_1}{\fntype{A'}{B'}}}
            \s\s
            \fntype{A'}{B'}\subtypep\fntype{A}{B}
        }{
            \gpetyperelation{v_1}{\ab}
        } & = \reduce(\D_1)\\
        \treerule{Subtype}{
            \treerule{}{\D'_2}{\gpetyperelation{v}{A'}}
            \s\s
            A'\subtypep A
        } {
            \gpetyperelation{v_1}{A}
        } & = \reduce(\D_2)
    \end{align}

    In
    \begin{equation}
        \treerule{Sub-type}{
            \treerule{Apply}{
                \treerule{}{
                    \D'_1
                }{
                    \gpetyperelation{v_1}{\fntype{A'}{B'}}
                }
            \s\s
                \treerule{Sub-type}{
                    \treerule{}{\D'_2}{\gpetyperelation{v_2}{A''}}
                    \s\s
                    A'' \subtypep A \subtypep A'
                } {
                    \gpetyperelation{v_2}{A'}
                }
            }{
                \gpetyperelation{\apply{v_1}{v_2}}{B'}
            }
            \s\s
            B' \subtypep B
        }{
            \gpetyperelation{\apply{v_1}{v_2}}{B}
        }
    \end{equation}


    \case{Bind}

    To find
    \begin{equation}
        \reduce(
            \treerule{Bind}{
                \treerule{}{
                    \D_1
                }{
                    \gpetyperelation{v_1}{\M{\e_1}{A}}
                }
                \s\s
                \treerule{}{
                    \D_2
                }{
                    \etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}
                }
            } {
                \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
            }
        )
    \end{equation}


    Let \begin{equation}
        \treerule{Sub-type}{
            \treerule{}{\D'_1}{\gpetyperelation{v_1}{\M{\e'_1}{A'}}}
        \s\s
        \subeffecttree{\e_1'}{A'}{\e_1}{A}
        }{
            \gpetyperelation{v_1}{\M{\e_1}{A}}
        } = \reduce(\D_1)
    \end{equation}

    Since $\ewrel{\P}{(i,\x)}{(\G, x: A')}{(\gax)}$ if $A' \subtypep A$, and by $\D_2 = \etyperelation{\P}{(\gax)}{v_2}{\M{\e_2}{B}}$, there also exists a derivation $\D_3$ of $\etyperelation{\P}{(\G, x: A')}{v_2}{\M{\e_2}{B}}$. $\D_3$ is derived from $\D_2$ simply by inserting a (Sub-type) rule below all instances of the (Var) rule.

    Let \begin{equation}
        \treerule{Sub-type}{
            \treerule{}{\D'_3}{\etyperelation{\P}{\G, x: A'}{v_2}{\M{\e'_2}{B'}}}
        \s\s
        \subeffecttree{\e_1'}{B'}{\e_2}{B}
        }{
            \etyperelation{\P}{\G, x: A'}{v_2}{\M{\e_2}{B}}
        } = \reduce(\D_3)
    \end{equation}
    

    Since the effects monoid operation is monotone, if $\e_1\subeffectp\e_1'$ and $\e_2\subeffectp\e_2'$ then $\e_1\dot\e_2 \subeffectp \e_1'\dot\e_2'$
    


    Then the result of reduction of the whole bind expression is:


    \begin{equation}
        \treerule{Sub-type}{
            \treerule{Bind}{
                \treerule{}{
                    \D'_1
                }{
                    \gpetyperelation{v_1}{\M{\e_1'}{A'}}
                }
                \s\s
                \treerule{}{
                    \D'_3
                }{
                    \etyperelation{\P}{\G, x: A'}{v_2}{\M{\e_2'}{B'}}
                }
            }{
            \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1'\dot\e_2'}{B}}
            }
            \s\s
            \subeffecttree{\e_1'\dot\e_2'}{B'}{\e_1\dot\e_2}{B}
        }{
            \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
        }
    \end{equation}
    \end{framed}

    \caption{Some cases of the reduce function}
\end{figure}

\begin{theorem}[Reduction preserves denotations]
   If the derivation $\D'$ is the result of applying  reduce to $\D$ then the denotations of the derivations are equal. That is $\D' = \reduce(\D) \implies \D' = \D$.
\end{theorem}


\begin{proof}
    We proceed by induction over the structure of $\D$, making use of the substitution and weakening theorems. We make use of the the definition of the $\reduce$ function as defined in figure \ref{ReduceFunctionCases}. We also use the definitions of $\D_1, \D_2 ...$ from the figue. \todo{May need to define $\D_1..$ locally.}
    
    \case{Apply}
    This case makes use of the fact that composing sub-typing morphisms gives the transitive sub-typing morphism.
        Let
        \begin{align}
            f & = \deno{A\subtypep A'}: A\rightarrow A' \\
            f' & = \deno{A''\subtypep A}: A'' \rightarrow A \\
            g & = \deno{B' \subtypep B}: B' \rightarrow B \\
        \end{align}

        Hence 
        \begin{align}
            \deno{\fntype{A'}{B'}\subtypep \ab} & = (g)^A \after (B')^f \\
            & = \cur{\app\after \app}\after\cur{\app\after(\Id{}\times f)}\\
            & = \cur {g\after\app\after(\Id{}\times f)}
        \end{align}

        Then 
        \begin{align}
            \D & = \app\after\pr{\D_1}{\D_2}\qt{By definition}\\
            & = \app\after\pr{\cur {g\after\app\after(\Id{}\times f)}\after\D'_1}{f'\after\D'_2}\qt{By reductions of $\D_1, \D_2$}\\
            & = \app\after(\cur {g\after\app\after(\Id{}\times f)}\times\Id{A})\after\pr{\D'_1}{f'\after\D'_2} \qt{Factoring out}\\
            & = g\after\app\after(\Id{}\times f)\after\pr{\D'_1}{f'\after\D'_2}\qt{By the exponential property}\\
            & = g\after\app\after\pr{\D'_1}{f\after f'\after \D'_2}\\
            & = \D'\qt{By defintion}
        \end{align}
        
    \case{Bind}

    This is a long case that makes use of the typing-environment weakening theorem on terms.

    Let \begin{align}
        f & = \deno{A' \subtypep A}: A' \rightarrow A\\
        g & = \deno{B' \subtypep B}: B' \rightarrow B\\
        h_1 & = \deno{\e_1' \subeffectp \e_1} : \T{\e_1'}{} \rightarrow \T{\e_1}{} \\
        h_2 & = \deno{\e_2'\subeffectp \e_2}:\T{\e_2'}{} \rightarrow \T{\e_2}{}\\
        h & = \deno{\e_1'\dot\e_2'\subeffectp\e_1\dot\e_2}: \T{\e_1'\dot\e_2'}{}\rightarrow \T{\e_1\dot\e_2}{}
    \end{align}

    Due to the denotation of the weakening used to derive $\D_3$ from $\D_2$, we have 
    \begin{equation}
        \D_3 = \D_2\after(\idg\times f)
    \end{equation}

    And due to the reduction of $\D_3$,
    we have 
    \begin{equation}
        \D_3 = h_{2, B} \after \T{\e_2'}{g}\after \D_3'
    \end{equation}

    So:

    \begin{align}
        \D &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{\D_1}\qt{By definition.}\\
        &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{h_{1, A}\after\T{\e_1'}{f}\after\D_1'}\qt{By reduction of $\D_1$.}\\
        &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after(\idg\times h_{1, A})\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Factor out $h_1$}\\
        &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after
        h_{1, (\G\times A)}\after
        \tstrength{\e_1'}{\G}{A}\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Tensor strength and sub-effecting $h_1$}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{\D_2}\after
        \tstrength{\e_1'}{\G}{A}\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Naturality of $h_1$}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{\D_2}\after
        \tstrength{\e_1'}{\G}{A}\after(\idg\times \T{\e_1'}{f})\after\pr{\idg}{\D_1'}\qt{Factor out pairing again}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{(\D_2\after(\idg\times f))}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{Tensorstrength}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{(\D_3)}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the definition of $\D_3$}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{(h_{2, B}\after\T{\e_2'}{g}\after \D_3')}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the reduction of $\D_3$}\\
        &= \bind{\e_1}{\e_2}{B}\after 
        h_{1, B}\after\T{\e_1'}{h_{2, B}}\after\T{\e_1'}{\T{\e_2'}{g}}\after \T{\e_1'}{\D_3'}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{Factor out the functor}\\
        &= h_B\after\bind{\e_1'}{\e_2'}{B}\after\T{\e_1'}{\T{\e_2'}{g}}\after \T{\e_1'}{\D_3'}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the $\mu$ and Sub-type rule }\\
        & = h_B\after\T{\e_1'\dot\e_2'}{g}\after\bind{\e_1'}{\e_2'}{B'}\after \T{\e_1'}{\D_3'}\after
        \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By naturality of $\bind{}{}{}$ }\\
        & = \D' \qt{By definition}
    \end{align}
    $$\square$$
\end{proof}

\begin{figure}[h!]
\begin{equation}
    \treerule{Lambda}{
        \treerule{Sub-Type}{
            \etyperelation{\P}{\gax}{v}{B}
            \s\s
            B \subtypep B'
        }{
            \etyperelation{\P}{\gax}{v}{B'}
        }
    }{\gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B'}}}
\end{equation}

\begin{equation}
    \treerule{Sub-Type}{    \treerule{Lambda}{
            \etyperelation{\P}{\gax}{v}{B}
    }{\gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B}}}
    \s\s \ab \subtype \fntype{A}{B'}}
    {\gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B'}}}
\end{equation}
    \caption{Two derivations of the same type-relation. The second derivation is reduced.}
\end{figure}

\section{Soundness}
We are now at a stage where we can state and prove the most important theorem for a denotational semantics: soundness with respect to $\beta\eta$-reductions. Soundness follows from the common sense requirement that terms that are equivalent in a given language should also have equivalent denotations. In our case, I introduce a $\beta\eta$-equivalence relation and then prove that equivalent terms have equal denotations.

The $\beta\eta$-equivalence relation is a rule based relation with three main flavours of rules. Firstly, as seen in figure \ref{BetaEtaReductions}, there are the $\beta\eta$-reductions which formalise how we expect the program to execute given an appropriate implementation. We give a $\beta\eta$-reduction for each term transition, such as the application of lambda terms or the execution of an if-expression. Secondly, there are congruences, seen in figure \ref{BetaEtaCongruence}, which formalise how the reduction of sub-expressions affects the rest of the expression in a compositional way. Finally, we extend this relation into an equivalence relation by closing it under transitivity, reflexivity and symmetry as seen in figure \ref{BetaEtaEquivalence}.


\begin{figure}[h!]\label{BetaEtaReductions}
    \[
        \treerule{Lambda-Beta}{\etyperelation{\P}{\gax}{v_2}{B}\s\s \gpetyperelation{v_1}{A}}{\gpeberelation{\apply{(\lam{x}{A}{v_1})}{v_2} }{ v_1\ssub{x}{v_2}}{B}}
        \quad
        \treerule{Lambda-Eta}{\gpetyperelation{v}{\ab}}{\gpeberelation{\lam{x}{A}{(\apply{v}{x}})}{v}{\ab}}
    \]

    \[
        \treerule{Left Unit}{\gpetyperelation{v_1}{A} \s\s \etyperelation{\P}{\gax}{v_2}{\meb}}{\gpeberelation{\doin{x}{\return{v_1}}{v_2}}{v_2\ssub{x}{v_1}}{\meb}}
        \quad
        \treerule{Right Unit}{\gpetyperelation{v}{\mea}}{\gpeberelation{\doin{x}{v}{\return{x}} }{v}{\mea}}
    \]

    \[
        \treerule{Associativity}{\gpetyperelation{v_1}{\M{\e_1}{A}} \s\s \etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}\s\s \etyperelation{\P}{\gby}{v_3}{\M{\e_3}{C}}}{
            \gpeberelation{\doin{x}{v_1}{(\doin{y}{v_2}{v_3})}}{\doin{y}{(\doin{x}{v_1}{v_2})}{v_3}}{\M{\e_1 \dot \e_2 \dot \e_3}{C}}
        }
    \]

    \[
        \treerule{Unit}{\gpetyperelation{v}{\U}}{\gpeberelation{v}{\u}{\U}}
    \]

    \[
        \treerule{if-true}{\gpetyperelation{v_1}{A}\s\s\gpetyperelation{v_2}{A}}{\gpeberelation{\pifthenelse{A}{\t}{v_1}{v_2}}{v_1}{A}}
        \quad
        \treerule{if-false}{\gpetyperelation{v_2}{A}\s\s\gpetyperelation{v_1}{A}}{\gpeberelation{\pifthenelse{A}{\f}{v_1}{v_2}}{v_2}{A}}    
    \]

    \[
        \treerule{If-Eta}{\etyperelation{\P}{\G, x: \B}{v_2}{A}\s\s\gpetyperelation{v_1}{\B}}{\gpeberelation{\pifthenelse{A}{v_1}{v_2\ssub{x}{\t}}{v_2\ssub{x}{\f}}}{v_2\ssub{x}{v_1}}{A}}
    \]

    \[
        \treerule{Effect-beta}{\wellformed{\P}{\e}\s\s\etyperelation{\P, \a}{\G}{v}{A}}{\gpeberelation{\eapp{(\elam{\a}{v}}{\e})}{v\ssub{\a}{\e}}{A\ssub{\a}{\e}}}
        \quad 
        \treerule{Effect-eta}{\etyperelation{\P}{\G}{v}{\all{\a}{A}}}{\gpeberelation{\elam{\a}{(\eapp{v}{\a})}}{v}{\all{\a}{A}}}
    \]
    \caption{The $\beta\eta$-reduction rules for PEC}
\end{figure}

\begin{figure}[h!]\label{BetaEtaCongruence}
    \[
        \treerule{Effect-Abs}{\eberelation{\P, \a}{\G}{v_1}{v_2}{A}}{\gpeberelation{\elam{\a}{v_1}}{\elam{\a}{v_2}}{\all{\a}{A}}}
        \quad
        \treerule{Effect-Apply}{\gpeberelation{v_1}{v_2}{\all{\a}{A}}\s\s\wellformed{\P}{\e}}{\gpeberelation{\eapp{v_1}{\e}}{\eapp{v_2}{\e}}{A\ssub{\a}{\e}}}
    \]

    \[
        \treerule{Lambda}{\eberelation{\P}{\gax}{v_1}{v_2}{B}}{\gpeberelation{\lam{x}{A}{v_1}}{\lam{x}{A}{v_2}}{\ab}}
        \quad
        \treerule{Return}{\gpeberelation{v_1}{v_2}{A}}{\gpeberelation{\return{v_1}}{\return{v_2}}{\moa}}
    \]

    \[
        \treerule{Apply}{\gpeberelation{v_1}{v_1'}{\ab}\s\s\gpeberelation{v_2}{v_2'}{A}}{\gpeberelation{\apply{v_1}{v_2}}{\apply{v_1'}{v_2'}}{B}}
        \quad   
        \treerule{Bind}{\gpeberelation{v_1}{v_1'}{\M{\e_1}{A}} \s\s \eberelation{\P}{\gax}{v_2}{v_2'}{\M{\e_2}{B}}}{\gpeberelation{\doin{x}{v_1}{v_2}}{\doin{c}{v_1'}{v_2'}}{\M{\e_1 \dot \e_2}{B}}} 
    \]

    \[
        \treerule{If}{\gpeberelation{v}{v'}{\B} \s\s \gpeberelation{v_1}{v_1'}{A}\s\s\gpeberelation{v_2}{v_2'}{A}}{\gpeberelation{\pifthenelse{A}{v}{v_1}{v_2}}{\pifthenelse{A}{v}{v_1'}{v_2'}}{A}}
        \quad    
        \treerule{Subtype}{\gpeberelation{v}{v'}{A} \s\s A \subtypep B}{\gpeberelation{v}{v'}{B}}
    \]
    \caption{The congruence rules for PEC}
\end{figure}

\begin{figure}\label{BetaEtaEquivalence}
    \[
        \treerule{Reflexive}{\gpetyperelation{v}{A}}{\gpeberelation{v}{v}{A}}
        \quad
        \treerule{Symmetric}{\gpeberelation{v_1}{v_2}{A}}{\gpeberelation{v_2}{v_1}{A}}
    \]

    \[
        \treerule{Transitive}{\gpeberelation{v_1}{v_2}{A}\s\s\gpeberelation{v_2}{v_3}{A}}{\gpeberelation{v_1}{v_3}{A}}
    \]
    \caption{Rules expanding the $\beta\eta$-reduction and congruence relation to an equivalence relation}
\end{figure}


Now we can state the $\beta\eta$-soundness theorem. 

\begin{theorem}[Soundness]
    If $\gpeberelation{v_1}{v_2}{A}$, then $\gpetyperelation{v_1}{A}$, $\gpetyperelation{v_2}{A}$, and $\deno{\gpetyperelation{v_1}{A}} = \deno{\gpetyperelation{v_2}{A}}$.
\end{theorem}


\begin{proof}
    The proof proceeds by induction on the definition of the $\beta\eta$-equivalence relation.

    This proof has a lot of cases and each of the $\beta\eta$-reductions makes use of many of the requirements we have placed on the indexed S-category.

    I have omitted the congruence cases here as they hold through simple application of the inductive hypothesis on sub-terms. Similarly, the equivalence relation cases hold simply because equality on morphisms is an equivalence relation by definition. I do however, give a selection of the $\beta\eta$-reduction cases to demonstrate the necessity of the S-category requirements.

\case{Right Unit}
This case makes use of the right-unit monad law.

Let $f = \deno{\gpetyperelation{v}{\mea}}$ 
    \begin{equation}
    \begin{split}
        \deno{\gpetyperelation{\doin{x}{v}{\return{x}}}{\mea}}  & = \bind{\e}{\1}{A} \after \T{\e}{(\point{A} \after \pp)} \after \tstrength{\e}{\G}{A}\after \pr{\idg}{f} \\
        & = \T{\e}{\pp} \after \tstrength{\e}{\G}{A} \after \pr {\idg}{f} \\
        & = \pp \after \pr{\idg}{f}\\
        & = f
    \end{split}
\end{equation}

\case{If-True}
This case makes use of the co-product diagram on $\1 + \1$.

Let
\begin{align}
    f = &\deno{\gpetyperelation{v_1}{A}}\\
    g = &\deno{\gpetyperelation{v_2}{A}}\\
\end{align}

Then
\begin{equation}
    \begin{split}
        \deno{\gpetyperelation{\pifthenelse{A}{v}{v_1}{v_2}}{A}} & = \ifMorph{\inl\after\term{\G}}{f}{g} \\
        & = \app\after((\cur{f\after\pp}\after\term{\G})\times\idg)\after\diag{\G}\\
        & = \app\after(\cur{f\after\pp}\times\idg)\after(\term{\G}\times\idg)\after\diag{\G}\\
        & = f\after\pp\after\pr{\term{\G}}{\idg}\\
        & = f \\
        & = \deno{\gpetyperelation{v_1}{A}}\\
    \end{split}
\end{equation}

\case{Effect-Beta}
This case makes use of the adjunction properties of $\allI, \pstar$.

let 
\begin{align}
    h & = \deno{\typerelation{\P}{\e}{\effect}}
    \\
    f & = \deno{\etyperelation{\P,\a}{\G}{v}{A}}
    \\
    A &= \deno{\typerelation{\P,\a}{A\ssub{\a}{\a}}{\type}}
\end{align}

Then

\begin{equation}
    \deno{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}} = \bar{f}\\
\end{equation}

So
\begin{align}
    \deno{\gpetyperelation{\eapp{(\elam{\a}{v})}{\e}}{\all{\a}{A}}} & = \pr{\Id{I}}{h}\star(\e_A)\after\bar{f}\\
    & = \pr{\Id{I}}{h}\star(\e_A)\after\pr{\Id{I}}{h}\star(\pstar(\bar{f}))\qt{Identity functor}\\
    &= \pr{\Id{I}}{h}\star(\e_A\after\pstar(\bar{f}))\\
    &= \pr{\Id{I}}{h}\star(f)\qt{By adjunction}\\
    &= \deno{\gpetyperelation{v\ssub{\a}{\e}}{A\ssub{\a}{e}}}\qt{By substitution theorem}\\
\end{align}


$$\square$$

\end{proof}


This completes the proof of soundness for this semantics.

\chapter{Instantiating a Model of PEC}
Now we have proved that we can form a model of PEC in an appropriate indexed S-category, it remains to show that it is feasible to construct such an indexed category. There exist $\set$-based models for the semantics of effect-ful languages with a graded monad, such as the Effect Calculus \todo{A reference for this}. More specifically, it is possible to treat $\set$ as an S-category. Hence, I use a $\set$ based S-category as a starting point. In this section, I  demonstrate how to construct an strictly indexed S-category which can model the PEC from such an S-category.

Let $\C$ be an S-category formed from $\set$.(\todo{Is this correct parlance?}) That is, $\C$ contains a graded monad $\Tz{}{}, \bindz{}{}{}, \pointz{}, \tstrengthz{}{}{}$, is cartesian closed, has a co-product on the terminal object $\1 = \left\{\star\right\}$, has sub-typing functions $\deno{A\subtypeg B}: A \rightarrow B$ for each instance of the ground sub-typing relation, and has natural transformations $\deno{\e_1 \subeffectz \e_2}: \Tz{\e_1}{} \rightarrow \Tz{\e_2}{}$. Since $\C$ is a model for the EC, it is graded by a pre-ordered monoid on ground effects: $(E, \subeffectz, \1, \dot)$. I have indexed each of these S-category properties with $0$ to indicate that they occur in the bottom category $\C$, induced by the empty effect environment.



Since, using $\alpha$-equivalence, we can see that all effect environments of the same length are equivalent, we can reduce an effect environment to the natural number $n$ indicating its length.

Next we must pick our fibre-categories for non-zero values of $n$. A simple instantiation is to pick each fibre $\C(n)$ to be the functor-category $[E^n, \C]$. That is, the category of functions returning an object in $\C$ given $n$ ground effects. Morphisms between objects are functions which, given a collection of ground effects, yield a morphism (function) in $C$. If $m\in [E^n, \C](A, B)$ then $m\ev\in\C(A\ev, B\ev)$. Shortly, I shall prove that these categories are indeed S-closed.

We also need to define the base category. This shall be $\Eff$, the discrete sub-category of $\set$, populated by the set of ground effects $E$ as the effect-object $U$, and its finite products.

\begin{align}
    E^0 & = \1 = \left\{\singleton\right\}\\
    E^{n+1} &= E^n \times E
\end{align}

Morphisms $E^n \rightarrow E$ are functions taking $n$ ground-effect parameters and returning a ground effect.


The fibres, $[E^n, C]$ are S-categories. This can be proved by constructing the S-category structures point-wise with respect to their parameter $\ev \in E^n$.

\todo{Fill in all the S-category constructions}

Now we need to define the required morphisms between fibres. Firstly, for any function $\theta: E^m \rightarrow E^n$ in $\Eff$, there should exist the re-indexing functor $\theta\star: [E^n, \C] \rightarrow [E^m, \C]$. A simple instantiation is the pre-composition functor.

\begin{align}
    A\in&\quad [E^n, \C]\\
    \theta\star(A) \emv =&\quad  A(\theta(\emv))\\
    f:&\quad A \rightarrow B\\
    \theta\star(f) \emv =&\quad f(\theta(\emv)): \theta\star(A) \rightarrow \theta\star(B)\\
\end{align}

This also obeys the composition law of re-indexing functors.

\begin{align}
    \theta\star(\phi\star A) \ev & = \phi\star(A)(\theta \ev)\\
    & = A(\phi(\theta\ev))\\
    & = A((\phi\after\theta) \ev)\\
    & = (\phi\after\theta)\star(A) \ev
\end{align}

\begin{theorem}
    The re-indexing functors are also S-closed. That is all the S-category features in $[E^n, \C]$ are preserved by $\theta\star$ in $[E^m, \C]$. For a full list of features please see appendix \todo{Reference}.
\end{theorem}


\begin{proof}
    , since all of the S-category features are proved point-wise.

    \case{Graded Monad Functor}
    \begin{align}
        (\theta\star\Tn{f}{A})\ev & = \Tn{f}{A}(\theta\ev) \\
        & = \Tz{(f(\theta\ev))}{(A(\theta\ev))}\\
        & = (\Tm{(f\after\theta)}{\theta\star A})\ev\\
    \end{align}

    \case{Terminal Object}
    
\begin{align}
    (\theta\star \1)\ev & = \1(\theta\ev)\\
    & = \1 \\
    & = \1 \ev\\
\end{align}

\begin{align}
    (\theta\star\term{A})\ev & = \term{A}(\theta\ev)\\
    & = \term{A(\theta\ev)}\\
    & = \term{\theta\star A}\ev
\end{align}

    $$\square$$
\end{proof}


Next, the re-indexing functor $\pstar$ should have a right-adjoint, $\allEn$. Here, we pick $\allEn$ to be defined as a finite product over the countable set of effects. This is possible, since types and effects are not impredicative (that is, they quantify over themselves)

\begin{align}
    \allEn:& [E^{n+1}, \C] \rightarrow [E^n, \C]\\
    \allEn(A)\env =&\Pi_{\e\in E}{A(\env, \e)}
    \\ 
    \allEn(f)\env =&\Pi_{\e\in E}{f(\env, \e)}
\end{align}

\todo{Need to express that the quantification functor need not be S-closed in the requirements}


We can now prove that $\pstar \dashv \allEn$. To do this, we need a natural bijection between morphisms in the functor categories $[E^n, \C]$ and $[E^{n+1}, \C]$.

\begin{equation}
    \bar{(-)}: [E^{n+1}, \C](\pstar A, B) \rightleftharpoons [E^n,\C] (A, \allEn B): \widehat{(-)}
\end{equation}

The left- and right-wards components of this bijection can be derived as follows. The leftwards component maps each morphism to a finite pairing of the morphism over each ground effect.

\begin{align}
    m:&\quad \pstar A \rightarrow B\\
    \bar{m}:&\quad A\rightarrow \allEn B\\
    \bar{m}(\env) =&\quad \finpr{m(\env, \e)}{e\in E}
\end{align}

The inverse is simply to project out the appropriate value of $\e$ from the product.

\begin{align}
    n:&\quad A \rightarrow \allEn B\\
    \widehat{n}:&\quad \pstar A\rightarrow B\\
    \widehat{n}(\env, \e_{n+1}) =&\quad\pi_\e\after g(\env)
\end{align}

These transformations give rise to the unit and co-unit of the adjunction:

With unit:

\begin{align}
    \unit{A}:&\quad A \rightarrow \allEn\pstar A\\
    \unit{A}(\env)=&\quad\finpr{\Id{A(\env,e)}}{\e\in E}
\end{align}


And co-unit


\begin{align}
    \counit{B} : &\quad \pstar\allEn B \rightarrow B\\
    \counit{B}(\env, \e) =&\quad \pi_\e : \Pi_{e\in E}B(\env, \e)\rightarrow \Pi_{e\in E}B(\env, \e)
\end{align}

The unit and co-unit allow us to prove that this construction is an adjunction. For any $g: \pstar A \rightarrow B$,

\begin{align}
    (\counit{B}\after\pstar(\bar{g}))(\env, \e_{n+1}) & = \pi_{\e_{n+1}}\after\finpr{g(\env, \e')}{\e'\in E}\\
    &= g(\env, \e_{n+1})
\end{align}


So $\counit{B}\after\pstar(\bar{g}) = g$.


Finally, we need to prove that the beck-chevalley condition holds
For $\theta: E^m \rightarrow E^n$.


\begin{theorem}
    [Beck-Chevalley condition, part I]
    Firstly, the functors $(\theta\star\after\allEn)$ and $(\allEm\after(\theta\times\Id{E})\star)$ are equal.

\end{theorem}

\begin{proof}
    
\begin{align}
    ((\theta\star\after\allEn)A)\env &= \theta\star(\allEn A)\env\\
    &= (\allEn A)(\theta(\env))\\
    &= \Pi_{\e\in E}(A(\theta(\env), \e))\\
    &= \Pi_{\e\in E}(((\theta\times \Id{U})\star A)(\env, \e))\\
    &= \allEm((\theta\times\Id{E})\star A)\env\\
    &= ((\allEm\after(\theta\times\Id{E})\star)A)\env
\end{align}

$$\square$$
\end{proof}


\begin{theorem}[Beck-Chevalley Condition, Part II]
    Secondly, the natural transformation $\bar{(\theta\times\Id{U})\star \counit{}}$ is equal to the identity natural transformation.

\end{theorem}

\begin{proof}
\begin{align}
    \bar{(\theta\times\Id{U})\star \counit{A}} \ev  & = \finpr{(\theta\times\Id{U})\star\counit{A}(\ev, \e)}{\e\in E}\\
    & = \finpr{\counit{A}(\theta\ev, \e)}{e\in E}\\
    & = \finpr{\pi_\e}{\e\in E}: \Pi_{\e\in E}A(\theta\ev, \e) \rightarrow \Pi_{\e\in E}A(\theta\ev, \e)\\
    & = \Id{\Pi_{\e\in E}A(\theta\ev, \e)}\\
    & = \Id{\allII\after(\theta\times\Id{U})\star A}\ev\\
    & = \Id{\theta\star\after\allI}
\end{align}

$$\square$$
\end{proof}

Hence we have proof that our construction is indeed a valid indexed S-category. Importantly, this shows that reasonable models of the PEC are possible to instantiate and that our requirements do not over-constrain potential models to the point that they are not viable for doing actual analysis.




\end{document}
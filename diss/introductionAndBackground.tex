\documentclass{Report}
\usepackage{framed}

\input{../proofs/header.tex}

\begin{document}
\abstract


    
To date, there has been limited work on the semantics of languages with polymorphic effect systems. The application, by Moggi, of strong monads to modelling the semantics of effects has become a mainstream concept in functional programming languages. This was improved upon by Lucasson (?) using a graded monad to model languages with a range of independent and dependent effects at an operational level. A categorical semantics for parametric polymorphism in types was first published by Reynolds (?) allowing a denotational analysis of languages including type parameters. There has been some work on polymorphism over the exception effect (which paper). Despite these works, there has been no work to date on the denotational semantics of languages with general parametric polymorphism over effects.

In this dissertation, I present several pieces of work. Firstly, I shall introduce a modern definition of a lambda-calculus based language with an explicit graded monad to handle a variety of effects. This calculus shall then be extended using polymorphic terms to yield a more general polymorphic-effect-calculus. I shall then give an indexed-category-based denotational semantics for the language, along with an outline of a proof for the soundness of these semantics. Following this, I shall present a method of transforming a model of a non-polymorphic language into a model of the language with polymorphism over effects.

The full proofs can be found online on my github repository (link), since due to the number of theorems and cases, the total size is well over 100 pages of definitions, theorems, and proofs.

\chapter{Introduction}
\section{What is Effect Polymorphism?}
Effect polymorphism is when the same function in a language can operate on values of similar types but with different effects. It allows the same piece of code to be used in multiple contexts with different type signatures. This manifests in a similar manner to type parameter polymorphism in system-F based languages. Consider the following Scala-style pseudo-code:

\begin{framed}
    \begin{framed}
        \begin{verbatim}
def check[E: Effect](
    action: Unit => (Unit;e)
): Unit; (IO, e) {
    val ok: Boolean = promptBool(
        "Are you sure you want to do this?"
    )
    If (ok) {
        action()
    } else {
       abort()
    }
}  
            \end{verbatim}
    \end{framed}

    \begin{framed}
        \begin{verbatim}
check[RealWorld](() => check[RealWorld](FireMissiles))
check[Transaction](SendMoney(Bob, 100, USD))
check[Exception](ThrowException("Not Aborted"))
        \end{verbatim}
    \end{framed}
\end{framed}

In this example, we are reusing the same “check” function in three different cases with three different effects in a type safe manner. Hence, “check” is polymorphic in the effect parameter it receives. To analyse this language, it would be useful to have an analysis tool that can precisely model these separate, though potentially interdependent effects. A denotational semantics that can account for the parametric polymorphism over effects would be a step towards building such tools.

\section{An Introduction to Categorical Semantics}
In this dissertation, I shall be describing a denotational semantics using category theory. A denotational semantics for a language is a mapping, known as a denotation, $\deno{-}$, of structures in the language, such as types and terms to mathematical objects in such a way that non-trivial properties of the terms in the language correspond to other properties of the denotations of the terms.

When we specify a denotational semantics of a language in category theory, we look to find a mapping of types and typing environments to objects in a given category.

\begin{align}
    A: \type & \mapsto \deno{A} \in \obj \C \\
    \G & \mapsto  \deno{\G} \in \obj \C
\end{align}



Further more, instances of the type relation should be mapped to morphisms between the relevant objects.

\begin{align}
    \gtyperelation{v}{A} & \mapsto \C(\deno{\G}, \deno{A}) 
\end{align}

This should occur in a sound manner. That is, for every instance of the $\beta\eta$-equivalence relation between two terms, the denotations of the terms should be equal in the category.

\begin{align}
    \gberelation{v_1}{v_2}{A} & \implies \deno{\gtyperelation{v_1}{A}} = \deno{\gtyperelation{v_2}{A}}
\end{align}

An example of $\beta\eta$-equivalence is that of the $\beta$-reduction of lambda terms. It should be the case that:

\begin{align}
    \treerule{Lambda-Beta}{\typerelation{\gax}{v_1}{B}\s\s\gtyperelation{v_2}{A}}{\gberelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{v_1\ssub{x}{v_2}}{B}}
\end{align}

Means that the denotations $\deno{\gtyperelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{B}}$ and $\deno{\gtyperelation{v_1\ssub{x}{v_2}}{B}}$ are equal.

To prove soundness, we perform rule induction over the derivation of the $\beta\eta$-equivalence relation, such as the lambda-beta-reduction rule above. 

Some of the inductive cases require us to quantify what the substitution of terms for variables, such as $\ssub{x}{v_1}$ does to the denotations of the parent term. Substitution theorems, allow us to quantify this action on denotations in a category theoretic way. 

If \begin{equation}
    \typerelation{\gax}{v_1}{B}
\end{equation}

And \begin{equation}
    \typerelation{\G}{v_2}{A}
\end{equation}

Then \begin{equation}
    \deno{\typerelation{\G}{v_1\ssub{x}{v_2}}{B}}
\end{equation}

Should be derivable from

\begin{equation}
    \deno{\typerelation{\gax}{v_1}{B}}
\end{equation}

And  \begin{equation}
    \deno{\gtyperelation{v_2}{A}}
\end{equation}

A similar concept is that of environment weakening. $\gax$ can derive every typing relation that $\G$ can, if $x$ is not already in the environment $\G$. Hence, $\gax$ is an example of a typing environment that is \textit{weaker} than $\G$. A weakening theorem proves that there is a systematic way to generate the denotation of a typing-relation on a term in a weaker environment from the denotation of the same term in a stronger environment.

If \begin{equation}
    \G' \leq_{\text{weaker}} \G
\end{equation}

Then

\begin{equation}
    \deno{\typerelation{\G'}{v}{A}}
\end{equation}

should be derivable from

\begin{equation}
    \deno{\typerelation{\G}{v}{A}}
\end{equation}

\subsection{Languages and Their Requirements}
Different languages require different structures to be present in a category for the category to be able to interpret terms in the language. Using the concepts defined in \ref{CategoryTheoryRequirements}, I shall now give an introduction to which category-theoretic structures are required to interpret different language features. 

One of the simplest, while still interesting, languages to derive a denotational semantics for is the simply typed lambda calculus (STLC). STLC's semantics require a cartesian closed category (CCC, see section \ref{CCC}).

Products in the CCC are used to denote the lists of variable types in the typing environment, exponential objects model functions, and the terminal object is used to derive representations of ground terms, such as the unit term, $()$, as well as the empty typing environment.


\begin{itemize}
    \item Products are used to construct type environments. $\deno{\G} = \deno{\nil, x: A, y:B, ... z:C} = \1 \times \deno{A} \times \deno{B} \times ... \times \deno{C}$
    \item Terminal objects are used in the denotation of constant terms $\deno{\gtyperelation{\const{A}}{A}} = \deno{\const{A}}\after\term{\deno{\G}}$
    \item Exponentials are used in the denotations of functions. $\deno{\typerelation{\G}{\lam{x}{A}{v}}{\ab}} = \cur{\deno{\typerelation{\gax}{v}{B}}}$
\end{itemize}

From this, we can specify what structures categories need to have in order to model more complex languages.
\begin{center}
    \begin{tabular}{|c|c|}
        \hline
        Language Feature & Structure Required \\
        \hline
        \hline
        STLC            & CCC \\
        \hline
        If expressions and booleans   & Co-product on the terminal object \\
        \hline
        Single Effect   & Strong Monad \\
        \hline
        Multiple Effects & Strong Graded Monad \\
        \hline
        Polymorphism & Indexed Category \\
        \hline
    \end{tabular}
\end{center}


A single effect can be modelled by adding a strong monad to the category, as shown by Moggi \todo{Reference}. The monad allows us to generate a unit effect and to compose multiple instances of the effect together in a way that intuitively matches the type system of a monadic language.

\begin{eqnarray}\label{MonadTypeRules}
    \treerule{Return}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\M{}{A}}} & \treerule{Bind}{\typerelation{\G}{v_1}{\M{}{A}} \s\s \typerelation{\gax}{v_2}{\M{}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{}{B}}}
\end{eqnarray}

These type rules can be modelled using the "unit" natural transformation and a combination of the "join" and tensor strength natural transformations respectively. 

For a more precise analysis of languages with multiple effects, we can look into the algebra on the effects. A simple example of such an algebra is a partially ordered monoid. The monoid operation defines how to compose effects, and the partial order gives a sub-typing relation to make programming more intuitive with respect to if statements. A category with a strong graded monad allows us to model this algebra in a category theoretic way. It also allows us to do some effect analysis in the type system, as seen in the type rules for return and bind in equation \ref{GradedMonadTypeRules}.

\begin{eqnarray}\label{GradedMonadTypeRules}
    \treerule{Return}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\moa}} & \treerule{Bind}{\typerelation{\G}{v_1}{\M{\e_1}{A}} \s\s \typerelation{\gax}{v_2}{\M{\e_2}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
\end{eqnarray}


To express polymorphism over a property $P$, the language's semantics are expanded to use a new environment specifying the variables ranging over $P$ that are allowed in a given context. This can be seen in the augmented type rules in \ref{PolymorphismTypeRules}.

\begin{eqnarray}\label{PolymorphismTypeRules}
    \treerule{Gen}{\etyperelation{\P, \a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}& \treerule{Spec}{\gpetyperelation{v}{\all{\a}{A}}\s\s\wellformed{\P}{\e}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\end{eqnarray}

To model these augmented type rules, we can create a category representing the semantics of the non-polymorphic language at each given context. This collection of non-polymorphic categories can be indexed by a base category which models the operations and relationships between the $P$-Environment. Morphisms in the base category between environments correspond to functors between the semantic categories for the relevant environments. These functors can then be used to construct the semantics of polymorphic terms. \todo{Index diagram}

In this dissertation, I shall show how these category theoretic building blocks can be put together to give the class of categories that can model polymorphic effect systems.


\chapter{Required Category Theory}\label{CategoryTheoryRequirements}

Before going further, it is necessary to assert a common level of category theory knowledge. This section is not intended as a tutorial but as a to jog the memory of the reader, and briefly introduce some new concepts.

\section{Cartesian Closed Category}\label{CCC}

Recall that a category is cartesian closed if it has a terminal object, products for all pairs of objects, and exponentials.

\subsection{Terminal Object}
An object, $\1$, is terminal in a category, $\C$ if for all objects $X\in\obj\C$, there exists exactly one morphism $\term{X}: X \rightarrow \1$.

\subsection{Products}
There is a product for a pair of objects $X, Y\in\obj\C$ if there exists an object and morphisms in C:
\begin{tikzcd}
    X & \arrow{l}[swap]{\p} (X\times Y) \arrow [r, "\pp"] & Y
\end{tikzcd}

Such that for any other object and morphisms,

\begin{tikzcd}
    X & \arrow{l}[swap]{f} Z \arrow [r, "g"] & Y
\end{tikzcd}

There exists a unique morphism $\pr{f}{g}: Z \rightarrow (X\times Y)$ such that the following commutes:

\begin{tikzcd}
    & \arrow{dl}[swap]{f} Z  \arrow[d, "\pr{f}{g}"] \arrow [dr, "g"] & \\
    X & \arrow [l, "\p"] (X\times Y) \arrow{r}[swap]{\pp} & Y\\
\end{tikzcd}

\subsection{Exponentials}
A category has exponentials if for all objects $A, B$, it has an object $B^A$ and a morphism $\app: \B^A \times A \rightarrow B$ and for each $f: (A\times B)\rightarrow C$ in $\C$ there exists a unique morphism $\cur{f}: A \rightarrow C^B$ such that the following diagram commutes.

\begin{tikzcd}
    C^B \times B \arrow{r}{\app}& C\\
    A\times B\arrow{u}{\cur{f}\times \Id{B}} \arrow{ur}{f}    
\end{tikzcd}

\section{Initial Object}

An initial object, $I$ of $\C$ is one such that for every other object $X\in\obj\C$, there exists a unique morphism $\i_X: I\rightarrow X$. It is the conceptual dual of a terminal objects.

\section{Co-Product}
A co-product is the conceptual dual of a product.

There is a co-product for a pair of objects $X, Y\in\obj\C$ if there exists an object and morphisms in C:
\begin{tikzcd}
    X  \arrow{r}[swap]{\inl} & (X + Y) & \arrow [l, "inr"]  Y
\end{tikzcd}

Such that for any other object and morphisms,

\begin{tikzcd}
    X \arrow{r}[swap]{f} & Z & \arrow [l, "g"]  Y
\end{tikzcd}

There exists a unique morphism $[f, g]: X + Y \rightarrow Z $ such that the following commutes:


\begin{tikzcd}
    &  Z   & \\
    X \arrow{ur}{f} \arrow [r, "\inl"] &  \arrow{u}{[f, g]} (X + Y)  & \arrow{l}[swap]{\inr} \arrow{ul}[swap]{g} Y\\
\end{tikzcd}



\section{Functors}
A functor $F: \C \rightarrow \DC$ is a mapping of objects:
\begin{align}
    A\in\obj\C \mapsto FA \in \obj\DC
\end{align}

And morphisms:

\begin{align}
    f: \C(A, B) \mapsto F(f): \DC(FA, FB)
\end{align}

that preserves the category properties of composition and identity.

\begin{align}
    F(\Id{A}) & = \Id{FA} \\
    F(g\after f) & = F(g)\after F(f)
\end{align}

\section{Natural Transformations}

A natural transformation $\theta$ between to functors $F, G: \C \rightarrow \DC$ is a collection of morphisms, indexed by objects in $\C$ with  $\theta_A: F(A) \rightarrow G(A)$ such that following diagram commutes for each $f: A \rightarrow B \in \C$

\begin{tikzcd}
    F(A) \arrow{r}{\theta_A} \arrow{d}{F(f)}  & G(A) \arrow{d}{G(f)}\\
    F(B) \arrow{r}{\theta_B}& G(B)\\ 
\end{tikzcd}

\section{Monad}

A monad is famously "a monoid on the category of endofunctors". In less opaque terms, a monad is:

\begin{itemize}
    \item A functor from $\C$ onto itself. (An endofunctor) $T: \C \rightarrow C$
    \item A "unit" natural transformation $\point{A}: A\rightarrow T(A)$
    \item A "join" natural transformation $\mu_{A}: T(T(A)) \rightarrow T(A)$
\end{itemize}

Such that the following diagrams commute:

\subsection{Associativity}
\begin{tikzcd}
    T(T(T(A)) \arrow{r}{\mu_{T(A)}} \arrow{d}{T(\mu_{A})} & T(T(A)) \arrow{d}{\mu_A} \\
    T(T(A)) \arrow{r}{\mu_A} & T(A)    
\end{tikzcd}


\subsection{Left and Right Unit}
\begin{tikzcd}
    T(A) \arrow{r}{\point{T(A)}} \arrow{d}{T(\point{A})} \arrow[equal]{rd} & T(T(A)) \arrow{d}{\mu_A}\\
    T(T(A)) \arrow{r}{\mu_A} & T(A)
\end{tikzcd}



\section{Graded Monad}
A graded monad is a generalisation of a monad to be indexed by a monoidal algebra $E$. It is made up of:

\begin{itemize}
    \item An endo-functor indexed by a monoid: $\T{}{}: (\E, \dot\, \1)  \rightarrow [\C, \C]$
    \item A unit natural transformation: $\point{}: \Id{} \rightarrow \T{\1}{}$
    \item A join natural transformation: $\bind{\e_1}{\e_2}{}: \T{\e_1}{\T{\e_2}{}} \rightarrow \T{\e_1 \dot \e_2}{}$
\end{itemize}

Such that the following diagrams commute.:
\subsection{Left and Right  Units}
    \begin{tikzcd}[ampersand replacement=\&]
        \tea
         \arrow[equal]{rd} 
         \arrow[r, "\T{\e}{\point{A}}"]
         \arrow{d}{\point{\tea}}
        \& 
        \T{\e}{\T{\1}{A}} 
            \arrow[d, "\bind{\e}{\1}{A}"] \\
            \T{\1}{\T{\e}{A}}
                 \arrow{r}{\bind{\1}{\e}{A}}
        \& 
        \tea
    \end{tikzcd}

\subsection{Associativity}
\begin{tikzcd}[ampersand replacement=\&]
    \T{\e_1}{\T{\e_2}{\T{\e_3}{A}}} 
    \arrow [r, "\bind{\e_1}{\e_2}{\T{\e_3}{A}}"]
    \arrow [d, "\T{\e_1}{\bind{\e_2}{\e_3}{A}}"] \& \T{\e_1 \dot \e_2}{\T{\e_3} A} \arrow [d, "\bind{\e_1 \dot \e_2}{\e_3}{A}"] \\
    \T{\e_1}{\T{\e_2 \dot \e_3}{A}} \arrow [r, "\bind{\e_1}{\e_2 \dot \e_3}{A}"] \& \T{\e_1 \dot \e_2 \dot \e_3}{A}    
\end{tikzcd}


\section{Tensor Strength}
Tensorial strength over a graded monad gives us the tools necessary to manipulate monadic operations in an intuitive way. A monad with tensor strength is referred to as "strong". Tensorial strength consists of a natural transformation:

\begin{align}
    \tstrength{\e}{A}{B}: A \times \teb \rightarrow \T{\e}{(A \times B)}
\end{align}

Such that the following diagrams commute:
\subsection{Left Naturality}
\begin{tikzcd}[ampersand replacement=\&]
    A \times \teb \arrow [r, "\Id{A} \times \T{\e}{f}"] \arrow [d, "\tstrength{\e}{A}{B}"]\&
    A \times \T{\e}{B'} \arrow [d, "\tstrength{\e}{A}{B'}"]\\
    \T{\e}{(A \times B)} \arrow [r, "\T{e}{(\Id{A} \times f)}"] \&
    \T{\e}{(A \times B')}
\end{tikzcd}

\subsection{Right Naturality}

\begin{tikzcd}[ampersand replacement=\&]
    A \times \teb  \arrow [r, "f \times \Id{\teb}"] \arrow [d, "\tstrength{\e}{A}{B}"]  \&
    A' \times \teb \arrow [d, "\tstrength {\e} {A'}{B}"]\\
    \T{\e}{(A \times B)} \arrow [r, "\T{\e}{(f \times \Id{B})}"]\&
    \T{\e}{(A' \times B)}
\end{tikzcd}

\subsection{Unitor Law}
\begin{tikzcd}[ampersand replacement=\&]
    \1 \times \tea 
    \arrow [r, "\tstrength{\e}{\1}{A}"]
    \arrow [rd, "\lambda_{\tea}"]
    \& 
    \T{\e}{(\1 \times A)}
    \arrow [d, "\T{\e}{(\lambda_A)}"]
    \\
    \&
    \tea
\end{tikzcd}
Where $\lambda: \terminal \times \Id{} \rightarrow \Id{}$ is the left-unitor.
($\lambda = \pp$)

\paragraph{Tensor Strength and Projection}
Due to the left-unitor law, we can develop a new law for the commutativity of $\pp$ with $\tstrength{}{}{}$

    $$\pi_{2, A, B} = \pi_{2, \1, B} \after (\term{A} \times \Id{B})$$

    And $\pi_{2, \1}$ is the left unitor, so by tensorial strength:
    
    \begin{equation}
        \begin{split}
            \T{\e}{\pp} \after \tstrength{\e}{A}{B} & = \T{\e}{\pi_{2, \1, B}} \after \T{\e}{(\term{A} \times \Id{B})} \after \tstrength{\e}{A}{B} \\
            & = \T{\e}{\pi_{2, 1, B}} \after \tstrength{\e}{\1}{B} \after (\term{A} \times \Id{B}) \\
            & = \pi_{2,1,B} \after (\term{A} \times \Id{B}) \\
            & = \pp
        \end{split}
    \end{equation}

So the following commutes:

\begin{tikzcd}[ampersand replacement=\&]
    A \times \teb 
    \arrow [r, "\tstrength{\e}{A}{B}"]
    \arrow [rd, "\pp"]
    \& 
    \T{\e}{(A \times B)}
    \arrow [d, "\T{\e}{\pp}"]
    \\
    \&
    \teb
\end{tikzcd}


\subsection{Commutativity with Join}
\begin{tikzcd}[ampersand replacement=\&]
    A \times \T{\e_1}{\T{\e_2}{B}} 
    \arrow [r, "\tstrength{\e_1}{A}{\T{\e_2}{B}}"]
    \arrow [dr, "\Id{A} \times \bind{\e_1}{\e_2}{B}"]
    \& 
    \T{\e_1}{(A \times \T{\e_2}{B})} 
    \arrow [r, "\T{\e_1}{\tstrength{\e_2}{A}{B}}"]
    \& 
    \T{\e_1}{\T{\e_2}{(A \times B)}} 
    \arrow [d, "\bind{\e_1}{\e_2}{A \times B}"]
    \\
    \&
    A \times \T{\e_1 \dot \e_2}{B}  
    \arrow [r, "\tstrength{\e_1 \dot \e_2}{A}{B}"] 
    \&
    \T{\e_1 \dot \e_2}({A \times B)}
\end{tikzcd}

\section{Commutativity with Unit}

\begin{tikzcd}[ampersand replacement=\&]
    A \times B
    \arrow [r, "\Id{A} \times \point{B}"]
    \arrow [rd, "\point{A \times B}"]
    \&
    A \times \tob 
    \arrow [d, "\tstrength{\1}{A}{B}"]
    \\
    \&
    \T{\1}{(A \times B)}
\end{tikzcd}

\section{Commutativity with $\alpha$}
Let $\alpha_{A, B, C} = \pr{\p\after\p}{\pr{\pp\after\p}{\pp}}: ((A \times B) \times C) \rightarrow (A \times (B \times C))$


\begin{tikzcd}[ampersand replacement=\&]
    (A\times B)\times \T{\e}{C} 
    \arrow [rr, "\tstrength{\e}{(A\times B)}{C}"]
    \arrow [d, "\alpha_{A, B, \T{\e}{C}}"]
    \& \& \T{\e}{((A \times B)\times C)}
    \arrow [d, "\T{\e}{\alpha_{A, B, C}}"]
    \\
    A \times (B \times \T{\e}{C}) 
    \arrow [r, "\Id{A}\times\tstrength{\e}{B}{C}"]
    \&
    A\times\T{\e}{(B \times C)} 
    \arrow [r, "\tstrength{\e}{A}{(B \times C)}"]
    \& \T{\e}{(A \times (B \times C))}
    \\
\end{tikzcd}


\section{Adjunction}
An important concept in category theory is that of an Adjunction.

Given functors F, G:

\begin{tikzcd}
    C \arrow[bend right=30]{rr}{F} & & D\arrow[bend right=30]{ll}{G}
\end{tikzcd}

And natural transformations:

\begin{itemize}
    \item Unit: $\eta_A: A \rightarrow G(F A)$ in $\C$
    \item Co-unit $\epsilon_B: F(G B) \rightarrow B$ in $\DC$
\end{itemize}

Such that 

\begin{align}
    \epsilon_{F A}\after F(\eta_A) & = \Id{F A} \\
    G(\epsilon_B)\after \eta_{F B} & = \Id{G B}
\end{align}

We can then use $\epsilon$ and $\eta$ to form a natural isomorphism between morphisms in the two categories.

\begin{align}
    \bar{(-)}: \quad\C(FA, B) &\leftrightarrow \DC(A, GB) \quad: \widehat{(-)}\\
     f & \mapsto G(f)\after\eta_A \\
     \epsilon\after F(g) & \mapsfrom g\\
\end{align}

\section{Strict Indexed Category}
The final piece of category theory required to understand this dissertation is the concept of a strictly indexed Category.

A strict indexed category is a functor from a base category into a target category of categories, such as the category of cartesian closed categories.

Objects in the base category are mapped to categories in the target category. Morphisms between objects in the base category are mapped to functors between categories in the target category.

For example, we may use the the case of cartesian closed categories indexed by a pre-order:

\begin{align}
    I: \mathbb{P} & \rightarrow \textit{CCCat}\qt{The indexing functor} \\
    A \in\obj\mathbb{P} & \mapsto \C \in\textit{CCCat}\qt{Objects are mapped to categories}\\
    A \leq B & \mapsto (A \leq B)\star: \C \rightarrow \DC\qt{Morphisms are mapped to functors preserving CCC properties.}
\end{align}

\section{Limits}
A limit is a generalisation of concepts such as terminal objects, products, and pullbacks. Co-products and initial objects are examples of co-limits.


For a diagram $D$ in $\C$, we define a cone of $D$ to be an instance of $D$, accompanied by another object $X$ and a collection of morphisms $\vec{\phi}$ completing the diagram. If one imagines the diagram as a 2-dimensional shape in C with its morphisms as edges, the object $X$ above the plane forms a cone shape.

\begin{tikzcd}
    & X \arrow{dd}{\phi_1} \arrow{lddd}{\phi_2} \arrow{rddd}{\phi_3} &\\
    \\
    & \arrow{ld}{d_1}    D_1 & \\
    D_2 \arrow{rr}{d_2}& & D_3 \arrow{lu}{d_3}
\end{tikzcd}

A limit of the diagram is a least-cone. That is, it is a cone object $L$ with morphisms $\vec{\psi}$ such that any other cone $X$ can be factored into a unique morphism $l$ to $L$ and the cone formed by $L$.

\begin{tikzcd}
    &  &X \arrow[dotted]{ld}{l}\arrow{lddd}{\phi_1} \arrow[bend right]{lldddd}{\phi_2} \arrow{dddd}{\phi_3} \\
    & L \arrow{dd}{\psi_1} \arrow{lddd}{\psi_2} \arrow{rddd}{\psi_3} &\\
    \\
    & \arrow{ld}{d_1}    D_1 & \\
    D_2 \arrow{rr}{d_2}& & D_3 \arrow{lu}{d_3}
\end{tikzcd}

\chapter{The Polymorphic-Effect-Calculus}
In this chapter I'll be introducing the monadic, effect-ful language used in the rest of the dissertation, known from now on as the Effect Calculus (EC). Then I shall introduce polymorphic terms to the EC which yield the Polymorphic Effect Calculus (PEC).

\section{Effect Calculus}
The basic effect calculus is an extension of the simply typed lambda calculus to include constants, if-statements, effects, and sub-typing.

It has terms of the following form:

\begin{align}
    v ::= \const{A} \mid x\mid \t \mid\f \mid\u\mid\lam{x}{A}{v}\mid\apply{v_1}{v_2}\mid\return{v}\mid\doin{x}{v_1}{v_2}\mid\pifthenelse{A}{v}{v_1}{v_2} 
\end{align}

Where $\const{A}$ is one of collection of ground constants, and $A$ ranges over the types:

\begin{align}
    A, B, C ::= \g\mid \ab \mid\mea
\end{align}

Where $\g$ is from a collection of ground types, including $\U, \B$, and $\e$ ranges over pre-ordered monoid of effects: $(E, \dot, \subeffect, \1)$


\todo{This is very vague so far. I don't want to get too bogged down in the semantics of the Effect Calculus though}
A full derivation and proof of soundness of the semantics of the Effect Calculus can be found online \todo{Link} as it is too long to include here and many of the concepts will be repeated in the rest of this dissertation anyway. The categorical semantics of the Effect Calculus require a CCC with a strong graded monad, sub-typing morphisms, sub-effecting natural transformations, and a co-product on the terminal object. These features allow us to prove the soundness of the effect-calculus semantics.

\section{Polymorphic Effect Calculus}
Next, we shall consider the Effect Calculus extended with terms to allow System-F style polymorphism over effects.

\begin{align}
    v::=\text{..}\mid\elam{\a}{v}\mid\eapp{v}{\e}
\end{align}

\begin{align}
    A, B, C::=\text{...}\mid \all{\a}{A}
\end{align}

Where effects $\e$ now range over the effect pre-ordered monoid augmented with effect variables from an environment $\P = \nil, \a, \b ...$, written as $(E_\P, \dotp, \subeffectp, \1)$.

\section{Type System}
\subsection{Environments}
As mentioned before, effects can now include effect variables. These are managed in the type system using a well-formed effect-variable-environment $\P$, which is a snoc-list.

\begin{align}
    \P ::= \nil \mid \P, \a
\end{align}



\subsection{Effects}
The ground effects form the same monotonous, pre-ordered monoid $(E, \dot, \1, \subeffect)$ over ground elements $e$. For each effect environment $\P$, we define a new, symbolic pre-ordered monoid:

\begin{equation}
    (E_\P, \dotp, \1, \subeffectp)
\end{equation}

Where $E_\P$ is the closure of $E\cup \left\{\a\mid\a\in\P\right\}$ under $\dotp$, which is defined as:

\begin{equation}
    \treerule{}{\e_3 = \e_1\dot\e_2}{\e_3 = \e_1\dotp\e_2}
\end{equation} 

For variable-free terms and is defined symbolically for variable containing terms. Further more, we also define the sub-effecting relation in terms of its variables and the ground relation.

\begin{equation}
    \e_1 \subeffectp \e_2 \Leftrightarrow \forall \si\downarrow. \e_1\sub{\si\downarrow} \subeffect \e_2\sub{\si\downarrow}
\end{equation}

Where $\si\downarrow$ denotes any ground-effect-substitution of $\P$. That is any substitution of all effect-variables in $\P$ to ground effects. Where it is obvious from the context, I shall use $\subeffect$ instead of $\subeffectp$.


\subsection{Types}
As stated, types are now generated by the following grammar.

$$ A, B, C \gens \ground \mid \ab \mid \mea \mid \all{\a}{A}$$
  
\subsection{Type Environments}
As is often the case in similar type systems, a type environment is a snoc-list of term-variable, type pairs, $G \gens \nil \mid \gax$.

\paragraph{Domain Function on Type Environments}

\[
    \dom{\nil} = \emptyset
    \quad\quad\quad
    \dom{\gax} =  \dom{\G}  \cup \left\{x \right\}
\]

\subsection{Well-Formed-Ness Predicates}
To formalise properties of the type system, it will be useful to have a collection of predicates ensuring that structures in the language are well-behaved with respect to their use of effect variables.

Informally, $\a \in \P$ if $\a$ appears in the list represented by $\P$.

The $\ok{}$ predicate on effect environments asserts that the effect environment does not contain any duplicate effect-variables.

\[
    \treerule{Atom}{}{\ok{\nil}}
\quad
    \treerule{A}{\ok{\P} \s\s \a\notin \P}{\ok{\P, \a}}
\]

Using this, we can define the well-formed-ness relation on effects, $\wellformed{\P}{\e}$. In short, this relation ensures that effects don't reference variables that are not in the effect environment.

\[
    \treerule{Ground}{\ok{\P}}{\wellformed{\P}{e}}
    \quad
    \treerule{Var}{\ok{\P,\a}}{\wellformed{\P,\a}{\a}}
    \quad
    \condtreerule{Weaken}{\wellformed{\P}{\a}}{\wellformed{\P,\b}{\a}}{\a\neq\b}
    \quad
    \treerule{Monoid Op}{\wellformed{\P}{\e_1}\s\s\wellformed{\P}{\e_2}}{\wellformed{\P}{\e_1\dot\e_2}}
\]

The well-formed-ness of effects can be used to a similar well-typed-relation on types, $\wellformed{\P}{A}$, which asserts that all effects in the type are well-formed.

\[
    \treerule{Ground}{}{\wellformed{\P}{\g}}
    \quad
    \treerule{Lambda}{\wellformed{\P}{A}\s\s\wellformed{\P}{B}}{\wellformed{\P}{\ab}}
    \quad
    \treerule{Computation}{\wellformed{\P}{A}\s\s\wellformed{\P}{\e}}{\wellformed{\P}{\mea}}
    \quad
    \treerule{For-All}{\wellformed{\P,\a}{A}}{\wellformed{\P}{\all{\a}{A}}}
\]

Finally, we can derive the a well-formed-ness of type-environments,   $\oke{\P}{\G}$, which ensures that all types in the environment are well formed.

\[
    \treerule{Nil}{}{\oke{\P}{\nil}}
    \quad
    \treerule{Var}{\oke{\P}{\G}\s\s x\notin\dom{\G}\s\s \wellformed{\P}{A}}{\oke{\P}{\gax}}
\]

\subsection{Sub-typing}
    There exists a sub-typing pre-order relation $\subtype_{\ground}$ over ground types. That is:

    \[
        \treerule{Reflexive}{}{A \subtype_{\ground} A}
        \quad
        \treerule{Transitive}{A \subtype_{\ground} B \s \s B \subtype_{\ground} C}{A \subtype_{\ground} C}
    \]

    We extend this relation with the function, effect, and effect-lambda sub-typing rules to yield the full sub-typing relation under an effect environment, $\P$, $\subtypep$
\[
    \treerule{ground}{A \subtype_{\ground} B}{A \subtypep B}
    \quad
    \treerule{Fn}{A \subtypep A' \s\s B' \subtypep B }{\fntype{A'}{B'} \subtypep \ab}
    \quad
    \treerule{All}{A\subtypep A'}{\all{\a}{A}\subtypep\all{a}{A'}}
    \quad
    \treerule{Effect}{A\subtypep B\s\s \e_1\subeffectp\e_2}{\M{\e_1}{A}\subtypep\M{\e_2}{B}}
\]


\subsection{Type Rules}
We define a fairly standard set of type rules on the language. \todo{stack these horizontally to reduce the vertical space.}


\[
    \treerule{Const}{\oke{\P}{\G}\s\s\wellformed{\P}{A}}{\gpetyperelation{\const{A}}{A}} 
    \quad
    \treerule{Unit}{\oke{\P}{\G}}{\gpetyperelation{\u}{\U}} 
    \quad
    \treerule{True}{\oke{\P}{\G}}{\gpetyperelation{\t}{\B}}
    \quad
    \treerule{False}{\oke{\P}{\G}}{\gpetyperelation{\f}{\B}}
\]
\[
\treerule{Var}{\oke{\P}{\gax}}{\etyperelation{\P}{\gax}{x}{A}}
\quad
\condtreerule{Weaken}{\etyperelation{\P}{\G}{x}{A}\s\s\wellformed{\P}{B}}{\etyperelation{\P}{\gby}{x}{A}}{x \neq y}
\quad
\treerule{Fn}{\etyperelation{\P}{\gax}{v}{\b}}{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
\]
\[
    \treerule{Sub}{\etyperelation{\P}{\G}{v}{A}\s\s A \subtypep B}{\etyperelation{\P}{\G}{v}{B}}
    \quad
    \treerule{Effect-Abs}{\etyperelation{\P,\a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}
    \quad
    \treerule{Effect-apply}{\gpetyperelation{v}{\all{\a}A}\s\s\wellformed{\P}{\e}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\]
\[
    \treerule{Return}{\gpetyperelation{v}{A}}{\gpetyperelation{\return{v}}{\moa}}
    \quad
    \treerule{Apply}{\gpetyperelation{v_1}{\aeb}\s\s\gpetyperelation{v_2}{A}}{\gpetyperelation{\apply{v_1}{v_2}}{\meb}}
\]
\[
    \treerule{If}{\gpetyperelation{v}{\B} \s\s \gpetyperelation{v_1}{A}\s\s\gpetyperelation{v_2}{A}}{\gpetyperelation{\pifthenelse{A}{V}{v_1}{v_2}}{A}}
    \quad
    \treerule{Do}{\gpetyperelation{v_1}{\M{\e_1}{A}} \s\s \etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}{\gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
\]

\subsection{Ok Lemma} The first lemma used in this dissertation is that: If $\gpetyperelation{v}{A}$ then $\oke{\P}{\G}$.
\paragraph{Proof}
If $\ok{\gax}$ then by inversion $\ok{\G}$
Only the type rule \texttt{Weaken} adds terms to the environment from its preconditions to its post-condition and it does so in an $\ok{}$ preserving way. Any type derivation tree has at least one leaf. All leaves are axioms which require $\oke{\P}{\G}$. And all non-axiom derivations preserve the $\ok{}$ property.


\chapter{Semantics for EC in an S-Category}
As hinted at previously, we can interpret the Effect Calculus in a CCC with a strong graded monad and co-products. A further requirement is the appropriate sub-effecting natural transformations. For each instance of $\e_1 \subeffect \e_2$, there exists a natural transformation $\db{\e_1\subeffect\e2}: \T{\e_1}{}\rightarrow\T{\e_2}{}$ such that it has the following interactions with the graded monad:

\todo{Put these horizontal to each other.}

\subsection{Sub-Effecting and Tensor Strength}
\begin{tikzcd}[ampersand replacement=\&]
    A \times \T{\e_1}{B} \arrow [r, "\Id{A} \times \dse{\e_1}{\e_2}_B"] \arrow [d, "\tstrength{\e_1}{A}{B}"] \&
    A \times \T{\e_2}{B} \arrow [d, "\tstrength{\e_2}{A}{B}"] \\
    \T{\e_1}{(A \times B)} \arrow [r, "\dse{\e_1}{\e_2}_{ A \times B}"] \&
    \T{\e_2}{(A \times B)} 
\end{tikzcd}

\begin{tikzcd}[ampersand replacement=\&]
    \T{\e_1}{\T{\e_2}{}} 
    \arrow [rr, "\T{\e_1}{\deno{\e_2\subeffect\e_2'}
    }"]
    \arrow [d, "\bind{\e_1}{\e_2}{}"]
    \&  \&
    \T{\e_1}{\T{\e_2'}{}}
    \arrow [rr, "\db{\e_1 \subeffect\e_1'}_{M, \T{\e_2'}{}}"]
    \& \&
     \T{\e_1'}{\T{\e_2'}{}} 
     \arrow [d, "\bind{\e_1'}{\e_2'}{}"]
     \\
    \T{\e_1\dot\e_2}{}
    \arrow [rrrr, "\deno{\e_1\dot\e_2\subeffect\e_1'\dot\e_2'}"]
    \& \&
     \& \&
    \T{\e_1'\dot\e_2'}{}
\end{tikzcd}

We shall call a category fulfilling these properties an S-Category (Semantic Category).

\todo{This has been very vague as I want to save words on the non-polymorphic stuff.}

\chapter{Semantics For PEC in an Indexed Category}
In this chapter, I shall describe the category structure required to interpret an instance of the PEC. I shall then present denotations of each type of structure in the language, such as types, effects, terms, substitutions, and environment weakenings. Finally, I shall provide outlines and interesting cases of the proofs of the lemmas leading up to and including soundness of $\beta\eta$-conversion.


\section{Required Category Structure}


\section{Road Map}
\todo{Diagram}.
The first pair of theorems is effect-substitution theorem on effects. These theorems show that substitutions of effects have well-behaved and easily defined action upon the denotations of effects.

Using these theorems, we can then move on to characterize the action of effect-substitutions and effect-environment-weakening on the denotations of types and type-environments.

Using the above, we can characterize the action of effect-substitutions and effect-environment weakening on the denotations of terms.

From this we can characterize the action of effect-weakening on term-substitutions and term weakenings. This gives us the means to prove the substitution and weakening theorems for typing environments.

The substitution and weakening theorems allow us to easily find the denotation of a substituted term, simply by pre-composing the term before substitution with the denotation of the substitution or the weakening.

Separately, we prove that all derivable denotations for a typing relation instance, $\gpetyperelation{v}{A}$ have the same denotation. This is important, since sub-typing allows us to find multiple distinct typing derivations for terms, which initially look like they may have distinct denotations. Using a reduction function to transform typing derivations into a unique form, I shall prove that all typing derivations yield equal denotations.

This collection of theorems finally allows us to complete all cases of the $\beta\eta$-equivalence soundness theorem.



\section{Denotations}

\section{Substitution and Weakening Theorems}



\end{document}
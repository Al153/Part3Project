\documentclass{Report}
\input{../proofs/header.tex}

\usepackage{fancyvrb}
\usepackage{alltt,xcolor}

\usepackage{graphicx}
\usepackage[nottoc]{tocbibind}
\usepackage{url}
 


\newcommand\comment[1]{}
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}
\newcommand\groundEffects[0]{\texttt{Ground}}




\title{A Denotational Semantics for Polymorphic Effect Systems}

\date{\today}
\author{Alexander Taylor}

\begin{document}

\maketitle

\newcommand{\note}[1]{
    %
}

\abstract
To date, there has been limited work on the semantics of languages with polymorphic effect systems. The application, by Moggi \cite{MoggiMonads}, of strong monads to modelling the semantics of effects has become a mainstream concept in functional programming languages. The usage of monads was made more precise by Katsumata (\cite{Katsumata:2014}) using a graded monad to model languages with a range of independent and dependent effects at an operational level. Separately, a categorical semantics for parametric polymorphism in types was first published by Reynolds \cite{PLCSemantics} allowing a denotational analysis of languages including type parameters. There has been some work on polymorphism over the exception effect (which paper). However, there has been no work to date on the denotational semantics of languages with general parametric polymorphism over effects.

In this dissertation, I present several pieces of work. Firstly, I introduce a modern definition of a lambda-calculus-based language with an explicit graded monad to handle a variety of effects. This calculus is then extended with parameterisation over effects to yield a more general lambda calculus with polymorphism over effects. Next, I give an indexed-category-based denotational semantics for the language, along with an outline of a proof for the soundness of these semantics. Following this, I present a method of transforming a model of a non-polymorphic language into a model of the language with polymorphism over effects.

The full proofs, though in a terser format, can be found online on my github repository\footnote{\url{https://github.com/Al153/Part3Project/blob/master/diss/OnlinePECSemantics.pdf}}, since due to the number of theorems and cases, the total size is well over 100 pages of definitions, theorems, and proofs.

\tableofcontents

\chapter{Introduction}


\section{What is an Effect System?}

Programs very rarely stand alone without interacting with their environment in some form. This interaction might be to receive input, such as from sensors or buttons, to write output to a file, or to halt with an error. In functional languages, manipulating mutable state can also be considered interacting with the environment. Language terms that produce these interactions are said to have \textit{effects} as they have some observable effect in the environment other than simply the returning value that executing the term produces. It is important to be able to reason about the effects that a program term may produce, in order to ensure the soundness of compiler transformations and formal verification. An effect system, analogously to a type system, is a formal system of rules which infers abstract information about the side-effects that a program might have. This data may then inform tools such as a compiler of the soundness of code transformations, such as removing redundant code or reordering statements. Languages such as Haskell and the languages introduced later in this dissertation do not allow implicit effects. Instead they require the programmer to explicitly use structures called monads \cite{MoggiMonads} to perform effect analysis using the type of program fragments. This has the useful result of combining the effect system with the type system of the language. For example, a program of type \texttt{Int} cannot interact with its environment to produce its result and hence always yields the same return value. However a program of type \texttt{IO Int} may perform IO operations before returning its result and hence may not always behave in exactly the same fashion.

\section{What is Effect Polymorphism?}


Effect polymorphism is when a single function in a language can operate on values of similar types but with different effect signatures. It allows the same piece of code to be used in multiple contexts with different type signature. This manifests in a similar manner to type parameter polymorphism in system-F-based languages. Consider the following Scala-style pseudocode:
\renewcommand\o[1]{\textcolor{orange}{#1}}
\newcommand\bl[1]{\textcolor{blue}{#1}}
\newcommand\gr[1]{\textcolor{DarkGreen}{#1}}
\newcommand\pl[1]{\textcolor{purple}{#1}}
\newcommand\cy[1]{\textcolor{cyan}{#1}}
\newcommand\red[1]{\textcolor{red}{#1}}

\begin{framed}
    \begin{framed}
        \begin{alltt}
\o{def} check[{\gr{E}}: \pl{Effect}](
    action: \bl{Unit} => (\bl{Unit}; \gr{E})
): \bl{Unit}; (\gr{IO}, \gr{E}) \{
    \o{val} ok: \bl{Boolean} = promptBool(
        \cy{"Are you sure you want to do this?"}
    )
    \o{if} (ok) \{
        action()
    \} \o{else} \{
       abort()
    \}
\}  
            \end{alltt}
    \end{framed}

    \begin{framed}
        \begin{alltt}
check[\gr{RealWorld}](FireMissiles)
check[\gr{Transaction}](SendMoney(\pl{Bob}, \cy{100}, \pl{USD}))
check[\gr{Exception}](ThrowException(\cy{"Not Aborted"}))
        \end{alltt}
    \end{framed}
\end{framed}

In this example, we are reusing the same “check” function in three different situations with three different effects in a type safe manner. Hence, “check” is polymorphic in the effect parameter it receives. To analyse this language, it would be useful to have an analysis tool that can precisely model these separate, though potentially interdependent, effects. A denotational semantics that can account for the parametric polymorphism over effects would be a step towards verifying and reasoning about such tools. 

A key property of effect polymorphism that distinguishes it from type polymorphism is that effects are not impredicative. That is, types are polymorphic over effects, but effects do not range over themselves. This means that the models used to interpret effect-polymorphic languages can be simpler than the models required to interpret languages with impredicative polymorphism, such as System F, where types can range over themselves \cite{PolymorphismIsNotSetTheoretic}. 


\section{An Introduction to Categorical Semantics}

In this dissertation, I describe a denotational semantics using category theory. A denotational semantics for a language is a mapping, the image $\deno{X}$ of which is known as a denotation, of structures in the language, such as types and terms to mathematical objects in a compositional way. This means that the denotation of a term is defined entirely in terms of the denotations of its subterms.

When we specify a denotational semantics of a language in category theory, we look to find a mapping of types and type environments to objects in a specific categorical structure.  That is, there should exist objects $\deno{A}, \deno{\G}$ in the category $\C$ such that:

\begin{align*}
    A: \type & \mapsto \deno{A} \in \obj \C \\
    \G & \mapsto  \deno{\G} \in \obj \C
\end{align*}

Furthermore, assuming the language has a type system with a typing relation of the form $\gtyperelation{v}{A}$, meaning ``in environment $\G$, language term $v$ has type $A$'', instances of the typing relation should be mapped to morphisms between the relevant objects in $\C$.

\begin{framed}
    \begin{aside}[Syntax highlighting]
        In this dissertation, I have made use of some simple syntax highlighting in order to make some relations easier to parse by eye. There is not a specific meaning attached to each colour, but as a guide: green indicates an assumption, blue a conclusion, and type annotations within terms are purple. For example: $\typerelation{\texttt{Assumption}}{\lam{x}{A}{\texttt{term}}}{\texttt{Type}}$.
    \end{aside}
     
\end{framed}

\begin{align*}
    \gtyperelation{v}{A} & \mapsto \C(\deno{\G}, \deno{A}) 
\end{align*}

This should occur in a sound manner with respect to some equational equivalence over the language. An equational equivalence is a relation of the form $\gtyperelation{v_1 \cong v_2}{A}$, which means ``in environment $\G$, terms $v_1$ and $v_2$ are equivalent under type $A$'', which represents equality up to some particular property. A categorical semantics is \textit{sound} with respect to an equational equivalence $\cong$ if and only if $\gtyperelation{v_1 \cong v_2}{A}$ implies that the denotations $\deno{\gtyperelation{v_1}{A}}$ and $\deno{\gtyperelation{v_2}{A}}$ are equal morphisms in $\C$ from $\deno{\G}$ to $\deno{A}$.

Typically when working with lambda-calculus-based languages, we pick our equational equality to be an extension of $\beta\eta$-equivalence to include other, language-specific, rules for equality under reduction. For example, we might want to include the execution of if-statements or effectful expressions.

An example of an inductive equivalence rule that we might want to be sound with respect to is that of the $\beta$-reduction of lambda terms. It should be the case that the equality defined in Equation \ref{LambdaBeta} below implies that the denotations $\deno{\gtyperelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{B}}$ and $\deno{\gtyperelation{v_1\ssub{x}{v_2}}{B}}$ are equal.

\begin{align}\label{LambdaBeta}
    \ntreeruleII{Lambda-Beta}{\typerelation{\gax}{v_1}{B}}{\gtyperelation{v_2}{A}}{\gberelation{\apply{(\lam{x}{A}{v_1})}{v_2}}{v_1\ssub{x}{v_2}}{B}}
\end{align}


In this dissertation, I introduce an effect-polymorphic language, describe a semantics for it, then prove that the semantics is sound with respect to a $\beta\eta$-equivalence-based equational equivalence relation.

\chapter{Background}



In this chapter I first introduce the required category theory to understand the rest of the dissertation. In addition, I explain briefly how the particular category-theoretic structures can be used to model particular features of various programming languages, such as the simply typed lambda calculus and system F. Following this, I proceed to introduce the monadic, effectful language used in the rest of the dissertation, known from now on as the Effect Calculus (EC). In the final section, I extend the EC with polymorphic syntax to yield Polymorphic Effect Calculus (PEC).

\section{Required Category Theory}\label{CategoryTheoryRequirements}


Before going further, it is necessary to assert a common level of category theory knowledge. This section is not intended as a tutorial but to jog the memory of the reader, and briefly introduce some new concepts. For a more detailed treatment of these concepts, please see \cite{maclane:71}.

\subsection{Cartesian Closed Category}\label{CCC}
A category is \textit{cartesian closed} if it has a terminal object, products for all pairs of objects, and exponentials. These concepts will be explained below.

\subsubsection{Terminal Object}
An object, typically written $\1$, is \textit{terminal} in a category, $\C$ if for all objects $A\in\obj\C$, there exists exactly one morphism from $A$ to $\1$, written $\term{A}: A \rightarrow \1$.

\subsubsection{Products}
A \textit{binary product} of a pair of objects $A, B\in\obj\C$ consists of an object, written $A \times B$, with morphisms $\p: A\times B\rightarrow A$, $\pp: A\times B \rightarrow B$ such that for any other object $C$ and morphisms, $f: C\rightarrow A$, $g: C\rightarrow B$ there exists a unique morphism $\pr{f}{g}: C \rightarrow (A\times B)$ such that the following commutes:

\begin{center}
    \begin{tikzcd}
        & \arrow{dl}[swap]{f} C  \arrow[d, "\pr{f}{g}"] \arrow [dr, "g"] & \\
        A & \arrow [l, "\p"] (A\times B) \arrow{r}[swap]{\pp} & B\\
    \end{tikzcd}
\end{center}



A category is said to \textit{have binary products} if for all objects $A, B$, the product $A\times B$ also exists.

\subsubsection{Exponentials}
An \textit{exponential} for objects $A, C$ is an object $C^A$ with morphism $\app: C^A\times A \rightarrow C$ such that for any object $B$ and morphism $f: B\times A \rightarrow C$, there exists a morphism $\cur{f}: B \rightarrow C^A$ such that the following commutes:


\begin{center}
    \begin{tikzcd}
        C^A \times A \arrow{r}{\app}& C\\
        B\times A\arrow{u}{\cur{f}\times \Id{B}} \arrow{ur}{f}
    \end{tikzcd}
\end{center}



A category \textit{has exponentials} if for all pairs of objects $A, C$ it has an exponential $C^A$.

\subsubsection{Diagonal and Twist Morphisms}
In the definition of the semantics of the if-expression, it is useful to make use of the following twist and diagonal shorthand morphisms.

\begin{align*}
    \twist{A}{B}: (A\times B) \rightarrow (B\times A) = \pr{\pp}{\p}\\
    \diag{A}: A \rightarrow (A\times A)  = \pr{\Id{A}}{\Id{A}}
\end{align*}

\subsection{Co-Product}
A \textit{co-product} is the dual of a product. The is a co-product for objects $A, B$ if there exists an object $A+B$ in $\C$ with morphisms $\inl: A\rightarrow (A+B)$, $inr: B\rightarrow (A+B)$ such that for any other object $C$ with morphisms $f: A\rightarrow C$, $g: B\rightarrow C$, there exists a unique morphism $[f, g]: (A + B)\rightarrow C $ such that the following commutes:


{\centering
\begin{tikzcd}
    &  C   & \\
    A \arrow{ur}{f} \arrow [r, "\inl"] &  \arrow{u}{[f, g]} (A + B)  & \arrow{l}[swap]{\inr} \arrow{ul}[swap]{g} B\\
\end{tikzcd}
}


\subsection{Functors}
A functor $F: \C \rightarrow \DC$ is a mapping of objects and morphisms in $\C$ to objects and morphisms respectively in $\DC$ that preserves composition and identities.

\begin{align*}
    A\in\obj\C &\mapsto FA \in \obj\DC\\
    f: \C(A, B) &\mapsto F(f): \DC(FA, FB)\\
    F(\Id{A}) & = \Id{FA} \\
    F(g\after f) & = F(g)\after F(f)
\end{align*}

\subsection{Natural Transformations}

A \textit{natural transformation} $\theta$ between two functors $F, G: \C \rightarrow \DC$ is a collection of morphisms in $\DC$, indexed by objects in $\C$ with  $\theta_A: F(A) \rightarrow G(A)$ such that diagram in Figure \ref{Naturality} commutes for each $f: A \rightarrow B \in \C$.

\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \centering
        \begin{framed}
            \begin{tikzcd}
                F(A) \arrow{r}{\theta_A} \arrow{d}{F(f)}  & G(A) \arrow{d}{G(f)}\\
                F(B) \arrow{r}{\theta_B}& G(B)\\ 
            \end{tikzcd}
    \end{framed}
        \caption{Naturality of a natural transformation}
        \label{Naturality}
    \end{minipage}\hfill
\end{figure}



\subsection{Monad}
A \textit{monad} consists of a functor, $T: \C \rightarrow \C$, from $\C$ onto itself, also known as an \textit{endofunctor}, which represents the collection of effectful values, and a pair of natural transformations. The first is the the \textit{unit} natural transformation $\point{A}: A\rightarrow T(A)$, which is used to treat pure values as an effectful expression. The second is the \textit{join} natural transformation, $\mu_{A}: T(T(A)) \rightarrow T(A)$,  which is used to model the sequential composition of effectful subexpressions. In addition, there is the requirement that the diagrams in Figures \ref{MonadAssociativity}, \ref{MonadUnits} commute.


\begin{figure}
\begin{framed}  
        \centering
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}
                T(T(T(A)) \arrow{r}{\mu_{T(A)}} \arrow{d}{T(\mu_{A})} & T(T(A)) \arrow{d}{\mu_A} \\
                T(T(A)) \arrow{r}{\mu_A} & T(A)    
            \end{tikzcd}        
            \caption{Monad Associativity Laws}
            \label{MonadAssociativity}
        \end{minipage}\hfill
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}
                T(A) \arrow{r}{\point{T(A)}} \arrow{d}{T(\point{A})} \arrow[equal]{rd} & T(T(A)) \arrow{d}{\mu_A}\\
                T(T(A)) \arrow{r}{\mu_A} & T(A)
            \end{tikzcd}
            \caption{Monad Left- and Right-Unit laws}
            \label{MonadUnits}
        \end{minipage}
\end{framed}
\end{figure}


\subsection{Monoid}

Another concept, though not strictly of category theory, is that of a monoidal algebra. A \textit{monoid} is a set, operation, and identity $(M, \dot, \1)$ where $\dot: M\times M \rightarrow M$, is associative ($a\dot(b\dot c) = (a\dot b)\dot c$), and has an identity $a\dot\1 = a = \1\dot a$. In this dissertation, I make use of a monoid with a partial order. This means there is a transitive, reflexive relation $\subeffect$ over the set $M$. In this case, the $\dot$ operator should also be monotone. That is if $a \subeffect a'$ and $b\subeffect b'$ then $a\dot b \subeffect a'\dot b'$ . Such an algebra can be used to describe how effects induced by terms in a program interact with each other. For example, $a \dot b$ is the effect induced by composing a subexpression which produces effect $a$ with a subexpression that produces effect $b$. The partial order is used to develop a notion of \textit{subtyping} over effects.

\subsection{Graded Monad}


A \textit{graded monad} is a generalisation of a monad to be indexed by a monoidal algebra $(E,\dot, \1)$. It consists of an endofunctor indexed by elements in the monoid, $\T{}{}: (E, \dot, \1)  \rightarrow [\C, \C]$, and a pair of indexed natural transformations. Firstly, there is the unit natural transformation to the monad functor indexed by the identity $\point{}: \Id{} \rightarrow \T{\1}{}$. The second natural transformation is a generalisation of join which composes nested instances of the indexed functor $\bind{\e_1}{\e_2}{}: \T{\e_1}{\T{\e_2}{}} \rightarrow \T{\e_1 \dot \e_2}{}$. Furthermore there is a requirement that the diagrams in Figures \ref{GradedMonadAssociativity}, \ref{GradedMonadUnits} commute.


\begin{figure}
\begin{framed}
        \centering
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}[ampersand replacement=\&]
                \T{\e_1}{\T{\e_2}{\T{\e_3}{A}}} 
                \arrow [r, "\bind{\e_1}{\e_2}{\T{\e_3}{A}}"]
                \arrow [d, "\T{\e_1}{\bind{\e_2}{\e_3}{A}}"] \& \T{\e_1 \dot \e_2}{\T{\e_3} A} \arrow [d, "\bind{\e_1 \dot \e_2}{\e_3}{A}"] \\
                \T{\e_1}{\T{\e_2 \dot \e_3}{A}} \arrow [r, "\bind{\e_1}{\e_2 \dot \e_3}{A}"] \& \T{\e_1 \dot \e_2 \dot \e_3}{A}    
            \end{tikzcd}
            \caption{Associativity of a graded monad}
            \label{GradedMonadAssociativity}
        \end{minipage}\hfill
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}[ampersand replacement=\&]
                \tea
                 \arrow[equal]{rd} 
                 \arrow[r, "\T{\e}{\point{A}}"]
                 \arrow{d}{\point{\tea}}
                \& 
                \T{\e}{\T{\1}{A}} 
                    \arrow[d, "\bind{\e}{\1}{A}"] \\
                    \T{\1}{\T{\e}{A}}
                         \arrow{r}{\bind{\1}{\e}{A}}
                \& 
                \tea
            \end{tikzcd}
            \caption{Left- and Right- Units of a graded monad}
            \label{GradedMonadUnits}
        \end{minipage}
\end{framed}
\end{figure}


\subsection{Tensor Strength}
A slightly harder concept to motivate is that of tensorial (or tensor) \textit{strength} for a graded monad. Tensor strength consists of a natural transformation: $\strengtht_{A, B}: A \times \T{}{B} \rightarrow \T{}{(A \times B)}$, which is required to have well-defined interactions with the graded monad morphisms and the product-reordering natural transformation $\alpha_{A, B, C} = \pr{\p\after\p}{\pr{\pp\after\p}{\pp}}: ((A \times B) \times C) \rightarrow (A \times (B \times C))$, as seen in Figures \ref{TensorStrengthLeftNaturality}, \ref{TensorStrengthRightNaturality}, \ref{TensorStrengthUnitorLaw}, \ref{TensorStengthJoin}, \ref{TensorStrengthPoint}, \ref{TensorStrengthAlpha}. The reasoning behind this is that the tensor-strength natural transformation allows us to model operations that are invisibly implicit in a programming language but not given by default in category theory, such as in Figure \ref{MonadStrengthRequirement} in Section \ref{LanguageFeatureRequirements}. Tensor strength of a monad can be generalised to tensor strength in a graded monad by indexing by an element of the monoid algebra. A monad (or respectively a graded monad) is called \textit{strong} if it has tensorial strength. 

\begin{figure}
\begin{framed}
        \centering
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}[ampersand replacement=\&]
                A \times \teb  \arrow [r, "f \times \Id{\teb}"] \arrow [d, "\tstrength{\e}{A}{B}"]  \&
                A' \times \teb \arrow [d, "\tstrength {\e} {A'}{B}"]\\
                \T{\e}{(A \times B)} \arrow [r, "\T{\e}{(f \times \Id{B})}"]\&
                \T{\e}{(A' \times B)}
                \end{tikzcd}
                \caption{Left Naturality of Graded Tensor Strength}
                \label{TensorStrengthLeftNaturality}
        \end{minipage}
        \hfill
        \begin{minipage}{0.45\textwidth}
            \centering
            \begin{tikzcd}[ampersand replacement=\&]
                A \times \teb \arrow [r, "\Id{A} \times \T{\e}{f}"] \arrow [d, "\tstrength{\e}{A}{B}"]\&
                A \times \T{\e}{B'} \arrow [d, "\tstrength{\e}{A}{B'}"]\\
                \T{\e}{(A \times B)} \arrow [r, "\T{e}{(\Id{A} \times f)}"] \&
                \T{\e}{(A \times B')}
            \end{tikzcd}
            \caption{Right Naturality of Graded Tensor Strength}
            \label{TensorStrengthRightNaturality}
        \end{minipage} 
\end{framed}
\end{figure}


\begin{figure}
\begin{framed}
        \centering
        \begin{minipage}{0.45\textwidth}
        \begin{tikzcd}[ampersand replacement=\&]
            A \times \teb 
            \arrow [r, "\tstrength{\e}{A}{B}"]
            \arrow [rd, "\pp"]
            \& 
            \T{\e}{(A \times B)}
            \arrow [d, "\T{\e}{\pp}"]
            \\
            \&
            \teb
        \end{tikzcd}
        \caption{Tensor Strength Unitor Law}
        \label{TensorStrengthUnitorLaw}
        \end{minipage}
        \quad
        \centering
        \begin{minipage}{0.45\textwidth}
            \begin{tikzpicture}[baseline= (a).base]
                \node[scale=.7] (a) at (0,0){
            \begin{tikzcd}[ampersand replacement=\&]
                A \times \T{\e_1}{\T{\e_2}{B}} 
                \arrow [r, "\tstrength{\e_1}{A}{\T{\e_2}{B}}"]
                \arrow [dr, "\Id{A} \times \bind{\e_1}{\e_2}{B}"]
                \& 
                \T{\e_1}{(A \times \T{\e_2}{B})} 
                \arrow [r, "\T{\e_1}{\tstrength{\e_2}{A}{B}}"]
                \& 
                \T{\e_1}{\T{\e_2}{(A \times B)}} 
                \arrow [d, "\bind{\e_1}{\e_2}{A \times B}"]
                \\
                \&
                A \times \T{\e_1 \dot \e_2}{B}  
                \arrow [r, "\tstrength{\e_1 \dot \e_2}{A}{B}"] 
                \&
                \T{\e_1 \dot \e_2}({A \times B)}
            \end{tikzcd}
            };
\end{tikzpicture}
            \caption{How the tensor-strength natural transformation commutes with the join natural transformation.}
            \label{TensorStengthJoin}
        \end{minipage}
    
        \quad
        \begin{minipage}{0.45\textwidth}
            \begin{tikzcd}[ampersand replacement=\&]
                A \times B
                \arrow [r, "\Id{A} \times \point{B}"]
                \arrow [rd, "\point{A \times B}"]
                \&
                A \times \tob 
                \arrow [d, "\tstrength{\1}{A}{B}"]
                \\
                \&
                \T{\1}{(A \times B)}
            \end{tikzcd}
            \caption{How the tensor-strength natural transformation commutes with the unit natural transformation}
            \label{TensorStrengthPoint}
        \end{minipage}
\end{framed}
\end{figure}



\begin{figure}
    \centering
    \begin{framed}
        \centering
            \begin{tikzcd}[ampersand replacement=\&, column sep=huge]
                (A\times B)\times \T{\e}{C} 
                \arrow [rr, "\tstrength{\e}{(A\times B)}{C}"]
                \arrow [d, "\alpha_{A, B, \T{\e}{C}}"]
                \& \& \T{\e}{((A \times B)\times C)}
                \arrow [d, "\T{\e}{\alpha_{A, B, C}}"]
                \\
                A \times (B \times \T{\e}{C}) 
                \arrow [r, "\Id{A}\times\tstrength{\e}{B}{C}"]
                \&
                A\times\T{\e}{(B \times C)} 
                \arrow [r, "\tstrength{\e}{A}{(B \times C)}"]
                \& \T{\e}{(A \times (B \times C))}
                \\
            \end{tikzcd}
    \end{framed}
    \caption{Tensor strength commutes with the reordering natural transformation.}
    \label{TensorStrengthAlpha}
\end{figure}






\subsection{Adjunction}\label{WhatsAnAdjunction}
An important concept in category theory is that of an adjunction. An adjunction consists of functors $F: C\rightarrow D$, and  $G: D\rightarrow C$ and a pair of natural transformations, known respectively as the unit and co-unit: $\eta_A: A \rightarrow G(F A)$ in $\C$ and $\epsilon_B: F(G B) \rightarrow B$ in $\DC$, such that $\epsilon_{F A}\after F(\eta_A) = \Id{F A}$ and $G(\epsilon_B)\after \eta_{F B} = \Id{G B}$. We can then use $\epsilon$ and $\eta$ to form a natural isomorphism between morphisms in the two categories, as seen in Figure \ref{Adjunction}. This natural isomorphism is called an adjunction.


\begin{figure}
    \begin{framed}
    \begin{align*}
        \bar{(-)}: \quad\C(FA, B) &\leftrightarrow \DC(A, GB)   \quad: \widehat{(-)}\\
        f & \mapsto G(f)\after\eta_A \\
        \epsilon\after F(g) & \mapsfrom g\\
    \end{align*}
    \end{framed}
    \caption{How to construct the adjunction isomorphism from its unit and co-unit.}
    \label{Adjunction}
\end{figure}

\subsection{Strictly Indexed Category}\label{IndexedCategoryDefinition}

The final piece of category theory required to understand this dissertation is the concept of a strictly indexed category. A strictly indexed category is a functor from a \textit{base category} $\C$ into a target (\textit{indexed}) category of categories, where objects are categories and morphisms are functors. Objects, $A$, in the base category are mapped to categories $\C(A)$, known as \textit{fibres} in the indexed category. Morphisms between objects in the base category, $f: B\rightarrow A$, are contravariantly mapped to functors, written $f\star: \C(A)\rightarrow \C(B)$ and known as \textit{re-indexing functors}, between fibres in the indexed category. The strictly adverb indicates that the indexing in this construction is done by a functor as opposed to the weaker pseudofunctor (weak 2-functor) structure. Since pseudofunctors are not needed to explain anything in this project, I leave out their definition, though an interested reader may wish to research them further\footnote{https://ncatlab.org/nlab/show/pseudofunctor}. 


Due to the composition laws for functors, $\theta\star\after\phi\star = (\phi\after\theta)\star$ and $\Id{A}\star(B) = B\in\obj \C(A)$, and $\Id{}\star$ is the identity functor. For example, we may use the category of cartesian closed categories and functors that preserve the cartesian closed structure, ($\cccat$) indexed by a partial order, $\mathbb{P}$:

\begin{align*}
    I: \mathbb{P} & \rightarrow \cccat\qt{The indexing functor} \\
    A \in\obj\mathbb{P} & \mapsto \C \in\cccat\qt{Objects are mapped to categories}\\
    A \leq B & \mapsto (A \leq B)\star: \C \rightarrow \DC\qt{Morphisms are mapped to functors preserving CCC properties.}
\end{align*}

\section{Language Features and Their Requirements}\label{LanguageFeatureRequirements}


Different languages require different structures to be present in a category for the category to be able to interpret terms in the language. Using the concepts defined in Section \ref{CategoryTheoryRequirements}, I now give an introduction to which category-theoretic structures are required to interpret different language features. 

One of the simplest, while still interesting, languages to derive a denotational semantics for is the simply typed lambda calculus (STLC)\@. STLC's semantics require a cartesian closed category (CCC, see Section \ref{CCC}).

Products in the CCC are used to denote the lists of variable types in the type environments, exponential objects model functions, and the terminal object is used to derive representations of ground terms, such as the unit term, $()$, as well as the empty type environments.

\begin{itemize}
    \item Products are used to construct type environments. $\deno{\G} = \deno{\nil, x: A, y:B, ... z:C} = \1 \times \deno{A} \times \deno{B} \times ... \times \deno{C}$
    \item Terminal objects are used in the denotation of constant terms $\deno{\gtyperelation{\const{A}}{A}} = \deno{\const{A}}\after\term{\deno{\G}}$
    \item Exponentials are used in the denotations of functions. $\deno{\typerelation{\G}{\lam{x}{A}{v}}{\ab}} = \cur{\deno{\typerelation{\gax}{v}{B}}}$
\end{itemize}

From this, we can specify what structures categories need to have in order to model more complex languages.
\begin{center}
    \begin{tabular}{|c|c|}
        \hline
        Language Feature & Structure Required \\
        \hline
        \hline
        STLC            & CCC \\
        \hline
        If expressions and booleans   & Co-product of the terminal object with itself and subtyping \\
        \hline
        Single Effect   & Strong Monad \\
        \hline
        Multiple Effects & Strong Graded Monad \\
        \hline
        Polymorphism & Indexed Category \\
        \hline
    \end{tabular}
\end{center}

To model if-expressions of the form $\pifthenelse{}{\texttt{condition}}{\texttt{if_true}}{\texttt{if_false}}$, we need a way to combine morphisms of the form $\deno{\gtyperelation{\texttt{condition}}{\B}}: \G\rightarrow\deno{\B}$, $\deno{\gtyperelation{\texttt{if_true}}{A}}: \G\rightarrow A$, and $\deno{\gtyperelation{\texttt{if_false}}{A}}: \G\rightarrow A$ to form a morphism $\G\rightarrow A$. If we have a co-product $\G + \G$, and a morphism mapping $\B$s to $\G + \G$, we could use the fold morphism $[\deno{\texttt{if_true}}, \deno{\texttt{if_false}}]$ to achieve the required composite morphism. It turns out that using exponentials, as seen in the denotation of the (If) type rule in Figure \ref{TermDenotations}, we can factor out the $\G$ to instead use a co-product  $\1 + \1$ instead of $\G + \G$. It now a natural choice to use $\1 + \1$ as $\deno{\B}$. Hence we can model the boolean values $\t, \f$ as the co-product constructors $\inl, \inr$.

A single effect can be modelled by adding a strong monad to the category, as shown by Moggi \cite{MoggiMonads}. A language with an explicit monad in its type system requires two operations: \textit{return} and \textit{bind}, the type rules for which can be seen in Equation \ref{MonadTypeRules}. The $\M{}{(-)}$ type constructor represents values which have an instance of the effect associated with their computation. The \textit{return} operator lifts pure values (with no associated effects) into the effectful type constructor. The \textit{bind} operator (often supplemented with some \texttt{do .. in ...} syntax) allows us to compose together expressions which have effects. As shown by Moggi \cite{MoggiMonads}, these two operations can be modelled using the \textit{unit} and \textit{join} natural transformations of a strong graded monad. The monad needs to be strong in order to allow access to variables in the environment from within the monadic expression. An example of this can be seen in Figure \ref{MonadStrengthRequirement}. 

\begin{figure}
    \begin{framed}
        \textbf{Motivating the Tensor Strength Requirement}
        \begin{framed}
            \begin{lstlisting}[
                mathescape,
                columns=fullflexible,
                basicstyle=\fontfamily{lmvtt}\selectfont,
              ]
let $x$ = $5$ in (
    do $y$ $\texttt{<-}$ readInt in (
        return $x$ + $y$
    ) 
);
            \end{lstlisting}
        \end{framed}
        
In the \texttt{return} clause, the program makes reference to variables $x$ and $y$ from the environment. Since $x$ is defined inside the monadic \texttt{do} clause, it is not available to clauses in the body of the clause without a means to convert the type $(\G \times \M{}{A)}$ to $\M{}{(\G\times A)}$.
\end{framed}
   
\caption{Program in a monadic effectful language that requires tensor strength of the effect's monad to execute.}
\label{MonadStrengthRequirement}
\end{figure}

\begin{eqnarray}\label{MonadTypeRules}
    \ntreeruleI{\vreturn}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\M{}{A}}} & \ntreeruleII{\vbind}{\typerelation{\G}{v_1}{\M{}{A}}}{\typerelation{\gax}{v_2}{\M{}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{}{B}}}
\end{eqnarray}

For a more precise analysis of languages with multiple effects, we can look into whether there is an algebra on the effects. For example, we might want to express the composite effect of two sequential expressions with different effects. We could follow an expression that might throw an exception with one that accesses mutable state and a third that carries out IO transactions. We would also want some form of \textit{unit} effect for pure expressions which does nothing when composed with other effects. Finally, to make it systematically possible to analyse branched code, such as \textit{if expressions}, some form of subtyping would be useful. This structure is modelled exactly by an appropriate partially ordered monoidal algebra $(E, \dot, \subeffect, \1)$. The set $E$ gives the various effects that can be produced, $\1$ represents the unit effect for pure values, $\dot$ allows us to associatively compose multiple effects and the partial order  $\subeffect$ gives us a subtyping of effects for an intuitive if-statement programming model.

In order to embed this algebra-based effect analysis in the type system, we can index Moggi's monadic type constructor $\M{}{}$ with the effect $\e$ that is produced when the corresponding expression is evaluated. Furthermore, when we use the \textit{return} operation to lift pure values into the monadic type constructor, the resulting monadic type should have an index of $\1$ indicating that the effect produced is pure. Finally, when we \textit{bind} together effectful expressions, the resulting effect should be the composition of the effects of the subexpressions. Putting together these requirements transforms the type rules in Equation \ref{MonadTypeRules} to the new type rules given in Equation \ref{GradedMonadTypeRules}. By suitably extending the monad laws to account for this new indexing, we find that we require a strong graded monad to model these features using category theory. This construct was first documented in the context of semantics by Katsumata (\cite{Katsumata:2014}).

\begin{eqnarray}\label{GradedMonadTypeRules}
    \ntreeruleI{\vreturn}{\typerelation{\G}{v}{A}}{\typerelation{\G}{\return{v}}{\moa}} & \ntreeruleII{\vbind}{\typerelation{\G}{v_1}{\M{\e_1}{A}}}{\typerelation{\gax}{v_2}{\M{\e_2}{B}}}{\typerelation{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
\end{eqnarray}


When we combine an effect system with if-expressions, we come across another, language-level, issue. When programming using the construct, we might want the true and false branches of the expressions to have different effects. For example, one branch of an expression may perform I/O operations, whilst the other has no side effects. Since effect analysis is done by the type system, this means that the two branches have different types. Hence the typical type rule  for if-expressions, as given in Equation \ref{IfTypeRule}, is not applicable. A solution for this is to introduce a notion of subtyping, using a subtyping relation $\subtype$. If $\gtyperelation{v}{A}$ and $A \subtype B$, then $\gtyperelation{v}{B}$. Using the partial order on effects to generate the subtyping relation, we can now unify compatible, though not equal, effects in an if-expression.

\begin{equation}\label{IfTypeRule}
    \ntreeruleIII{\vif}{
        \gtyperelation{\texttt{condition}}{\B}
    }{
        \gtyperelation{\texttt{if_true}}{A}
    }{
        \gtyperelation{\texttt{if_false}}{A}
    }{
        \gtyperelation{
            \pifthenelse{}{
                \texttt{condition}
            }{
                \texttt{if_true}
            }{
                \texttt{if_false}
            }
        }{A}
    }
\end{equation}

To model subtyping, we need a way to convert morphisms $\deno{\gtyperelation{v}{A}}: \G\rightarrow A$ to $\deno{\gtyperelation{v}{B}}:\G\rightarrow B$ when $A\subtype B$. This can be done if for each instance of $A\subtype B$, we have a there is morphism $\deno{A\subtype B}: A \rightarrow B$. These morphisms should respect the transitivity and reflexivity of the subtyping relation, meaning that $\deno{B\subtype C}\after\deno{A\subtype B} = \deno{A\subtype C}$ and $\deno{A\subtype A} = \Id{A}$.

Polymorphism is a harder concept to explain intuitively. The particular flavour of polymorphism that this dissertation discusses is System-F-style parametric polymorphism. For a given type-system feature $G$, such as types, effects, type constructors, or some other language specific feature, we can add parametric polymorphism over $G$ by allowing $G$ variables to occur in expressions and introducing expression terms to indicate when these $G$ variables are introduced and when they are eliminated. For example, let us look at system F \cite{SystemFIntroduction}. System F has polymorphism over types. This means that we can replace a type expression with a type variable parameter. We also need to be able to syntactically generalise over type parameters and to be able to specify a particular type parameter's value. This requires us to extend the syntax of the simply typed lambda calculus with the appropriate specialisation and generalisation terms as well as parameterised types, as seen in Figure \ref{SystemFTermsTypes}.

\begin{figure}
    \begin{framed}
        \centering
        \textbf{System F}

        Types are extended with type variables and parameterisation.
        \begin{align*}
            A \gens ... \mid \a\mid \all{\a}{A}
        \end{align*}

        Values are extended with generalisation and specialisation terms respectively.
        \begin{align*}
            v \gens ... \mid \elam{\a}{t}\mid \eapp{t}{A}
        \end{align*}
    \end{framed}
    \caption{The extensions made to the simply typed lambda calculus which yield System F}
    \label{SystemFTermsTypes}
\end{figure}

To correctly account for these new terms and types in the type system, we need to ensure that all parameterisations are soundly constructed, in a similar way to how a closed term in the simply typed lambda calculus has no free variables. To do this, we introduce a new $F$-environment $\P$ to complement the type environments $\G$. A term or type is well formed (written $\wellformedF{\P}{f}$) only if it only contains $F$ variables in $\P$. An $F$ expression, $f$, is also well formed only if it only contains $F$ variables in $\P$. We can now specify type rules for the generalisation (parameterisation of an expression over an $F$-variable) and specialisation (substituting a parameter for a value) of terms. As seen in Equation \ref{PolymorphismTypeRules}.

\begin{eqnarray}\label{PolymorphismTypeRules}
    \condtreeruleI{\vgen}{\etyperelation{\P, \a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}{\a\notin\P}& 
    \ntreeruleII{\vspec}{\gpetyperelation{v}{\all{\a}{A}}}{\wellformedF{\P}{f}}{\gpetyperelation{\eapp{v}{f}}{A\ssub{\a}{f}}}
\end{eqnarray}

If we can model the language without the polymorphic terms in Equation \ref{PolymorphismTypeRules}, at each specific $F$ environment, then we can instantiate a collection of categories, each of which models the language at a given $F$ environment. This collection of categories (which we call \textit{fibres}) can be indexed by a base category, the structure of which models the $F$ environments and relationships between them. We can hence construct an indexed category, whereby each $F$ environment in the base category is mapped to the fibre modelling the semantics at the specific environment, and morphisms between $F$ environments correspond to functors between the respective fibres. Figure \ref{IndexDiagram} demonstrates this construction. If we model an $F$ environment $\P, \a$ as a product, then the $\p$ morphism represents removing $\a$ from the environment and the $\pstar$ functor conversely increases the size of the environment. As will be show later in this dissertation, if $\pstar$ has a right adjoint (see Section \ref{WhatsAnAdjunction}), $\forall$, then this adjunction can be used to model generalisation and specialisation of polymorphic terms. This will be explained in the next chapter. 

How the fibres are derived from objects in the base category depends on the polymorphic properties of the language being modelled. For example, in system F, types are impredicative. That is, types can quantify over any other types, including themselves. This means that there has to be a strong coupling between the base category, which represents type-variable environments and transformations upon them and objects in the fibres, which represent types. This typically manifests in the set of objects  in each fibre being in bijection with the set of morphisms from the appropriate type-variable environment in the base category. Since, in effect-polymorphic languages, types quantify over effects, but effects do not quantify over themselves, we can conceptually decouple the objects in the fibres from the base category, meaning that effect-polymorphic models are simpler to define. 

In this dissertation, I show how these category-theoretic building blocks can be put together to give the class of categories that can model polymorphic effect systems.

\begin{figure}[ht!]
    \scalebox{0.9}{
        \begin{tikzpicture}[->,>=stealth']]
            % Draw the env objects
            \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {3, 4, 5, 6}{
                \node[fill,circle,inner sep=2pt,label=left:{\small $\P_\yi$}] (d\yi) at (0,\y) {};
            }
    
            % draw the ... above the env objects
            \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {7, 7.5, 8}{
                \node[fill, circle, inner sep=1pt] (dd\yi) at (0,\y){};
            }
            % Draw the index category
            \node[fit=(d0) (d1) (d2) (d3) (dd0) (dd1) (dd2),ellipse,draw,minimum width=2cm] {};
    
            %draw the s-category stack
            \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {2, 4, 6, 8}{
                \node[circle, draw, inner sep=1pt, fill, label=above:{$\G$}] (g\yi) at (7,\y){};
                \node[circle, draw, inner sep=1pt, fill, label=above:{$A$}] (a\yi) at (9,\y){};
                \draw[->](g\yi) to[bend right=5] node[below]{\tiny $\deno{\etyperelation{\P_\yi}{\G}{v}{A}}$} (a\yi);
                \node[ellipse, draw, minimum width=5cm, minimum height=15mm,label=right:$S_\yi$] (s\yi) at (8,\y){};
            }
    
            % Hidden ellipse to draw functors to
            \node[ellipse, minimum width=5cm, minimum height=15mm] (s4) at (8,10){};
    
            %Draw the ... for the s-category stack
            \foreach \y[count=\c,evaluate={\yi=int(\c-1)}] in {9.5, 10, 10.5}{
                \node[fill, circle, inner sep=1pt] (p\yi) at (8, \y){};
            }
    
            % Draw index arrows
            \foreach \i in {0, 1, 2, 3}{
                \draw[->, very thick] (d\i) to (s\i);
            }
    
            % draw the re-indexing functors
    
            \foreach \source[count=\dest] in {0, 1, 2, 3}{
                \draw[->, very thick](s\source.north west) to[bend left=10] node[left]{$\pstar$} (s\dest.south west);
            }
    
            % Draw the quantification functors
            \foreach \dest[count=\source] in {0, 1, 2, 3}{
                \draw[->, very thick] 
                (s\source.south east) to[bend left=10] node[right]{$\forall_{\P_\dest}$} (s\dest.north east);
            }
    
            % Draw the internal morphisms in base category
            \foreach \dest[count=\source] in {0, 1, 2}{
                \draw[->]
                (d\source) to[bend right=10] node[right]{$\p$} (d\dest);
            }
    
            %Draw the bracket
    
            \draw [decoration={brace,amplitude=8pt},decorate] ($(s3)+(10em,1ex)$) -- ($(s0)+(10em,-1ex)$);
            \node[text width=20mm] (Label) at (14,5){Fibres for each effect-variable environment};
        \end{tikzpicture}
    }
    
    \caption{Diagram of the structure of an indexed category for modelling a polymorphic language. Thick arrows between categories represent functors and thinner arrows withing categories represent internal morphisms. The left-hand category is the base category.
    }
    \label{IndexDiagram}
\end{figure}


\section{The Effect Calculus}
\label{ECDefinition}
The basic effect calculus is an extension of the simply typed lambda calculus to include constants, \texttt{if} expressions, effects, and subtyping. It has terms of the following form:

\begin{align*}
    v ::= \const{A} \mid x\mid \t \mid\f \mid\u\mid\lam{x}{A}{v}\mid\apply{v_1}{v_2}\mid\return{v}\mid\doin{x}{v_1}{v_2}\mid\pifthenelse{A}{v}{v_1}{v_2} 
\end{align*}

Here, $\const{A}$ is one of collection of constants, and $A$ ranges over the types:

\begin{align*}
    A, B, C ::= \g\mid \ab \mid\M{e}{A}
\end{align*}

Here $\g$ is from a collection of ground types, including $\U, \B$, and $e$ ranges over partially ordered monoid of effects: $(E, \dot, \subeffect, \1)$.

The calculus has a simple, Haskell-style semantics. Lambda terms when applied to a parameter substitute their bound variable for the parameter expression, as seen in Figure \ref{ECBeta}, if statements pick a branch once their condition is decided to be true or false, Figure \ref{ECIf}, and finally the monadic effects behave in a similar way to Haskell's monad type class. It is difficult to simply formalise an operational $\beta\eta$-reduction semantics for a monadic language without a concrete instantiation of the graded monad. Instead, the monad should obey the equational laws given in Figure \ref{ECMonads}.


\begin{figure}
    \begin{framed}
        \begin{align*}
            \apply{(\lam{x}{A}{v_1})}{v_2} & \rightsquigarrow v_1\ssub{x}{v_1}
        \end{align*}
    \end{framed}
    \caption{The $\beta$ reduction lambda terms of lambda terms in the effect calculus.}
    \label{ECBeta}
\end{figure}

\begin{figure}
    \begin{framed}
        \begin{align*}
            \pifthenelse{A}{\t}{v_1}{v_2} & \rightsquigarrow v_1\\
            \pifthenelse{A}{\t}{v_2}{v_2} & \rightsquigarrow v_2\\
        \end{align*}
    \end{framed}
    \caption{The reduction of if expressions in the effect calculus.}
    \label{ECIf}
\end{figure}


\begin{figure}
    \begin{framed}
        \begin{align*}
            \doin{x}{\return{v_1}}{v_2} & \rightsquigarrow v_2\ssub{x}{v_1}\\
            \doin{x}{v}{\return{x}} & \rightsquigarrow v\\
            \doin{x}{v_1}{(\doin{y}{v_2}{v_3})} 
            & \leftrightsquigarrow\quad  \doin{y}{(\doin{y}{v_1}{v_2})}{v_3}
        \end{align*}
    \end{framed}
    \caption{The monad laws for the effect calculus.}
    \label{ECMonads}
\end{figure}



As an example, by instantiating the language with the appropriate constants, ground effects, and ground types, we can write the programs in Figure \ref{CheckExample}.

\begin{figure}
    \centering
    \begin{minipage}{0.45\textwidth}
        \begin{framed}
            \begin{lstlisting}[
                mathescape,
                columns=fullflexible,
                basicstyle=\fontfamily{lmvtt}\selectfont,
              ]
do $b$ $\texttt{<-}$ Prompt("Are You Sure?") in (
    if $b$ then
        FireMissiles
    else
        AbortMissiles
)
            \end{lstlisting}        
        \end{framed}
    \end{minipage}
    \quad
    \begin{minipage}{0.45\textwidth}
        \begin{framed}
            \begin{lstlisting}[
                mathescape,
                columns=fullflexible,
                basicstyle=\fontfamily{lmvtt}\selectfont,
              ]
$\lambda$ $alice$: Agent. (
    $\lambda$ $bob$: Agent. (
    do $amount$ $\texttt{<-}$ AwaitPayment($alice$)
    in SendPayment($bob$, $amount$)
    )
)
              \end{lstlisting}
        \end{framed}
    \end{minipage}
    \caption{A pair of examples of non-polymorphic programs}
    \label{CheckExample}
\end{figure}



Already, we can see where having effect polymorphism in the language would be useful. We could make the first example in Figure \ref{CheckExample} into a more general procedure that prompts a user to confirm any IO action, as can be seen in the extended example in Figure \ref{PolymorphicCheckExample}.

\begin{figure}
\begin{framed}
    \begin{lstlisting}[
        mathescape,
        columns=fullflexible,
        basicstyle=\fontfamily{lmvtt}\selectfont,
      ]
$\Lambda$ $\mathit{Action}$: Effect. 
$\lambda$ $\mathit{ifConfirmed}$: $\mathit{Action}$.
$\lambda$ $\mathit{ifAborted}$: $\mathit{[Action}$.
do $b$ $\texttt{<-}$ Prompt("Are You Sure?") in (
    if $b$ then 
        $\mathit{ifConfirmed}$ 
    else
        $\mathit{ifAborted}$
)
    \end{lstlisting}        
\end{framed}
\caption{A polymorphic version of the checking example}
\label{PolymorphicCheckExample}
\end{figure}


\section{Polymorphic Effect Calculus}

Next, we consider the Effect Calculus extended with terms to allow System-F-style polymorphism over effects. We call this the Polymorphic Effect Calculus (PEC).

\begin{figure}[H]
    \centering
    \begin{framed}
        
\[
    v::=\text{..}\mid\elam{\a}{v}\mid\eapp{v}{\e}
    \quad\quad
    A, B, C::=\text{...}\mid \all{\a}{A}\mid\mea
    \quad\quad
    \e ::= e \mid \a \mid \e\dot\e
\]
    \end{framed}
    \caption{The extension to the grammar of EC which yields PEC}
    \label{PECExtension}
\end{figure}

\subsection{Type System}
\subsubsection{Environments}
As mentioned before, expressions can now include effect variables. These are managed in the type system using a well-formed effect-variable environment $\P$, which is a snoc-list.

\begin{align*}
    \P ::= \nil \mid \P, \a
\end{align*}



\subsubsection{Effects}
The ground effects form the same monotonic, partially ordered monoid $(E, \dot, \1, \subeffect)$ over ground elements $e$ as in EC (Section \ref{ECDefinition}). However, we now want to be able to reason about effects that contain polymorphic variables. As a  result, we need to be able reason about effect expressions in a symbolic fashion. As a result, we construct a new partially ordered monoid over effects with variables in a effect-variable environment $\P$, written $(E_\P, \dotp, \subeffectp, \1)$. To understand this structure, we consider a simple, extensional equational equivalence: $\zpberelation{\e_1}{\e_2}{\effect}$, defined in Figure \ref{EffectEquivalence}. The set $E_\P$ consists of expressions generated, up to equational equivalence, from the grammar given in Figure \ref{PECExtension} where $\a$ ranges over variables in $\P$.

\begin{figure}[H]
    \centering
    \begin{framed}
        \begin{align}
            \zpberelation{\e_1}{\e_2}{\effect} & \Leftrightarrow \forall \si\in\groundEffects.\s\e_1\ssi = \e_2\ssi
        \end{align}
    \end{framed}
    
    \caption{Equational equivalence of effects with respect to an effect-variable environment. $\groundEffects$ is defined to be the set of ground-effect substitutions.}
    \label{EffectEquivalence}
\end{figure}
Now we can define the monoid operator. 
\begin{framed}
    \begin{definition}[Polymorphic Effect Monoid]
        $$\e_1\dotp\e_2 = \e_3 \Leftrightarrow \forall \si\in\groundEffects.\s (\e_1\ssi \dot \e_2\ssi = \e_3\ssi)$$ 
    \end{definition}
\end{framed}

This choice of operator preserves any identity or annihilator elements in ground monoid. To define the $\subeffectp$ relation, we must again take inspiration from the substitution-based equivalence. 


\begin{framed}
    
\begin{definition}[Polymorphic Subeffecting]
    $$\e_1\subeffectp\e_2\Leftrightarrow \forall\si\in\groundEffects.\s\e_1\ssi\subeffect\e_2\ssi$$
    
\end{definition}

\end{framed}
This subeffecting relation preserves ground effect structures such as a \textit{top} effect, which has all effects as subeffects. Where it is obvious from the context, I use $\dot$ instead of $\dotp$.


\subsubsection{Types}
As stated, types are now generated by the grammar below. Note that $\g$ ranges over the ground types of a particular instantiation of PEC.

$$ A, B, C \gens \ground \mid \ab \mid \mea \mid \all{\a}{A}$$
  
\subsubsection{Type Environments}
As is often the case in similar type systems, a type environment is a snoc list of (term-variable, type) pairs, $\G \gens \nil \mid \gax$.

\begin{framed}
    \begin{definition}[Domain Function on Type Environments]
        \[
        \dom{\nil} = \emptyset
        \quad\quad\quad
        \dom{\gax} =  \dom{\G}  \cup \left\{x \right\}
    \]
    
    \end{definition}      
\end{framed}


\subsubsection{Well-Formedness Predicates}


To formalise properties of the type system, it will be useful to have a collection of predicates ensuring that structures in the language are well behaved with respect to their use of effect variables. We write $\a \in \P$ if $\a$ appears in the list represented by $\P$.

The $\okt$ predicate (Figure \ref{EffectEnvOk}) on effect-variable environments asserts that the effect-variable environment does not contain any duplicated effect variables. Using this, we can define the well-formedness relation on effects, $\wellformedeffect{\P}{\e}$ (Figure \ref{EffectWellformednes}). In short, this relation ensures that effects only reference variables that are in the effect-variable environment. This is equivalent to saying that $\wellformedeffect{\P}{\e}$ means that $\e\in E_\P$.

\begin{figure}[H]
    \centering
    \begin{framed}
        \[
    \ntreerulez{\pnil}{\ok{\nil}}
\quad
    \condtreeruleI{\pextend}{\ok{\P}}{\ok{\P, \a}}{\a\notin \P}
\]
    \end{framed}
    
    \caption{The \okt\s predicate on effect-variable environments}
    \label{EffectEnvOk}
\end{figure}


\begin{figure}[H]
    \centering
    \begin{framed}
        \[
    \ntreeruleI{\eground}{\ok{\P}}{\wellformedeffect{\P}{e}}
    \quad
    \ntreeruleI{\evar}{\ok{\P,\a}}{\wellformedeffect{\P,\a}{\a}}
    \] 
    
    \[
    \condtreeruleI{\eweaken}{\wellformedeffect{\P}{\a}}{\wellformedeffect{\P,\b}{\a}}{\a\neq\b, \b\notin\P}
    \quad
    \ntreeruleII{\ecompose}{\wellformedeffect{\P}{\e_1}}{\wellformedeffect{\P}{\e_2}}{\wellformedeffect{\P}{\e_1\dot\e_2}}
\]
    \end{framed}
    
    \caption{The well-formedness relation on effects}
    \label{EffectWellformednes}
\end{figure}



The well-formedness of effects can be used to a similar well-typed-relation on types, $\wellformedtype{\P}{A}$, which asserts that all effects in the type are well formed (Figure \ref{TypeWellformedness}). 
Finally, we can derive the a well-formedness of type environments,   $\oke{\P}{\G}$, which ensures that all types in the environment are well formed (Figure \ref{TypeEnvWellformedness}).

\begin{figure}[H]
    \centering
    \begin{framed}
        
\[
    \ntreeruleI{\tground}{\ok{\P}}{\wellformedtype{\P}{\g}}
    \quad
    \ntreeruleII{\tfun}{\wellformedtype{\P}{A}}{\wellformedtype{\P}{B}}{\wellformedtype{\P}{\ab}}
\] 

\[
    \ntreeruleII{\teffect}{\wellformedtype{\P}{A}}{\wellformedeffect{\P}{\e}}{\wellformedtype{\P}{\mea}}
    \quad
    \ntreeruleI{\tquant}{\wellformedtype{\P,\a}{A}}{\wellformedtype{\P}{\all{\a}{A}}}
\]
    \end{framed}    
    \caption{The well-formedness relation on types}
    \label{TypeWellformedness}
\end{figure}

\begin{figure}[H]
    \centering
\begin{framed}
    \[
        \ntreerulez{\envnil}{\oke{\P}{\nil}}
        \quad
        \condtreeruleI{\envextend}{\oke{\P}{\G}\s\s \wellformedtype{\P}{A}}{\oke{\P}{\gax}}{x\notin\dom{\G}}
    \]    
\end{framed}
    \caption{The well-formedness relation on type environments}
    \label{TypeEnvWellformedness}
\end{figure}

\subsubsection{Subtyping}

We assume that the set of ground types ($\g$) has a subtyping partial order relation $\subtype_{\ground}$. This subtyping relationship could be the trivial partial order, which only includes $A\subtypeg B$ if $A = B$, or could be a more interesting relation. As this relationship is a partial order, it is antisymmetric, transitive and reflexive (Figure \ref{GroundSubtyping}).

\begin{figure}[H]
    \centering
\begin{framed}
    \[
        \ntreerulez{\sreflexive}{A \subtype_{\ground} A}
        \quad
        \ntreeruleII{\stransitive}{A \subtype_{\ground} B}{B \subtype_{\ground} C}{A \subtype_{\ground} C}
    \]
\end{framed}
    \caption{Ground subtyping rules.}
    \label{GroundSubtyping}
\end{figure}
    

Using this ground type relation, we can then construct a subtyping relation between pairs of types $A, B$ with respect to an effect-variable environment $\P$ (Figure \ref{FullSubtypingDefinition}).

\begin{figure}[H]
    \centering

    \begin{framed}
    
\[
    \scalebox{0.85}{$
    \ntreeruleI{\sground}{A \subtype_{\ground} B}{A \subtypep B}
    \quad
    \ntreeruleII{\sfun}{A \subtypep A'}{B' \subtypep B }{\fntype{A'}{B'} \subtypep \ab}
    $}
    \]
    
    \[\scalebox{0.85}{$
    \condtreeruleI{\squant}{A\subtypep A'}{\all{\a}{A}\subtypepa\all{\a}{A'}}{\a\notin\P}
    \quad
    \ntreeruleII{\seffect}{A\subtypep B}{ \e_1\subeffectp\e_2}{\M{\e_1}{A}\subtypep\M{\e_2}{B}}
    $}
\]      
    \end{framed}
  

    \caption{The extension of ground subtyping to the full subtyping relation.}
    \label{FullSubtypingDefinition}
\end{figure}

Since the ground subtyping and subeffecting relations are partial orders, it is fairly simple to prove by induction that the new relation is also a partial order. By induction, it is also easy to prove that if $A \subtypep B$ and $\wellformedtype{\P}{A}$ then $\wellformedtype{\P}{B}$. This last property comes about because the subeffecting relation $\subeffectp$ only holds between effects in $E_\P$, which are well formed by definition.


\subsubsection{Type Rules}
We define a fairly standard set of type rules on the language (Figure \ref{TypeRules}).


\begin{figure}[H]
    \centering
    \begin{framed}
        
\[
    \scalebox{0.85}{$
    \ntreeruleII{\vconst}{\oke{\P}{\G}}{\wellformedtype{\P}{A}}{\gpetyperelation{\const{A}}{A}} 
    \quad
    \ntreeruleI{\vunit}{\oke{\P}{\G}}{\gpetyperelation{\u}{\U}} 
    \quad
    \ntreeruleI{\vtrue}{\oke{\P}{\G}}{\gpetyperelation{\t}{\B}}
    \quad
    \ntreeruleI{\vfalse}{\oke{\P}{\G}}{\gpetyperelation{\f}{\B}}
    $}
\]
\[
    \scalebox{0.85}{$
\ntreeruleI{\vvar}{\oke{\P}{\gax}}{\etyperelation{\P}{\gax}{x}{A}}
\quad
\condtreeruleII{\vweaken}{\etyperelation{\P}{\G}{x}{A}}{\wellformedtype{\P}{B}}{\etyperelation{\P}{\gby}{x}{A}}{x \neq y, y\notin\dom{\G}}
\quad
\ntreeruleI{\vfun}{\etyperelation{\P}{\gax}{v}{B}}{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
$}
\]
\[
    \scalebox{0.85}{$
    \ntreeruleII{\vsubtype}{\etyperelation{\P}{\G}{v}{A}}{A \subtypep B}{\etyperelation{\P}{\G}{v}{B}}
    \quad
    \ntreeruleI{\vgen}{\etyperelation{\P,\a}{\G}{v}{A}}{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}}
    \quad
    \ntreeruleII{\vspec}{\gpetyperelation{v}{\all{\a}A}}{\wellformedeffect{\P}{\e}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
    $}
\]
\[
    \scalebox{0.85}{$
    \ntreeruleI{\vreturn}{\gpetyperelation{v}{A}}{\gpetyperelation{\return{v}}{\moa}}
    \quad
    \ntreeruleII{\vapply}{\gpetyperelation{v_1}{\ab}}{\gpetyperelation{v_2}{A}}{\gpetyperelation{\apply{v_1}{v_2}}{B}}
    $}
\]
\[
    \scalebox{0.85}{$
    \ntreeruleIII{\vif}{\gpetyperelation{v}{\B} }{ \gpetyperelation{v_1}{A}}{\gpetyperelation{v_2}{A}}{\gpetyperelation{\pifthenelse{A}{V}{v_1}{v_2}}{A}}
    \quad
    \ntreeruleII{\vbind}{\gpetyperelation{v_1}{\M{\e_1}{A}}}{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}{\gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}}
    $}
\]        
    \end{framed}
    \caption{The type rules for PEC}
    \label{TypeRules}
\end{figure}

\subsubsection{Ok Lemmas}

\begin{framed}
    
    \begin{lemma}[Ok Lemma on Type Environments]
        If $\gpetyperelation{v}{A}$ then $\oke{\P}{\G}$.
    \end{lemma}
    \begin{proof}
        If $\oke{\P}{\gax}$ then by inverting (See Figure \ref{InversionPrinciple}) the $\okt$ rule, we have $\oke{\P}{\G}$ 
    
        Only the type rule (\textit{\envextend}) adds terms to the environment from its preconditions to its postcondition and it does so in an $\okt$ preserving way. Any type derivation tree has at least one leaf. All leaves are axioms which require $\oke{\P}{\G}$. All non-axiom derivations preserve the $\okt$ property.
        $$\square$$
    \end{proof}
    
\end{framed}



\begin{framed}
    \begin{lemma}[Ok Lemma on Effect-Variable Environments]
        A second group of lemmas is that each of the judgments  $\wellformedeffect{\P}{\e}$, $\wellformedtype{\P}{A}$, and $\oke{\P}{\G}$ implies $\ok{\P}$.
    \end{lemma}
    
    \begin{proof}
        We prove each of the implications separately, but an over-arching theme of this proof is that the leaf rules of any $\wellformedtype{\P}{\texttt{Consequence}}$ derivation tree require $\ok{\P}$ and that any modifications to the effect-variable environment in the assumptions to the effect-variable environment in the consequence of a rule preserve the $\okt$ relation. Hence, using induction and inversion, we can show that the effect-variable environment is always well formed in any complete derivation tree.
    
        Firstly in the case of the well-formedness relation $\wellformedeffect{\P}{\e}$, the only leaf rules are the (\textit{\eground}) and (\textit{\evar}) rules. By inversion, if $\wellformedeffect{\P}{e}$ or $\wellformedeffect{\P, \a}{\a}$ then $\ok{\P}$ or $\ok{\P, \a}$ respectively. Next, by inversion on the (\textit{\ecompose}) rule, if $\wellformedeffect{\P}{\e_1\dot\e_2}$ then $\wellformedeffect{\P}{\e_1}$, so by induction $\ok{\P}$. Finally, the weakening rule preserves the $\okt$ property of the effect-variable environment, so $\wellformedeffect{\P, \b}{\a} \implies \wellformedeffect{\P}{\a} \implies \ok{\P} \implies \ok{(\P, \b)}$.
    
        Secondly, in the case of the well formedness relation on types, the only leaf rule is (\textit{\tground}). If $\wellformedtype{\P}{\g}$, then by inversion, $\ok{\P}$. Similarly to the (\textit{\ecompose}) rule for effects, the (\textit{\tfun}) rule's preconditions have the same effect-environment, so $\ok{\P}$ holds by inversion and induction. By inversion on the (\textit{\teffect}) rule, $\wellformedeffect{\P}{\e}$ so $\ok{\P}$. Finally the (\textit{\tquant}) rule preserves $\okt$ in a similar way to the (\textit{\eweaken}) rule above.
    
        Finally, if $\oke{\P}{\gax}$ then, by inversion, $\wellformedtype{\P}{A}$  and $\oke{\P}{\G}$. Since $\G$ is finite, $\oke{\P}{\nil}$. By inversion of the (\textit{\envnil}) rule, $\ok{\P}$.

        $$\square$$
    \end{proof}
    
\end{framed}


\begin{figure}
    \begin{framed}
        \textbf{Inversion in Inductive Proofs}

        In proofs involving assumptions with multiple inductive rules, a useful property is that of inversion. This allows us to case split over the inductive rule that generated the assumption and can allow us to infer the structure of the term.

        For example, consider a theorem which assumes $\gpetyperelation{v}{B}$, then we can case split over the type rules. If $\gpetyperelation{v}{B}$ was generated by the (\textit{\vapply}) rule (\ref{InversionExample}), then by inspecting the rule, we can infer that there exist two subterms $\gpetyperelation{v_1}{\ab}$, $\gpetyperelation{v_2}{A}$ such that $v = \apply{v_1}{v_2}$. 

        \begin{equation}\label{InversionExample}
            \ntreeruleII{\vapply}{\gpetyperelation{v_1}{\ab}}{\gpetyperelation{v_2}{A}}{\gpetyperelation{\apply{v_1}{v_2}}{B}}
        \end{equation}
        Then we might use the inferred subexpressions $v_1, v_2$ to prove the theorem in this case.
    \end{framed}
    \caption{An explanation of the concept of inversion.}
    \label{InversionPrinciple}
\end{figure}


\chapter{The Semantics of PEC in an Strictly Indexed Category}
In this chapter, I  describe the category structure required to interpret an instance of PEC\@. I then present denotations of each type of structure in the language, such as types, effects, terms, substitutions, and environment weakenings. Finally, I provide outlines and interesting cases of the proofs of the lemmas leading up to and including soundness of the semantics with respect to a $\beta\eta$-conversion-based equational equivalence. However, firstly I give a brief treatment to the semantics of EC.


\section{Semantics for EC in an S-Category}\label{SCategoryIntro}

As suggested in Section \ref{LanguageFeatureRequirements}, since EC contains multiple effects, STLC terms, and \texttt{if} expressions, we should be able to interpret its semantics in a cartesian closed category with an appropriate strong graded monad and the co-product $\1 + \1$, which models the type of booleans. With the addition of some extra category structure to handle subtyping, which I explain shortly, it is indeed possible to interpret EC. This section contains a fairly high-level treatment of the semantics. This is because the concepts introduced are a subset of those required for the semantics of PEC, which I explain in more detail in Section \ref{PECDenotations}. Semantics for similar languages to EC have also been given using an S-category-style construct, such as by Katsumata \cite{Katsumata:2014}. 

In order to model a given instantiation of EC, that is an EC with a collection of effects, constants, and ground types, there should be a collection of objects in the category to represent the ground types. There should also be a \textit{point} morphism (a morphism from the terminal object to the appropriate type) for each constant. In addition to the previously stated requirements, we also require the category, $\C$, to be able to model subtyping. 

If a cartesian closed category has a morphism to represent each instance of  ground subtyping relation $A\subtypeg B$ and a natural transformation to represent each instance of the subeffect relation $\e_1\subeffect \e_2$, then using the cartesian closed structure of the category, all instances of the general subtyping relation can be modelled. This is explained in Section \ref{PECDenotations}.

From this point onwards, I refer to a category that fulfills these properties of having a strong graded monad, CCC, ground objects and points, subeffect natural transformations, and a co-product $\1 + \1$ as an \textit{S-Category} (Semantic Category).

\begin{framed}
    \begin{definition}[S-Category for an EC Instance]\label{SCategoryDefinition}   
        An S-category for a given instance of the effect calculus is a category that satisfies the following requirements.
        \begin{enumerate}[label=\roman*.]
            \item The category is cartesian closed.
            \item The category has a co-product for the terminal object ($\1 + \1$).
            \item The category has a graded monad indexed by the effect monoid of the EC instance.
            \item The category has an object $\deno{\g}$ for each ground type $\g$ in EC.
            \item The category has a \textit{point} morphism $\deno{\const{A}}: \1\rightarrow \deno{A}$ for each constant in EC. The object $\deno{A}$ is defined in section \ref{PECDenotations}.
            \item For each instance of the ground subtyping relation, $A \subtypeg B$, there exists a morphism between the objects representing the ground types $A$ and $B$.
            \item For each instance of $\e_1 \subeffect \e_2$, there should exist a natural transformation $\db{\e_1\subeffect\e_2}: \T{\e_1}{}\rightarrow\T{\e_2}{}$ such that it has interactions with the graded monad as specified in Figures \ref{SubeffectTensorStrength}, \ref{SubeffectBind}.
        \end{enumerate}
    \end{definition}
\end{framed}

A full derivation and proof of soundness of the semantics of the Effect Calculus can be found online on my github repository\footnote{\url{https://github.com/Al153/Part3Project/blob/master/diss/OnlineECSemantics.pdf}} as it is too long to include here and many of the concepts are explained later in the remainder of this dissertation anyway. The categorical semantics of the Effect Calculus requires an S-category not only to simply model all of the features of EC but also to use the various commutivity diagrams and rules to manipulate the expressions encountered when proving properties of the semantics. Again, as all these manipulations are also applied when proving the semantics of PEC, I shall not go into further detail here.



\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
    \begin{tikzcd}[ampersand replacement=\&, column sep=huge]
        A \times \T{\e_1}{B} \arrow [r, "\Id{A} \times \dse{\e_1}{\e_2}_B"] \arrow [d, "\tstrength{\e_1}{A}{B}"] \&
        A \times \T{\e_2}{B} \arrow [d, "\tstrength{\e_2}{A}{B}"] \\
        \T{\e_1}{(A \times B)} \arrow [r, "\dse{\e_1}{\e_2}_{ A \times B}"] \&
        \T{\e_2}{(A \times B)} 
    \end{tikzcd}\qquad
    \caption{The interaction of the subeffect natural transformation with the tensor-strength natural transformation.}
    \label{SubeffectTensorStrength}
\end{minipage}  
\quad
\begin{minipage}{0.45\textwidth}
\scalebox{0.8}{    
\begin{tikzcd}[ampersand replacement=\&]
    \T{\e_1}{\T{\e_2}{}} 
    \arrow [rr, "\T{\e_1}{\deno{\e_2\subeffect\e_2'}
    }"]
    \arrow [d, "\bind{\e_1}{\e_2}{}"]
    \&  \&
    \T{\e_1}{\T{\e_2'}{}}
    \arrow [rr, "\db{\e_1 \subeffect\e_1'}_{M, \T{\e_2'}{}}"]
    \& \&
     \T{\e_1'}{\T{\e_2'}{}} 
     \arrow [d, "\bind{\e_1'}{\e_2'}{}"]
     \\
    \T{\e_1\dot\e_2}{}
    \arrow [rrrr, "\deno{\e_1\dot\e_2\subeffect\e_1'\dot\e_2'}"]
    \& \&
     \& \&
    \T{\e_1'\dot\e_2'}{}
\end{tikzcd}
}
\caption{The interaction of the subeffect natural transformation with the graded monad join natural transformation.}
\label{SubeffectBind}
\end{minipage}  
\end{figure}


\section{Required Category Structure}\label{PECRequirements}

In order to model the polymorphism of PEC, we need to now look at an indexed category. This consists of a base category, $\C$ in which we can interpret the possible effect-variable environments in, and a mapping from objects in the base category to S-categories in the category of S-categories. This mapping is denoted from this point onwards as $\C(-)$ and the induced categories $\C(\deno{\P})$ are called \textit{fibres}. To extend our mapping $\C(-)$ to a contravariant functor, as required in Section \ref{IndexedCategoryDefinition}, it needs to map morphisms in the base category $\C$ to functors between fibres. In particular, all functors derived from $\C$ must be \textit{S-preserving} (Definition \ref{SPreservingDefinition}). Thus, each morphism $\theta: \deno{\P'}\rightarrow\deno{\P}$ in $\C$ should induce an S-preserving, re-indexing functor $\theta\star: \C(\deno{\P})\rightarrow\C(\deno{\P'})$ between the fibres.


\begin{framed}
    \begin{definition}[S-Preserving Functor]\label{SPreservingDefinition}
        A functor $F$ preserves the properties of S-categories if it preserves each of the features within an S-category (Definition \ref{SCategoryDefinition}).  For example $F(A\times B) = (FA)\times (FB)$. For a full list of properties that an S-preserving functor should preserve, please see Appendix \ref{AppendixReindexingFunctors}.
    \end{definition}
\end{framed}

The essential idea from this point on is that we have defined several relations of the form $\wellformed{\texttt{Env}}{\texttt{Conclusion}}$, such as the typing relation $\gpetyperelation{v}{A}$, and the well-formedness relation on effects $\wellformedeffect{\P}{\e}$. Each instance of such a relation has a denotation that is an object or morphism in a category. For example, $\deno{\typerelation{\P}{\e}{\effect}}$ is a morphism in the base category, $\deno{\typerelation{\P}{A}{\type}}$ is an object in the fibre (S-category) induced by $\P$, and $\deno{\gpetyperelation{v}{A}}$ is morphism between the objects which denote $\G$ and $A$ in the fibre induced by $\P$.

To form our base category, we pick the concrete category $\Eff$ (Definition \ref{EffDefinition}) of ground effects and monotone functions. The denotation of an effect variable environment, $\deno{\P}$, is simply $E^n$ where $n$ is the number of variables in $\P$. The denotation of an effect, $\deno{\wellformedeffect{\P}{\e}}$ is a monotone function $E^n\rightarrow E$. For each ground effect $e$, we define $\deno{e}$ to be the constant function $\singleton \mapsto e$.


\begin{framed}
    
    \begin{definition}[The Category of Effects]
        \label{EffDefinition}
        We define $\Eff$ to be a subcategory of $\set$. Its objects are finite powers of $E$, the set of ground effects. That is the objects are of the form $E^n$, which indicates the set of $n$-tuples of ground effects. Morphisms in $\Eff$ are functions monotone with respect to the subeffect partial order ($\subeffect$).
    \end{definition}
\end{framed}

Next, we define a monoidal operator, $\Mul_n: (E^n \rightarrow E)\times (E^n \rightarrow E) \rightarrow (E^n \rightarrow E)$ (Definition \ref{MulDef}). $\Mul$ has the function $\ev\mapsto \1$ as its identity. Note that this makes the set of functions $(E^n \rightarrow E)$ into a pre-ordered monoid. We could use a more general category structure here; the monoidal, natural $\Mul$ operator is all that is needed. However, this extra generality is not essential and requires some more structure to ensure that the semantics of effects is sound with respect to the effect equational equivalence given in Section \ref{PECExtension}.



\begin{framed}
    \begin{definition}\label{MulDef}
        [$\Mul$ operator]
        $\Mul_n: (E^n \rightarrow E)\times (E^n \rightarrow E) \rightarrow (E^n \rightarrow E) = (f, g)\mapsto \ev\mapsto f(\ev)\dot g(\ev)$
    \end{definition}
    
    \begin{definition}[Naturality]\label{MulNaturality}
        $\Mul$ has the following property:

        \begin{equation*}
            (\Mul_n(f, g)\after \theta) = \ev\mapsto(f(\theta \ev))\dot(g(\theta\ev)) = \Mul_m(f\after\theta, g\after\theta)
        \end{equation*}
    \end{definition}
\end{framed}

There is also a requirement that the indexed category can model ground effects, types, and terms. In order to do this, it should have a base-category function $\deno{e}: \1\rightarrow E$ for each ground effect $e$. Furthermore, each fibre should contain an object $\deno{\g}$ for each ground type $\g$. Finally, for each constant, $\const{A}$, there should exist a morphism in each fibre: $\deno{\const{A}}: \1 \rightarrow A$. These last two requirements are satisfied by the fibres all being S-categories.

Our penultimate requirement is that the re-indexing functor induced by $\p: E^n\times E\rightarrow E$ (that is $\pstar: \C(E^n) \rightarrow \C(E^n\times E)$) has a right adjoint, denoted by $\allEn: \C(E^n\times E) \rightarrow \C(E^n)$. As the reader might be able to guess, this functor allows us to interpret quantification over effects. This right adjoint need not be S-preserving.

Finally, this adjunction should satisfy the Beck-Chevalley condition, as seen in Figure \ref{BeckChevalleyDiagram}. That is $\theta\star\after\allEn = \allEm\after(\theta\times\Id{E})\star$, and the natural transformation $\bar{(\theta\times\Id{E})\star(\counit{})}$ between these functors is equal to the identity natural transformation. This allows us to commute the re-indexing functors with the quantification functor.

\begin{figure}
    \begin{framed}
        \centering
        \begin{tikzcd}[column sep=huge]
            \C(E^n) 
            \arrow[bend left=50]{rrrr}[name=U,label=above:$\scriptstyle \theta\star\after\allEn$]{}
            \arrow[bend right=50]{rrrr}[name=D,label=below:$\scriptstyle \allEm\after(\theta\times\Id{E})\star$]{} 
            &&&& 
            \C(E^m\times E)
            \arrow[name=Canon,shorten <=10pt,shorten >=10pt,equal,to path={(U) -- node[label=right:$\bar{(\theta\times\Id{E})\star(\counit{})}$] {} (D)}]{}
        \end{tikzcd}
    \end{framed}
    \caption{A functor diagram of the Beck-Chevalley condition}
    \label{BeckChevalleyDiagram}
\end{figure}

\begin{align*}
    \bar{(\theta\times\Id{E})\star(\counit{})} = \Id{}: \theta\star\after\allEn \rightarrow \allEm\after(\theta\times\Id{E})\star\in \C(E^m)
\end{align*}

From the Beck-Chevalley condition, we can derive some more naturality conditions that will become useful later.
Using the adjunction property, we have that: $\bar{f\after\pstar(n)} = \bar{f}\after n$. Secondly, using the Beck-Chevalley condition, we can derive some non-trivial interactions between re-indexing functors and the adjunction\footnote{This part of the proof comes from a stack-overflow answer: https://math.stackexchange.com/questions/188099/beck-chevalley-condition-and-maps-of-adjunctions}. 
    \begin{align*}
        \theta\star\unit{A}:\quad&\theta\star A \rightarrow \theta\star\after\allEn\after\pstar A\\
        \theta\star\unit{} =& \bar{(\theta\times\Id{E})\star(\counit{\pstar})}\after\theta\star\unit{}\\
        =& (\allEm\after(\theta\times\Id{E})\star)(\counit{\pstar})\after\unit{(\allEm\after(\theta\times\Id{E})\star)\after\pstar}\after\theta\star\unit{}\\
        = & (\allEm\after(\theta\times\Id{E})\star)(\counit{\pstar})\after\unit{\theta\star\after\allEn\after\pstar}\after\theta\star\unit{}\\
        = & (\allEm\after(\theta\times\Id{E})\star)(\counit{\pstar}) \after(\theta\star\after\allEn\after\pstar)\unit{} \after\unit{(\theta\times\Id{E})\star}\\
        = & (\theta\star\after\allEn)(\counit{\pstar}
        \after\pstar\unit{})\after\unit{(\theta\times\Id{E})\star}\\
        = & (\theta\star\after\allEn)(\Id{})\after\unit{(\theta\times\Id{E})\star}\\
        = & \unit{(\theta\times\Id{E})\star}
    \end{align*}

    Importantly, this gives us the useful naturality condition that allows us to push re-indexing functors into the adjunction terms.

    \begin{align}\label{NaturalityCondition}
        \theta\star(\bar{f}) & = \theta\star(\allEn(f)\after\eta_A)\\
        & = \theta\star(\allEn(f))\after\theta\star(\eta_A)\\
        & =  (\allEm\after(\theta\times\Id{E})\star)f \after\unit{(\theta\times\Id{E})\star A}\\
        & = \bar{(\theta\times\Id{E})\star f}\\
    \end{align}

\section{Road Map}
In Figure \ref{RoadMap}, one can see a diagram of the collection of theorems that need to be proved to establish the soundness of a semantics for PEC.


The first pair of theorems (\ref{EffectSubstitutionOnEffects}, \ref{EffectWeakeningOnEffects}) is made up of the effect substitution and weakening theorem on effects. These theorems show that substitutions of effects have a well-behaved and easily defined action upon the denotations of effects. Using these theorems, we can then move on to characterize the action of effect substitutions and effect-environment weakening on the denotations of types and type environments in Theorems \ref{EffectSubstitutionOnTypes}, \ref{EffectSubstitutionOnTypeEnvs}, and \ref{EffectWeakeningOnTypes}. From this, we can also look at the action of weakening and substituting effect-variable environments on the subtyping relation between types in Theorems \ref{EffectSubstitutionOnSubtyping}, \ref{EffectWeakeningOnSubtyping}.

The next step is to use these substitution theorems to formalise the action of substitution and weakening of the effect-variable environments on terms in Theorems \ref{EffectSubstitutionOnTerms}, \ref{EffectWeakeningOnTerms}. This then allows us to find denotations for the weakening of term substitutions and type environment weakening, which set us up to prove the typical weakening and substitution theorems upon term variables and type environments in Theorems \ref{TermSubstitutionOnTerms}, \ref{TermWeakeningOnTerms}. 

Separately, we prove that all derivable denotations for a typing relation instance, $\gpetyperelation{v}{A}$ have the same denotation (Section \ref{UniqueDenotations}). This is important, since subtyping allows us to find multiple distinct typing derivations for terms, which initially look like they may have distinct denotations. Using a reduction function to transform typing derivations into a unique form, I prove that all typing derivations yield equal denotations.

This collection of theorems finally allows us to complete all cases of the equational-equivalence soundness theorem.

\begin{figure}[H]
    \begin{center}
        \scalebox{0.8}{
        \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=3cm,
            thick,main node/.style={rectangle,fill=blue!20,draw,
            font=\sffamily\small\bfseries,minimum size=15mm}]
        
            \node[main node,text width=20mm, fill=red] (IndexCategory) {Indexed Category and Adjunction (\ref{PECRequirements})};
            \node[main node,text width=20mm, fill=red] (MulNaturality) [below of=IndexCategory] {Naturality of Mul Operator (Def. \ref{MulNaturality})};
        
            \node[main node,text width=20mm, fill=red] (BeckChevalley) [left of=MulNaturality]{Beck-Chevalley Condition (\ref{PECRequirements})};
            \node[main node,text width=20mm, fill=red](SClosure) [right of=MulNaturality]{Re-indexing Functors are S-Preserving (Def. \ref{SPreservingDefinition})};
        
            \node[main node, text width=20mm](EffectWeakeningEffects) [below left of=MulNaturality]{Effect Weakening on Effects (Theorem \ref{EffectWeakeningOnEffects})};
        
            \node[main node, text width=20mm](EffectSubEffects) [below right of=MulNaturality]{Effect Substitution on Effects (Theorem \ref{EffectSubstitutionOnEffects})};
        
            \node[main node, text width=20mm](EffectWeakeningTypes)[below of=EffectWeakeningEffects]{Effect Weakening on Types (Theorem \ref{EffectWeakeningOnTypes})};
        
            \node[main node, text width=20mm](EffectSubTypes)[below of=EffectSubEffects]{Effect Substitution on Types (Theorem \ref{EffectSubstitutionOnTypes})};
        
            \node[main node, text width=20mm](EffectWeakeningTerms)[below of=EffectWeakeningTypes]{Effect Weakening on Terms (Theorem \ref{EffectWeakeningOnTerms})};
        
            \node[main node, text width=20mm](EffectSubTerms)[below of=EffectSubTypes]{Effect Substitution on Terms (Theorem \ref{EffectSubstitutionOnTerms})};
        
            \node[main node, text width=20mm](EffectWeakeningSubTyping)[left of=EffectWeakeningTerms]{Effect Weakening on Subtyping (Theorem \ref{EffectWeakeningOnSubtyping})};
        
            \node[main node, text width=20mm](EffectSubSubTyping)[right of=EffectSubTerms]{Effect Substitution on Subtyping (Theorem \ref{EffectSubstitutionOnSubtyping})};
        
            \node[main node, text width=20mm](EffectWeakeningWeakening)[below of=EffectWeakeningTerms]{Effect Weakening on Term Weakening (Theorem \ref{EffectWeakeningOnTermWeakening})};
        
            \node[main node, text width=20mm](EffectWeakeningSubstitution)[below of=EffectSubTerms]{Effect Weakening on Term Substitution (Theorem \ref{EffectWeakeningOnTermSubstitution})};
        
            \node[main node, text width=20mm](TermWeakening)[below of=EffectWeakeningWeakening]{Term Weakening Theorem (Theorem \ref{TermWeakeningOnTerms})};
        
            \node[main node, text width=20mm](TermSubstitution)[below of=EffectWeakeningSubstitution]{Term Substitution Theorem (Theorem \ref{TermSubstitutionOnTerms})};
        
            \node[main node, text width=20mm](UniqueDenotations)[below left of=TermSubstitution]{Unique Denotations (corollary \ref{DenotationsAreUnique})};
        
            \node[main node, text width=20mm](Soundness)[below of=UniqueDenotations]{Soundness (Theorem \ref{SOundness})};
        
            \draw [->] (IndexCategory) edge (BeckChevalley) (IndexCategory) edge (MulNaturality) (IndexCategory) edge (SClosure);
            \draw [->] (MulNaturality) edge (EffectWeakeningEffects) (MulNaturality) edge (EffectSubEffects);
        
            
            \draw [->] (EffectWeakeningEffects) edge (EffectWeakeningTypes) (EffectSubEffects) edge (EffectSubTypes);
        
            \draw [->] (EffectWeakeningTypes) edge (EffectWeakeningSubTyping) (EffectSubTypes) edge (EffectSubSubTyping);
        
            
            \draw [->] (EffectWeakeningSubTyping) edge (EffectWeakeningTerms) (EffectSubSubTyping) edge (EffectSubTerms);
        
        
            \draw [->] (EffectWeakeningTypes) edge (EffectWeakeningTerms) (EffectSubTypes) edge (EffectSubTerms);
        
            \draw [->] (EffectWeakeningTerms) edge (EffectWeakeningSubstitution) (EffectWeakeningSubTyping) edge (EffectWeakeningWeakening);
        
            \draw [->] (EffectWeakeningWeakening) edge (TermWeakening) (EffectWeakeningSubstitution) edge (TermSubstitution);
        
            \draw [->] (EffectSubTerms) edge [bend left=40] (TermSubstitution);
            \draw [->] 
                (BeckChevalley) edge [bend right=30] (EffectWeakeningTypes)
                (SClosure) edge [bend right=20] (EffectWeakeningTypes)
                (BeckChevalley) edge [bend left=20]  (EffectSubTypes)
                (SClosure) edge [bend left=30] (EffectSubTypes);
            
        
            \draw [->] (TermWeakening) edge (UniqueDenotations) (TermSubstitution) edge (UniqueDenotations) (TermWeakening) edge [bend right=20] (Soundness)
            (TermSubstitution) edge [bend left=20] (Soundness)
            (UniqueDenotations) edge (Soundness);
          \end{tikzpicture}
    }
    \end{center}
\caption{A road map of the proof dependencies. Assumptions are in red, theorems in blue.}
\label{RoadMap}
\end{figure}


\section{Denotations}\label{PECDenotations}
We are now equipped to define the denotations of structures in the language. Firstly, we define the denotation of effect-variable environments. In the base category, with the kind of effects indicated by $E$, the denotation of an effect-variable environment $\P$ is given by a finite product.

\[
\deno{\nil} = \1 \quad\quad \deno{\P, \a} = \deno{\P}\times E    
\]

Hence, the denotation of an  effect-variable environment $\P$ is given by a finite product on $E$ of width $n$ where $n$ is the length of $\P$. As stated earlier, the denotation of a well-formed effect is a morphism $\deno{\typerelation{\P}{\e}{\effect}}: E^n \rightarrow E$ in $\Eff$. The denotations for effects are shown in Figure \ref{EffectDenotations}.
\begin{figure}[H]
    \centering
    \begin{framed}
        \[
    \deno{\typerelation{\P}{e}{\effect}} = \deno{e} \after \term{E^n}: E^n\rightarrow E
    \quad\quad
    \deno{\typerelation{\P,\a}{\a}{\effect}} = \pp: E^n\times E \rightarrow E
\]\[
    \deno{\typerelation{\P, \b}{\a}{\effect}} = \deno{\typerelation{\P}{\a}{\effect}}\after\p: E^n\times E\rightarrow E
\]\[
    \deno{\typerelation{\P}{\e_1\dot \e_2}{\effect}} = \Mul_{E^n}(\deno{\typerelation{\P}{\e_2}{\effect}},\deno{\typerelation{\P}{\e_1}{\effect}}): E^n \rightarrow E
\]
    \end{framed}
    \caption{The denotations of effects in the base category}
    \label{EffectDenotations}
\end{figure}


Using these denotations, we are now equipped to define the denotations of types. As stated above, types that are well formed in $\P$ are denoted by objects in the fibre category $\C(E^n)$ given by the denotation of $\P$. These type denotations are given in Figure \ref{TypeDenotations}
 
Since the fibre category $\C(E^n)$ is an S-category, it has objects for all ground types, a terminal object, graded monad $\T{}{}$, exponentials, products, and co-product over $\1+\1$.

\begin{figure}[H]
    \centering
    \begin{framed}
\[
    \deno{\typerelation{\P}{\U}{\type}} = \1
    \quad\quad
    \deno{\typerelation{\P}{\B}{\type}} = \1+\1
    \quad\quad
    \deno{\typerelation{\P}{\g}{\type}} = \deno{\g}
\] 

\[
    \deno{\typerelation{\P}{\ab}{\type}} = (\deno{\typerelation{\P}{B}{\type}})^{(\deno{\typerelation{\P}{A}{\type}})}
\]

\[
    \deno{\typerelation{\P}{\mea}{\type}} =\T{\deno{\typerelation{\P}{\e}{\effect}}}{\deno{\typerelation{\P}{A}{\type}}}
    \quad\quad
    \deno{\typerelation{\P}{\all{\a}{A}}{\type}} =\allEn(\deno{\typerelation{\P,\a}{A}{\type}})
\]


    \end{framed}
    \caption{The denotations of type expressions within the appropriate fibre.}
    \label{TypeDenotations}
\end{figure}

By using the terminal objects and products present in each fibre, we can now derive denotations of type environments. $\deno{\oke{\P}{\G}}$ should be an object in the fibre $\C(E^n)$ induced by $\P$. Specific denotations are given in Figure \ref{TypeEnvDenotations}.

\begin{figure}[H]
    \centering
    \begin{framed}
        \[
            \deno{\wellformedok{\P}{\nil}} = \1
            \quad\quad
            \deno{\wellformedok{\P}{\gax}} = (\deno{\wellformedok{\P}{\G}} \times \deno{\typerelation{\P}{A}{\type}})
        \]  
    \end{framed}

    \caption{Denotations of type environments within the appropriate fibre}
    \label{TypeEnvDenotations}
\end{figure}


Another construction that is important is the denotation of subtyping. For each instance of the subtyping relation in $\P$, $A\subtypep B$, there exists a denotation in the fibre induced by $\P$. $\deno{A\subtypep B} \in\C(E^n)(A, B)$. Since the fibres are S-categories, the ground instances of the subtyping relation exist in each fibre anyway. In addition, for each instance of the subeffect relation $\e_1\subeffectp \e_2$ each fibre contains the natural transformation $\dsep{\e_1}{\e_2}: \T{\e_1}{}\rightarrow \T{\e_2}{}$. Specific subtyping denotations are given in Figure \ref{SubtypingDenotations}.

\begin{figure}[H]
    \centering
    \begin{framed}
        \begin{align*}
            \deno{\g_1\subtypep \g_2} &= \deno{\g_1\subtypeg \g_2}
            \\
            \deno{\ab \subtypep \fntype{A'}{B'}} &= \deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}}
            \\
            \deno{\M{\e_1}{A}\subtypep\M{\e_2}{B}} &= \deno{\e_1\subeffectp\e_2}\after\T{\e_1}{\deno{A\subtypep B}}
            \\
            \deno{\all{\a}{A}\subtypep\all{\a}{B}} &= \allEn{\deno{A\subtypepa B}}
        \end{align*}
    \end{framed}
    
    \caption{The denotations of subtyping relations}
    \label{SubtypingDenotations}
\end{figure}


This finally gives us the ability to express the denotations of well-typed terms in an effect-variable environment, $\P$ as morphisms in the fibre induced by $\P$, $\C(E^n)$.  Writing $\G_{E^n}$ and $A_{E^n}$ for $\deno{\wellformedok{\P}{\G}}$ and $\deno{\typerelation{\P}{A}{\type}}$, we can derive $\deno{\gpetyperelation{v}{A}}$ as a morphism in $\C(E^n)(\G_{E^n}, A_{E^n})$. Since each fibre is an S-category, for each constant, $\const{A}$, there exists $\deno{\const{A}}: \1 \rightarrow A_{E^n}$ in $\C(E^n)$. These denotations can be seen in Figure \ref{TermDenotations}.

\begin{figure}[H]
    \footnotesize
    \begin{framed}
        \[
            \ntreeruleI{\vunit}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\u}{\U}} = \term{\G} : \G \rightarrow \1}
            \quad
            \ntreeruleI{\vconst}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\const{A}}{A}} = \deno{\const{A}} \after \term{\G} : \G \rightarrow A}
        \]
        \\
        \\        
        \[
            \ntreeruleI{\vtrue}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\t}{\B}} = \inl \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}
        \]
        \\
        \\
        \[
            \ntreeruleI{\vfalse}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\f}{\B}} = \inr \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}
        \]
        \\
        \\        
        \[
            \ntreeruleI{\vvar}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\gax}{x}{A}} = \pp: \G \times A \rightarrow A}
            \quad    
            \ntreeruleI{\vweaken}{f = \deno{\gpetyperelation{x}{A}}: \G \rightarrow A}{\deno{\etyperelation{\P}{\gby}{x}{A}} = f \after \p: \G \times B \rightarrow A}
        \]
        \\
        \\        
        \[
            \ntreeruleI{\vfun}{f = \deno{\etyperelation{\P}{\gax}{v}{B}} : \G \times A \rightarrow B}{\deno{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}} = \cur{f} : \G \rightarrow (B)^A}
        \]
        \\
        \\        
        \[
            \ntreeruleII{\vsubtype}{f = \deno{\etyperelation{\P}{\G}{v}{A}} : \G \rightarrow A}{g = \deno{A \subtypep B}}{\deno{\etyperelation{\P}{\G}{v}{B}} = g \after f : \G \rightarrow B}
            \quad 
            \ntreeruleI{\vreturn}{f = \deno{\etyperelation{\P}{\G}{v}{A}}}{\deno{\etyperelation{\P}{\G}{\return{v}}{\moa}} = \point{A} \after f}   
        \]
        \\
        \\        
        \[
            \ntreeruleIII{\vif}{f = \deno{\etyperelation{\P}{\G}{v}{\B}}: \G\rightarrow\1+\1}{g = \deno{\etyperelation{\P}{\G}{v_1}{\mea}}}{ h = \deno{\etyperelation{\P}{\G}{v_2}{\mea}}}{\deno{{\etyperelation{\P}{\G}{\ifthenelse{\e}{A}{v}{v_1}{v_2}}{\mea}}} = \app\after((\fld{\cur{g\after\pp}}{\cur{h\after\pp}}\after f)\times \idg)\after \diag{\G} : \G \rightarrow \tea}    
        \]
        \\
        \\
        \[
            \ntreeruleII{\vbind}{f = \deno{\etyperelation{\P}{\G}{v_1}{\M{\e_1}{A}} : \G \rightarrow \T{\e_1}{A}}}{{ g = \deno{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}}: \G \times A \rightarrow \T{\e_2}{B}}{\deno{\etyperelation{\P}{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1 \dot \e_2}{B}}} = \bind{\e_1}{\e_2}{B} \after \T{\e_1}{g} \after \tstrength{\G}{A}{\e_1} \after \pr{\idg}{f}: \G \rightarrow \T{\e_1 \dot \e_2}{B}}  
        \]
        \\
        \\        
        \[
            \ntreeruleII{\vapply}{f = \deno{\gpetyperelation{v_1}{\ab}}: \G \rightarrow (B)^{A}}{g=\deno{\gpetyperelation{v_2}{A}}: \G \rightarrow A}{\deno{\gpetyperelation{\apply{v_1}{v_2}}{B}}= \app\after\pr{f}{g}: \G \rightarrow B }
        \]
        \\
        \\        
        \[
            \ntreeruleI{\vgen}{f = \deno{\etyperelation{\P,\a}{\G}{v}{A}}: \C(E^n\times E)(\G, A)}{\deno{\gpetyperelation{\elam{\a}{A}}{\all{\e}{A}}} = \bar{f}: \C(E^n)(\G, \allEn(A))}    
        \] 
        \\
        \\
        \begin{equation}\label{EffectApplication}
            \ntreeruleII{\vspec}{g=\deno{\gpetyperelation{v}{\all{\a}{A}}}: \C(E^n)(\G, \allEn(A))}{ h = \deno{\typerelation{\P}{\e}{\effect}}: E^n \rightarrow E}{\deno{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}} = \pr{\Id{E^n}}{h}\star(\counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after g: \C(E^n)(\G, A\ssub{\a}{\e})}
        \end{equation}                
    \end{framed}
    \caption{The denotations of terms in PEC}
    \label{TermDenotations}
\end{figure}

The least intuitive of these denotations is that of effect-application (\textit{\vspec}) in Equation \ref{EffectApplication}. As explained later in Section \ref{SubsAndWeakening} the re-indexing functor represents application of the substitution $\ssub{\b}{\e}$. By doing type analysis on the co-unit morphism $ \counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}}$, as in Figure \ref{CoUnitType}  we can see that before the application of the substitution, the co-unit natural transformation takes a quantified type to a substituted type under an extended effect-variable environment. By applying the substitution re-indexing functor in Figure \ref{ReIndexedCoUnitType}, we substitute $\e$ for the extra effect variable, $\b$. In the case of the quantified type, as $\b$ is not used, the substitution has no effect, but in the case of the substituted type, the substitutions compose to yield the substitution $\ssub{\a}{\e}$. This composes with the expression denotation $g$ to give the applied denotation in Figure \ref{EffectSpecComp}.


\begin{figure}[H]
    \begin{framed}
        \begin{align*}
            \counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}} & = \widehat{\Id{\allEn(\deno{\typerelation{\P,\b}       {A\ssub{\a}{\b}}{\type}})}} \\ 
            & : \quad \pstar \allEn(\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}) \rightarrow \deno{\typerelation{\P,\b}       {A\ssub{\a}{\b}}{\type}} \\
            & : \quad\pstar \deno{\typerelation{\P}{\all{\b}{A\ssub{\a}{\b}}}{\type}} \rightarrow \deno{\typerelation{\P,\b}        {A\ssub{\a}{\b}}{\type}} \\
            & : \quad \pstar \deno{\typerelation{\P}{\all{\a}{A}}{\type}} \rightarrow \deno{\typerelation{\P,\b}{A\ssub     {\a}{\b}}{\type}}\\
            & : \quad \deno{\typerelation{\P, \b}{\all{\a}{A}}{\type}} \rightarrow \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}
        \end{align*}
    \end{framed}
    \caption{Analysis of the type of the co-unit natural transformation}
    \label{CoUnitType}
\end{figure}

\begin{figure}[H]
    \begin{framed}
        \begin{align*}
            \pr{\Id{E^n}}{h}\star(\counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}}) & : \quad \deno{\typerelation{\P}{\all{\a}{A}}{\type}} \rightarrow \deno{\typerelation{\P}{A\ssub{\a}{\b}\ssub{\b}{\e}}{\type}}\\
            & : \quad \deno{\typerelation{\P}{\all{\a}{A}}{\type}} \rightarrow \deno{\typerelation{\P}{A\ssub{\a}{\e}}{\type}}
        \end{align*}
    \end{framed}
    \caption{Analysis of the type of the re-indexed co-unit}
    \label{ReIndexedCoUnitType}
\end{figure}


 
\begin{figure}[H]
    \begin{framed}
        \centering
        \begin{tikzcd}
            &  \deno{\typerelation{\P, \b}{\all{\a}{A}}{\type}}  \arrow{rrrr}{\counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}}}&&&&  \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}} &
            \\
            \G \arrow{rr}{g}&&
            \allEn (A) \arrow{rrrr}{ \pr{\Id{E^n}}{h}\star(\counit{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})}
            &&&&
            A\ssub{\a}{\e}
        \end{tikzcd}
    \end{framed}
    \caption{Composition of the effect-specialisation denotation}
    \label{EffectSpecComp}
\end{figure}



\section{Effect Substitution and Weakening Theorems}\label{SubsAndWeakening}


In this section, I introduce and prove a series of utility theorems which will help us prove cases in future theorems. These weakening and substitution theorems are concerned with a change in environment of typing derivations and their associated denotations. If $\gpetyperelation{v}{A}$, then it should be the case that $\etyperelation{\P}{\gax}{v}{A}$ if $x$ is fresh in $\G$. We also want to know what happens to the denotation when we change the type environment. In this section, I introduce the tools for manipulating the type and effect-variable environments in this fashion.

Substitutions and weakenings are two distinct ways of manipulating effect or type environments. Weakening acts as a kind of subtyping of the environment. If we insert fresh variables into an environment, then any expression that was typeable under the previous environment should also be typeable under the the new environment. This change of environment should also have a predictable effect on the denotations of any expressions to which it is applied.

Substitution considers what happens when we simultaneously replace all variables in one expression, that is typeable under an environment, with expressions that are well formed under another environment. The resulting substituted expression should be typeable under the new environment, and the denotation of the new expression should be composed from the denotation of the old relation and the denotations of the expressions that replace the variables. 

As we go on, I define and state the denotations of specific substitutions and weakenings, upon both the effect-variable environment and the type environments.

In this dissertation, substitutions and weakenings come in two flavours: weakening and substitution of the effect-variable environment and weakening and substitution of the type environments. For each of these there is a family of theorems defining the effects of the applying a substitution and weakening to the various language structures and their denotations, such as well-formedness and typing relations.

\begin{framed}
    \begin{aside}[Weakening Proofs]
        The structure of weakening theorems and their proofs are often rather similar to their respective substitution theorem. In these cases, I have placed the example cases of the weakening proof in Appendix \ref{WeakeningProofs}.
    \end{aside}
\end{framed}

\subsection{Substitution and Weakening on Effects}\label{SectionEffectSubstitution}

The first family of theorems is that of weakening and substitution of the effect-variable environment. Weakenings are a relation between effect-variable environments $\wrel{\w}{\P'}{\P}$, that are defined in Figure \ref{EffectWeakeningDefinition}. We can define the denotation of an effect-environment weakening as a morphism in the base category: $\deno{\wrelw{\P'}{\P}}: E^m \rightarrow E^n$. The denotations are defined in Figure \ref{TermWeakeningDenotations}.

\begin{figure}[H]
    \centering
    \begin{framed}
        \[
    \ntreeruleI{\eid}{\ok{\P}}{\wrel{\i}{\P}{\P}}
    \quad
    \condtreeruleI{\eproject}{\wrel{\w}{\P'}{\P}}{\wrel{\w\pi}{(\P', \a)}{\P}}{\a\notin\P'}
    \quad
    \condtreeruleI{\eextend}{\wrel{\w}{\P'}{\P}}{\wrel{\w\x}{(\P', \a)}{(\P, \a)}}{\a\notin\P'}
\]
    \end{framed}
    \caption{Effect weakening definitions}
    \label{EffectWeakeningDefinition}
\end{figure}


\begin{figure}[H]
    \centering
    \begin{framed}
        \begin{align*}
            \deno{\wrel{\i}{\P}{\P}} & = \Id{E^n}: E^n \rightarrow E^n
            \\
            \deno{\wrel{\w\pi}{\P',\a}{\P}} & = \deno{\wrelw{\P'}{\P}}\after \p: E^m\times E\rightarrow E^n
            \\
            \deno{\wrel{\w\x}{\P',\a}{\P,\a}} & = (\deno{\wrelw{\P'}{\P}}\times \Id{E}): E^m\times E\rightarrow E^n\times E 
        \end{align*}
    \end{framed}
    \caption{Effect weakening denotations}
    \label{EffectWeakeningDenotations}
\end{figure}

Substitutions are also an inductively defined relation between effect-variable environments, with inductively defined denotations. Finite substitutions may be represented as a snoc-list of variable-effect pairs. The substitution relation matches substitutions to the environments it operates between. The relation instance $\typerelation{\P'}{\si}{\P}$ means that $\si$ is a substitution from $\P$ to $\P'$. It is defined inductively using rules in Figure \ref{EffectSubstitutionDefinition}.

\begin{figure}[H]
    \centering
    \begin{framed}
        \[
    \si \gens \nil \mid \si, \a \setto \e    
\]



\[
    \ntreeruleI{\esubnil}{\ok{\P'}}{\typerelation{\P'}{\nil}{\nil}}
    \quad\quad
    \condtreeruleII{\esubextend}{\typerelation{\P'}{\si}{\P}}{\wellformedeffect{\P'}{\e}}{\typerelation{\P'}{(\si, \a \setto\e)}{(\P, \a)}}{\a\notin\P}
\]
    \end{framed}
    
    \caption{Effect substitution definition}
    \label{EffectSubstitutionDefinition}
\end{figure}


We can define the action of substitutions on effects, as in Figure \ref{EffectSubstitutionActionEffects}. Furthermore, Figure \ref{EffectSubstitutionActionEffects} also gives the denotation of substitutions. The denotation of an effect-environment substitutions, $\deno{\typerelation{\P'}{\si}{\P}}$, is a morphism $E^m \rightarrow E^n$ in the base category.



\begin{figure}[H]
    \centering
    \begin{minipage}{0.47\textwidth}
      \begin{framed}
        \centering
        \textbf{Action}
  
        \scalebox{.8}{\parbox{\linewidth}{%
        \begin{align*}
            \si(e) & = e \\
            \si(\e_1\dot\e_2) & = (\si(\e_1))\dot(\si(\e_2))\\
            \nil(\a) & = \a\\
            (\si, \b\setto \e)(\a) & = \si(\a) \\
            (\si, \a\setto \e)(\a) & =\e
        \end{align*}
        
        }}
      \end{framed}
    \end{minipage}
    \quad
    \begin{minipage}{0.47\textwidth}
      \begin{framed}
        \centering
        \textbf{Denotations}
  
        \scalebox{.8}{\parbox{\linewidth}{%
        \begin{align*}
            \\
            \deno{\typerelation{\P'}{\nil}{\nil}} & = \term{E^n}: \C(E^m, \1)
            \\
            \deno{\typerelation{\P'}{(\si, \a\setto\e)}{\P,\a}} & = \pr{\deno{\typerelation{\P'}{\si}{\P}}}{\deno{\typerelation{\P}{\e}{\effect}}}\\&\quad: \C(E^m, E^n\times E)
            \\
        \end{align*}
        }}
      \end{framed}
    \end{minipage}
    \caption{The action on effects and denotations of an effect substitution}
    \label{EffectSubstitutionActionEffects}
\end{figure}

The general construction for effect-variable substitution allows us to define, in particular, the identity substitution, $\typerelation{\P}{\Id{\P}}{\P}$ and the singleton substitution, $\typerelation{\P}{\ssub{\a}{\e}}{\P,\a}$ in Figure \ref{EffectSpecialSubs}. By inspection, we can also obtain the denotations of these special-case substitutions. Note that in particular, the denotation of the identity substitution completes our intuition for the denotation of the (\textit{\vspec}) rule in Section \ref{PECDenotations}. These substitutions will form a useful shorthand later. Finally, it will be useful to examine how the substitutions generated by extending the effect-variable environment, such as in the case of polymorphic types, relate to the original substitution.

\begin{figure}[H]
    \centering
    \begin{minipage}{.45\linewidth}
        \begin{framed}
            \begin{align*}
                \Id{\nil} & = \nil\\
                \Id{\P,\a} & = (\Id{\P}, \a\setto\a)\\
                \ssub{\a}{\e} & = (\Id{\P}, \a\setto \e)
            \end{align*}
        \end{framed}
    \end{minipage}
    \quad
    \begin{minipage}{.45\linewidth}
        \begin{framed}
            \begin{align*}
                \deno{\typerelation{\P}{\Id{\P}}{\P}} & = \Id{E^n}\\
                \deno{\typerelation{\P}{\ssub{\a}{\e}}{(\P,\a)}} & = \pr{\Id{E^n}}{\deno{\typerelation{\P}{\e}{\effect}}}
                \\
            \end{align*}
        \end{framed}
    \end{minipage}
    \caption{Special case substitutions and their denotations.}
    \label{EffectSpecialSubs}
\end{figure}

\begin{framed}
    \begin{definition}[Freshness]\label{EffectFreshness}
      We define $\a \# \si$ to mean that $\a$ does not occur in the domain or any of the substitution expression of $\si$.
    \end{definition}
\end{framed}

\begin{framed}
    \begin{theorem}[Effect Substitution on Effects]\label{EffectSubstitutionOnEffects} 
        If $\wellformedeffect{\P}{\e}$ and $\typerelation{\P'}{\si}{\P}$ then: 
        \begin{enumerate}[label=\roman*.]
            \item $\wellformedeffect{\P'}{\si(\e)}$
            \item Writing $\si$ for $\deno{\typerelation{\P'}{\si}{\P}}$,  $\deno{\wellformedeffect{\P'}{\si(\e)}} = \deno{\wellformedeffect{\P}{\e}}\after\si$
        \end{enumerate}
          
    \end{theorem}
    
    \begin{proof}
        The proof of this depends on the naturality of $\Mul_{E^n}$ and inversion to narrow down case splitting on the structure of the effect-variable environments. It proceeds by induction on the definition of denotations of effects given in Figure \ref{EffectDenotations}.
    
        \case{\eground}
        This case holds due to the terminal morphism being unique. Hence, pre-composing it with another morphism yields the terminal morphism.
    
        \begin{align*}
            \deno{\typerelation{\P}{e}{\effect}}\after\si & = \deno{e}\after\term{E^n}\after\si \\
            & = \deno{e}\after\term{E^m} \\
            & = \deno{\typerelation{\P'}{e}{\type}}\\
        \end{align*}
    
    \case{\evar}
    
    Since the structure of the substitution $\si$ depends on the structure of $\P$, we can perform inversion to infer the denotation of $\si$.
    
    \begin{align*}
        \deno{\typerelation{\P,\a}{\a}{\effect}}\after\si &= \pp\after\pr{\si'}{\deno{\typerelation{\P'}{\e}{\effect}}}\qt{By inversion $\si = (\si', \a\setto\e)$}\\
        & =\deno{\typerelation{\P'}{\e}{\effect}} \\
        &= \deno{\typerelation{\P'}{\si'(\a)}{\effect}}\\
    \end{align*}
    
    
    \case{\ecompose}
    
    We make use of the naturality of $\Mul_{E^n}$ and induction upon the subterms.
    \begin{align*}
        \deno{\typerelation{\P}{\e_1\dot\e_2}{\effect}} \after\si &=
        \Mul_{E^n}(\deno{\typerelation{\P}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}})\after \si \\
        & = \Mul_{E^n}(\deno{\typerelation{\P}{\e_1}{\effect}}\after \si, \deno{\typerelation{\P}{\e_2}{\effect}}\after \si)\qt{By Naturality}\\
        & = \Mul_{E^m}(\deno{\typerelation{\P'}{\si(\e_1)}{\effect}}, \deno{\typerelation{\P}{\si(\e_2)}{\effect}})\\
        & = \deno{\typerelation{\P'}{\si(\e_1)\dot\si(\e_2)}{\effect}}\\
        & = \deno{\typerelation{\P'}{\si(\e_1\dot\e_2)}{\effect}}\\
    \end{align*}
    
    $$\square$$
    \end{proof}
\end{framed}

The weakening theorem proceeds similarly.

\begin{framed}
    \begin{theorem}[Effect Weakening on Effects]\label{EffectWeakeningOnEffects}
       If $\wellformedeffect{\P}{\e}$ and $\wrelw{\P'}{\P}$ then: 
       \begin{enumerate}[label=\roman*.]
           \item $\wellformedeffect{\P'}{\e}$
           \item Writing $\w$ for $\deno{\wrelw{\P'}{\P}}$,  $\deno{\wellformedeffect{\P'}{\e}} = \deno{\wellformedeffect{\P}{\e}}\after\w$.
       \end{enumerate}    
    \end{theorem}
    
    \begin{proof}
        This proof also depends on the naturality of $\Mul_{E^n}$ and case splitting on the structure of $\w$.  Some cases can be found in Appendix \ref{AppendixEffectWeakeningOnEffects}
    \end{proof}
\end{framed}


\begin{framed}
    \begin{lemma}[Extension Lemma on Effect Substitutions]\label{ExtensionLemmaOnEffectSubstitutions}
        If $\typerelation{\P'}{\si}{\P}$, and $\a\#\si$, then $\typerelation{(\P', \a)}{(\si, \a\setto\a)}{(\P,\a)}$ with denotation $\deno{\typerelation{(\P', \a)}{(\si, \a\setto\a)}{(\P,\a)}} = (\deno{\typerelation{\P'}{\si}{\P}}\times\Id{E})$
    \end{lemma}
    \begin{proof}
       This holds by the weakening-theorem on effects, theorem \ref{EffectWeakeningOnEffects}
    
       $$\square$$
    \end{proof}
\end{framed}


\subsection{Substitution and Weakening on Typing}
We can now move on to state and prove the weakening and substitution theorems on types, subtyping, and type environments. The general structure of these theorems, as well as the term-based theorems later, is that when we want to quantify the action of a morphism $\theta: E^m \rightarrow E^n$ between objects in the base category on structure in the fibres $\C(E^n)$, we should simply apply the associated re-indexing functor (As defined in Section \ref{PECRequirements}) $\theta\star: \C(E^n) \rightarrow \C(E^m)$ to the structure. The proof of the soundness of this operation is driven by the fact that the re-indexing functor is S-preserving. Specifically, effect substitutions ($\si$) have the actions given in Figure \ref{SubstitutionActionTypesTypeEnvs} on types and type-environments.

\begin{figure}[H]
    
    \begin{framed}
        \centering
        \textbf{Action of Effect Substitution}

        \begin{minipage}{.47\linewidth}
            
\begin{align*}
    \g\sub{\si} &= \g \\
    (\fntype{A}{B})\sub{\si} &= \fntype{(A\sub{\si})}{(B\sub{\si})} \\
    (\M{\e}{A})\ssi &= \M{\si(\e)}{(A\ssi)}\\
    (\all{\a}{A})\ssi &= \all{\a}{(A\ssi)}\qt{If $\a\#\si$}
\end{align*}
        \end{minipage}
        \quad
        \begin{minipage}{.47\linewidth}
            \begin{align*}
                \nil\ssi & = \nil \\
                (\gax)\ssi &= (\G\ssi, x:(A\ssi))\\
            \end{align*}            
        \end{minipage}
    \end{framed}
    
    \caption{The action of effect substitutions on types and type environments.}
    \label{SubstitutionActionTypesTypeEnvs}
\end{figure}




\begin{framed}
    \begin{theorem}[Effect Substitution on Types]\label{EffectSubstitutionOnTypes}
       If $\wellformedtype{\P}{A}$ and $\typerelation{\P'}{\si}{\P}$, then:
       \begin{enumerate}[label=\roman*.]
           \item $\wellformedtype{\P'}{A\ssi}$
           \item $\deno{\wellformedtype{\P'}{A\ssi}} = \si\star\deno{\wellformedtype{\P}{A}}$
       \end{enumerate}
    \end{theorem}
    
    \begin{proof}
       By induction on the derivation of $\deno{\wellformedtype{\P}{A}}$ (Figure \ref{TypeDenotations}) and the fact that $\si\star$ is S-preserving. These specific cases show the dependencies on Theorem \ref{EffectSubstitutionOnEffects}, the Beck-Chevalley condition and the extension lemma (Lemma \ref{ExtensionLemmaOnEffectSubstitutions}).
    
        \case{\teffect}
        This case makes use of the fact that $\si\star$ is S-preserving. Specifically the property upon the graded monad functor $\T{}{}$: $\si\star(\T{f}{A}) = \T{f\after\si}{(\si\star A)}$.
    
    
        \begin{align*}
            \si\star\deno{\typerelation{\P}{\mea}{\type}} & =  \si\star(\T{\deno{\typerelation{\P}{\e}{\effect}}}{\deno{\typerelation{\P}{A}{\type}}})\\
            &= \T{\deno{\typerelation{\P}{\e}{\effect}}\after\si}{\si\star(\deno{\typerelation{\P}{A}{\type}})}\\
            & = \T{\deno{\wellformedeffect{\P'}{\si(\e)}}}{\deno{\wellformedtype{\P'}{A\ssi}}}\\
            & = \deno{\typerelation{\P'}{(\mea)\ssi}{\type}}
        \end{align*}
        
        \case{\tquant}
        This case makes use of the Beck-Chevalley condition and the fact that $\deno{\typerelation{(\P', \a)}{(\si, \a\setto\a)}{(\P, \a)}} = \si\times\Id{E}$, which we can induct upon.
            \begin{align*}
                \si\star\deno{\typerelation{\P}{\all{\a}A}{\type}} & = \si\star(\allEn(\deno{\typerelation{\P,\a}{A}{\type}}))\\
                & = \allEn((\si\times\Id{E})\star\deno{\typerelation{\P,\a}{A}{\type}})\qt{By Beck-Chevalley}\\
                & = \allEn(\deno{\typerelation{\P',\a}{A\sub{\si, \a\setto\a}}{\type}})\qt{By induction}\\
                & = \deno{\typerelation{\P'}{\all{\a}{(A\sub{\si, \a\setto\a})}}{\type}}\\
                & = \deno{\typerelation{\P'}{(\all{\a}{A})\ssi}{\type}}\\
            \end{align*}
            $$\square$$
    \end{proof}
\end{framed}

Similarly, we can extend the effect-substitution theorem to type environments.

\begin{framed}
    \begin{theorem}[Effect Substitution on Type Environments]\label{EffectSubstitutionOnTypeEnvs}
        If $\wellformedok{\P}{\G}$, then:
        \begin{enumerate}[label=\roman*.]
            \item $\wellformedok{\P'}{\G\ssi}$
            \item $\deno{\wellformedok{\P'}{\G\ssi}} = \si\star\deno{\wellformedok{\P}{\G}}$.
        \end{enumerate}
         
    \end{theorem}
    
    \begin{proof}
        By induction on the derivation of $\deno{\wellformedok{\P}{\G}}$ (Figure \ref{TypeEnvDenotations}) whilst making use of the S-preserving property of the re-indexing functor.
    
        \case{\envnil}
        We make use of the fact that an S-preserving functor preserves the terminal object.
        \begin{align*}
            \si\star\deno{\wellformedok{\P}{\nil}} &=\si\star\1\\
            & = \1\qt{By S-preserving property}\\
            &= \deno{\wellformedok{\P'}{\nil}}\\
            &= \deno{\wellformedok{\P'}{\nil\ssi}}\\
        \end{align*}
        
        \case{\envextend}
        The S-preserving property means that $\si\star(A \times B) = (\si\star A)\times (\si\star B)$.
        \begin{align*}
           \si\star\deno{\wellformedok{\P}{\gax}} &= \si\star(\deno{\wellformedok{\P}{\G}} \times \deno{\typerelation{\P}{A}{\type}}) \\
           & = (\si\star\deno{\wellformedok{\P}{\G}} \times \si\star\deno{\typerelation{\P}{A}{\type}})\\
            & = (\deno{\wellformedok{\P'}{\G\ssi}} \times \deno{\typerelation{\P'}{A\ssi}{\type}})\\
            & = \deno{\wellformedok{\P'}{\G\ssi, x: A\ssi}}\\
            & = \deno{\wellformedok{\P'}{(\gax)\ssi}}\\
        \end{align*}
    
        $$\square$$
    \end{proof}
    
\end{framed}

The effect-weakening theorem on types and type environments is formulated analogously.

\begin{framed}
    \begin{theorem}[Effect Weakening on Types and Type Environments]\label{EffectWeakeningOnTypes}  
        If $\wrelw{\P'}{\P}$ and $\wellformedtype{\P}{A}$ then:
        \begin{enumerate}[label=\roman*.]
            \item $\wellformedtype{\P'}{A}$ $\deno{\wellformedtype{\P'}{A}} = \w\star\deno{\wellformedtype{\P}{A}}$
            \item $\wrelw{\P'}{\P}$ and $\wellformedok{\P}{\G}$ imply $\deno{\wellformedok{\P'}{\G}} = \w\star\deno{\wellformedok{\P}{\G}}$
        \end{enumerate}        
    \end{theorem}
    

\begin{proof}
    The proof for types proceeds in a similar fashion the proof of effect substitution on types (Theorem \ref{EffectSubstitutionOnTypes}). That is, by inducting over the derivation of $\deno{\typerelation{\P}{A}{\type}}$, and making use of the Beck-Chevalley condition and the S-preserving property of $\w\star$.
   
    The proof for type environments follows the same steps as the effect-substitution proof (Theorem \ref{EffectSubstitutionOnTypeEnvs}).
    $$\square$$
\end{proof}
\end{framed}

The above theorems confirm that to model the action of  an effect weakening or substitution on the denotation of a type or type environment, we simply apply the suitable re-indexing functor to the denotation object of the type.

Next, we consider the action of weakening and substitution on subtyping relations. The denotations of the subtyping relations, given in Figure \ref{SubtypingDenotations}, are morphisms as opposed to objects. However, the action of substitution and weakening can still be achieved by applying the appropriate re-indexing functor.


\begin{framed}
    \begin{theorem}[Effect Substitution on Subtyping]\label{EffectSubstitutionOnSubtyping}
        If $A$ is a subtype of $B$ under environment $\P$ ($A \subtypep B$), and $\si$ is a substitution from $\P'$ to $\P$ ($\typerelation{\P'}{\si}{\P}$), then:
        \begin{enumerate}[label=\roman*.]
            \item $A\ssi$ is also a subtype of $B\ssi$ under $\P'$ ($A\ssi\subtypepp B\ssi$)
            \item $\deno{A\ssi\subtypepp B\ssi} = \si\star\deno{A\subtypep B}$.
        \end{enumerate}
    \end{theorem}


\begin{proof}
    By rule induction over the definition of the subtype relation (Figures \ref{FullSubtypingDefinition}, \ref{SubtypingDenotations}), making use of S-preserving property and the effect-substitution theorem on types.


\case{\sground}
This case holds by the property of the S-preserving property of $\si\star$ that $\si\star$ preserves the ground-type subtyping denotation.

\begin{align*}
    \si\star(\g_1\subtypeg\g_2) &= (\g_1\subtypeg\g_2)
\end{align*}



\case{\sfun}

This case holds by several S-preserving properties of $\si\star$. $\si\star$ preserves the exponential morphisms: $\si\star(\cur{f}) = \cur{\si\star(f)}$ and $\si\star(\app) = \app$. $\si\star$ should also preserve the product morphisms: $\si\star(\p) = \p$, $\si\star(\pp) = \pp$ and $\si\star\pr{f}{g} = \pr{\si\star f}{\si\star g}$. Hence $\si\star(f \times g) = (\si\star f \times \si\star g)$.

\begin{align*}
    \si\star\deno{(\ab)\subtypep\fntype{A'}{B'}} &= \si\star(\deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}})\\
    &= \si\star(\cur{\deno{B\subtypep B'}\after\app})\after\si\star(\cur{\app\after(\Id{B}\times\deno{A'\subtypep A})})\\
    & = \cur{\si\star(\deno{B\subtypep B'})\after\app}\after\cur{\app\after(\Id{B}\times\si\star(\deno{A'\subtypep A}))}\\
    & = \cur{\deno{B\ssi\subtypepp B'\ssi}\after\app}\after\cur{\app\after(\Id{B\ssi}\times\deno{A'\ssi\subtypepp A\ssi})}\\
    &= \deno{\fntype{(A\ssi)}{(B\ssi)}\subtypepp\fntype{(A'\ssi)}{(B'\ssi)}}\\
    &= \deno{(\ab)\ssi\subtypepp(\fntype{A'}{B'})\ssi}
\end{align*}


$$\square$$
\end{proof}
\end{framed}

Similarly we can form the symmetrical weakening theorem.

\begin{framed}
    \begin{theorem}[Effect Weakening on Subtyping]\label{EffectWeakeningOnSubtyping}
        If $A \subtypep B$ and $\wrelw{\P'}{\P}$, then $A \subtypepp B$ and $\deno{A\subtypepp B} = \w\star\deno{A\subtypep B}$.
    \end{theorem}
    
    
    \begin{proof}
        The cases hold the same as in the corresponding substitution theorem.
        $$\square$$
    \end{proof}
\end{framed}

These subtyping theorems complete our understanding of how the type system is affected by the application of substitutions and weakenings.

\subsection{Effect Substitution and Weakening on Terms}
Now that we have defined the action of effect substitutions on all other components of the PEC type system, we are now at a point to define and prove the effect weakening and substitution theorems on terms. Following the intuition above that changes of index object should be modelled by applying the re-indexing functor to the morphisms denoting the terms, we can construct the theorems. Firstly, we must define the operation of effect substitutions on terms, as in Figure \ref{EffectSubstitutionActionTerms}.

\begin{figure}[H]
    \centering
    \begin{framed}
        
\begin{align*}
    x\ssi & = x \\
    \const{A}\ssi & = \const{(A\ssi)} \\
    (\lam{x}{A}{v})\ssi &= \lam{x}{(A\ssi)}{(v\ssi)}\\
    (\pifthenelse{A}{v}{v_1}{v_2})\ssi &= \pifthenelse{(A\ssi)}{v\ssi}{v_1\ssi}{v_2\ssi}\\
    (\apply{v_1}{v_2})\ssi&= \apply{(v_1\ssi)}{v_2\ssi}\\
    (\doin{x}{v_1}{v_2})\ssi&= \doin{x}{(v_1\ssi)}{(v_2\ssi)}\\
    (\elam{\a}{v})\ssi & = \elam{\a}{(v\ssi)}\qt{If $\a\#\si$}\\
    (\eapp{v}{\e})\ssi & = \eapp{(v\ssi)}{\si(\e)}\\
\end{align*}
    \end{framed}
    
    \caption{Action of effect substitution on terms}
    \label{EffectSubstitutionActionTerms}
\end{figure}

We can now formulate the substitution theorem on terms. We need to be more careful when dealing with denotations of terms. Due to subtyping, typing relations on terms may have multiple derivations. As denotations are defined inductively on these derivations, each denotation carries around an implicit derivation. In the next section, I prove that all derivations for a given type relation yield equal denotations. However, for now, we need to take more care to refer to the derivation. In the theorems in this section, I use the symbol $\D$ to indicate both a typing relation derivation and its denotation.


\begin{framed}
    \begin{theorem}[Effect Substitution on Terms]\label{EffectSubstitutionOnTerms}
        If $\typerelation{\P'}{\si}{\P}$ and typing derivation tree $\D$ derives $\gpetyperelation{v}{A}$ then there exists a typing derivation tree  $\D'$ deriving $\etyperelation{\P'}{\G\ssi}{v\ssi}{A\ssi}$ and $\D' = \si\star(\D)$.
    \end{theorem}
    
    
    \begin{proof}
        This proof makes use of the previous effect-substitution theorems in section \ref{SubsAndWeakening}, and the adjunction of quantification and the re-indexing functor of projection, $\pstar$. It proceeds by induction on the typing relation (Figure \ref{TypeRules}) and references term denotations (Figure \ref{TermDenotations}).
    
        \case{\vgen}
    
    This case makes use of the naturality condition \ref{NaturalityCondition} and simple reductions. 
    If $\D$ derives $\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}$ then by inversion, there exists $\D_1$ deriving  $\etyperelation{\P,\a}{\G}{v}{A}$ such that $\D = \bar{\D_1}$. By the extension lemma, we can pick $\a\notin\P'\wedge\a\notin\P$ so that we have: $\typerelation{(\P',\a)}{(\si, \a\setto\a)}{(\P,\a)}$. By induction, there exists $\D_1'$ deriving $\etyperelation{(\P', \a)}{\G\sub{\si, \a\setto\a}}{v\sub{\si,\a\setto\a}}{A\sub{\si, \a\setto\a}}$, which we can simplify to $\etyperelation{\P',\a}{\G\ssi}{v\ssi}{A\ssi}$ since $\a$ does not occur in $\P$ or $\P'$. Hence $\etyperelation{\P'}{\G\ssi}{v\ssi}{(\all{\a}{A})\ssi}$ by the tree given in Equation \ref{EffectSubTermsEffectLambda} ($\D'$).
    
    \begin{equation}\label{EffectSubTermsEffectLambda}
        \D' = \ntreeruleI{\vgen}{\treeruleI{\D_1'}{\etyperelation{\P',\a}{\G\ssi}{v\ssi}{A\ssi}}}{\etyperelation{\P'}{\G\ssi}{v\ssi}{(\all{\a}{A})\ssi}}
    \end{equation}
    
    It is also the case that:
    
    \begin{equation}
        \si\times\Id{} = \deno{\typerelation{(\P',\a)}{(\si, \a\setto\e)}{(\P,\a)}}
    \end{equation}
    
    So
    \begin{align*}
        \si\star\D &= \si\star(\bar{\D_1})\\
        & = \bar{(\si\times\Id{E})\star\D_1}\qt{By naturality}\\
        & = \bar{\D_1'}\qt{By induction}\\
        & = \D'
    \end{align*}
    
    \case{\vspec}
    
    This is a more complex case, as it makes use of several naturality properties and the adjunction $\pstar\dashv\allEn$. By inversion, if $\D$ derives $\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}$ then there exists $\D_1$ deriving $\gpetyperelation{v}{\all{\a}{A}}$ and $h = \deno{\typerelation{\P}{\e}{\effect}}$ such that $\D$ is derived from $\D_1$ and $h$ as in equations \ref{EffectSubTermsEffAppTree} and \ref{EffectSubTermsEffAppDeno}.
    
    
    \begin{equation}\label{EffectSubTermsEffAppTree}
        \D = \ntreeruleII{\vspec}{\treeruleI{\D_1}{\gpetyperelation{v}{\all{\a}{A}}}}{\treeruleI{h}{\typerelation{\P}{\e}{\effect}}}{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
    \end{equation}
    \begin{equation}\label{EffectSubTermsEffAppDeno}
        \D = \pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1
    \end{equation}
    
    So by induction and effect-substitution preserving well-formedness of effects, we have $\D_1'$ deriving $\etyperelation{\P'}{\G\ssi}{v\ssi}{(\all{\a}{A})\ssi}$ and $\wellformedeffect{\P'}{\si(\e)}$. Using the Effect-Spec type rule, we can construct $\D'$ deriving $\etyperelation{\P'}{\G\ssi}{\eapp{(v\ssi)}{(\si(\e))}}{A\ssi\ssub{\a}{\si(\e)}}$ from $\D_1'$, as in Equation \ref{EffectSubTermsEffAppNewTree}. Since $\a\#\si$, we can commute the applications of substitution. As a result, $\D'$ also derives $\etyperelation{\P'}{\G\ssi}{(\eapp{v}{\e})\ssi}{A\ssub{\a}{\e}\ssi}$.
    
    
    \begin{equation}
        \label{EffectSubTermsEffAppNewTree}
        \D' = \ntreeruleII{\vspec}{
        \treeruleI{\D_1'}{\etyperelation{\P'}{\G\ssi}{v\ssi}{(\all{\a}{A})\ssi}}
        }{
        \wellformedeffect{\P'}{\si(\e)}
        }{\etyperelation{\P'}{\G\ssi}{\eapp{(v\ssi)}{(\si(\e))}}{A\ssi\ssub{\a}{\si(\e)}}}
    \end{equation}
    
    
    
    So, due to the substitution theorem on effects,
    \begin{equation}
        h\after\si = \deno{\typerelation{\P}{\e}{\effect}}\after\si = \deno{\typerelation{\P'}{\si(\e)}{\effect}} = h'
    \end{equation}
    
    Hence, by applying the re-indexing functor to $\D$, we have:
    
    \begin{align}
        \si\star{\D} & = \si\star(\pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)\\
        & = (\pr{\Id{\G}}{h}\after\si)\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\si\star(\D_1)\\
        & = ((\si\times\Id{E})\after\pr{\Id{\G}}{h\after\si})\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1'\\
        & = (\pr{\Id{\G}}{h'})\star((\si\times\Id{E})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1' \label{SubsProofLineNumber}
    \end{align}
    
    Looking at the inner part of the functor application:
    Let \begin{align*}
        A & = \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}\\
    \end{align*}
    \begin{align*}
        (\si\times\Id{E})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}} &= (\si\times\Id{E})\star\counit{A}\\
        & = (\si\times\Id{E})\star(\widehat{\Id{\allEn(A)}})\\
        & = \widehat{\bar{(\si\times\Id{E})\star(\widehat{\Id{\allEn(A)}})}}\qt{By bijection}\\
        & = \widehat{\si\star(\bar{\widehat{\Id{\allEn(A)}}})}\qt{By naturality}\\
        & = \widehat{\si\star(\Id{\allEn(A)})}\qt{By bijection}\\
        & = \widehat{\Id{\allEm(A\after(\si\times\Id{E}))}}\qt{By S-preserving property, naturality}\\
        & = \widehat{\Id{\allEm(A\sub{\si,\a\setto\a})}}\qt{By Substitution theorem}\\
        & = \e_{A\ssi}
    \end{align*}
    
    Going back to the expression in Equation \ref{SubsProofLineNumber}
    
    \begin{align*}
        \si\star{\D} & = (\pr{\Id{\G}}{h'})\star(\e_{A\ssi})\after\D_1')\\
        & = \D'
    \end{align*}
    $$\square$$
    \end{proof}
    
\end{framed}

Similarly, we can derive the weakening theorem on terms.


\begin{framed}
    \begin{theorem}[Effect Weakening on Terms]\label{EffectWeakeningOnTerms}
        If $\wrelw{\P'}{\P}$ and $\D$ derives $\gpetyperelation{v}{A}$ then:
        \begin{enumerate}[label=\roman*.]
            \item there exists $\D'$ deriving $\etyperelation{\P'}{\G}{v}{A}$ 
            \item $\D' = \w\star\D$.
        \end{enumerate}
    \end{theorem}
    
    \begin{proof}
        This theorem is proved in a similar fashion to the effect substitution theorem (Theorem \ref{EffectSubstitutionOnTerms}) and many of its cases are the same. Some cases of this proof can be found in Appendix \ref{AppendixEffectWeakeningOnTerms}.
    \end{proof}
\end{framed}

This concludes our treatment of effect-environment substitution and weakening.

\subsection{Term Substitution and Weakening}

Having analysed the manipulation of the effect-variable environment, we are now at a point to start considering weakenings and substitution of the type environments. Type environment weakenings are inductively defined inf Figure \ref{TermWeakeningRelation} with respect to an effect-variable environment.


\begin{figure}[H]
    \centering
    \begin{framed}
        \[
            \ntreeruleI{\tid}{\wellformedok{\P}{\G}}{\pewrel{\i}{\G}{\G}}
            \quad  
            \condtreeruleII{\tproject}{\pewrel{\w}{\G'}{\G}}{\typerelation{\P}{A}{\type}}{\pewrel{\w \pi}{\G, x: A}{\G}}{x \notin \dom{\G'}}
        \]
        
        \[
            \condtreeruleII{\textend}{\pewrel{\w}{\G'}{\G}}{ A \subtype B}{\pewrel{\w \x}{\G', x: A}{\G, x: B}}{x \notin \dom{\G'}}
        \] 
    \end{framed}
    \caption{Definition of the term weakening relation}
    \label{TermWeakeningRelation}
\end{figure}


The denotation of such a weakening is a morphism within the fibre category derived from the effect-variable environment: $\deno{\pewrel{\w}{\G'}{\G}}: \G' \rightarrow \G \in \C(E^n)$. These denotations are defined in Figure \ref{TermWeakeningDenotations}.

\begin{figure}[H]
    \centering
    \begin{framed}
        \begin{align}
            \deno{\pewrel{\i}{\G}{\G}} &= \idg: \G \rightarrow \G \in \C(E^n)
            \\
            \deno{\pewrel{\w\pi}{\G', ax}{\G}} &= \deno{\pewrel{\w}{\G'}{\G}}\after\p: \G'\times A \rightarrow \G
            \\
            \deno{\pewrel{\w\x}{\G', x: A}{\G, x: B}} &= \deno{\pewrel{\w}{\G'}{\G}}\times \deno{A\subtypep B}: \G'\times A \rightarrow \G\times B
        \end{align}
        
    \end{framed}\caption{Denotations of Term Weakening}
    \label{TermWeakeningDenotations}
\end{figure}


Similarly to the definition of effect-environment substitutions (Section \ref{SectionEffectSubstitution}, type-environment substitutions are also snoc-lists derived inductively with respect to an effect-variable environment inf Figure \ref{TermSubstitutionDefinition}.

\begin{figure}[H]
    \centering
\begin{framed}
    
    \[
        \si\gens\nil\mid\si,x\setto v    
    \]

    \[
    \ntreeruleI{\tsubnil}{\wellformedok{\P}{\G'}}{\etyperelation{\P}{\G'}{\nil}{\nil}}
    \quad
    \condtreeruleII{\tsubextend}{
        \etyperelation{\P}{\G'}{\si}{\G}
    }{
        \etyperelation{\P}{\G'}{v}{A}
    }{
        \etyperelation{\P}{\G'}{(\si, x \setto v)}{(\gax)}
    }{x \notin \dom{\G'}}
\]
\end{framed}
    \caption{Definition of Term Substitutions}
    \label{TermSubstitutionDefinition}
\end{figure}




We also need to explain the action of these term substitutions on terms. We define the action of applying a substitution $\si$  on term $v$ as $v\ssi$. 


\begin{framed}
    \begin{definition}[Freshness]
        We write $x\#\si$ to indicate that x does not occur in the domain of $\si$ or as a free variable in any of its substituted terms.
    \end{definition}
\end{framed}

\begin{align*}
    x\sub{\nil} & = x \\
    x\sub{\si,x\setto v} & = v \\
    x\sub{\si,x'\setto v'} & = x\ssi\qt{If }x \neq x'\\
    \const{A}\ssi & = \const{A} \\
    (\lam{x}{A}{v})\ssi &= \lam{x}{A}{(v\ssi)}\qt{If }x\#\si\\
    (\pifthenelse{A}{v}{v_1}{v_2})\ssi &= \pifthenelse{A}{v\ssi}{v_1\ssi}{v_2\ssi}\\
    (\apply{v_1}{v_2})\ssi&= \apply{(v_1\ssi)}{v_2\ssi}\\
    (\doin{x}{v_1}{v_2})&= \doin{x}{(v_1\ssi)}{(v_2\ssi)}\qt{If } x\#\si\\
    (\elam{\a}{v})\ssi & = \elam{\a}{(v\ssi)}\\
    (\eapp{v}{\e})\ssi & = \eapp{(v\ssi)}{\e}\\
\end{align*}

Denotations of type-environment substitutions are morphisms in the appropriate fibre category: $\deno{\etyperelation{\P}{\G'}{\si}{\G}}: \G' \rightarrow \G \in \C(E^n)$ and are defined in Figure \ref{TermSubstitutionDenotations}.

\begin{figure}[H]
    \centering
    \begin{framed}
\begin{align*}
    \deno{\etyperelation{\P}{\G'}{\nil}{\nil}} = \term{\G'}:&\quad \G' \rightarrow \1
    \\
    \deno{\etyperelation{\P}{\G'}{(\si, x \setto v)}{\gax}} =&\quad \pr{\deno{\etyperelation{\P}{\G'}{\G}}}{\deno{\etyperelation{\P}{\G'}{v}{A}}}: \G' \rightarrow \G\times A
\end{align*}
    \end{framed}
    \caption{Denotations for term substitutions}
    \label{TermSubstitutionDenotations}
\end{figure}


In order to prove the quantification case of term-environment weakening and substitution theorems on terms, as can be seen in the road map in Figure \ref{RoadMap}, it will be necessary to be able to weaken the effect-variable environment on term-environment weakenings and substitutions.

Let us first consider the action of effect weakenings on these morphisms. The weakening theorem on term-environment weakenings is as so:



\begin{framed}
    \begin{theorem}[Effect Weakening on Term Weakening]\label{EffectWeakeningOnTermWeakening}
        If $\wrel{\w_1}{\P'}{\P}$ and $\pewrel{\w}{\G'}{\G}$ then:
        \begin{enumerate}[label=\roman*.]
            \item $\ewrel{\P'}{\w}{\G'}{\G}$
            \item $\deno{\ewrel{\P'}{\w}{\G'}{\G}} = \w_1\star\deno{\pewrel{\w}{\G'}{\G}}$.
        \end{enumerate} 
    \end{theorem}
    
    \begin{proof}
        By induction on the derivation of $\w$. making use of weakening on types, type environments, and subtyping.
    
        \case{\tid}
        Then $\w = \i$, so its denotation is $\w = \Id{\G_{E^n}}$
        
        So
        \begin{equation}
          \w_1\star(\Id{\G_{E^n}}) = \Id{\G_{E^m}} = \deno{\ewrel{\P'}{\i}{\G}{\G}}  
        \end{equation}
        
        \case{\tproject}
        Then $\w = \w'\pi$
        
        \begin{equation}
            \ntreeruleI{\tproject}{\ewrel{\P}{\w'}{\G'}{\G}}{\ewrel{\P}{\w\pi}{\G',x:A}{\G}}
        \end{equation}
        
        So $\w = \w'\after\p$
        
        Hence
        \begin{align*}
            \w_1\star(\w) &= \w_1\star(\w')\after\w_1\star(\p)\\
            & = \deno{\ewrel{\P'}{\w'}{\G'}{\G}}\after\p\\
            & = \deno{\ewrel{\P'}{\w'\pi}{(\G',x:A)}{\G}}\\
            & = \deno{\ewrel{\P'}{\w}{(\G', x:A)}{\G}}
        \end{align*}
        
        \case{\textend}
        Then $\w = \w'\x$
        
        \begin{equation}
            \ntreeruleII{\textend}{\ewrel{\P}{\w'}{\G'}{\G}}{A\subtypep B}{\ewrel{\P}{\w\x}{(\G',x:A)}{(\G, x:B)}}
        \end{equation}
        
        So $\w = \w'\times\deno{A\subtypep B}$
        
        Hence
        \begin{align*}
            \w_1\star(\w) &=(\w_1\star(\w')\times\w_1\star(\deno{A\subtypep B})\\
            & = (\deno{\ewrel{\P'}{\w'}{\G'}{\G}}\times\deno{A\subtypepp B})\\
            & = \deno{\ewrel{\P'}{\w}{(\G',x:A)}{(\G,x:B)}}
        \end{align*}
    
        $$\square$$
    \end{proof}
\end{framed}


Secondly, we can state and prove the weakening theorem on term-environment substitutions.



\begin{framed}
    \begin{theorem}[Effect Weakening on Term Substitution]\label{EffectWeakeningOnTermSubstitution}
        If $\etyperelation{\P}{\G'}{\si}{\G}$ and $\wrelw{\P'}{\P}$ then:
        
        \begin{enumerate}[label=\roman*.]
            \item $\etyperelation{\P'}{\G'}{\si}{\G}$
            \item $\deno{\etyperelation{\P'}{\G'}{\si}{\G}} = \w\star\deno{\etyperelation{\P}{\G'}{\si}{\G}}$
        \end{enumerate}
    \end{theorem}
    
    
    \begin{proof}
        By induction on the definition of $\si$, making use of the weakening on terms, types, and type environments.
    
        \case{\tsubnil}
        Then $\si = \term{\G'_{E^n}}$, so $\w\star(\si) = \term{\G'_{E^m}} = \deno{\etyperelation{\P'}{\G'}{\si}{\G}}$
        
        \case{\tsubextend}
        Then $\si = (\si',x\setto v)$
        
        \begin{align*}
            \w\star\si & = \w*\pr{\si'}{\deno{\gpetyperelation{v}{A}}}\\
            & = \pr{\w\star\si'}{\w\star\deno{\gpetyperelation{v}{A}}}\\
            &=\pr{\deno{\etyperelation{\P'}{\G'}{\si'}{\G}}}{\deno{\etyperelation{\G'}{\P'}{v}{A}}}\\
            &=\deno{\etyperelation{\P'}{\G'}{\si}{\gax}}
        \end{align*}
    
        $$\square$$
    
    \end{proof}
\end{framed}

As with effect substitutions, it is useful to define a couple of special substitutions and lemmas on term substitutions. Firstly, we define the identity and single substitutions in an equivalent way in Figure \ref{TermSubstitutionIdAndSingle}.

\begin{figure}[H]
    \centering

    \begin{minipage}{.45\linewidth}
        \begin{framed}
            \begin{align*}
                \etyperelation{\P}{\G}{&\Id{\G}}{\G}\\
                \Id{\nil} & = \nil\\
                \Id{\gax} & = (\idg, x\setto x)\\
                \ssub{x}{v} & = (\idg, x\setto v)
            \end{align*}
        \end{framed}
    \end{minipage}
    \quad
    \begin{minipage}{.45\linewidth}
        \begin{framed}
            \begin{align*}
                \deno{\etyperelation{\P}{\G}{\Id{\G}}{\G}}: &\quad \G\rightarrow\G\\
                \deno{\etyperelation{\P}{\G}{\Id{\G}}{\G}} = &\quad  \idg\\
                \deno{\etyperelation{\P}{\G}{\ssub{x}{v}}{\gax}}: &\quad \G\rightarrow \G\times A\\
                \deno{\etyperelation{\P}{\G}{\ssub{x}{v}}{\gax}} =\quad & \pr{\idg}{\deno{\gpetyperelation{v}{A}}}
            \end{align*}
        \end{framed}
    \end{minipage}
    
    \caption{Definition and denotation of identity and single term substitutions}
    \label{TermSubstitutionIdAndSingle}
\end{figure}



By inspection, these also have simple denotations, similar to those seen in the case of effect substitutions. Furthermore, it will be useful to have an analogue of the extension lemma for term substitutions.


\begin{framed}
    \begin{lemma}[Extension Lemma on Term Substitutions]
        If $\etyperelation{\P}{\G'}{\si}{\G}$ and $x\#\si$\\ then $\etyperelation{\P}{(\G',x: A)}{(\si, x\setto x)}{(\gax)}$ with denotation $$\deno{\etyperelation{\P}{(\G',x: A)}{(\si, x\setto x)}{(\gax)}} = \deno{\etyperelation{\P}{\G'}{\si}{\G}} \times \Id{A}$$
    \end{lemma}
    
    \begin{proof}
         Makes use of the weakening on terms (theorem \ref{TermWeakeningOnTerms}). If $\etyperelation{\P}{\G'}{\si}{\G}$ then $\etyperelation{\P}{(\G', x:A) }{\si}{\G}$ with denotation $\si\after\p$. $\square$
    \end{proof}
\end{framed}


Finally, we can move on to the term substitution and weakening theorems. These theorems are the final step before we prove that derivations of the same typing-relation instance have the same denotation and then move onto soundness. They demonstrate that we can model the action of applying well-formed type-environment changes by pre-composing the morphisms to be acted on with a morphism modelling the change in environment. The term-substitution theorem is formulated as so: 

\begin{framed}
    \begin{theorem}[Term Substitution]\label{TermSubstitutionOnTerms}
        If $\etyperelation{\P}{\G'}{\si}{\G}$ and $\D$ is a derivation of $\gpetyperelation{v}{A}$, then we can construct $\D'$ deriving $\etyperelation{\P}{\G'}{v\ssi}{A}$ with denotation $\D' = \D \after \si$.
    \end{theorem}
    
    
    \begin{proof}
        By induction on the derivation of $\D$ (Figure \ref{TypeRules}) using the denotations of terms (Figure \ref{TermDenotations}). Making use of the weakening of effect-variable environments on term substitutions in the case of (\textit{\vgen})
    
    \case{\vweaken}
    
    \begin{equation} \label{TermSubsWeakenRule}
        \ntreeruleI{\vweaken}{\treeruleI{\D_1}{\etyperelation{\P}{\G''}{x}{A}}}{\etyperelation{\P}{\G'',y: B}{x}{A}}
    \end{equation}
    
    By inversion, $\G = \G', y:B$ and we have $\D_1$ deriving the tree in Equation \ref{TermSubsWeakenRule}. In addition, by inversion of the well-formedness of $\etyperelation{\P}{\G'}{\si}{\G}$, we can decompose $\si$ into $(\si', y\setto v)$. Here $\si'$ satisfies $\etyperelation{\P}{\G'}{\si'}{\G''}$, and the denotation of $\si$ depends on that of $\si'$: $\deno{\etyperelation{\P}{\G'}{\si}{\G}} = \pr{\deno{\etyperelation{\P}{\G'}{\si'}{\G''}}}{\deno{\etyperelation{\P}{\G'}{v}{B}}}$. Hence by induction on $\D_1$ we have $\D_1'$ deriving $(\etyperelation{\P}{\G'}{x\ssi}{A})$. So we can take $\D'$ to be $\D_1'$.
    
    Hence
    \begin{align*}
        \D' & = \D_1' \qt{By definition}\\
            & = \D_1\after\si'\qt{By induction}\\
            & = \D_1\after\p\after\pr{\si'}{\deno{\etyperelation{\P}{\G'}{v}{B}}}\qt{By product property}\\
            & = \D_1\after\p\after\si\qt{By defintion of the denotation of $\si$}\\
            & = \D\after\si\qt{By defintion.}
    \end{align*}
    
    
    \case{\vfun}
    
    By inversion, we have $\D_1$ such that the derivation tree in Equation \ref{TermSubLambda} holds. By induction on $(\gax)$ and $\D_1$ we have $\D_1'$ deriving $\etyperelation{\P}{\G', x:A}{(v\ssi)}{B}$. Also by induction, and making use of the extension lemma, we can derive the denotation of $\D_1'$  from $\D_1$: $\D_1' = \D_1\after(\si\times\Id{A})$. Furthermore, $\D_1'$ allows us to construct the derivation $\D'$, in Equation \ref{TermSubLambdaPrime}.
    \begin{equation}\label{TermSubLambda}
        \D = \ntreeruleI{\vfun}{
            \treeruleI{D_1}{\etyperelation{\P}{\G, x:A}{v}{B}}
        }{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
    \end{equation}
    
    
    \begin{equation}\label{TermSubLambdaPrime}
        \D' = \ntreeruleI{\vfun}{
            \treeruleI{\D_1'}{\etyperelation{\P}{\G', x:A}{(v\ssi)}{B}}
        }{\etyperelation{\P}{\G}{(\lam{x}{A}{v})\ssi}{\ab}}
    \end{equation}
    
    
    Hence:
    
    \begin{align*}
        \D' &= \cur{\D_1'}\qt{By definition}\\
            &= \cur{\D_1\after(\si\times\Id{A})}\qt{By induction and extension lemma.}\\
            & = \cur{\D_1}\after\si\qt{By the exponential property (Uniqueness)}\\
            &= \D\after\si\qt{By Definition}\\
    \end{align*}
    
    $$\square$$
    \end{proof}
\end{framed}

The term-weakening theorem is formulated similarly. 

\begin{framed}
    \begin{theorem}[Term Weakening]\label{TermWeakeningOnTerms}
        If $\pewrel{\w}{\G'}{\G}$ and $\D$ is a derivation of $\gpetyperelation{v}{A}$ then we can derive $\D'$, a derivation of $\etyperelation{\P}{\G'}{v}{A}$ with denotation $\D' = \D\after\w$.
    \end{theorem}
    
    \begin{proof}
        This proof follows similarly to the proof of the substitution theorem (Theorem \ref{TermSubstitutionOnTerms}). Some cases can be found in Appendix \ref{AppendixTermWeakeningTheorem}
    \end{proof}
    
\end{framed}




\subsection{Summary}
In this section, I have stated and proved a number of theorems to do with the substitution of effect and term variables within an expression. In particular, these theorems give us a way of manipulating the denotations of terms when the effect-variable and type environments are changed. As a result, these theorems provide us with a set of tools to tackle problems such as soundness and the uniqueness do denotations.

\section{Uniqueness of Denotations}\label{UniqueDenotations}

Up until this point, due to the subtyping rule, we have had to be careful about the implicit typing derivation for every term denotation $\deno{\gpetyperelation{v}{A}}$. This is because typing relations have multiple derivations, as seen in Figure \ref{NonUniqueDerivations}. We are now equipped with the tools to prove that all derivations of the same typing relation instance $\gpetyperelation{v}{A}$ induce the same denotation. This allows us to no longer worry about the equality of denotations, which will be helpful in the soundness proof.


\begin{figure}[H]
\begin{framed}
        \centering
            \begin{minipage}{0.47\textwidth}
                \centering
                \begin{equation*}
                    \scalebox{.9}{$                    \ntreeruleII{\vsubtype}{
                        \scalebox{.6}{$
                        \ntreeruleII{\vapply}{\gpetyperelation{v_1}{\ab}}{\gpetyperelation{v_2}{A}}{\gpetyperelation{\apply{v_1}{v_2}}{B}}
                        $}
                    }{
                        \scalebox{.9}{$B\subtypep B'$}
                    }{
                        \gpetyperelation{\apply{v_1}{v_2}}{B'}
                    }
                    $}
                \end{equation*}
            \end{minipage}
            \quad
            \begin{minipage}{0.47\textwidth}
                \centering

                \begin{equation*}
                    \scalebox{.9}{$
                    \ntreeruleII{\vapply}{
                        \scalebox{.6}{$
                        \ntreeruleII{\vsubtype}{\gpetyperelation{v_1}{\ab}}{\ab\subtypep \fntype{A}{B'}}{\gpetyperelation{v}{\fntype{A}{B'}}}
                        $}
                    }{
                        \scalebox{.7}{$\gpetyperelation{v_2}{A}$}
                    }{
                        \gpetyperelation{\apply{v_1}{v_2}}{B'}
                    }$}
                \end{equation*}
            \end{minipage}
\end{framed}
    \caption{Two different derivations of the same typing relation.}
    \label{NonUniqueDerivations}
\end{figure}

To prove that all typing derivations have the same denotation, I first introduce the concept of a \textit{reduced} typing derivation that is unique to each term and type in each effect and type environment. Next, I present a function, $\reduce$, which recursively maps  typing derivations to their reduced equivalent. I also prove that this function preserves the denotation of the derivations. That is $\deno{\gpetyperelation{v}{A}} = \deno{\reduce(\gpetyperelation{v}{A})}$. Hence, we can conclude, since all derivations for a typing relation instance reduce to the same unique typing derivation, and that the reduction function preserves the denotations, that all derivations of a typing derivation have the same denotation.

The need for reduced typing derivations comes about because of subtyping. The subtyping rule can be inserted into different places in a derivation to derive the same typing relation. Hence, the reduction function focuses on only placing subtyping rule instances in specific places. 

In particular a reduced typing derivation is one where subtyping rule only occurs in three places. Firstly, the subtyping rule must occur exactly once at the root of the tree in order to coerce the the typing relation to the correct type. Secondly, the subtyping rule must occur at the root of any of subtrees deriving the preconditions of the type-annotated (if) rule. This is to coerce the condition to a boolean type, and each of the branches to the type $A$ in the if-expression itself. Finally, the subtyping rule must occur at the root of the argument subtree of an (apply) rule. This allows us to coerce the argument to the correct type to match the parameter type in a lambda expression. These subtyping rule instances may be the identity subtyping rule, making use of the reflexive relation $A \subtypep A$. These rules have the effect of only introducing subtyping rule uses when it is necessary maintain syntactic correctness of the derivation. 

\begin{aside}[Syntactic Subtyping]
    If subtyping were a syntactic feature, that is if subtyping were induced by explicit casts, then the rules for the typing relation would be entirely syntax directed, and hence we would not have the ambiguity that these theorems are required in order to solve.
\end{aside}


\begin{framed}
    \begin{theorem}[Uniqueness of reduced Derivations]\label{UniquenessOfReducedDenotations}
        These reduced derivations are unique.    
    \end{theorem}
    
    \begin{proof}
        This proof proceeds by induction on the term structure, making use of the unique derivations of the subterms to show that a reduced derivation of the whole term must also be unique. There are no cases for subtyping, as it is not a syntactic feature. 
    
        \case{\vbind} This case makes use of the weakening theorem on type environment. Let the trees in equations \ref{UniqueBindOne}, \ref{UniqueBindTwo} be the respective unique reduced type derivations of the subterms. By weakening, $\ewrel{\P}{\i\x}{(\G, x:A)}{(\G, x: A')}$ so if there's a derivation of $\etyperelation{\P}{(\G, x:A')}{v_2}{B}$, there's also one of $\etyperelation{\P}{\gax}{v_2}{B}$ (equation \ref{UniqueBindThree}). 
    
        \begin{equation}\label{UniqueBindOne}
            \edeltacrule{\G}{v_1}{\e_1}{A}{\e_1'}{A'}
        \end{equation}
    
        \begin{equation}\label{UniqueBindTwo}
            \edeltacruleprime{\G, x:A'}{v_2}{\e_2}{B}{\e_2'}{B'}
        \end{equation}
    
        \begin{equation}\label{UniqueBindThree}
            \edeltacruleprimeprime{(\G, x:A)}{v_2}{\e_2}{B}{\e_2'}{B'}
        \end{equation}
    
        Since the effects monoid operation is monotone, if $\e_1\subeffectp\e_1'$ and $\e_2\subeffectp\e_2'$ then $\e_1\dot\e_2 \subeffectp \e_1'\dot\e_2'$. Hence the reduced type derivation of $\gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1'\dot\e_2'}{B'}}$ can be seen in Equation \ref{UniqueBindResult}.
    
        \begin{equation}\label{UniqueBindResult}
            \resizebox{.9\hsize}{!}{
            \ntreeruleII{\vsubtype}{
                \ntreeruleII{\vbind}{
                    \treeruleI{\D}{\gpetyperelation{v_1}{\M{\e_1}{A}}}
                }{
                    \treeruleI{\D''}{\etyperelation{\P}{\G, x:A}{v_2}{\M{\e_2}{B}}}
                } {
                    \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
                }
            }{
                \subeffecttreep{\e_1\dot\e_2}{B}{\e_1'\dot\e_2'}{B'}
            } {
                \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1'\dot\e_2'}{B'}}
            }
        }
        \end{equation}
    
        \case{\vgen}
        If Equation \ref{ApplyUniqueOne} is the unique reduced derivation of $\etyperelation{\P,\a}{\G}{v}{B}$, then the unique reduced derivation of $\gpetyperelation{\elam{\a}{A}}{\all{\a}{B}}$ is shown in Equation \ref{ApplyUniqueResult}.
    
        \begin{equation}\label{ApplyUniqueResult}
            \ntreeruleII{\vsubtype}{
                \ntreeruleI{\vgen}{
                    \treeruleI{\D}{\etyperelation{\P,\a}{\G}{v}{A}}
                }{
                    \gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}
                }
            }{
                \all{\a}{A}\subeffectp\all{\a}{B}
            }{
                \gpetyperelation{\elam{\a}{B}}{\all{\a}{B}}
            }
        \end{equation}
    
        \begin{eqnarray}\label{ApplyUniqueOne}
            \ntreeruleII{\vsubtype}{
                \treeruleI{\D}{\etyperelation{\P,\a}{\G}{v}{A}}
            }{
                A\subtypepa B
            }{
                \etyperelation{\P,\a}{\G}{v}{B}
            }
        \end{eqnarray}
        $$\square$$
    \end{proof}
    
\end{framed}

The $\reduce$ function maps each derivation to its reduced equivalent. It does this by pushing subtyping rules from the leaves of the derivation tree down towards the root of the tree. The function case splits on the root of the tree and works up recursively. Some cases of the function are given in Figure \ref{ReduceFunctionCases}. 

\begin{figure}[H]
    \begin{framed}
        {\centering
            \textbf{The Reduce Function}   \par
        }

    \case{\vapply}
    To find the reduction of a tree ending in (\textit{\vapply}) as seen in Equation \ref{ApplyBeforeReduction}, we pattern match on the reductions of the subtrees to find trees $\D_1'$, $\D_2'$, as seen in equations \ref{ApplyReductionOne} and \ref{ApplyReductionTwo}. These trees allow us to build a reduced derivation tree as in Equation \ref{ApplyAfterReduction}.

    \begin{equation}\label{ApplyBeforeReduction}
        \scalebox{.8}{$
        \reduce(\ntreeruleII{\vapply}{
            \treeruleI{\D_1}{
                \gpetyperelation{v_1}{\ab}
            }
        }{
            \treeruleI{\D_2}{
                \gpetyperelation{v_2}{A}
            }
        }{
            \gpetyperelation{\apply{v_1}{v_2}}{B}
        })
        $}
    \end{equation}

    \begin{equation}\label{ApplyReductionOne}
        \scalebox{.8}{$
            \ntreeruleII{\vsubtype}{
                \treeruleI{\D'_1}{\gpetyperelation{v_1}{\fntype{A'}{B'}}}
            }{
                \fntype{A'}{B'}\subtypep\fntype{A}{B}
            }{
                \gpetyperelation{v_1}{\ab}
            }  = \reduce(\D_1)
            $}
    \end{equation}

    \begin{equation}\label{ApplyReductionTwo}
        \scalebox{.8}{$
        \ntreeruleII{\vsubtype}{
            \treeruleI{\D'_2}{\gpetyperelation{v}{A'}}
        }{
            A'\subtypep A
        }{
            \gpetyperelation{v_1}{A}
        } = \reduce(\D_2)
        $}
    \end{equation}


    \begin{equation}\label{ApplyAfterReduction}
        \scalebox{.8}{$
        \ntreeruleII{\vsubtype}{
            \ntreeruleII{\vapply}{
                \treeruleI{
                    \D'_1
                }{
                    \gpetyperelation{v_1}{\fntype{A'}{B'}}
                }
            }{
                \ntreeruleII{\vsubtype}{
                    \treeruleI{\D'_2}{\gpetyperelation{v_2}{A''}}
                }{
                    A'' \subtypep A \subtypep A'
                } {
                    \gpetyperelation{v_2}{A'}
                }
            }{
                \gpetyperelation{\apply{v_1}{v_2}}{B'}
            }
        }{
            B' \subtypep B
        }{
            \gpetyperelation{\apply{v_1}{v_2}}{B}
        }
        $}
    \end{equation}


    \case{\vbind}

    To find the reduction of a tree ending in a use of the (\textit{\vbind}) rule as seen in Equation \ref{BindBeforeReduction}, we first reduce the left-most subtree, $\D_1$ to find $\D_1'$, as seen in Equation \ref{BindReductionOne}.
    \begin{equation}\label{BindBeforeReduction}
        \scalebox{.8}{$
        \reduce(
            \ntreeruleII{\vbind}{
                \treeruleI{
                    \D_1
                }{
                    \gpetyperelation{v_1}{\M{\e_1}{A}}
                }
            }{
                \treeruleI{
                    \D_2
                }{
                    \etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}
                }
            } {
                \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
            }
        )
        $}
    \end{equation}


    \begin{equation}\label{BindReductionOne}
        \scalebox{.8}{$
        \ntreeruleII{\vsubtype}{
            \treeruleI{\D'_1}{\gpetyperelation{v_1}{\M{\e'_1}{A'}}}
        }{
        \subeffecttreep{\e_1'}{A'}{\e_1}{A}
        }{
            \gpetyperelation{v_1}{\M{\e_1}{A}}
        } = \reduce(\D_1)
        $}
    \end{equation}

    Since $\ewrel{\P}{(i,\x)}{(\G, x: A')}{(\gax)}$ if $A' \subtypep A$, and because $\D_2$ derives $\etyperelation{\P}{(\gax)}{v_2}{\M{\e_2}{B}}$, there also exists a derivation $\D_3$ of $\etyperelation{\P}{(\G, x: A')}{v_2}{\M{\e_2}{B}}$. $\D_3$ is derived from $\D_2$ simply by inserting a (\textit{\vsubtype}) rule below all instances of the (\textit{\vvar}) rule. Then we can reduce $\D_3$ to find $\D_3'$ in \ref{BindReductionThree}.

    \begin{equation}\label{BindReductionThree}
        \scalebox{.8}{$
        \ntreeruleII{\vsubtype}{
            \treeruleI{\D'_3}{\etyperelation{\P}{\G, x: A'}{v_2}{\M{\e'_2}{B'}}}
        }{
        \subeffecttreep{\e_1'}{B'}{\e_2}{B}
        }{
            \etyperelation{\P}{\G, x: A'}{v_2}{\M{\e_2}{B}}
        } = \reduce(\D_3)
        $}
    \end{equation}
    

    Since the effects monoid operation is monotone, if $\e_1\subeffectp\e_1'$ and $\e_2\subeffectp\e_2'$ then $\e_1\dot\e_2 \subeffectp \e_1'\dot\e_2'$. Then the result of reduction of the whole bind expression is:


    \begin{equation}
        \scalebox{0.8}{$
        \ntreeruleII{\vsubtype}{
            \subeffecttreep{\e_1'\dot\e_2'}{B'}{\e_1\dot\e_2}{B}
        }{
            \ntreeruleII{\vbind}{
                \treeruleI{
                    \D'_1
                }{
                    \gpetyperelation{v_1}{\M{\e_1'}{A'}}
                }
            }{
                \treeruleI{
                    \D'_3
                }{
                    \etyperelation{\P}{\G, x: A'}{v_2}{\M{\e_2'}{B'}}
                }
            }{
            \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1'\dot\e_2'}{B}}
            }
        }{
            \gpetyperelation{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
        }
        $}
    \end{equation}
    \end{framed}

    \caption{Some cases of the reduce function.}
    \label{ReduceFunctionCases}
\end{figure}


\begin{framed}
    \begin{theorem}[Reduction preserves denotations]\label{ReductionPreservesDenotations}
       If the derivation $\D'$ is the result of applying  reduce to $\D$ then the denotations of the derivations are equal. That is $\D' = \reduce(\D) \implies \D' = \D$.
    \end{theorem}
    
    
    \begin{proof}
        We proceed by induction over the structure of $\D$, making use of the substitution and weakening theorems. We make use of the the definition of the $\reduce$ function as defined in Figure \ref{ReduceFunctionCases}. We also use the definitions of $\D_1, \D_2 ...$ from the same figure.    
        \case{\vapply}
        This case makes use of the fact that composing subtyping morphisms gives the transitive subtyping morphism. Let us define some short-hands.
            \begin{align*}
                f & = \deno{A\subtypep A'}: A\rightarrow A' \\
                f' & = \deno{A''\subtypep A}: A'' \rightarrow A \\
                g & = \deno{B' \subtypep B}: B' \rightarrow B \\
            \end{align*}
    
            Hence 
            \begin{align*}
                \deno{\fntype{A'}{B'}\subtypep \ab} & = (g)^A \after (B')^f \\
                & = \cur{\app\after \app}\after\cur{\app\after(\Id{}\times f)}\\
                & = \cur {g\after\app\after(\Id{}\times f)}
            \end{align*}
    
            Then 
            \begin{align*}
                \D & = \app\after\pr{\D_1}{\D_2}\qt{By definition}\\
                & = \app\after\pr{\cur {g\after\app\after(\Id{}\times f)}\after\D'_1}{f'\after\D'_2}\qt{By reductions of $\D_1, \D_2$}\\
                & = \app\after(\cur {g\after\app\after(\Id{}\times f)}\times\Id{A})\after\pr{\D'_1}{f'\after\D'_2} \qt{Factoring out}\\
                & = g\after\app\after(\Id{}\times f)\after\pr{\D'_1}{f'\after\D'_2}\qt{By the exponential property}\\
                & = g\after\app\after\pr{\D'_1}{f\after f'\after \D'_2}\\
                & = \D'\qt{By defintion}
            \end{align*}
            
        \case{\vbind}
    
        This is a long case that makes use of the term-environment weakening theorem on terms.
    
        Let us define the following helper morphisms:
        \begin{align*}
            f & = \deno{A' \subtypep A}: A' \rightarrow A\\
            g & = \deno{B' \subtypep B}: B' \rightarrow B\\
            h_1 & = \deno{\e_1' \subeffectp \e_1} : \T{\e_1'}{} \rightarrow \T{\e_1}{} \\
            h_2 & = \deno{\e_2'\subeffectp \e_2}:\T{\e_2'}{} \rightarrow \T{\e_2}{}\\
            h & = \deno{\e_1'\dot\e_2'\subeffectp\e_1\dot\e_2}: \T{\e_1'\dot\e_2'}{}\rightarrow \T{\e_1\dot\e_2}{}
        \end{align*}
    
        Due to the denotation of the weakening used to derive $\D_3$ from $\D_2$, we have 
        \begin{equation}
            \D_3 = \D_2\after(\idg\times f)
        \end{equation}
    
        Due to the reduction of $\D_3$,
        we have 
        \begin{equation}
            \D_3 = h_{2, B} \after \T{\e_2'}{g}\after \D_3'
        \end{equation}
    
        So we can look at the denotation of the whole term.
    
        \begin{align*}
            \D &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{\D_1}\qt{By definition.}\\
            &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{h_{1, A}\after\T{\e_1'}{f}\after\D_1'}\qt{By reduction of $\D_1$.}\\
            &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after(\idg\times h_{1, A})\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Factor out $h_1$}\\
            &= \bind{\e_1}{\e_2}{B}\after \T{\e_1}{\D_2}\after
            h_{1, (\G\times A)}\after
            \tstrength{\e_1'}{\G}{A}\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Tensor strength and subeffecting $h_1$}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{\D_2}\after
            \tstrength{\e_1'}{\G}{A}\after\pr{\idg}{\T{\e_1'}{f}\after\D_1'}\qt{Naturality of $h_1$}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{\D_2}\after
            \tstrength{\e_1'}{\G}{A}\after(\idg\times \T{\e_1'}{f})\after\pr{\idg}{\D_1'}\qt{Factor out pairing again}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{(\D_2\after(\idg\times f))}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{Tensorstrength}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{(\D_3)}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the definition of $\D_3$}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{(h_{2, B}\after\T{\e_2'}{g}\after \D_3')}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the reduction of $\D_3$}\\
            &= \bind{\e_1}{\e_2}{B}\after 
            h_{1, B}\after\T{\e_1'}{h_{2, B}}\after\T{\e_1'}{\T{\e_2'}{g}}\after \T{\e_1'}{\D_3'}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{Factor out the functor}\\
            &= h_B\after\bind{\e_1'}{\e_2'}{B}\after\T{\e_1'}{\T{\e_2'}{g}}\after \T{\e_1'}{\D_3'}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By the $\mu$ and Subtype rule }\\
            & = h_B\after\T{\e_1'\dot\e_2'}{g}\after\bind{\e_1'}{\e_2'}{B'}\after \T{\e_1'}{\D_3'}\after
            \tstrength{\e_1'}{\G}{A'}\after\pr{\idg}{\D_1'}\qt{By naturality of $\bindmu$ }\\
            & = \D' \qt{By definition}
        \end{align*}
        $$\square$$
    \end{proof}
\end{framed}

\begin{figure}[h!]
    \begin{framed}
        \begin{minipage}{0.47\textwidth}
            \begin{equation}
                \ntreeruleI{\vfun}{\scalebox{.65}{$
                    \ntreeruleII{\vsubtype}{
                        \etyperelation{\P}{\gax}{v}{B}
                    }{
                        B \subtypep B'
                    }{
                        \etyperelation{\P}{\gax}{v}{B'}
                    }
                $}}{\gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B'}}}
            \end{equation}
        \end{minipage}
        \quad
        \begin{minipage}{0.47\textwidth}
            \begin{equation}
                \ntreeruleII{\vsubtype}{
                    \scalebox{.65}{$
                    \ntreeruleI{\vfun}{
                        \etyperelation{\P}{\gax}{v}{B} 
                    }{    
                        \gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B}}
                    }
                    $}
                }{ 
                    \scalebox{.7}{$\ab \subtype \fntype{A}{B'}$}
                }{
                    \gpetyperelation{\lam{x}{A}{v}}{\fntype{A}{B'}}
                }
            \end{equation}
        \end{minipage}
        
    \end{framed}

    \caption{Two derivations of the same type relation. The right derivation is in reduced form.}
\end{figure}

We can sum up the importance of these theorems in the corollary below.

\begin{framed}
    \begin{corollary}[Denotations are Unique]\label{DenotationsAreUnique}
      For any two derivations $\D_1, \D_2$ deriving $\gpetyperelation{v}{A}$, the denotations of $\D_1$ and $\D_2$ are equal.
    \end{corollary}

    \begin{proof}
        Since reduced derivations of the typing relation are unique, the derivations $\reduce(\D_1), \reduce(\D_2)$ are equivalent and so have the same denotation. Since reduction preserves denotations, $\D_1 = \reduce(\D_1) = \reduce(\D_2) = \D_2$.
    \end{proof}
\end{framed}

\section{Soundness}
We are now at a stage where we can state and prove the most important theorem for a denotational semantics: soundness with respect to an equational equivalence. The desire for soundness follows from the common sense requirement that terms that are equivalent in a given language should also have equivalent denotations. In our case, I introduce a $\beta\eta$-based equational equivalence relation and then prove that equivalent terms have equal denotations.

The equational equivalence relation is a rule-based relation with three main flavours of rules. Firstly, as seen in Figure \ref{BetaEtaReductions}, there are the reductions which formalise how we expect the program to execute given an appropriate implementation. We give $\beta\eta$-reductions for each term transition, such as the application of lambda terms or the execution of an \texttt{if} expression, as well as the monad equivalence laws. Secondly, there are congruences, seen in Figure \ref{BetaEtaCongruence}, which formalise how the reduction of subexpressions affects the rest of the expression in a compositional way. Finally, we extend this relation into an equivalence relation by closing it under transitivity, reflexivity and symmetry as seen in Figure \ref{BetaEtaEquivalence}.

\begin{figure}[H]
    
    \begin{framed}
        \[
            \scalebox{0.8}{$
            \ntreeruleII{\eqbeta}{\etyperelation{\P}{\gax}{v_2}{B}}{\gpetyperelation{v_1}{A}}{\gpeberelation{\apply{(\lam{x}{A}{v_1})}{v_2} }{ v_1\ssub{x}{v_2}}{B}}
            \quad
            \ntreeruleI{\eqeta}{\gpetyperelation{v}{\ab}}{\gpeberelation{\lam{x}{A}{(\apply{v}{x}})}{v}{\ab}}
            $}
        \]
    
        \[\scalebox{0.8}{$
            \ntreeruleII{\eqleftunit}{\gpetyperelation{v_1}{A} }{ \etyperelation{\P}{\gax}{v_2}{\meb}}{\gpeberelation{\doin{x}{\return{v_1}}{v_2}}{v_2\ssub{x}{v_1}}{\meb}}
            \quad
            \ntreeruleI{\eqrightunit}{\gpetyperelation{v}{\mea}}{\gpeberelation{\doin{x}{v}{\return{x}} }{v}{\mea}}
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleIII{\eqassociativity}{\gpetyperelation{v_1}{\M{\e_1}{A}} }{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}{ \etyperelation{\P}{\gby}{v_3}{\M{\e_3}{C}}}{
                \gpeberelation{\doin{x}{v_1}{(\doin{y}{v_2}{v_3})}}{\doin{y}{(\doin{x}{v_1}{v_2})}{v_3}}{\M{\e_1 \dot \e_2 \dot \e_3}{C}}
            }
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleI{\equnitequiv}{\gpetyperelation{v}{\U}}{\gpeberelation{v}{\u}{\U}}
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleII{\eqiftrue}{\gpetyperelation{v_1}{A}}{\gpetyperelation{v_2}{A}}{\gpeberelation{\pifthenelse{A}{\t}{v_1}{v_2}}{v_1}{A}}
            \quad
            \ntreeruleII{\eqiffalse}{\gpetyperelation{v_2}{A}}{\gpetyperelation{v_1}{A}}{\gpeberelation{\pifthenelse{A}{\f}{v_1}{v_2}}{v_2}{A}}    
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleII{\eqifeta}{\etyperelation{\P}{\G, x: \B}{v_2}{A}}{\gpetyperelation{v_1}{\B}}{\gpeberelation{\pifthenelse{A}{v_1}{v_2\ssub{x}{\t}}{v_2\ssub{x}{\f}}}{v_2\ssub{x}{v_1}}{A}}
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleII{\eqeffbeta}{\wellformedeffect{\P}{\e}}{\etyperelation{\P, \a}{\G}{v}{A}}{\gpeberelation{\eapp{(\elam{\a}{v}}{\e})}{v\ssub{\a}{\e}}{A\ssub{\a}{\e}}}
            \quad 
            \ntreeruleI{\eqeffeta}{\etyperelation{\P}{\G}{v}{\all{\a}{A}}}{\gpeberelation{\elam{\a}{(\eapp{v}{\a})}}{v}{\all{\a}{A}}}
        $}\]
    \end{framed}
    \caption{The reduction rules for PEC}
    \label{BetaEtaReductions}
\end{figure}

\begin{figure}[H]
   \begin{framed}
        \[\scalebox{0.8}{$
            \ntreeruleI{\eqgen}{\eberelation{\P, \a}{\G}{v_1}{v_2}{A}}{\gpeberelation{\elam{\a}{v_1}}{\elam{\a}{v_2}}{\all{\a}{A}}}
            \quad
            \ntreeruleII{\eqspec}{\gpeberelation{v_1}{v_2}{\all{\a}{A}}}{\wellformedeffect{\P}{\e}}{\gpeberelation{\eapp{v_1}{\e}}{\eapp{v_2}{\e}}{A\ssub{\a}{\e}}}
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleI{\eqfun}{\eberelation{\P}{\gax}{v_1}{v_2}{B}}{\gpeberelation{\lam{x}{A}{v_1}}{\lam{x}{A}{v_2}}{\ab}}
            \quad
            \ntreeruleI{\eqreturn}{\gpeberelation{v_1}{v_2}{A}}{\gpeberelation{\return{v_1}}{\return{v_2}}{\moa}}
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleII{\eqapply}{\gpeberelation{v_1}{v_1'}{\ab}}{\gpeberelation{v_2}{v_2'}{A}}{\gpeberelation{\apply{v_1}{v_2}}{\apply{v_1'}{v_2'}}{B}}
            \quad   
            \ntreeruleII{\eqbind}{\gpeberelation{v_1}{v_1'}{\M{\e_1}{A}} }{\eberelation{\P}{\gax}{v_2}{v_2'}{\M{\e_2}{B}}}{\gpeberelation{\doin{x}{v_1}{v_2}}{\doin{x}{v_1'}{v_2'}}{\M{\e_1 \dot \e_2}{B}}} 
        $}\]
    
        \[\scalebox{0.8}{$
            \ntreeruleIII{\eqif}{\gpeberelation{v}{v'}{\B} }{ \gpeberelation{v_1}{v_1'}{A}}{\gpeberelation{v_2}{v_2'}{A}}{\gpeberelation{\pifthenelse{A}{v}{v_1}{v_2}}{\pifthenelse{A}{v'}{v_1'}{v_2'}}{A}}
            \quad    
            \ntreeruleII{\eqsubtype}{\gpeberelation{v}{v'}{A}}{A \subtypep B}{\gpeberelation{v}{v'}{B}}
        $}\]
   \end{framed}
    \caption{The congruence rules for PEC}
    \label{BetaEtaCongruence}
\end{figure}

\begin{figure}[H]
    
    \begin{framed}
        \[
            \ntreeruleI{\eqreflexive}{\gpetyperelation{v}{A}}{\gpeberelation{v}{v}{A}}
            \quad
            \ntreeruleI{\eqsymmetric}{\gpeberelation{v_1}{v_2}{A}}{\gpeberelation{v_2}{v_1}{A}}
        \]
    
        \[
            \ntreeruleII{\eqtransitive}{\gpeberelation{v_1}{v_2}{A}}{\gpeberelation{v_2}{v_3}{A}}{\gpeberelation{v_1}{v_3}{A}}
        \]
    \end{framed}
    \caption{Rules expanding the reduction and congruence relation to an equivalence relation}
    \label{BetaEtaEquivalence}
\end{figure}


Now we can state the soundness theorem. 


\begin{framed}
    \begin{theorem}[Soundness]\label{SOundness}
        If $\gpeberelation{v_1}{v_2}{A}$, then $\gpetyperelation{v_1}{A}$, $\gpetyperelation{v_2}{A}$, and $\deno{\gpetyperelation{v_1}{A}} = \deno{\gpetyperelation{v_2}{A}}$.
    \end{theorem}
    
    
    \begin{proof}
        The proof proceeds by induction on the definition of the equational equivalence relation.
    
        This proof has a lot of cases and each of the reduction cases makes use of many of the requirements we have placed on the indexed S-category.
    
        I have omitted the congruence cases here as they hold through simple application of the inductive hypothesis on subterms. This occurs because this denotational semantics is compositional, meaning that denotations of terms are defined entirely in terms of the denotations of their subexpression. Similarly, the equivalence relation cases hold simply because equality on morphisms is an equivalence relation by definition. I do however, give a selection of the reduction cases to demonstrate the necessity of the S-category requirements.
    
    \case{\eqrightunit}
    This case makes use of the right-unit monad law. Let $f = \deno{\gpetyperelation{v}{\mea}}$.
        \begin{equation}
        \begin{split}
            \deno{\gpetyperelation{\doin{x}{v}{\return{x}}}{\mea}}  & = \bind{\e}{\1}{A} \after \T{\e}{(\point{A} \after \pp)} \after \tstrength{\e}{\G}{A}\after \pr{\idg}{f} \\
            & = \T{\e}{\pp} \after \tstrength{\e}{\G}{A} \after \pr {\idg}{f} \\
            & = \pp \after \pr{\idg}{f}\\
            & = f
        \end{split}
    \end{equation}
    
    \case{\eqiftrue}
    This case makes use of the co-product diagram on $\1 + \1$. Let $f = \deno{\gpetyperelation{v_1}{A}}$  and  $g = \deno{\gpetyperelation{v_2}{A}}$. Then we can simplify the denotation of the whole expression.
    
    \begin{equation}
        \begin{split}
            \deno{\gpetyperelation{\pifthenelse{A}{\t}{v_1}{v_2}}{A}} & = \ifMorph{\inl\after\term{\G}}{f}{g} \\
            & = \app\after((\cur{f\after\pp}\after\term{\G})\times\idg)\after\diag{\G}\\
            & = \app\after(\cur{f\after\pp}\times\idg)\after(\term{\G}\times\idg)\after\diag{\G}\\
            & = f\after\pp\after\pr{\term{\G}}{\idg}\\
            & = f \\
            & = \deno{\gpetyperelation{v_1}{A}}\\
        \end{split}
    \end{equation}
    
    \case{\eqeffbeta}
    This case makes use of the adjunction properties of $\allEn, \pstar$. Let  $h = \deno{\typerelation{\P}{\e}{\effect}}$, $f = \deno{\etyperelation{\P,\a}{\G}{v}{A}}$, and $A = \deno{\typerelation{\P,\a}{A\ssub{\a}{\a}}{\type}}$. Then we can find the sub-term denotation $\deno{\gpetyperelation{\elam{\a}{v}}{\all{\a}{A}}} = \bar{f}$, which allows us to express the denotation of the whole expression.
    
    \begin{align*}
        \deno{\gpetyperelation{\eapp{(\elam{\a}{v})}{\e}}{\all{\a}{A}}} & = \pr{\Id{E^n}}{h}\star(\counit{A})\after\bar{f}\\
        & = \pr{\Id{E^n}}{h}\star(\counit{A})\after\pr{\Id{E^n}}{h}\star(\pstar(\bar{f}))\qt{Identity functor}\\
        &= \pr{\Id{E^n}}{h}\star(\counit{A}\after\pstar(\bar{f}))\\
        &= \pr{\Id{E^n}}{h}\star(f)\qt{By adjunction}\\
        &= \deno{\gpetyperelation{v\ssub{\a}{\e}}{A\ssub{\a}{e}}}\qt{By substitution theorem}\\
    \end{align*}
    
    \case{\eqeffeta}
        Let $f  = \deno{\gpetyperelation{v}{\all{\a}{A}}}$, and $A  = \deno{\typerelation{\P,\a}{A}{\type}}$. We can now express the denotation of the entire expression.
    
        \begin{align*}
            \deno{\gpetyperelation{\elam{\a}{(\eapp{v}{\a})}}{\all{\a}{A}}} & = \bar{\deno{\etyperelation{\P,\a}{\G}{\eapp{v}{\a}}{A}}} \\
            & = \bar{\pr{\Id{E^n\times E}}{\pp}\star(\e_{\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}})\after\pstar(f)}
        \end{align*}
    
        Let us look at $\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}$. We have the weakening $\wrel{\i\pi\x}{\P,\a,\b}{\P,\b}$, so by the weakening theorem on type denotations, we can re-arrange the quantification and projection functors.
    
        \begin{align*}
            \allIU(\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}) & = \allEn( (\p\times \Id{E})\star\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}})\\ 
            & = \pstar\allEn(\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}})
        \end{align*}
    
        Using this and the adjunction and naturality properties (\ref{NaturalityCondition}), we can unwind the definition of the co-unit on $\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}$.
    
    
        \begin{align*}
            \counit{\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}} 
            & = \widehat{\Id{\allIU(\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}})}}\\
            & = \widehat{\Id{\pstar\allEn(\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}})}}\\
            & =\widehat{\Id{\pstar\allEn A}}\\
            & = \widehat{\pstar(\Id{\allEn A})}\\
            & = \widehat{\pstar(\bar{\counit{A}})}\\
            & = \widehat{\bar{(\p\times\Id{E})\star(\counit{A})}}\\
            & = (\p\times\Id{E})\star(\counit{A}) 
        \end{align*}
    
        This rearrangement can now be used in conjunction with the contravariant composition of re-indexing functors to show the denotation $\deno{\gpetyperelation{\elam{\a}{(\eapp{v}{\a})}}{\all{\a}{A}}}$ is equal to the morphism $f$.
        \begin{align*}
            \deno{\gpetyperelation{\elam{\a}{(\eapp{v}{\a})}}{\all{\a}{A}}} & = \bar{\pr{\Id{E^n\times E}}{\pp}\star(\counit{\deno{\typerelation{\P,\a,\b}{A\ssub{\a}{\b}}{\type}}})\after\pstar(f)}\\
            & = \bar{\pr{\Id{E^n\times E}}{\pp}\star((\p\times\Id{E})\star(\counit{A}))\after\pstar(f)}\\
            & = \bar{\pr{\p}{\pp}\star(\counit{A})\after\pstar(f)}\\
            &= \bar{\Id{E^n\times E}\star(\counit{A})\after\pstar(f)} \\
            & = \bar{\counit{A}\after \pstar(f)}\qt{The identity re-indexing functor is the identity.}\\
            & = f \qt{By adjunction}
        \end{align*}
    
    
        $$\square$$
    
    \end{proof}
    
\end{framed}

This completes the proof of soundness for this semantics.

\section{Summary}

In this chapter, I have introduced the indexed S-category structure, given a denotational semantics for PEC with respect to this structure, and proved that these semantics soundly model PEC. However, I have not shown whether it's possible to construct an indexed S-category, or how complex such categories might be. These questions will be addressed in the next chapter.

\chapter{Constructing a Model of PEC}

Now we have proved that an appropriate categorical structure can model PEC, it remains to explicitly construct such an indexed category. There exist $\set$-based models for the semantics of many effectful languages with a graded monad, such as a certain instantiations of the Effect Calculus \cite{Katsumata:2014}. More specifically, it is possible to treat $\set$ as an S-category. Hence, I use a $\set$ based S-category as a starting point. In this section, I  demonstrate how to construct an strictly indexed S-category, which can model the PEC, from such an S-category.

Suppose we have an S-category structure derived from $\set$ which models an instance of EC. That is, there is a graded monad $\Tz{}{}, \bindmu^0, \pointz{}, \strengtht^0$ on $\set$, and there exist subtyping functions $\deno{A\subtypeg B}: A \rightarrow B$ for each instance of the ground subtyping relation, and natural transformations $\deno{\e_1 \subeffectz \e_2}: \Tz{\e_1}{} \rightarrow \Tz{\e_2}{}$ for each instance of the subeffecting relation. Furthermore, $\set$ is cartesian closed and has co-products for all pairs of objects. Since this structure is a model for the EC, it is graded by the partially ordered monoid on ground effects: $(E, \subeffectz, \1, \dot)$. I have marked each of these instances of S-category structure with $0$ to indicate that they occur in the fibre induced by the empty effect-variable environment.

Using $\a$-equivalence, we can see that all effect-variable environments of the same length are equivalent. For example, the terms in Equation \ref{AlphaEquivalence} are $\a$-equivalent. Hence, we can reduce an effect-variable environment to the natural number $n$ indicating its length.

\begin{equation}\label{AlphaEquivalence}
    \scalebox{.8}{$
    (\etyperelation{(\nil, \a, \b)}{\G}{\lam{f}{\fntype{\texttt{Int}}{\M{\a\dot\b}{\U}}}{(\apply{f}{0})}}{\M{\a\dot\b}{\U}})  =_\a(\etyperelation{(\nil, \g, \d)}{\G}{\lam{f}{\fntype{\texttt{Int}}{\M{\g\dot\d}{\U}}}{(\apply{f}{0})}}{\M{\g\dot\d}{\U}})
    $}
\end{equation}


We define the base category as specified in Section \ref{PECDenotations}. Next we must pick our fibre categories for non-zero values of $n$. A simple instantiation is to pick each fibre $\C(E^n)$ to be the functor category $[E^n, \set]$,  where $E^n$ is a discrete category (a category that only contains the identity morphisms). That is, the category of functions returning an object in $\set$ given $n$ ground effects. Morphisms between objects are functions which, given a collection of ground effects, yield a morphism (function) in $C$. If $m\in [E^n, \set](A, B)$ then $m\ev\in\set(A\ev, B\ev)$. The fibres, $[E^n, C]$ are S-categories. This can be proved by constructing the S-category structures pointwise with respect to their parameter $\ev \in E^n$ as seen in Figures \ref{HowToBuildCCC} - \ref{HowToBuildSubtyping}. Full proofs of the naturality and monad laws can be found in Appendix \ref{NaturalityAndMonadLawsProof}.



\begin{figure}
    
    \begin{framed}
        \centering\textbf{Cartesian Closed Category}

Since $E$ is small, $E^n$ is also small, and hence $[E^n, \set]$ is a CCC. This can be demonstrated pointwise.

\begin{align*}
    (A\times B)\ev & = (A\ev)\times(B\ev)\\
    \1\ev & = \1\\
    (B^A)\ev &= (B\ev)^{(A\ev)}\\
    \p\ev & = \p\\
    \pp\ev & = \pp\\
    \app\ev & = \app\\
    \cur{f}\ev & = \cur{f\ev}\\
    \pr{f}{g}\ev & = \pr{f\ev}{g\ev}\\
\end{align*}

\end{framed}
\caption{The construction of CCC features in the functor category $[E^n, \set]$}
\label{HowToBuildCCC}
\end{figure}

\begin{figure}
    
\begin{framed}
    \centering\textbf{The Co-Product on the Terminal Set}

We can define the co-product pointwise.

\begin{align*}
    (\1 + \1)\ev & = (\1\ev + \1\ev)\\
    & = (\1 + \1)\\
    \inl\ev &= \inl\\
    \inr\ev &= \inr\\
    [f, g]\ev &= [f\ev, g\ev]\\
\end{align*}
\end{framed}
\caption{The construction of co-product features in the functor category $[E^n, \set]$}
\label{HowToBuildCoproduct}
\end{figure}

\begin{figure}
    \begin{framed}
        \centering\textbf{Ground Types and Terms}

        Each ground type in the non-polymorphic calculus has a fixed denotation $\deno{\g}\in\obj\set$. The ground type in the polymorphic calculus hence has a denotation represented by the constant function.
        
        \begin{align*}
            \deno{\g}:&\quad E^n\rightarrow \obj\set\\
            \ev \mapsto&\quad  \deno{\g}\\
        \end{align*}
        
        Each constant term $\const{A}$ in the non-polymorphic calculus has a fixed denotation $\deno{\const{A}}\in\set(\1, A)$.
        
        So the morphism $\deno{\const{A}}$ in $[E^n, \set]$ is the corresponding constant dependently typed morphism.
        
        \begin{align*}
            \deno{\const{A}}:&\quad[E^n, \set](\1, A)\\
            \ev\mapsto&\quad\deno{\const{A\ev}}
        \end{align*}        
    \end{framed}
    \caption{The definition of ground types and terms in the category $[E^n, \set]$ }
    \label{HowToBuildGround}
\end{figure}


\begin{figure}
    \begin{framed}
        \centering\textbf{Strong Graded Monad}

Given the strong graded monad $(\Tz{}{}, \pointz{}, \bindmu^0, \strengtht^0)$ on $\set$ we can construct an appropriate graded monad, $(\Tn{}{}, \pointn{}{}{}, \bindmu^n,\strengtht^n)$, on $[E^n, \set]$.

\begin{align*}
    \Tn{}{}:&\quad(E^n, \dot, \subeffect_n, \1_n) \rightarrow [[E^n, \set], [E^n, \set]]\\
    (\Tn{f}{A})\ev=&\quad \Tz{(f\ev)}{A\ev}\\
    (\pointn{A})\ev=&\quad\pointz{A\ev}\\
    (\bindn{f}{g}{A})\ev=&\quad\bindz{(f\ev)}{(g\ev)}{(A\ev)}\\
    (\tstrengthn{f}{A}{B})\ev=&\quad\tstrengthz{(f\ev)}{(A\ev)}{(B\ev)}
\end{align*}

Through some mechanical proof and the naturality of the $\Tz{}{}$ strong graded monad, these morphisms are natural in their type parameters and form a strong graded monad in $[E^n, \set]$

    \end{framed}
    \caption{The definition of the graded monad in the category $[E^n, \set]$}
    \label{HowToBuildMonad}
\end{figure}


\begin{figure}
    \begin{framed}
        
        \centering\textbf{Subeffecting}


        Given a collection of subeffecting natural transformations in $\set$,
        
        \begin{align*}
            \deno{\e_1\subeffectz \e_2}:&\quad \Tz{\e_1}{} \rightarrow \Tz{\e_2}{}
        \end{align*}
        
        We can form subeffect natural transformations in $[E^n, \set]$:
        
        \begin{align*}
            \deno{f\subeffectn g}:&\quad\Tn{f}{}\rightarrow \Tn{g}{}\\
            (\deno{f\subeffectn g} A) \ev:&\quad\Tn{f\ev}{(A\ev)}\rightarrow \Tn{g\ev}{(B\ev)}\\
            =&\quad \deno{f\ev\subeffectz g\ev}(A\ev)
        \end{align*}
    \end{framed}
    \caption{Subeffect natural transformations in the category $[E^n, \set]$}
    \label{HowToBuildSubeffecting}
\end{figure}

\begin{figure}
    \begin{framed}
        
\centering\textbf{Subtyping}


Subtyping in $[E^n, \set]$ holds via subtyping in $\set$

\begin{align*}
    \deno{A\subtype_n B}:&\quad A\rightarrow B\\
    \deno{A\subtype_n B}\ev=&\quad \deno{A\ev\subtype_0 B\ev}
\end{align*}

So the subtyping relation $A \subtype B$ forms a morphism in $[E^n, \set]$

    \end{framed}
    \caption{Definition of subtyping morphisms in the functor category $[E^n, \set]$}
    \label{HowToBuildSubtyping}
\end{figure}

Now we need to define the required morphisms between fibres. Firstly, for any function $\theta: E^m \rightarrow E^n$ in $\Eff$, there should exist an S-preserving re-indexing functor $\theta\star: [E^n, \set] \rightarrow [E^m, \set]$. A simple instantiation is the pre-composition functor, as seen in Figure \ref{PrecompositionFunctor}. This also obeys the composition law of re-indexing functors Figure \ref{PrecompositionFunctorComposition} and is S-preserving.


\begin{figure}
    \begin{framed}
        \centering
        \textbf{The Pre-composition Functor}

        \begin{align*}
            A\in&\quad [E^n, \set]\\
            \theta\star(A) \emv =&\quad  A(\theta(\emv))\\
            f:&\quad A \rightarrow B\\
            \theta\star(f) \emv =&\quad f(\theta(\emv)): \theta\star(A) \rightarrow \theta\star(B)\\
        \end{align*}
    \end{framed}
    \caption{A description of the pre-composition functor.}
    \label{PrecompositionFunctor}
\end{figure}

\begin{figure}
    \begin{framed}
        \centering
        \textbf{Composition of Pre-Composition Functor}

        \begin{align*}
            \theta\star(\phi\star A) \ev & = \phi\star(A)(\theta \ev)\\
            & = A(\phi(\theta\ev))\\
            & = A((\phi\after\theta) \ev)\\
            & = (\phi\after\theta)\star(A) \ev
        \end{align*}
    \end{framed}

    \caption{The pre-composition functor composes in a contravariant fashion.}
    \label{PrecompositionFunctorComposition}
\end{figure}



\begin{figure}
    
    \begin{framed}
        \centering
        \textbf{Re-Indexing Functors are S-Preserving}
                
        \begin{theorem}
            The re-indexing functors are also S-preserving. That is all the S-category features in $[E^n, \set]$ are preserved by $\theta\star$ in $[E^m, \set]$. For a full list of features and their proofs, please see Appendix \ref{ReindexingFunctorProperties}.
        \end{theorem}
        
        
        \begin{proof}
            All of the S-category features are proved pointwise.
        
            \case{Graded Monad Functor}
            \begin{align*}
                (\theta\star\Tn{f}{A})\ev & = \Tn{f}{A}(\theta\ev) \\
                & = \Tz{(f(\theta\ev))}{(A(\theta\ev))}\\
                & = (\Tm{(f\after\theta)}{\theta\star A})\ev\\
            \end{align*}
        
            \case{Terminal Object}
            
        \begin{align*}
            (\theta\star \1)\ev & = \1(\theta\ev)\\
            & = \1 \\
            & = \1 \ev\\
        \end{align*}
        
        \begin{align*}
            (\theta\star\term{A})\ev & = \term{A}(\theta\ev)\\
            & = \term{A(\theta\ev)}\\
            & = \term{\theta\star A}\ev
        \end{align*}
        
            $$\square$$
        \end{proof}
    \end{framed}
    \caption{The pre-composition re-indexing functor $f\star$ is S-Preserving}
    \label{PrecompositionSClosure}
\end{figure}

Next, the re-indexing functor $\pstar$ should have a right adjoint, $\allEn$. Under the current construction, the only option for such a right adjoint is for $\allEn$ to be defined as a product over the set of effects (figure \ref{ProductQuantification}). This is possible because types and effects are not impredicative (that is, they do not quantify over themselves), meaning that the set of effects is countable or finite.

\begin{figure}
    \begin{framed}
        \centering
        \textbf{The Quantification Functor}

        \begin{align*}
            \allEn:& [E^{n+1}, \set] \rightarrow [E^n, \set]\\
            \allEn(A)\env =&\Pi_{\e\in E}{A(\env, \e)}
            \\ 
            \allEn(f)\env =&\Pi_{\e\in E}{f(\env, \e)}
        \end{align*}
        
    \end{framed}
    \caption{Definition of the quantification functor}
    \label{ProductQuantification}
\end{figure}



We can now prove that $\pstar \dashv \allEn$. To do this, we need a natural bijection between morphisms in the functor categories $[E^n, \set]$ and $[E^{n+1}, \set]$.

\begin{equation}
    \bar{(-)}: [E^{n+1}, \set](\pstar A, B) \rightleftharpoons [E^n,\set] (A, \allEn B): \widehat{(-)}
\end{equation}

The leftwards and rightwards components of this bijection can be derived as follows. The leftwards component maps each morphism to a finite pairing of the morphism over each ground effect. The inverse is simply to project out the appropriate value of $\e$ from the product. These mappings can be seen in Figure \ref{AdjunctionDefinition}. These transformations give rise to the unit and co-unit of the adjunction, which are defined in Figure \ref{UnitCoUnitDefinition}. The unit and co-unit allow us to prove that this construction is an adjunction (figure \ref{AdjunctionProof}).  Finally, we need to prove that the Beck-Chevalley conditions given in \ref{PECRequirements} holds. The proof of the appropriate theorems are given in Figure \ref{BeckChevalley1}.




\begin{figure}
    \begin{framed}
        


        \centering
        \textbf{The Adjunction Operations}
        

        \begin{align*}
            f:&\quad \pstar A \rightarrow B\\
            \bar{f}:&\quad A\rightarrow \allEn B\\
            \bar{f}(\env) =&\quad \finpr{f(\env, \e)}{\e\in E}
        \end{align*}
        

        \begin{align*}
            g:&\quad A \rightarrow \allEn B\\
            \widehat{g}:&\quad \pstar A\rightarrow B\\
            \widehat{g}(\env, \e_{n+1}) =&\quad\pi_{\e_{n+1}}\after g(\env)
        \end{align*}
    \end{framed}

    \caption{The definition of the adjunction's bijection operations}
    \label{AdjunctionDefinition}
\end{figure}



\begin{figure}
    \centering
    \begin{minipage}{0.47\textwidth}
      \begin{framed}
        \centering
        \textbf{Unit}
  
        \scalebox{.9}{\parbox{\linewidth}{%
          \begin{align*}
            \unit{A}:&\quad A \rightarrow \allEn\pstar A\\
            \unit{A}(\env)=&\quad\finpr{\Id{A(\env, \e)}}{\e\in E}
          \end{align*}
        }}
      \end{framed}
    \end{minipage}
    \quad
    \begin{minipage}{0.47\textwidth}
      \begin{framed}
        \centering
        \textbf{Co-Unit}
  
        \scalebox{.9}{\parbox{\linewidth}{%
          \begin{align*}
            \counit{B} : &\quad \pstar\allEn B \rightarrow B\\
            \counit{B}(\env, \e') =&\quad \pi_{\e'} : \Pi_{\e\in E}B(\env, \e)\rightarrow B(\env, \e')
          \end{align*}
        }}
      \end{framed}
    \end{minipage}

\caption{The unit and co-unit of the adjunction}
    \label{UnitCoUnitDefinition}
\end{figure}




\begin{figure}
    \begin{framed}
        \centering
        \textbf{Verifying We Have an Adjunction}

        \centering
        For any $g: \pstar A \rightarrow B$,
        
        \begin{align*}
            (\counit{B}\after\pstar(\bar{g}))(\env, \e_{n+1}) & = \pi_{\e_{n+1}}\after\finpr{g(\env, \e')}{\e'\in E}\\
            &= g(\env, \e_{n+1})
        \end{align*}
        
        \centering
        So $\counit{B}\after\pstar(\bar{g}) = g$.
\\


        Similarly, for any $f: A \rightarrow \allEn B$,
        \begin{align*}
            ((\allEn(\widehat{f}))\after\unit{A})(\env) & = \Pi_{\e\in E}(\widehat{f}(\env, \e))\after \finpr{\Id{A(\env, \e)}}{\e\in E}\\
            & = \Pi_{\e\in E}(\pi_\e\after f(\env))\after \finpr{\Id{A(\env, \e)}}{\e\in E}\\
            & =  \finpr{\pi_\e\after f(\env)}{\e\in E}\\
            & = \finpr{\pi_\e}{\e\in E}\after f(\env)\\
            & = f(\env)
        \end{align*}
        $$\square$$
    \end{framed}
    \caption{Proof that the $\pstar$ and $\allEn$ functors form an adjunction, as required in \ref{PECRequirements}}
    \label{AdjunctionProof}
\end{figure}




\begin{figure}
    \begin{framed}
        
\begin{theorem}
    [Beck-Chevalley condition, part I]
    Firstly, the functors $(\theta\star\after\allEn)$ and $(\allEm\after(\theta\times\Id{E})\star)$ are equal. Secondly, the natural transformation $\bar{(\theta\times\Id{E})\star \counit{}}$ is equal to the identity natural transformation.
\end{theorem}

    \begin{proof}

        Firstly,

    \begin{align*}
    ((\theta\star\after\allEn)A)\env &= \theta\star(\allEn  A)\env\\
        &= (\allEn A)(\theta(\env))\\
        &= \Pi_{\e\in E}(A(\theta(\env), \e))\\
    &= \Pi_{\e\in E}(((\theta\times \Id{E})\star A)(\env,   \e))\\
        &= \allEm((\theta\times\Id{E})\star A)\env\\
        &= ((\allEm\after(\theta\times\Id{E})\star)A)\env
    \end{align*}

Secondly,
    
\begin{align*}
    \bar{(\theta\times\Id{E})\star \counit{A}} \ev  & = \finpr{(\theta\times\Id{E})\star\counit{A}(\ev, \e)}{\e\in E}\\
    & = \finpr{\counit{A}(\theta\ev, \e)}{\e\in E}\\
    & = \finpr{\pi_\e}{\e\in E}: \Pi_{\e\in E}A(\theta\ev, \e) \rightarrow \Pi_{\e\in E}A(\theta\ev, \e)\\
    & = \Id{\Pi_{\e\in E}A(\theta\ev, \e)}\\
    & = \Id{\allEm\after(\theta\times\Id{E})\star A}\ev\\
    & = \Id{\theta\star\after\allEn}
\end{align*}

    $$\square$$
    \end{proof}
    \end{framed}
    \caption{Proof that the $\pstar \dashv \allEn$ adjunction satisfies the Beck-Chevalley condition.}
    \label{BeckChevalley1}
\end{figure}

Hence we have proof that our construction is indeed a valid indexed S-category. Importantly, this shows that reasonable models of the PEC are possible to construct and that our requirements do not overconstrain potential models to the point that they are not useful for doing actual analysis. This contrasts with models for System F, which cannot be \set based\cite{PolymorphismIsNotSetTheoretic}.

\chapter{Conclusion}
This dissertation has introduced a denotational semantics for polymorphic effect systems in category theory and has proved that non-trivial models capable of interpreting effect-polymorphic languages can indeed be constructed in simple categories such as $\set$. It is reasonable to conjecture that the reason that PEC's semantics are significantly simpler than those of other polymorphic languages, such as System F, is that PEC's polymorphism is not impredicative. Its polymorphic types do not quantify over themselves. This hypothesis could be tested by attempting to construct simple, $\set$-based models for other predicatively polymorphic languages. An example of such a language might be the lambda calculus extended with types that depend on the natural numbers.

The final piece of the puzzle would be to find an adequate model of a given effect-polymorphic language. This means instantiating a sound model such that if the denotations of two terms are equal in the model, then the terms themselves are equal up to the same equational equivalence. This is typically a hard problem which is often not addressed in presentations of denotational semantics.

This work forms a potential foundation for precise analysis tools which could be used to improve compilers and interpreters in the future. A more precise analysis of programs allows more specific optimisations to be made, such as code re-ordering or removal of dead code, where they would not be considered sound under a non-polymorphic system.

\bibliography{diss} 
\bibliographystyle{ieeetr}



%% Appendices
\appendix

% Appendices account for ~1000 words
\input{AppendixWeakeningProofs.tex}
\input{AppendixSCategoryFunctors.tex}
\input{AppendixFunctorCategoryStructures.tex}

\end{document}
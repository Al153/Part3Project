\documentclass{report}
\input{header.tex}

\begin{document}
    \section{Reduced Type Derivation}
    A reduced type derivation is one where subtype and subeffect rules must, and may only, occur at the root or directly above an \textbf{if}, \textbf{lambda} or \textbf{apply} rule.

    \section{Reduced Type Derivations are Unique}
    For each instance of the relation $\gtyperelation{t}{\tau}$,there exists at most one reduced derivation of  $\gtyperelation{t}{\tau}$. This is proved by induction over the typing rules on the bottom rule used in each derivation.

    \subsection{Constants}
    For each of the constants, ($\const{A}$, $\t$, $\f$, $\u$), there is exactly one possible derivation for $\typerelation{\G}{c}{A}$ for a given A. I shall give examples using the case $\const{A}$


    $$
        \treerule{Subtype}{\truleconst\s\s A \subtype B}{\gtyperelation{\const{A}}{B}}
    $$

    If $A = B$, then the subtype relation is the identity subtype ($A \subtype A$).

    \subsection{Value Terms}
    \paragraph{Case Lambda}
    The reduced derivation of $\gtyperelation{\lam{x}{A}{C}}{\lamtype{A'}{\e'}{B'}}$ is:


    $$
    \treerule{Subtype}
    {\treerule{Lambda}{\treerule{}{\D}{\typerelation{\gax}{C}{\meb}}}
    {
        \gtyperelation{\lam{x}{A}{B}}{\lamtype{A}{\e}{B}}}
        \s\s
        \lamtype{A}{\e}{B} \subtype \lamtype{A'}{\e'}{B'}
    }{
       \gtyperelation{\lam{x}{A}{C}}{\lamtype{A'}{\e'}{B'}} 
    }
    $$

    Where $\D$ is the reduced derivation of $\typerelation{\gax}{C}{\meb}$ if it exists.

    \paragraph{Case Subtype}
    \todo{Do we need to write anything here? (Probably needs an explanation)}


    \subsection{Computation Terms}
    \paragraph{Case Return}
    The reduced denotation of $\gtyperelation{\return{v}}{\meb}$ is 
    $$
        \treerule{Subtype}
        {
            \treerule{Return}
            {\treerule{}{\D}{\gtyperelation{v}{A}}}
            {\gtyperelation{\return{v}}{\moa}}
            \s\s
            A \subtype A' \subtype B
            \s\s
            \1 \subeffect \e
        }
        {\gtyperelation{\return{v}}{\meb}}
    $$

    Where $$\deltavrule{\G}{v}{A}{A'}$$ is the reduced derivation of $\gtyperelation{v}{A'}$
    
    \paragraph{Case Apply}
    If 
    $$
        \deltavrule{\G}{v_1}{\lamtype{A}{\e}{BB}}{\lamtype{A'}{\e'}{B'}}
    $$ and $$
        \deltavruleprime{\G}{v_2}{A''}{A'}
    $$

    Are the reduced type derivations of $\gtyperelation{v_1}{\lamtype{A'}{\e'}{B'}}$ and $\gtyperelation{v_2}{A'}$



    Then we can construct the reduced derivation of $\gtyperelation{\apply{v_1}{v_2}}{\M{\e'}{B'}}$ as

    $$
        \treerule{Subeffect}{
            \treerule{Apply}{
                \treerule{}{\D}{
                    \gtyperelation{v_1}{\lamtype{A}{\e}{B}}
                }
                \s\s
                \treerule{Subtype}{
                    \treerule{}{\D'}{
                        \gtyperelation{v}{A''}
                    } \s\s A'' \subtype A
                }
                {\gtyperelation{v}{A}}
            }{
                \gtyperelation{\apply{v_1}{v_2}}{\meb}
            }
            \s\s
            B \subtype B'
            \s\s
            \e \subeffect \e'
        }{
            \gtyperelation{\apply{v_1}{v_2}}{\M{\e'}{B'}}
        }
    $$
    \paragraph{Case If}
    \paragraph{Case Bind}
    \paragraph{Case Subeffect}

    \section{Each type derivation has a reduced equivalent with the same denotation.}
    We introduce a function, $\reduce$ that maps each valid type derivation of $\gtyperelation{t}{\tau}$ to a reduced equivalent with the same denotation. To do this, we do case analysis over the root type rule of a derivation and prove that the denotation is not changed. \todo{Fill in these cases with actual maths}

        \subsection{Constants}
            \todo{$\reduce$ just appends the identity subtype rule to the derivation, trivially preserves denotation}
        \subsection{Value Types}
            \paragraph{Lambda}
                \todo{Recursively call reduce on C then push subtyping through using currying}
            \paragraph{Subtype}
                \todo{Recursively call reduce then merge subtypes}
        \subsection{Computation Types}
            \paragraph{Return}
                \todo{Recursively call reduce then use naturality to push subtyping into subeffect}
            \paragraph{Apply}
                \todo{Recursively call reduce, then construct the reduced apply as in the proof of uniqueness}
            \paragraph{If}
                \todo{
                    Recursively call reduce, then leave tree otherwise unchanged.
                }
            \paragraph{Bind}
                \todo{Recursively call reduce then push subtyping rules through the bind}
            \paragraph{Subeffect}
                \todo{Recursively call reduce, then merge subeffecting rules}


    
    \section{Denotations are Equivalent}
    For each type relation instance $\gtyperelation{t}{\tau}$ there exists a unique reduced derivation of the relation instance. For all derivations $\D$, $\D'$ of the type relation instance, $\deno{\D} = \deno{\reduce{\D}} = \deno{\reduce{\D'}} = \deno{\D'} $, hence the denotation $\deno{\gtyperelation{t}{\tau}}$ is unique.
\end{document}
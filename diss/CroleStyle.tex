\documentclass{report}
\input{header.tex}

\begin{document}

\tableofcontents
\chapter{Preliminaries}
\section{Base Category Requirements}
There are 3 distinct objects in the base category, $\C$:

\begin{itemize}
    \item $U$ - The kind of \effect
    \item $W$ - The kind of \type
    \item $\1$ - A terminal object
\end{itemize}

And we have finite products on $U$.

\begin{itemize}
    \item $U^0 = \1$
    \item $U^{n+1} = U^n \times U$
\end{itemize}

We also have the following natural operations on morphisms in $\C$.

Let $I = U^n$.

\begin{itemize}
    \item $\diamond: \ciw \times \ciw \rightarrow \ciw$ - Generates exponential types.
    \item $\square: \ciw\times\ciw\rightarrow\ciw$ - Generates products of types.
    \item $\allI: \ciuw\rightarrow\ciw$ - generates quantified types.
    \item $\Eff:\ciu\times\ciw\rightarrow\ciw$ - generates monad types.
    \item $\Mul:\ciu\times\ciu\rightarrow\ciu$ - Generates multiplication of effects.
\end{itemize}

With naturality conditions which mean, for $\theta: \U^m \rightarrow\U^n (I' \rightarrow I)$,
\begin{itemize}
    \item $\diamond(\phi,\psi)\after\theta = \diamond(\phi\after\theta,\psi\after\theta)$
    \item $\square(\phi,\psi)\after\theta = \square(\phi\after\theta,\psi\after\theta)$
    \item $\allI(\phi)\after\theta = \allII(\phi\after(\theta\times\Id{U}))$
    \item $\Eff(\phi,\psi)\after\theta = \Eff(\phi\after\theta,\psi\after\theta)$
    \item $\Mul(\phi,\psi)\after\theta = \Mul(\phi\after\theta,\psi\after\theta)$
\end{itemize}
\section{Well-Formed-ness}

Each instance of the well-formed-ness relation on effects, $\wellformed{\P}{\e}$ has a denotation in $\C$: \begin{equation}
    \deno{\typerelation{\P}{\e}{\effect}}: I \rightarrow U
\end{equation}


Each instance of the well-formed-ness relation on types, $\wellformed{\P}{A}$ has a denotation in $\C$:

\begin{equation}
    \deno{\typerelation{P}{A}{\type}}: I \rightarrow W
\end{equation}

It should also be the case that \begin{equation}
    \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}}) = \deno{\typerelation{\P}{\e_1\dot\e_2}{\effect}} \in \ciu
\end{equation}

That is, $\Mul$ should be have identity $\deno{\typerelation{\P}{\1}{\effect}}$ and be associative.
\section{Substitution and Weakening of the Effect Environment}

For each instance of the well-formed-ness relation on substitution of effects $\typerelation{\P'}{\si}{\P}$, there exists a denotation in $\C$:

\begin{equation}
    \deno{\typerelation{\P'}{\si}{\P}}: I'\rightarrow I
\end{equation}

For each instance of the well-formed weakening relation on effect-environments, $\wrelw{\P'}{\P}$
 there exists a denotation in $\C$:

 \begin{equation}
     \deno{\wrelw{\P'}{\P}}: I'\rightarrow I
 \end{equation}.

\section{Fibre Categories}
Each set of morphisms $\ciw$ forms the objects of a semantic-closed (S-closed) category. That is, a category satisfying all the properties needed for the non-polymorphic language:

\begin{itemize}
    \item Cartesian Closed
    \item Co-product of the terminal object with itself ($\1 + \1$)
    \item Ground morphisms for each ground constant ($\const{A}: \1\rightarrow A$)
    \item Partial order morphisms on ground types ($\deno{A\subtypeg} B$)
    \item A strong, monad, graded by the po-monoid $(E_\P, \dot_\P, \subeffectp, \1)$.
\end{itemize}

\section{Re-indexing Functors}

For each morphism $f: I' \rightarrow I$ in $\C$, there should be a co-variant, re-indexing functor  $f\star: \ciw \rightarrow \cipw$, which is S-closed. That is, it preserves the S-closed properties of $\ciw$. (See below).

$(-)\star$ should be a contra-variant functor in its $\C$ argument and co-variant in its right argument.

\begin{itemize}
    \item $(g\after f)\star(a) = f\star(\g\star(a))$
    \item $\Id{I}\star(a) = a$
    \item $f\star(\Id{A}) = \Id{f\star(A)}$
    \item $f\star(a\after b) = f\star(a)\after f\star(b)$
\end{itemize}

\subsection{$f\star$ Preserves Products}
If $\pr{g}{h}:\ciw(Z, X\times Y)$
Then 
\begin{align}
    f\star(X\times Y) & = f\star(X)\times f\star(Y)\\
    f\star(\pr{g}{h}) & = \pr{f\star(g)}{f\star{h}}&:\cipw(f\star Z, f\star(X)\times f\star(Y))\\
    f\star(\p) & = \p&:\cipw(f\star(X)\times f\star(Y), f\star(X)) \\
    f\star(\pp) &= \pp&:\cipw(f\star(X)\times f\star(Y), f\star(Y))
\end{align}

\subsection{$f\star$ Preserves Terminal Object}
If $\Id{A}:\ciw(A, \1)$
Then 
\begin{align}
    f\star(\1) & = \1 \\
    f\star(\term{A}) & = \term{f\star(A)}&:\cipw(f\star A, \1)\\
\end{align}

\subsection{$f\star$ Preserves Exponentials}
\begin{align}
    f\star(Z^X) & = (f\star(Z))^{(f\star(X))}\\
     f\star(\app) &= \app&:\cipw(f\star(Z^X)\times f\star(X), f\star(Z))\\
     f\star(\cur{g}) &= \cur{f\star(g)}&:\cipw(f\star(Y)\times f\star(X), f\star(Z)^{f\star(X)})
\end{align}

\subsection{$f\star$ Preserves Co-product on Terminal}

\begin{align}
    f\star(\1+\1) &= \1+\1\\
    f\star(\inl)  &= \inl&:\cipw(\1, \1+\1) \\
    f\star(\inr) &= \inr&:\cipw(\1, \1+\1) \\
    f\star([g, h]) &= [f\star(g), f\star(h)]&:\cipw(\1+\1, f\star(Z))
\end{align}

\subsection{$f\star$ Preserves Graded Monad}
\begin{align}
    f\star(\tea) &= \T{f\star(\e)}{f\star(A)}&:\cipw\\
    f\star(\1) &= \1 \qt{The unit effect}\\
    f\star(\point{A}) &= \point{f\star(A)}&:\cipw(f\star(A), f\star(\toa))\\
    f\star(\bind{\e_1}{\e_2}{A}) &= \bind{f\star(\e_1)}{f\star(\e_2)}{f\star(A)}&:\cipw(f\star(\T{\e_1}{\T{\e_2}{A}}), f\star(\T{f\star(\e_1)\dot f\star(\e_2)}{f\star(A)}))\\
    f\star(\e_1\dot\e_2) &= f\star(\e_1)\dot f\star(\e_2)\\
\end{align}

\subsection{$f\star$ Preserves Tensor Strength}
\begin{align}
    f\star(\tstrength{\e}{A}{B}) &= \tstrength{f\star(\e)}{f\star(A)}{f\star(B)} &: \cipw(f\star(A\times\teb), f\star(\T{\e}{(A\times B)}))
\end{align}
\subsection{$f\star$ Preserves Ground Constants}
For each ground constant $\deno{\const{A}}$ in $\ciw$,

\begin{align}
    f\star(\deno{\const{A}}) = \const{f\star(A)} : \cipw(\1, f\star(A))
\end{align}
\subsection{$f\star$ Preserves Ground Sub-effecting}
For ground effects $e_1, e_2$ such that $e_1\subeffect e_2$



\begin{align}
    f\star(e) & = e: \cipu\\
    f\star\db{\e_1\subeffect e_2}_A = \db{e_1 \subeffect e_2}_{f\star(A)} &:\cipw{f\star(\T{e_1}{A}), f\star(\T{e_2}{A})} \\
\end{align}
\subsection{$f\star$ Preserves Ground Sub-typing}
For ground types $\g_1, \g_2$ such that $\g_1\subtypeg\g_2$

\begin{align}
    f\star{\g} = \g: \cipw(\1, \g)\\
    f\star(\deno{\g_1 \subtypeg \g_2}) & = \deno{\g_1 \subtypeg \g_2} &: \cipw(\g_1, \g_2)\\
\end{align}

\subsection{Action on Objects}

It follows that the action of $f\star$ on an object $A$ in $\ciw$ (i.e. a morphism $I \rightarrow U$ in $\C$) is:

\begin{equation}
    f\star(A) = A\after f: I'\rightarrow I\rightarrow W
\end{equation}

\section{Naturality Properties}

\section{The $\allI$ functor}
We expand $\allI: \ciuw \rightarrow \ciw$ to be a functor which is right adjoint to the re-indexing functor $\pstar$.

\begin{equation}
    \bar{(\_)}: \ciuw(\pstar A, B) \leftrightarrow \ciw(A, \allI B) : \widehat{(\_)}
\end{equation}

For $A: \ciw$, $B: \ciuw$.

Hence the action of $\allI$ on a morphism $l : A\rightarrow A'$ is as follows:
\begin{eqnarray}
    \allI(l) = \bar{l\after\e_A}
\end{eqnarray}
Where $\e_A: \ciuw(\pstar\allI A \rightarrow A)$ is the co-unit of the adjunction.

\section{Naturality Corollaries}
Here are some simple corollaries of the adjunction between $\pstar$ and $\allI$.

\subsection{Naturality}
By the definition of an adjunction:

\begin{equation}
    \bar{f\after\pstar(n)} = \bar{f}\after n
\end{equation}

\subsection{$\bar{(-)}$ and Re-indexing Functors}

\todo{Why does this occur? it comes from page 222 of Crole?}
\begin{align}
    \theta\star(\bar{f}) & = (\p\after(\theta\times\Id{U}))\star(\bar{f})\\\
     &= (\theta\times\Id{U})\star(\p\star(\bar{f}))\\
     \\
     \\
     &= \bar{(\theta\times\Id{U})\star f}\\
     \\
\end{align}

\subsection{$\hat{(-)}$ and Re-Indexing Functors}
\begin{align}
    \theta\star(\pr{\Id{I}}{\rho}\star(\widehat{m})) &= (\pr{\Id{I}}{\rho}\after\theta)\star(\widehat{m})\\
    & = ((\theta\times\Id{U})\after\pr{\Id{I}}{\rho})\star(\widehat{m})\\
    & = \pr{\Id{I}}{\rho\after\theta}\star(\theta\times\Id{U})\star(\widehat{m}) \\
    & = \pr{\Id{I}}{\theta\star\rho}\star(\theta\star(\widehat{m}))
\end{align}

\subsection{Pushing Morphisms into $f\star$}

\begin{align}
    \pr{\Id{I}}{\rho}\star(\widehat{m})\after n &= \pr{\Id{I}}{\rho}\star(\widehat{m})\after\pr{\Id{I}}{\rho}\star\p\star(n)\\
    & = \pr{\Id{I}}{\rho}\star(\widehat{m}\after\pstar(n))\\
    &= \pr{\Id{I}}{\rho}\star(\widehat{m\after n})
\end{align}

\chapter{Denotations}
\section{Effects}
For each instance of the well-formed-ness relation on effects, we define a morphism $\deno{\typerelation{\P}{\e}{\effect}}: \ciu$

\begin{itemize}
    \item $\deno{\typerelation{\P}{e}{\effect}} = \deno{\e} \after \term{I}: \rightarrow U$
    \item $\deno{\typerelation{\P,\a}{\a}{\effect}} = \pp: I\times U \rightarrow U$
    
    \item $\deno{\typerelation{\P, \b}{\a}{\effect}} = \deno{\typerelation{\P}{\a}{\effect}}\after\p: I\times U\rightarrow U$
    
    \item $\deno{\typerelation{\P}{\e_1\dot \e_2}{\effect}} = \Mul(\deno{\typerelation{\P}{\e_2}{\effect}},\deno{\typerelation{\P}{\e_1}{\effect}}): I \rightarrow U$
\end{itemize}
\section{Types}
For each instance of the well-formed-ness relation on types, we define a morphism $\deno{\typerelation{\P}{A}{\type}}: \ciw$.

$\deno{\U}$ is the morphism generating the terminal object of $\ciw$. $\B$ is the morphism generating the co-product of this terminal object, $\1 + \1$.
\begin{itemize}
    \item $\deno{\typerelation{\P}{\U}{\type}} = \deno{\U}\after\term{I}: I \rightarrow W$
    
    \item $\deno{\typerelation{\P}{\B}{\type}} = \deno{\B}\after\term{I}: I \rightarrow W$
    
    \item $\deno{\typerelation{\P}{\g}{\type}} = \deno{\g}\after\term{I} : I \rightarrow W$
    
    \item $\deno{\typerelation{\P}{\ab}{\type}} = \diamond(\deno{\typerelation{\P}{A}{\type}},\deno{\typerelation{\P}{B}{\type}}): I \rightarrow W$
    
    \item $\deno{\typerelation{\P}{\mea}{\type}} =\Eff(\deno{\typerelation{\P}{\e}{\effect}},\deno{\typerelation{\P}{A}{\type}}): I \rightarrow W$
    \item $\deno{\typerelation{\P}{\all{\a}{A}}{\type}} =\allI(\deno{\typerelation{\P,\a}{A}{\type}}): I \rightarrow W$
\end{itemize}

\section{Effect Substitution}

For each effect-substitution well-formed-ness-relation, define a denotation morphism, $\deno{\typerelation{\P'}{\si}{\P}}: \cii$

\begin{itemize}
    \item $\deno{\typerelation{\P'}{\nil}{\nil}} = \term{I}: \C(I', \1)$
    \item $\deno{\typerelation{\P'}{(\si, \a\setto\e)}{\P,\a}} = \pr{\deno{\typerelation{\P'}{\si}{\P}}}{\deno{\typerelation{\P}{\e}{\effect}}}: \C(I', I\times U)$
\end{itemize}
\section{Effect Weakening}

For each instance of the effect-environment weakening relation, define a denotation morphism: $\deno{\wrelw{\P'}{P}}: \cii$

\begin{itemize}
    \item $\deno{\wrel{\i}{\P}{\P}} = \Id{I}: I \rightarrow I$
    \item $\deno{\wrel{w\pi}{\P',\a}{\P}} = \deno{\wrelw{\P'}{\P}}\after \p: I'\times U\rightarrow I$
    \item $\deno{\wrel{w\x}{\P',\a}{\P,\a}} = (\deno{\wrelw{\P'}{\P}}\times \Id{U}): I'\times U\rightarrow I\times U$
\end{itemize}
\section{Sub-Typing}
For each instance of the sub-typing relation with respect  to an effect environment, there exists a denotation, $\deno{A\subtypep B}: \ciw(A, B)$.

\begin{itemize}
    \item $\deno{\g_1\subtypep \g_2} = \deno{\g_1\subtypeg \g_2} : \ciw(\g_1, \g_2)$
    \item $\deno{\ab \subtypep \fntype{A'}{B'}} = \deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}}$
    \item $\deno{\M{\e_1}{A}\subtypep\M{\e_2}{B}} = \deno{\e_1\subeffectp\e_2}\after\T{\e_1}{\deno{A\subtypep B}}$
    \item $\deno{\all{\a}{A}\subtypep\all{\a}{B}} = \allI{\deno{A\subtypepa B}}$
\end{itemize}
\section{Type-Environments}

For each instance of the well-formed relation on type environments, define an object in $\deno{\wellformedok{I}{W}}\in\ciw$.

\begin{itemize}
    \item $\deno{\wellformedok{\P}{\nil}} = \1: \ciw$
    \item $\deno{\wellformedok{\P}{\gax}} = \square(\deno{\wellformedok{\P}{\G}}, \deno{\typerelation{\P}{A}{\type}})$
\end{itemize}

\section{Terms}
For each instance of the typing relation, define a denotation morphism: $\deno{\gpetyperelation{v}{A}}: \ciw(\G_I, A_I)$. Writing $\G_I$ and $A_I$ for $\deno{\wellformedok{\P}{\G}}$ and $\deno{\typerelation{\P}{A}{\type}}$.

For each ground constant, $\const{A}$, there exists $c: \1 \rightarrow A_I$ in $\ciw$.

\begin{itemize}
    \item $\treerule{Unit}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\u}{\U}} = \term{\G} : \G_I \rightarrow \1}$
        
    \item $\treerule{Const}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\const{A}}{A}} = \deno{\const{A}} \after \term{\G} : \G \rightarrow \deno{A}}$
         
    \item $\treerule{True}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\t}{\B}} = \inl \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}$
        
    \item $\treerule{False}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\G}{\f}{\B}} = \inr \after \term{\G} : \G \rightarrow \deno{\B} = \1+\1}$
        
    \item $\treerule{Var}{\wellformedok{\P}{\G}}{\deno{\etyperelation{\P}{\gax}{x}{A}} = \pp: \G \times A \rightarrow A}$
    \item $\treerule{Weaken}{f = \deno{\gpetyperelation{x}{A}}: \G \rightarrow A}{\deno{\etyperelation{\P}{\gby}{x}{A}} = f \after \p: \G \times B \rightarrow A}$
    \item $\treerule{Lambda}{f = \deno{\etyperelation{\P}{\gax}{C}{\meb}} : \G \times A \rightarrow \teb}{\deno{\etyperelation{\P}{\G}{\lam{x}{A}{C}}{A \rightarrow \meb}} = \cur{f} : \G \rightarrow (\teb)^A}$
    
    \item $\treerule{Subtype}{f = \deno{\etyperelation{\P}{\G}{v}{A}} : \G \rightarrow A\s\s g = \deno{A \subtype B}}{\deno{\etyperelation{\P}{\G}{v}{B}} = g \after f : \G \rightarrow B}$
  
    \item $\treerule{Return}{f = \deno{\etyperelation{\P}{\G}{v}{A}}}{\deno{\etyperelation{\P}{\G}{\return{v}}{\moa}} = \point{A} \after f}$
        
 
    \item $\treerule{If}{f = \deno{\etyperelation{\P}{\G}{v}{\B}}: \G\rightarrow\1+\1 \s\s g = \deno{\etyperelation{\P}{\G}{C_1}{\mea}}\s\s h = \deno{\etyperelation{\P}{\G}{C_2}{\mea}}}{\deno{{\etyperelation{\P}{\G}{\ifthenelse{\e}{A}{v}{C_1}{C_2}}{\mea}}} = \app\after((\fld{\cur{g\after\pp}}{\cur{h\after\pp}}\after f)\times \idg)\after \diag{\G} : \G \rightarrow \tea}$
        
    \item $\treerule{Bind}{f = \deno{\etyperelation{\P}{\G}{C_1}{\M{\e_1}{A}} : \G \rightarrow \T{\e_1}{A}\s\s g = \deno{\etyperelation{\P}{\gax}{C_2}{\M{\e_2}{B}}}}: \G \times A \rightarrow \T{\e_2}{B}}{\deno{\etyperelation{\P}{\G}{\doin{x}{C_1}{C_2}}{\M{\e_1 \dot \e_2}}} = \bind{\e_1}{\e_2}{B} \after \T{\e_1}{g} \after \tstrength{\G}{A}{\e_1} \after \pr{\idg}{f}: \G \rightarrow \T{\e_1 \dot \e_2}{B}}$ 
   
    \item $\treerule{Apply}{f = \deno{\gpetyperelation{v_1}{\lamtype{A}{\e}B}}: \G \rightarrow (\teb)^{A} \s\s g=\deno{\gpetyperelation{v_2}{A}}: \G \rightarrow A}{\deno{\gpetyperelation{\apply{v_1}{v_2}}{\meb}}= \app\after\pr{f}{g}: \G \rightarrow \teb }$
    \item $\treerule{Effect-Lambda}{f = \deno{\etyperelation{\P,\a}{\G}{v}{A}}: \ciuw(\G, A)}{\deno{\gpetyperelation{\elam{\a}{A}}{\all{\e}{A}}} = \bar{f}: \ciw(\G, \allI(A))}$
    \item $\treerule{Effect-App}{g=\deno{\gpetyperelation{v}{\all{\a}{A}}}: \ciw(\G, \allI(A))\s\s h = \deno{\typerelation{\P}{\e}{\effect}}: \ciu}{\deno{\gpetyperelation{\eapp{v}{\e}}{A\ssub{\a}{\e}}} = \pr{\Id{I}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after g: \ciw(\G, A\ssub{\a}{\e})}$
\end{itemize}

\chapter{Effect Substitution Theorem}
In this section, we state and prove a theorem that the action of a simultaneous effect-variable substitution upon a structure in the language has a consistent effect upon the denotation of the language. More formally, for the denotation morphism $\D$ of some relation, the denotation of the substituted relation, $\D' = \si\star(\D)$.
\section{Effects}
If $\si = \deno{\typerelation{\P'}{\si}{\P}}$ then $\deno{\typerelation{\P'}{\si(\e)}{\effect}} = \si\star\deno{\typerelation{\P}{\e}{\effect}} = \deno{\typerelation{\P}{\e}{\effect}}\after\si$.

\proof
By induction on the derivation on $\deno{\typerelation{\P}{\e}{\effect}}$

\case{Ground}
\begin{align}
    \deno{\typerelation{\P}{e}{\effect}}\after\si & = \deno{e}\after\term{I}\after\si \\
    & = \deno{e}\after\term{I'} \\
    & = \deno{\typerelation{\P'}{e}{\type}}\\
\end{align}

\case{Var}
\begin{align}
    \deno{\typerelation{\P,\a}{\a}{\effect}}\after\si' &= \pp\after\pr{\si}{\deno{\typerelation{\P'}{\e}{\effect}}}\qt{By inversion $\si' = (\si, \a\setto\e)$}\\
    & =\deno{\typerelation{\P'}{\e}{\effect}} \\
    &= \deno{\typerelation{\P'}{\si'(\a)}{\effect}}\\
\end{align}

\case{Weaken}
\begin{align}
    \deno{\typerelation{\P, \b}{\a}{\type}}\after\si' &= \deno{\typerelation{\P}{\a}{\type}} \after \p\after\pr{\si}{\deno{\typerelation{\P'}{\e}{\effect}}}\qt{By inversion, $\si' = (\si, \b\setto\e)$}\\
    & = \deno{\typerelation{\P}{\a}{\type}}\after\si\\
    & = \deno{\typerelation{\P'}{\si(\a)}{\type}}\\
    & = \deno{\typerelation{\P'}{\si'(\a)}{\type}}\\
\end{align}

\case{Multiply}
\begin{align}
    \deno{\typerelation{\P}{\e_1\dot\e_2}{\type}} \after\si &=
    \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}})\after \si \\
    & = \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}\after \si, \deno{\typerelation{\P}{\e_2}{\effect}}\after \si)\qt{By Naturality}\\
    & = \Mul(\deno{\typerelation{\P'}{\si(\e_1)}{\effect}}, \deno{\typerelation{\P}{\si(\e_2)}{\effect}})\\
    & = \deno{\typerelation{\P'}{\si(\e_1)\dot\si(\e_2)}{\effect}}\\
    & = \deno{\typerelation{\P'}{\si(\e_1\dot\e_2)}{\effect}}\\
\end{align}

\section{Types}
If $\si = \deno{\typerelation{\P'}{\si}{\P}}$ then $\deno{\typerelation{\P'}{A\ssi}{\type}} = \si\star\deno{\typerelation{\P}{A}{\type}} = \deno{\typerelation{\P}{A}{\type}}\after\si$.

\proof
By induction on the derivation on $\deno{\typerelation{\P}{A}{\type}}$. Making use of naturality properties of the type constructors.

\case{Ground}
\begin{align}
    \deno{\typerelation{\P}{\g}{\type}}\after\si &= \deno{\g}\after\term{I}\after\si\\
    & =  \deno{\g}\after\term{I'}\\
    & = \deno{\typerelation{\P'}{\g}{\type}}\\
    & = \deno{\typerelation{\P'}{\g\ssi}{\type}}
\end{align}

\case{Monad}
\begin{align}
    \deno{\typerelation{\P}{\mea}{\type}}\after\si & =  \Eff(\deno{\typerelation{\P}{\e}{\effect}}, \deno{\typerelation{\P}{A}{\type}})\after\si \\
    & = \Eff(\deno{\typerelation{\P}{\e}{\effect}}\after\si, \deno{\typerelation{\P}{A}{\type}}\after\si) \qt{By naturality}\\
    & = \Eff(\deno{\typerelation{\P'}{\si(\e)}{\effect}}, \deno{\typerelation{\P'}{A\ssi}{\type}})\\
    & = \deno{\typerelation{\P'}{\M{\si(\e)}{A\ssi}}{\type}}\\
    & = \deno{\typerelation{\P'}{(\mea)\ssi}{\type}}
\end{align}
\case{Quantification}
    \begin{align}
        \deno{\typerelation{\P}{\all{\a}A}{\type}}\after\si & = \allI(\deno{\typerelation{\P,\a}{A}{\type}})\after\si\\
        & = \allI(\deno{\typerelation{\P,\a}{A}{\type}}\after(\si\times\Id{U}))\\
        & = \allI(\deno{\typerelation{\P',\a}{A\sub{\si, \a\setto\e}}{\type}})\\
        & = \allI(\deno{\typerelation{\P',\a}{A\ssi}{\type}})\\
        & = \deno{\typerelation{\P'}{\all{\a}{A\ssi}}{\type}}\\
        & = \deno{\typerelation{\P'}{(\all{\a}{A})\ssi}{\type}}\\
    \end{align}

\case{Function}
\begin{align}
    \deno{\typerelation{\P}{\ab}{\type}}\after\si &= \diamond(\deno{\typerelation{\P}{A}{\type}},\deno{\typerelation{\P}{B}{\type}})\after\si\\
    &= \diamond(\deno{\typerelation{\P}{A}{\type}}\after\si,\deno{\typerelation{\P}{B}{\type}}\after\si)\qt{By Naturality}\\
    & = \diamond(\deno{\typerelation{\P'}{A\ssi}{\type}},\deno{\typerelation{\P'}{B\ssi}{\type}})\\
    & = \deno{\typerelation{\P'}{\fntype{(A\ssi)}{(B\ssi)}}{\type}}\\
    & = \deno{\typerelation{\P'}{(\ab)\ssi}{\type}}\\
\end{align}

\section{Sub-typing}
If $\si = \deno{\typerelation{\P'}{\si}{\P}}$ then $\deno{A\ssi\subtypepp B\ssi} = \si\star\deno{A\subtypep B}: \cipw(A, B)$.

\proof
By induction on the derivation on $\deno{A\subtypep B}$. Using S-closure of $\si\star$ 

\case{Ground}
\begin{align}
    \si\star(\g_1\subtypeg\g_2) &= (\g_1\subtypeg\g_2)
\end{align}

Since $\si\star$ is s-closed.

\case{Monad}
\begin{align}
    \si\star\deno{\M{\e_1}{A} \subtypep \M{\e_2}{B}} & = \si\star(\deno{\e_1\subeffectp\e_2})\after\si\star(\T{\e_1}(\deno{A\subtypep B})) \\ 
     &= \deno{\si(\e_1)\subeffectpp\si(\e_2)} \after \T{\si(\e_1)}{\deno{A\ssi\subtypepp B\ssi}}\qt{By S-Closure}\\
     &= \deno{\M{\si(\e_1)}{A\ssi}\subtypepp\M{\si(\e_2)}{B\ssi}}\\
     &= \deno{(\M{\e_1}{A})\ssi\subtypepp\M{\e_2}{B}\ssi}\\
\end{align}

\case{For All}
    \begin{align}
        \si\star\deno{\all{\a}{A}\subtypep\all{\a}{B}} &= \si\star(\allI(\deno{A\subtypepa B})) \\
        &=\allII((\si\times\Id{U})\star(\deno{A\subtypepa B}))\\
        &=\allII(\deno{A\sub{\si,\a\setto\a}\subtypeppa B\sub{\si,\a\setto\a}})\\
        &= \deno{(\all{\a}{A})\ssi \subtypepp(\all{\a}{B})\ssi}\\
    \end{align}

\case{Fn}
\begin{align}
    \si\star\deno{(\ab)\subtypep\fntype{A'}{B'}} &= \si\star(\deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}})\\
    &= \si\star(\cur{\deno{B\subtypep B'}\after\app})\after\si\star(\cur{\app\after(\Id{B}\times\deno{A'\subtypep A})})\\
    & = \cur{\si\star(\deno{B\subtypep B'})\after\app}\after\cur{\app\after(\Id{B}\times\si\star(\deno{A'\subtypep A}))}\\
    & = \cur{\deno{B\ssi\subtypepp B'\ssi}\after\app}\after\cur{\app\after(\Id{B\ssi}\times\deno{A'\ssi\subtypepp A\ssi})}\\
    &= \deno{\fntype{(A\ssi)}{(B\ssi)}\subtypepp\fntype{(A'\ssi)}{(B'\ssi)}}\\
    &= \deno{(\ab)\ssi\subtypepp(\fntype{A'}{B'})\ssi}
\end{align}

\section{Type Environments}
If $\si = \deno{\typerelation{\P'}{\si}{\P}}$ then $\deno{\wellformedok{\P'}{\G\ssi}} = \si\star\deno{\wellformedok{\P}{\G}} = \deno{\wellformedok{\P}{\G}}\after\si: \cipw$.

\proof
By induction on the derivation on $\deno{\wellformedok{\P}{\G}}$. Using Naturality.

\case{Nil}
\begin{align}
    \si\star\deno{\wellformedok{\P}{\nil}} &= \term{I}\after\si\\
    &= \term{I'}\\
    &= \deno{\wellformedok{\P'}{\nil}}\\
    \deno{\wellformedok{\P'}{\nil\ssi}}\\
\end{align}

\case{Var}
\begin{align}
   \si\star\deno{\wellformedok{\P}{\gax}} &= \si\star(\square(\deno{\wellformedok{\P}{\G}},\deno{\typerelation{\P}{A}{\type}})) \\
    & = \square(\deno{\wellformedok{\P}{\G}},\deno{\typerelation{\P}{A}{\type}})\after\si\\
   & = \square(\deno{\wellformedok{\P}{\G}}\after\si, \deno{\typerelation{\P}{A}{\type}}\after\si)\\
    & = \square(\deno{\wellformedok{\P'}{\G\ssi}},\deno{\typerelation{\P'}{A\ssi}{\type}})\\
    & = \deno{\wellformedok{\P'}{\G\ssi, x: A\ssi}}\\
    & = \deno{\wellformedok{\P'}{(\gax)\ssi}}\\
\end{align}

\section{Terms}
If 
\begin{align}
    \si &= \deno{\typerelation{\P'}{\si}{\P}}\\
    \D &= \deno{\gpetyperelation{v}{A}}\\
    \D' &= \deno{\etyperelation{\P'}{\G\ssi}{v\ssi}{A\ssi}}\\
\end{align}

Then \begin{eqnarray}
    \D' = \si\star(\D)
\end{eqnarray}

\proof
By induction over the derivation of $\D$. Using the S-Closure of $\si\star$. We use $\G_I$ to indicate $\deno{\wellformedok{\P}{\G}}$, an $A_I$ to indicate $\deno{\typerelation{\P}{A}{\effect}}$

\case{Unit}

\begin{equation}
    \D = \term{\G_I}
\end{equation}

So

\begin{equation}
    \si\star(\D) = \term{\G_I\ssi} = \D'
\end{equation}

\case{True, False}
Giving the case for true as false is the same but using $\inr$
\begin{equation}
    \D = \inl\after\term{\G_I}
\end{equation}

So

\begin{equation}
    \si\star(\D) = \inl\after \term{\G_I\ssi} = \D'
\end{equation}

Since $\si\star$ is S-closed.

\case{Constant}


\begin{equation}
    \D = \deno{\const{A}}\after\term{\G_I}
\end{equation}

So

\begin{equation}
    \si\star(\D) = \si\star\deno{\const{A}}\after \term{\G_I\ssi}=\deno{\const{A\ssi}}\after \term{\G_I\ssi}  = \D'
\end{equation}

Since $\si\star$ is S-closed.

\case{Subtype}

Let \begin{equation}
    \D_1 = \deno{\gpetyperelation{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \deno{A\subtypep B}\after \D_1\\
\end{equation}

So 
\begin{align}
    \si\star(\D) & = \si\star{\deno{A\subtypep B}}\after\si\star\D_1 \\
    & = \deno{A\ssi\subtypepp B\ssi}\after\D_1'\qt{By induction}\\
    & = D'
\end{align}

\case{Lambda}
Let \begin{equation}
    \D_1 = \deno{\etyperelation{\P}{\gax}{v}{B}}
\end{equation}

Then

\begin{equation}
    \D = \cur(\D_1)\\
\end{equation}

So
\begin{align}
    \si\star(\D) & = \si\star(\cur{\D_1})\\
    & = \cur{\si\star(\D_1)}\qt{By S-closure}\\
    & = \cur{\D_1'}\qt{By induction}\\
    & = \D'
\end{align}

\case{Application}
Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v_1}{\ab}}\\
    \D_2 &= \deno{\gpetyperelation{v_2}{A}}
\end{align}

Then

\begin{equation}
    \D = \app\after\pr{\D_1}{\D_2}\\
\end{equation}

So

\begin{align}
    \si\star\D & = \si\star(\app\after\pr{\D_1}{\D_2})\\
    & = \app\after\pr{\si\star(\D_1)}{\si\star(\D_2)}\qt{By S-closure}\\
    & = \app\after\pr{\D_1'}{\D_2'}\qt{By Induction}\\
    & = \D'
\end{align}

\case{Return}
Let \begin{equation}
    \D_1 = \deno{\gpetyperelation{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \point{A_I}\after \D_1\\
\end{equation}

So

\begin{align}
    \si\star(\D) &= \si\star(\point{A_I}\after \D_1)\\
            & = \point{A_{I'}} \after\si\star(\D_1)\qt{By S-closure}\\
            & = \point{A_{I'}} \after\D_1'\\
            & = \D'
\end{align}

\case{Bind}
Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v_1}{\M{\e_1}{A}}}\\
    \D_2 &= \deno{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}
\end{align}

Then

\begin{equation}
    \D = \M{\e_1}{\e_2}{A_I}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G_I}{A_I}\after\pr{\Id{\G_{I}}}{\D_1}\\
\end{equation}

So

\begin{align}
    \si\star(\D) &= \si\star(\bind{\e_1}{\e_2}{A}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\Id{\G}}{\D_1})\\
    & = \si\star(\bind{\e_1}{\e_2}{A})\after\si\star(\T{\e_1}{\D_2})\after\si\star(\tstrength{\e_1}{\G}{A})\after\pr{\si\star(\Id{\G_{I})}}{\si\star(\D_1)}\qt{By S-Closure}\\
    &= \bind{\si(\e_1)}{\si(\e_2)}{A\ssi'}\after\T{\si(\e_1)}{\si\star(\D_2)}\after\tstrength{\si(\e_1)}{\G\ssi}{A\ssi}\after\pr{\si\star(\Id{\G_{I})}}{\si\star(\D_1)}\qt{By S-Closure}\\
    &= \bind{\si(\e_1)}{\si(\e_2)}{A\ssi'}\after\T{\si(\e_1)}{\D_2'}\after\tstrength{\si(\e_1)}{\G\ssi}{A\ssi}\after\pr{\si\star(\Id{\G_{I})}}{\D_1'}\qt{By Induction}\\
    &= \D'\\
\end{align}

\case{If}

Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v}{\B}}\\
    \D_2 &= \deno{\gpetyperelation{v_1}{A}}\\
    \D_3 &= \deno{\gpetyperelation{v_2}{A}}\\
\end{align}

Then

\begin{equation}
    \D = \app\after(([\cur{\D_2\after\pp}, \cur{\D_3\after\pp}]\after\D_1)\times\Id{\G})\after\diag{\G}\\
\end{equation}

So

\begin{align}
    \si\star(\D) &= \si\star(\app\after(([\cur{\D_2\after\pp}, \cur{\D_3\after\pp}]\after\D_1)\times\Id{\G})\after\diag{\G})\\
    &= \app\after(([\cur{\si\star(\D_2)\after\pp}, \cur{\si\star(\D_3)\after\pp}]\after\si\star(\D_1))\times\Id{\G\ssi})\after\diag{\G\ssi}\qt{By S-Closure}\\
    &= \app\after(([\cur{\D_2'\after\pp}, \cur{\D_3'\after\pp}]\after\D_1')\times\Id{\G\ssi})\after\diag{\G\ssi}\qt{By Induction}\\
    & = \D'\\
\end{align}


\case{Effect-Lambda}

Let \begin{equation}
    \D_1 = \deno{\etyperelation{\P,\a}{\G}{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \widehat{\D_1}\\
\end{equation}

And also

\begin{equation}
    \si\times\Id{} = \deno{\typerelation{(\P',\a)}{(\si, \a\setto\e)}{(\P,\a)}}
\end{equation}

So
\begin{align}
    \si\star\D &= \si\star(\widehat{\D_1})\\
    & = \widehat{(\si\times\Id{U})\star\D_1}\qt{By naturality}\\
    & = \widehat{\D_1'}\qt{By induction}\\
    & = \D'
\end{align}

\case{Effect-Application}

Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v}{\all{\a}{A}}}\\
    h &= \deno{\typerelation{\P}{\e}{\effect}}\\
\end{align}

Then

\begin{equation}
    \D = \pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1\\
\end{equation}

So
Due to the substitution theorem on effects
\begin{equation}
    h\after\si = \deno{\typerelation{\P}{\e}{\effect}}\after\si = \deno{\typerelation{\P'}{\si(\e)}{\effect}} = h'
\end{equation}

\begin{align}
    \si\star{\D} & = \si\star(\pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)\\
    & = (\pr{\Id{\G}}{h}\after\si)\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\si\star(\D_1)\\
    & = ((\si\times\Id{U})\after\pr{\Id{\G}}{h\after\si})\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)'\\
    & = (\pr{\Id{\G}}{h'})\star((\si\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)'\\
\end{align}

Looking at the inner part of the functor application:
Let \begin{align}
    A & = \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}\\
\end{align}
\begin{align}
    (\si\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}} &= (\si\times\Id{U})\star\e_{A}\\
    & = (\si\times\Id{U})\star(\widehat{\Id{\allI(A)}})\\
    & = \widehat{\bar{(\si\times\Id{U})\star(\widehat{\Id{\allI(A)}})}}\qt{By bijection}\\
    & = \widehat{\si\star(\bar{\widehat{\Id{\allI(A)}}})}\qt{By naturality}\\
    & = \widehat{\si\star(\Id{\allI(A)})}\qt{By bijection}\\
    & = \widehat{\Id{\allII(A\after(\si\times\Id{U}))}}\qt{By S-Closure, naturality}\\
    & = \widehat{\Id{\allII(A\sub{\si,\a\setto\a})}}\qt{By Substitution theorem}\\
    & = \e_{A\ssi}
\end{align}

Going back to the original expression:

\begin{align}
    \si\star{\D} & = (\pr{\Id{\G}}{h'})\star(\e_{A\ssi})\after\D_1)'\\
    & = \D'\\
\end{align}

\chapter{Effect Weakening Theorem}
In this section, we state and prove a theorem that the action of a simultaneous effect-weakening upon a structure in the language has a consistent effect upon the denotation of the language. More formally, for the denotation morphism $\D$ of some relation, the denotation of the weakened relation, $\D' = \w\star(\D)$.

\section{Effects}
If $\w = \deno{\wrelw{\P'}{\P}}$ then $\typerelation{\P'}{\e}{\effect} = \w\star\deno{\typerelation{\P}{\e}{\effect}} = \deno{\typerelation{\P}{\e}{\effect}}\after\w$

\proof
By induction on the derivation on $\deno{\typerelation{\P}{\e}{\effect}}$

\case{Ground}
\begin{align}
    \deno{\typerelation{\P}{e}{\effect}}\after\w & = \deno{e}\after\term{I}\after\w \\
    & = \deno{e}\after\term{I'} \\
    & = \deno{\typerelation{\P'}{e}{\type}}\\
\end{align}

\case{Var}
Case split on $\w$.
\subcase{$\w = \i$}
Then $\P' = \P$ and $\w = \Id{I}$. So the theorem holds trivially.
\subcase{$\w = \w'\x$}
Then

\begin{align}
    \deno{\typerelation{\P,\a}{\a}{\effect}}\after\w &= \pp\after(\w'\times \Id{U}) \\
    & = \pp\\
    & = \deno{\typerelation{\P',\a}{\a}{\effect}}
\end{align}

\subcase{$\w = \w'\p$}
Then \begin{equation}
    \deno{\typerelation{\P,\a}{\a}{\effect}} = \pp\after\w'\after\p
\end{equation}

Where $\P' = \P,\b$ and $\wrel{\w'}{\P''}{\P}$.

So\begin{align}
    \pp\after\w' & = \deno{\typerelation{\P''}{\a}{\effect}}
    \\
    \pp\after\w'\after\p & =\deno{\typerelation{\P'',\b}{\a}{\effect}}
    &= \deno{\typerelation{\P'}{\a}{\effect}}
\end{align}

\case{Weaken}
\begin{equation}
    \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w = \deno{\typerelation{\P}{\a}{\effect}}\after\p\after\w
\end{equation}

Case split of structure of $w$

\subcase{$\w=\i$}
Then $\P' = \P,\b$ so $\w=\Id{I}$
So $\deno{\typerelation{\P,\b}{\a}{\effect}}\after\w = \deno{\typerelation{\P'}{\a}{\effect}}$

\subcase{$\w=\w'\p$}
Then $\P' = \P'',\g$ and $\w=\w'\after\p$
Where $\wrel{\w'}{\P''}{\P,\b}$.
So
\begin{align}
    \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w & = \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w'\after\p\\
    & = {\typerelation{\P''}{\a}{\effect}}\after\p\\
    & = {\typerelation{\P'',\g}{\a}{\effect}}\\
    & = {\typerelation{\P'}{\a}{\effect}}\\
\end{align}

\subcase{$\w=\w'\x$}
Then $\P'=\P'',\b$ and $\wrel{\w'}{\P'}{\P}$

So \begin{align}
    \deno{\typerelation{\P,\b}{\a}{\effect}}\after\w &= \deno{\typerelation{\P}{\a}{\effect}}\after\p\after(\w'\times\Id{U})\\
    &=\deno{\typerelation{\P}{\a}{\effect}}\after\w'\after\p\\
    & = \deno{\typerelation{\P''}{\a}{\effect}}\after\p\\
    & = \deno{\typerelation{\P'}{\a}{\effect}}\\
\end{align}

\case{Multiply}
\begin{align}
    \deno{\typerelation{\P}{\e_1\dot\e_2}{\type}} \after\w &=
    \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}})\after \w \\
    & = \Mul(\deno{\typerelation{\P}{\e_1}{\effect}}\after \w, \deno{\typerelation{\P}{\e_2}{\effect}}\after \w)\qt{By Naturality}\\
    & = \Mul(\deno{\typerelation{\P'}{\e_1}{\effect}}, \deno{\typerelation{\P}{\e_2}{\effect}})\\
    & = \deno{\typerelation{\P}{\e_1\dot\e_2}{\effect}}
\end{align}


\section{Types}
If $\w = \deno{\wrelw{\P'}{\P}}$ then $\deno{\typerelation{\P'}{A}{\type}} = \w\star\deno{\typerelation{\P}{A}{\type}} = \deno{\typerelation{\P}{A}{\type}}\after\w$.

\proof
By induction on the derivation on $\deno{\typerelation{\P}{A}{\type}}$. Making use of naturality properties of the type constructors.

\case{Ground}
\begin{align}
    \deno{\typerelation{\P}{\g}{\type}}\after\w &= \deno{\g}\after\term{I}\after\w\\
    & =  \deno{\g}\after\term{I'}\\
    & = \deno{\typerelation{\P'}{\g}{\type}}\\
    & = \deno{\typerelation{\P'}{\g}{\type}}
\end{align}

\case{Monad}
\begin{align}
    \deno{\typerelation{\P}{\mea}{\type}}\after\w & =  \Eff(\deno{\typerelation{\P}{\e}{\effect}}, \deno{\typerelation{\P}{A}{\type}})\after\w \\
    & = \Eff(\deno{\typerelation{\P}{\e}{\effect}}\after\w, \deno{\typerelation{\P}{A}{\type}}\after\w) \qt{By naturality}\\
    & = \Eff(\deno{\typerelation{\P'}{\e}{\effect}}, \deno{\typerelation{\P'}{A}{\type}})\\
    & = \deno{\typerelation{\P'}{(\mea)}{\type}}
\end{align}
\case{Quantification}
    Note $\deno{\wrel{\w\x}{\P',\a}{\P,\a}} = \w\times\Id{U}$

    \begin{align}
        \deno{\typerelation{\P}{\all{\a}A}{\type}}\after\w & = \allI(\deno{\typerelation{\P,\a}{A}{\type}})\after\w\\
        & = \allI(\deno{\typerelation{\P,\a}{A}{\type}}\after(\w\times\Id{U}))\qt{By naturality}\\
        & = \allI(\deno{\typerelation{\P',\a}{A}{\type}})\qt{By induction}\\
        & = \deno{\typerelation{\P'}{\all{\a}{A}}{\type}}\\
        & = \deno{\typerelation{\P'}{(\all{\a}{A})}{\type}}\\
    \end{align}

\case{Function}
\begin{align}
    \deno{\typerelation{\P}{\ab}{\type}}\after\w &= \diamond(\deno{\typerelation{\P}{A}{\type}},\deno{\typerelation{\P}{B}{\type}})\after\w\\
    &= \diamond(\deno{\typerelation{\P}{A}{\type}}\after\w,\deno{\typerelation{\P}{B}{\type}}\after\w)\qt{By Naturality}\\
    & = \diamond(\deno{\typerelation{\P'}{A}{\type}},\deno{\typerelation{\P'}{B}{\type}})\\
    & = \deno{\typerelation{\P'}{(\ab)}{\type}}\\
\end{align}

\section{Sub-typing}
If $\w = \deno{\wrelw{\P'}{\P}}$ then $\deno{A\subtypepp B} = \w\star\deno{A\subtypep B}: \cipw(A, B)$.

\proof
By induction on the derivation on $\deno{A\subtypep B}$. Using S-closure of $\w\star$ 

\case{Ground}
\begin{align}
    \w\star(\g_1\subtypeg\g_2) &= (\g_1\subtypeg\g_2)
\end{align}

Since $\w\star$ is s-closed.

\case{Monad}
\begin{align}
    \w\star\deno{\M{\e_1}{A} \subtypep \M{\e_2}{B}} & = \w\star(\deno{\e_1\subeffectp\e_2})\after\w\star(\T{\e_1}(\deno{A\subtypep B})) \\ 
     &= \deno{\e_1\subeffectpp\e_2} \after \T{\e_1}{\deno{A\subtypepp B}}\qt{By S-Closure}\\
     &= \deno{\M{\e_1}{A}\subtypepp\M{\e_2}{B}}\\
     &= \deno{(\M{\e_1}{A})\subtypepp\M{\e_2}{B}}\\
\end{align}

\case{For All}
Note $\deno{\wrel{\w\x}{\P',\a}{\P,\a}} = (\w\times\Id{U})$
    \begin{align}
        \w\star\deno{\all{\a}{A}\subtypep\all{\a}{B}} &= \w\star(\allI(\deno{A\subtypepa B})) \\
        &=\allII((\w\times\Id{U})\star(\deno{A\subtypepa B}))\\
        &=\allII(\deno{A\subtypeppa B})\\
        &= \deno{(\all{\a}{A}) \subtypepp(\all{\a}{B})}\\
    \end{align}

\case{Fn}
\begin{align}
    \w\star\deno{(\ab)\subtypep\fntype{A'}{B'}} &= \w\star(\deno{B\subtypep B'}^{A'}\after B^{\deno{A'\subtypep A}})\\
    &= \w\star(\cur{\deno{B\subtypep B'}\after\app})\after\w\star(\cur{\app\after(\Id{B}\times\deno{A'\subtypep A})})\\
    & = \cur{\w\star(\deno{B\subtypep B'})\after\app}\after\cur{\app\after(\Id{B}\times\w\star(\deno{A'\subtypep A}))}\\
    & = \cur{\deno{B\subtypepp B'}\after\app}\after\cur{\app\after(\Id{B}\times\deno{A'\subtypepp A})}\\
    &= \deno{(\ab)\subtypepp(\fntype{A'}{B'})}
\end{align}

\section{Type Environments}
If $\w = \deno{\wrelw{\P'}{\P}}$ then $\deno{\wellformedok{\P'}{\G}} = \w\star\deno{\wellformedok{\P}{\G}} = \deno{\wellformedok{\P}{\G}}\after\w: \cipw$.

\proof
By induction on the derivation on $\deno{\wellformedok{\P}{\G}}$. Using Naturality.

\case{Nil}
\begin{align}
    \w\star\deno{\wellformedok{\P}{\nil}} &= \term{I}\after\w\\
    &= \term{I'}\\
    &= \deno{\wellformedok{\P'}{\nil}}\\
\end{align}

\case{Var}
\begin{align}
   \w\star\deno{\wellformedok{\P}{\gax}} &= \w\star(\square(\deno{\wellformedok{\P}{\G}},\deno{\typerelation{\P}{A}{\type}})) \\
    & = \square(\deno{\wellformedok{\P}{\G}},\deno{\typerelation{\P}{A}{\type}})\after\w\\
   & = \square(\deno{\wellformedok{\P}{\G}}\after\w, \deno{\typerelation{\P}{A}{\type}}\after\w)\\
    & = \square(\deno{\wellformedok{\P'}{\G}},\deno{\typerelation{\P'}{A}{\type}})\\
    & = \deno{\wellformedok{\P'}{(\gax)}}\\
\end{align}

\section{Terms}


\section{Terms}
If 
\begin{align}
    \w &= \deno{\wrelw{\P'}{\P}}\\
    \D &= \deno{\gpetyperelation{v}{A}}\\
    \D' &= \deno{\etyperelation{\P'}{\G}{v}{A}}\\
\end{align}

Then \begin{eqnarray}
    \D' = \w\star(\D)
\end{eqnarray}

\proof
By induction over the derivation of $\D$. Using the S-Closure of $\w\star$. We use $\G_I$ to indicate $\deno{\wellformedok{\P}{\G}}$, an $A_I$ to indicate $\deno{\typerelation{\P}{A}{\effect}}$

\case{Unit}

\begin{equation}
    \D = \term{\G_I}
\end{equation}

So

\begin{equation}
    \w\star(\D) = \term{\G_{I'}} = \D'
\end{equation}

\case{True, False}
Giving the case for true as false is the same but using $\inr$
\begin{equation}
    \D = \inl\after\term{\G_I}
\end{equation}

So

\begin{equation}
    \w\star(\D) = \inl\after \term{\G_{I'}} = \D'
\end{equation}

Since $\w\star$ is S-closed.

\case{Constant}


\begin{equation}
    \D = \deno{\const{A}}\after\term{\G_I}
\end{equation}

So

\begin{equation}
    \w\star(\D) = \w\star\deno{\const{A}}\after \term{\G_{I'}}=\deno{\const{A_{I'}}}\after \term{\G_{I'}}  = \D'
\end{equation}

Since $\w\star$ is S-closed.

\case{Subtype}

Let \begin{equation}
    \D_1 = \deno{\gpetyperelation{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \deno{A\subtypep B}\after \D_1\\
\end{equation}

So 
\begin{align}
    \w\star(\D) & = \w\star{\deno{A\subtypep B}}\after\w\star\D_1 \\
    & = \deno{A_{I'}\subtypepp B_{I'}}\after\D_1'\qt{By induction}\\
    & = D'
\end{align}

\case{Lambda}
Let \begin{equation}
    \D_1 = \deno{\etyperelation{\P}{\gax}{v}{B}}
\end{equation}

Then

\begin{equation}
    \D = \cur(\D_1)\\
\end{equation}

So
\begin{align}
    \w\star(\D) & = \w\star(\cur{\D_1})\\
    & = \cur{\w\star(\D_1)}\qt{By S-closure}\\
    & = \cur{\D_1'}\qt{By induction}\\
    & = \D'
\end{align}

\case{Application}
Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v_1}{\ab}}\\
    \D_2 &= \deno{\gpetyperelation{v_2}{A}}
\end{align}

Then

\begin{equation}
    \D = \app\after\pr{\D_1}{\D_2}\\
\end{equation}

So

\begin{align}
    \w\star\D & = \w\star(\app\after\pr{\D_1}{\D_2})\\
    & = \app\after\pr{\w\star(\D_1)}{\w\star(\D_2)}\qt{By S-closure}\\
    & = \app\after\pr{\D_1'}{\D_2'}\qt{By Induction}\\
    & = \D'
\end{align}

\case{Return}
Let \begin{equation}
    \D_1 = \deno{\gpetyperelation{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \point{A_I}\after \D_1\\
\end{equation}

So

\begin{align}
    \w\star(\D) &= \w\star(\point{A_I}\after \D_1)\\
            & = \point{A_{I'}} \after\w\star(\D_1)\qt{By S-closure}\\
            & = \point{A_{I'}} \after\D_1'\\
            & = \D'
\end{align}

\case{Bind}
Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v_1}{\M{\e_1}{A}}}\\
    \D_2 &= \deno{\etyperelation{\P}{\gax}{v_2}{\M{\e_2}{B}}}
\end{align}

Then

\begin{equation}
    \D = \M{\e_1}{\e_2}{A_I}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G_I}{A_I}\after\pr{\Id{\G_{I}}}{\D_1}\\
\end{equation}

So

\begin{align}
    \w\star(\D) &= \w\star(\bind{\e_1}{\e_2}{A}\after\T{\e_1}{\D_2}\after\tstrength{\e_1}{\G}{A}\after\pr{\Id{\G}}{\D_1})\\
    & = \w\star(\bind{\e_1}{\e_2}{A})\after\w\star(\T{\e_1}{\D_2})\after\w\star(\tstrength{\e_1}{\G}{A})\after\pr{\w\star(\Id{\G_{I})}}{\w\star(\D_1)}\qt{By S-Closure}\\
    &= \bind{\e_1}{\e_2}{A_{I'}}\after\T{\e_1}{\w\star(\D_2)}\after\tstrength{\e_1}{\G_{I'}}{A_{I'}}\after\pr{\w\star(\Id{\G_{I})}}{\w\star(\D_1)}\qt{By S-Closure}\\
    &= \bind{\e_1}{\e_2}{A_{I'}}\after\T{\e_1}{\D_2'}\after\tstrength{\e_1}{\G_{I'}}{A_{I'}}\after\pr{\w\star(\Id{\G_{I})}}{\D_1'}\qt{By Induction}\\
    &= \D'\\
\end{align}

\case{If}

Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v}{\B}}\\
    \D_2 &= \deno{\gpetyperelation{v_1}{A}}\\
    \D_3 &= \deno{\gpetyperelation{v_2}{A}}\\
\end{align}

Then

\begin{equation}
    \D = \app\after(([\cur{\D_2\after\pp}, \cur{\D_3\after\pp}]\after\D_1)\times\Id{\G})\after\diag{\G}\\
\end{equation}

So

\begin{align}
    \w\star(\D) &= \w\star(\app\after(([\cur{\D_2\after\pp}, \cur{\D_3\after\pp}]\after\D_1)\times\Id{\G})\after\diag{\G})\\
    &= \app\after(([\cur{\w\star(\D_2)\after\pp}, \cur{\w\star(\D_3)\after\pp}]\after\w\star(\D_1))\times\Id{\G_{I'}})\after\diag{\G_{I'}}\qt{By S-Closure}\\
    &= \app\after(([\cur{\D_2'\after\pp}, \cur{\D_3'\after\pp}]\after\D_1')\times\Id{\G_{I'}})\after\diag{\G_{I'}}\qt{By Induction}\\
    & = \D'\\
\end{align}


\case{Effect-Lambda}

Let \begin{equation}
    \D_1 = \deno{\etyperelation{\P,\a}{\G}{v}{A}}
\end{equation}

Then

\begin{equation}
    \D = \widehat{\D_1}\\
\end{equation}

And also

\begin{equation}
    \w\times\Id{} = \deno{\wrel{\w\x}{(\P',\a)}{(\P,\a)}}
\end{equation}

So
\begin{align}
    \w\star\D &= \w\star(\widehat{\D_1})\\
    & = \widehat{(\w\times\Id{U})\star\D_1}\qt{By naturality}\\
    & = \widehat{\D_1'}\qt{By induction}\\
    & = \D'
\end{align}

\case{Effect-Application}

Let \begin{align}
    \D_1 &= \deno{\gpetyperelation{v}{\all{\a}{A}}}\\
    h &= \deno{\typerelation{\P}{\e}{\effect}}\\
\end{align}

Then

\begin{equation}
    \D = \pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1\\
\end{equation}

So due to the substitution theorem on effects
\begin{equation}
    h\after\w = \deno{\typerelation{\P}{\e}{\effect}}\after\w = \deno{\typerelation{\P'}{\e}{\effect}} = h'
\end{equation}

Also note $(\w\times\Id{U}) = \deno{\wrel{\w\x}{\P',\a}{\P\a}}$

\begin{align}
    \w\star{\D} & = \w\star(\pr{\Id{\G}}{h}\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)\\
    & = (\pr{\Id{\G}}{h}\after\w)\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\w\star(\D_1)\\
    & = ((\w\times\Id{U})\after\pr{\Id{\G}}{h\after\w})\star(\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)'\\
    & = (\pr{\Id{\G}}{h'})\star((\w\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}})\after\D_1)'\\
\end{align}

Looking at the inner part of the functor application:
Let \begin{align}
    A & = \deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}\\
\end{align}
\begin{align}
    (\w\times\Id{U})\star\e_{\deno{\typerelation{\P,\b}{A\ssub{\a}{\b}}{\type}}} &= (\w\times\Id{U})\star\e_{A}\\
    & = (\w\times\Id{U})\star(\widehat{\Id{\allI(A)}})\\
    & = \widehat{\bar{(\w\times\Id{U})\star(\widehat{\Id{\allI(A)}})}}\qt{By bijection}\\
    & = \widehat{\w\star(\bar{\widehat{\Id{\allI(A)}}})}\qt{By naturality}\\
    & = \widehat{\w\star(\Id{\allI(A)})}\qt{By bijection}\\
    & = \widehat{\Id{\allII(A\after(\w\times\Id{U}))}}\qt{By S-Closure, naturality}\\
    & = \widehat{\Id{\allII(A)}}\qt{By Substitution theorem}\\
    & = \e_{A_{I'}}
\end{align}

Going back to the original expression:

\begin{align}
    \w\star{\D} & = (\pr{\Id{\G}}{h'})\star(\e_{A_{I'}})\after\D_1)'\\
    & = \D'\\
\end{align}



\section{Term-Substitution}

If $\w = \deno{\wrelw{\P'}{\P}}$, then $\deno{\etyperelation{\P'}{\G'}{\si}{\G}} = \w\star\deno{\etyperelation{\P}{\G'}{\si}{\G}}$.

\proof
By induction on the structure of $\si$, making use of the weakening of term denotations above.

\case{Nil}
Then $\si = \term{\G'_{I}}$, so $\w\star(\si) = \term{\G'_{I'}} = \deno{\etyperelation{\P'}{\G'}{\si}{\G}}$

\case{Var}
Then $\si = (\si',x\setto v)$

\begin{align}
    \w\star\si & = \w*\pr{\si'}{\deno{\gpetyperelation{v}{A}}}\\
    & = \pr{\w\star\si'}{\w\star\deno{\gpetyperelation{v}{A}}}\\
    &=\pr{\deno{\etyperelation{\P'}{\G'}{\si'}{\G}}}{\deno{\etyperelation{\G'}{\P'}{v}{A}}}\\
    &=\deno{\etyperelation{\P'}{\G'}{\si}{\gax}}
\end{align}

\section{Term-Weakening}
If $\w = \deno{\wrelw{\P'}{\P}}$, then $\deno{\ewrel{\P'}{\w_1}{\G'}{\G}} = \w\star\deno{\ewrel{\P}{\w_1}{\G'}{\G}}$.


\proof
By induction on the structure of $\w_1$.

\case{Id}
Then $\w_1 = \i$, so its denotation is $\w_1 = \Id{\G_I}$

So
\begin{equation}
  \w\star(\Id{\G_I}) = \Id{\G_{I'}} = \deno{\ewrel{\P'}{\i}{\G}{\G}}  
\end{equation}

\case{Project}
Then $\w_1 = \w_1'\pi$

\begin{equation}
    \treerule{Project}{\ewrel{\P}{\w_1'}{\G'}{\G}}{\ewrel{\P}{\w_1\pi}{\G',x:A}{\G}}
\end{equation}

So $\w_1 = \w_1'\after\p$

Hence
\begin{align}
    \w\star(\w_1) &= \w\star(\w_1')\after\w\star(\p)\\
    & = \deno{\ewrel{\P'}{\w_1'}{\G'}{\G}}\after\p\\
    & = \deno{\ewrel{\P'}{\w_1'\pi}{\G',x:A}{\G}}\\
    & = \deno{\ewrel{\P'}{\w_1}{\G', x:A}{\G}}
\end{align}

\case{Extend}
Then $\w_1 = \w_1'\x$

\begin{equation}
    \treerule{Extend}{\ewrel{\P}{\w_1'}{\G'}{\G}}{\ewrel{\P}{\w_1\x}{\G',x:A}{\gax}}
\end{equation}

So $\w_1 = \w_1'\times\Id{A_I}$

Hence
\begin{align}
    \w\star(\w_1) &=(\w\star(\w_1')\times\w\star(\Id{A_I})\\
    & = (\deno{\ewrel{\P'}{\w_1'}{\G'}{\G}}\times\Id{A_I})\\
    & = \deno{\wrel{\P'}{\w_1}{\G',x:A}{\gax}}
\end{align}

\chapter{Value Substitution Theorem}

If $\D$ derives $\gpetyperelation{v}{A}$ and $\etyperelation{\P}{\G'}{\si}{\G}$ then the derivation $\D'$ deriving $\etyperelation{\P}{\G'}{v\ssi}{A}$ satisfies:

\begin{equation}
    \D' = \D \after\deno{\etyperelation{\P}{\G'}{\si}{\G}}
\end{equation}

This is proved by induction over the derivation of $\etyperelation{\P}{\G}{v}{A}$.
We shall use $\si$ to denote $\deno{\etyperelation{\P}{\G'}{\si}{\G}}$ where it is clear from the context.

\case{Var}
By inversion $\G = \G'', x:A$
\begin{equation}
    \treerule{Var}{\wellformedok{\P}{\G}}{\etyperelation{\P}{\G'', x:A}{x}{A}}
\end{equation}
By inversion, $\si = \si', x\setto v$ and $\etyperelation{\P}{\G'}{v}{A}$.

Let 
\begin{align}
    \si &=\deno{\etyperelation{\P}{\G'}{\si}{\G}} = \pr{\si'}{\D'}\\
    \D &=\deno{\etyperelation{\P}{\G'', x:A}{x}{A}} = \pp\\
\end{align}

\begin{align}
    \D\after\si &= \pp\after\pr{\si'}{\D'}\qt{By definition}\\
    &= \D'\qt{By product property}
\end{align}


\case{Weaken}
By inversion, $\G = \G', y:B$ and $\si = \si', y\setto v$
and we have $\D_1$ deriving:

\begin{equation}
    \treerule{Weaken}{\treerule{}{\D_1}{\etyperelation{\P}{\G''}{x}{A}}}{\etyperelation{\P}{\G'',y: B}{x}{A}}
\end{equation}

Also by inversion of the well-formed-ness of $\etyperelation{\P}{\G'}{\si}{\G}$, we have $\etyperelation{\P}{\G'}{\si'}{\G''}$ and 

\begin{equation}
    \deno{\etyperelation{\P}{\G'}{\si}{\G}} = \pr{\deno{\etyperelation{\P}{\G'}{\si}{\G''}}}{\deno{\etyperelation{\P}{\G'}{v}{B}}}
\end{equation}

Hence by induction on $\D_1$ we have $\D_1'$ such that

\begin{equation}
    \treerule{}{\D_1'}{\etyperelation{\P}{\G'}{x\ssi}{A}}
\end{equation}



Hence
\begin{align}
    \D' & = \D_1' \qt{By definition}\\
        & = \D_1\after\si'\qt{By induction}\\
        & = \D_1\after\p\after\pr{\si'}{\deno{\etyperelation{\P}{\G'}{v}{B}}}\qt{By product property}\\
        & = \D_1\after\p\after\si\qt{By defintion of the denotation of $\si$}\\
        & = \D\after\si\qt{By defintion.}
\end{align}

\case{Constants}
The logic for all constant terms ($\t,\f,\u,\const{A}$) is the same.
Let
\begin{equation}
    c = \deno{\const{A}}
\end{equation}
\begin{align}
    \D' & = c\after\term{\G'}\qt{By Definition}\\
        & = c\after\term{G}\after\si\qt{Terminal property}\\
        & = \D\after\si\qt{By definition}
\end{align}


\case{Lambda}

By inversion, we have $\D_1$ such that
\begin{equation}
    \D = \treerule{Fn}{
        \treerule{}{\D_1}{\etyperelation{\P}{\G, x:A}{v}{B}}
    }{\etyperelation{\P}{\G}{\lam{x}{A}{v}}{\ab}}
\end{equation}

By induction of $\D_1$ we have $\D_1'$ such that
\begin{equation}
    \D' = \treerule{Fn}{
        \treerule{}{\D_1'}{\etyperelation{\P}{\G', x:A}{(v\ssi)}{B}}
    }{\etyperelation{\P}{\G}{(\lam{x}{A}{v})\ssi}{\ab}}
\end{equation}
By induction and the extension lemma, we have:
\begin{equation}
    \D_1' = \D_1\after(\si\times\Id{A})
\end{equation}

Hence:

\begin{align}
    \D' &= \cur{\D_1'}\qt{By definition}\\
        &= \cur{\D_1\after(\si\times\Id{A})}\qt{By induction and extension lemma.}\\
        & = \cur{\D_1}\after\si\qt{By the exponential property (Uniqueness)}\\
        &= \D\after\si\qt{By Definition}\\
\end{align}
\case{Sub-type}
By inversion, there exists derivation $\D_1$ such that:

\begin{equation}
    \D = \treerule{Sub-type}{\treerule{}{\D_1}{\etyperelation{\P}{\G}{v}{A}}\s\s A\subtype B}{\etyperelation{\P}{\G}{v}{B}}
\end{equation}

By induction on $\D_1$, we find $\D_1'$ such that $\D_1' = \D_1\after\si$ and:

\begin{equation}
    \D' = \treerule{Sub-type}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v\ssi}{A}}\s\s A\subtype B}{\etyperelation{\P}{\G'}{v\ssi}{B}}
\end{equation}

Hence,

\begin{align}
    \D' &= \deno{A\subtype B}\after\D_1'\qt{By definition}\\
        &= \deno{A\subtype B}\after\D_1\after\si\qt{By induction}\\
        &= \D\after\si\qt{By definition}\\
\end{align}

\case{Return}

By inversion, we have $\D_1$ such that:
\begin{equation}
    \D = \treerule{Return}{\treerule{}{\D_1}{\etyperelation{\P}{\G}{v}{A}}}{\etyperelation{\P}{\G}{\return{v}}{\moa}}
\end{equation}

By induction on $\D_1$, we find $\D_1'$ such that $\D_1' = \D_1\after\si$ and:

\begin{equation}
    \D' = \treerule{Return}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v\ssi}{A}}}{\etyperelation{\P}{\G'}{(\return{v})\ssi}{\moa}}
\end{equation}

Hence,

\begin{align}
    \D' & = \point{A}\after\D_1'\qt{By Definition}\\
    & = \point{A}\after\D_1\after\si\qt{By induction}\\
    & = \D\after\si\qt{By Definition}\\
\end{align}
\case{Apply}
By inversion, we find $\D_1, \D_2$ such that
\begin{equation}
    \D = \treerule{Apply}{\treerule{}{\D_1}{\etyperelation{\P}{\G}{v_1}{\ab}}\s\s\treerule{}{\D_2}{\etyperelation{\P}{\G}{v_2}{A}}}{\etyperelation{\P}{\G}{\apply{v_1}{v_2}}{B}}
\end{equation}

By induction we find $\D_1', \D_2'$ such that 
\begin{align}
    \D_1' &= \D_1\after\si\\
    \D_2' &= \D_2\after\si\\
\end{align}

And
\begin{equation}
    \D' = \treerule{Apply}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v_1\ssi}{\ab}}\s\s\treerule{}{\D_2'}{\etyperelation{\P}{\G'}{v_2\ssi}{A}}}{\etyperelation{\P}{\G'}{(\apply{v_1}{v_2})\ssi}{B}}
\end{equation}

Hence
\begin{align}
    \D' &= \app\after\pr{\D_1'}{\D_2'}\qt{By Definition}\\
        &= \app\after\pr{\D_1\after\si}{\D_2\after\si}\qt{By induction}\\
        &= \app\after\pr{\D_1}{\D_2}\after\si\qt{By Product Property}\\
        & = \D\after\si\qt{By Definition}\\
\end{align}

\case{If}


By inversion, we find $\D_1, \D_2, \D_3$ such that
\begin{equation}
    \D = \treerule{If}{\treerule{}{\D_1}{\etyperelation{\P}{\G}{v}{\B}}\s\s\treerule{}{\D_2}{\etyperelation{\P}{\G}{v_1}{A}}\s\s\treerule{}{\D_3}{\etyperelation{\P}{\G}{v_2}{A}}}{\etyperelation{\P}{\G}{\pifthenelse{A}{v}{v_1}{v_2}}{A}}
\end{equation}

By induction we find $\D_1', \D_2', \D_3'$ such that 
\begin{align}
    \D_1' &= \D_1\after\si\\
    \D_2' &= \D_2\after\si\\
    \D_3' &= \D_3\after\si\\
\end{align}

And
\begin{equation}
    \D' = \treerule{If}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v\ssi}{\B}}\s\s\treerule{}{\D_2'}{\etyperelation{\P}{\G'}{v_1\ssi}{A}}\s\s\treerule{}{\D_3'}{\etyperelation{\P}{\G'}{v_2\ssi}{A}}}{\etyperelation{\P}{\G'}{(\pifthenelse{A}{v}{v_1}{v_2})\ssi}{A}}
\end{equation}

Since $\si: \G' \rightarrow \G$, \\
Let $(\tea)^{\si}: \tea^{\G}\rightarrow\tea^{\G'}$ be as defined in ExSh 3 (\footnote{https://www.cl.cam.ac.uk/teaching/1819/L108/exercises/L108-exercise-sheet-3.pdf})
That is:

\begin{align}
    (\tea)^{\si} & = \cur{\app\after(\Id{\tea}\times w)}
\end{align}.
And hence, we have:

\begin{align}
    \cur{f\after(\Id{}\times \si)} & = (\tea)^{\si} \after\cur{f}
\end{align}

And so:

\begin{align}
    \D' & =\app\after((\fld{\cur{\D_2'\after\pp}}{\cur{\D_3'\after\pp}}\after\D_1')\times \Id{\G'})\after\diag{\G'}\qt{By Definition}\\
    & =\app\after((\fld{\cur{\D_2\after\si\after\pp}}{\cur{\D_3\after\si\after\pp}}\after\D_1')\times \Id{\G'})\after\diag{\G'}\qt{By Induction}\\
    & = \app\after((\fld{\cur{\D_2\after\pp\after(\Id{\1}\times \si)}}{\cur{\D_3\after\pp\after(\Id{\1}\times \si)}}\after\D_1\after\si)\times \Id{\G'})\after\diag{\G'}\qt{By product property}\\
    & = \app\after((\fld{(\tea)^{\si}\after\cur{\D_2\after\pp}}{(\tea)^{\si}\after\cur{\D_3\after\pp}}\after\D_1\after\si)\times \Id{\G'})\after\diag{\G'}\qt{By $(\tea)^{\si}$ property}\\
    & = \app\after(((\tea)^{\si}\after\fld{\cur{\D_2\after\pp}}{\cur{\D_3\after\pp}}\after\D_1\after\si)\times \Id{\G'})\after\diag{\G'}\qt{Factor out transformation}\\
    & = \app\after((\tea)^{\si}\times\Id{\G'})\after((\fld{\cur{\D_2\after\pp}}{\cur{\D_3\after\pp}}\after\D_1)\times \Id{\G'})\after(\si \times \Id{\G'})\after\diag{\G'}\qt{Factor out Identity pairs}\\
    & = \app\after(\Id{(\tea)}\times\si)\after((\fld{\cur{\D_2\after\pp}}{\cur{\D_3\after\pp}}\after\D_1) \times \Id{\G'})\after(\si \times \Id{\G'})\after\diag{\G'}\qt{By defintion of $\app, (\tea)^{\si}$}\\
    & = \app\after((\fld{\cur{\D_2\after\pp}}{\cur{\D_3\after\pp}}\after\D_1)\times \idg)\after(\si \times \si)\after\diag{\G'}\qt{Push through pairs}\\
    & = \app\after((\fld{\cur{\D_2\after\pp}}{\cur{\D_3\after\pp}}\after\D_1)\times \idg)\after\diag{\G}\after\si\qt{By Definition of the diagonal morphism.}\\
    & = \D\after\si
\end{align}


\case{Bind}

By inversion, we have $\D_1, \D_2$ such that:

\begin{equation}
    \D = \treerule{Bind}{
        \treerule{}{\D_1}{\etyperelation{\P}{\G}{v_1}{A}}
        \s\s
        \treerule{}{\D_2}{\etyperelation{\P}{\G, x:A }{v_1}{B}}
    }{
        \etyperelation{\P}{\G}{\doin{x}{v_1}{v_2}}{\M{\e_1\dot\e_2}{B}}
    }
\end{equation}

By property 3,

\begin{equation}
    \etyperelation{\P}{(\G', x:A)}{(\si, x\setto x}{(\gax)}
\end{equation}

With denotation (extension lemma)

\begin{equation}
    \deno{\etyperelation{\P}{(\G', x:A)}{(\si, x\setto x}{(\gax)}} = \si\times\Id{A}
\end{equation}

By induction, we derive $\D_1', \D_2'$ such that:

\begin{align}
    \D_1' & = \D_1\after \si\\
    \D_2' & = \D_2\after (\si\times\Id{A})\qt{By Extension Lemma}
\end{align}

And:

\begin{equation}
    \D' = \treerule{Bind}{
        \treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v_1\ssi}{A}}
        \s\s
        \treerule{}{\D_2'}{\etyperelation{\P}{\G', x:A }{v_1\ssi}{B}}
    }{
        \etyperelation{\P}{\G'}{(\doin{x}{v_1}{v_2})\ssi}{\M{\e_1\dot\e_2}{B}}
    }
\end{equation}

Hence:

\begin{align}
    \D' & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{\D_2'}\after\tstrength{\e_1}{\G'}{A}\after\pr{\Id{\G'}}{\D_1'}\qt{By Definition}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{(\D_2\after(\si\times\Id{A}))}\after\tstrength{\e_1}{\G'}{A}\after\pr{\Id{\G'}}{\D_1\after\si}\qt{By Induction using the extension lemma}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{(\D_2)}\after\tstrength{\e_1}{\G}{A}\after(\si\times\Id{\T{\e_1}{A}})\after\pr{\Id{\G'}}{\D_1\after\si}\qt{By Tensor Strength}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{(\D_2)}\after\tstrength{\e_1}{\G}{A}\after\pr{\si}{\D_1\after\si}\qt{By Product rule}\\
    & = \bind{\e_1}{\e_2}{B}\after\T{\e_1}{(\D_2)}\after\tstrength{\e_1}{\G}{A}\after\pr{\idg}{\D_1}\after\si\qt{By Product rule}\\
    &= \D\after\si\qt{By Defintion}\\
\end{align}

\case{Effect-Lambda}

By inversion, we have $\D_1$ such that

\begin{equation}
    \D = \treerule{Effect-Fn}{\treerule{}{\D_1}{\etyperelation{\P,\a}{\G}{v}{A}}}{\gpetyperelation{\elam{\a}{v}}{\all{\e}{A}}}
\end{equation}

By induction, we derive $\D_1'$ such that

\begin{equation}
    \D' = \treerule{Effect-Fn}{\treerule{}{\D_1'}{\etyperelation{\P,\a}{\G'}{v\ssi}{A}}}{\etyperelation{\P}{\G'}{(\elam{\a}{v})\ssi}{\all{\e}{A}}}
\end{equation}

Where 
\begin{align}
    \D_1' & = \D_1\after\deno{\etyperelation{\P,\a}{\G'}{\si}{\G}}\\
    & = \D_1\after\deno{\wrel{\i\pi}{\P,a}{\P}}\star(\si\\
    & = \D_1\after\pstar(\si)
\end{align}

Hence \begin{align}
    \D\after\si & = \bar{\D_1}\after\si\\
    & = \bar{\D_1\after\pstar(\si)}\\
    & = \bar{\D_1'}\\
    & = \D'
\end{align}

\case{Effect-Application}
By inversion, we derive $\D_1$ such that
\begin{equation}
    \D = \treerule{Effect-App}{\treerule{}{\D_1}{\etyperelation{\P}{\G}{v}{\all{\a}{A}}}\s\s\wellformed{\P}{\e}}{\etyperelation{\P}{\G}{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\end{equation}

By induction, we derive $\D_1'$ such that

\begin{equation}
    \D' = \treerule{Effect-App}{\treerule{}{\D_1'}{\etyperelation{\P}{\G'}{v}{\all{\a}{A}}}\s\s\wellformed{\P}{\e}}{\etyperelation{\P}{\G'}{\eapp{v}{\e}}{A\ssub{\a}{\e}}}
\end{equation}

Where 

\begin{align}
    \D_1' = \D\after\si
\end{align}



Hence, if $h = \deno{\typerelation{\P}{\e}{\effect}}$
\begin{align}
    \D\after\si &= \pr{\Id{I}}{h}\star(\e{\deno{\typerelation{\P,\b}{A\ssub{\b}{\a}}{\effect}}})\after\D_1\after\si\\
    &= \pr{\Id{I}}{h}\star(\e{\deno{\typerelation{\P,\b}{A\ssub{\b}{\a}}{\effect}}})\after\D_1'\\
    & = \D'
\end{align}

\chapter{Type-Environment Weakening Theorem}

\chapter{Unique Denotation Theorem}

\chapter{Beta-Eta-Equivalence Theorem (Soundness)}


    
\end{document}
